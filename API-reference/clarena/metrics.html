<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.1"/>
    <title>clarena.metrics API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style><script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    /* Re-invoke MathJax when DOM content changes, for example during search. */
    document.addEventListener("DOMContentLoaded", () => {
        new MutationObserver(() => MathJax.typeset()).observe(
            document.querySelector("main.pdoc").parentNode,
            {childList: true}
        );
    })
</script>
<style>
    mjx-container {
        overflow-x: auto;
        overflow-y: hidden;
    }
</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../clarena.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;clarena</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>

            <h2>Contents</h2>
            <ul>
  <li><a href="#metrics">Metrics</a></li>
</ul>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#MetricCallback">MetricCallback</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MetricCallback.__init__">MetricCallback</a>
                        </li>
                        <li>
                                <a class="variable" href="#MetricCallback.save_dir">save_dir</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CLAccuracy">CLAccuracy</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CLAccuracy.__init__">CLAccuracy</a>
                        </li>
                        <li>
                                <a class="variable" href="#CLAccuracy.test_acc_csv_path">test_acc_csv_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#CLAccuracy.acc_training_epoch">acc_training_epoch</a>
                        </li>
                        <li>
                                <a class="variable" href="#CLAccuracy.acc_val">acc_val</a>
                        </li>
                        <li>
                                <a class="variable" href="#CLAccuracy.acc_test">acc_test</a>
                        </li>
                        <li>
                                <a class="variable" href="#CLAccuracy.task_id">task_id</a>
                        </li>
                        <li>
                                <a class="function" href="#CLAccuracy.on_fit_start">on_fit_start</a>
                        </li>
                        <li>
                                <a class="function" href="#CLAccuracy.on_train_batch_end">on_train_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#CLAccuracy.on_train_epoch_end">on_train_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#CLAccuracy.on_validation_batch_end">on_validation_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#CLAccuracy.on_validation_epoch_end">on_validation_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#CLAccuracy.on_test_start">on_test_start</a>
                        </li>
                        <li>
                                <a class="function" href="#CLAccuracy.on_test_batch_end">on_test_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#CLAccuracy.on_test_epoch_end">on_test_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#CLAccuracy.update_test_acc_to_csv">update_test_acc_to_csv</a>
                        </li>
                        <li>
                                <a class="function" href="#CLAccuracy.plot_test_acc_matrix_from_csv">plot_test_acc_matrix_from_csv</a>
                        </li>
                        <li>
                                <a class="function" href="#CLAccuracy.plot_test_ave_acc_curve_from_csv">plot_test_ave_acc_curve_from_csv</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CLLoss">CLLoss</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CLLoss.__init__">CLLoss</a>
                        </li>
                        <li>
                                <a class="variable" href="#CLLoss.test_loss_cls_csv_path">test_loss_cls_csv_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#CLLoss.loss_cls_training_epoch">loss_cls_training_epoch</a>
                        </li>
                        <li>
                                <a class="variable" href="#CLLoss.loss_training_epoch">loss_training_epoch</a>
                        </li>
                        <li>
                                <a class="variable" href="#CLLoss.loss_cls_val">loss_cls_val</a>
                        </li>
                        <li>
                                <a class="variable" href="#CLLoss.loss_cls_test">loss_cls_test</a>
                        </li>
                        <li>
                                <a class="variable" href="#CLLoss.task_id">task_id</a>
                        </li>
                        <li>
                                <a class="function" href="#CLLoss.on_fit_start">on_fit_start</a>
                        </li>
                        <li>
                                <a class="function" href="#CLLoss.on_train_batch_end">on_train_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#CLLoss.on_train_epoch_end">on_train_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#CLLoss.on_validation_batch_end">on_validation_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#CLLoss.on_validation_epoch_end">on_validation_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#CLLoss.on_test_start">on_test_start</a>
                        </li>
                        <li>
                                <a class="function" href="#CLLoss.on_test_batch_end">on_test_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#CLLoss.on_test_epoch_end">on_test_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#CLLoss.update_test_loss_cls_to_csv">update_test_loss_cls_to_csv</a>
                        </li>
                        <li>
                                <a class="function" href="#CLLoss.plot_test_loss_cls_matrix_from_csv">plot_test_loss_cls_matrix_from_csv</a>
                        </li>
                        <li>
                                <a class="function" href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv">plot_test_ave_loss_cls_curve_from_csv</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CULDistributionDistance">CULDistributionDistance</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CULDistributionDistance.__init__">CULDistributionDistance</a>
                        </li>
                        <li>
                                <a class="variable" href="#CULDistributionDistance.distribution_distance_type">distribution_distance_type</a>
                        </li>
                        <li>
                                <a class="variable" href="#CULDistributionDistance.distribution_distance_csv_path">distribution_distance_csv_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#CULDistributionDistance.distribution_distance">distribution_distance</a>
                        </li>
                        <li>
                                <a class="variable" href="#CULDistributionDistance.task_id">task_id</a>
                        </li>
                        <li>
                                <a class="function" href="#CULDistributionDistance.on_test_start">on_test_start</a>
                        </li>
                        <li>
                                <a class="function" href="#CULDistributionDistance.on_test_batch_end">on_test_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#CULDistributionDistance.on_test_epoch_end">on_test_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#CULDistributionDistance.update_unlearning_test_distance_to_csv">update_unlearning_test_distance_to_csv</a>
                        </li>
                        <li>
                                <a class="function" href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv">plot_unlearning_test_distance_from_csv</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CULAccuracyDifference">CULAccuracyDifference</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CULAccuracyDifference.__init__">CULAccuracyDifference</a>
                        </li>
                        <li>
                                <a class="variable" href="#CULAccuracyDifference.accuracy_difference_csv_path">accuracy_difference_csv_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#CULAccuracyDifference.accuracy_difference">accuracy_difference</a>
                        </li>
                        <li>
                                <a class="variable" href="#CULAccuracyDifference.task_id">task_id</a>
                        </li>
                        <li>
                                <a class="function" href="#CULAccuracyDifference.on_test_start">on_test_start</a>
                        </li>
                        <li>
                                <a class="function" href="#CULAccuracyDifference.on_test_batch_end">on_test_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#CULAccuracyDifference.on_test_epoch_end">on_test_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv">update_unlearning_accuracy_difference_to_csv</a>
                        </li>
                        <li>
                                <a class="function" href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv">plot_unlearning_accuracy_difference_from_csv</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#HATAdjustmentRate">HATAdjustmentRate</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#HATAdjustmentRate.__init__">HATAdjustmentRate</a>
                        </li>
                        <li>
                                <a class="variable" href="#HATAdjustmentRate.plot_adjustment_rate_every_n_steps">plot_adjustment_rate_every_n_steps</a>
                        </li>
                        <li>
                                <a class="variable" href="#HATAdjustmentRate.task_id">task_id</a>
                        </li>
                        <li>
                                <a class="function" href="#HATAdjustmentRate.on_fit_start">on_fit_start</a>
                        </li>
                        <li>
                                <a class="function" href="#HATAdjustmentRate.on_train_batch_end">on_train_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#HATAdjustmentRate.plot_hat_adjustment_rate">plot_hat_adjustment_rate</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#HATNetworkCapacity">HATNetworkCapacity</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#HATNetworkCapacity.__init__">HATNetworkCapacity</a>
                        </li>
                        <li>
                                <a class="variable" href="#HATNetworkCapacity.task_id">task_id</a>
                        </li>
                        <li>
                                <a class="function" href="#HATNetworkCapacity.on_fit_start">on_fit_start</a>
                        </li>
                        <li>
                                <a class="function" href="#HATNetworkCapacity.on_train_batch_end">on_train_batch_end</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#HATMasks">HATMasks</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#HATMasks.__init__">HATMasks</a>
                        </li>
                        <li>
                                <a class="variable" href="#HATMasks.plot_training_mask_every_n_steps">plot_training_mask_every_n_steps</a>
                        </li>
                        <li>
                                <a class="variable" href="#HATMasks.task_id">task_id</a>
                        </li>
                        <li>
                                <a class="function" href="#HATMasks.on_fit_start">on_fit_start</a>
                        </li>
                        <li>
                                <a class="function" href="#HATMasks.on_train_batch_end">on_train_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#HATMasks.on_test_start">on_test_start</a>
                        </li>
                        <li>
                                <a class="function" href="#HATMasks.plot_hat_mask">plot_hat_mask</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#MTLAccuracy">MTLAccuracy</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MTLAccuracy.__init__">MTLAccuracy</a>
                        </li>
                        <li>
                                <a class="variable" href="#MTLAccuracy.test_acc_csv_path">test_acc_csv_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#MTLAccuracy.acc_training_epoch">acc_training_epoch</a>
                        </li>
                        <li>
                                <a class="variable" href="#MTLAccuracy.acc_val">acc_val</a>
                        </li>
                        <li>
                                <a class="variable" href="#MTLAccuracy.acc_test">acc_test</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLAccuracy.on_fit_start">on_fit_start</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLAccuracy.on_train_batch_end">on_train_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLAccuracy.on_train_epoch_end">on_train_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLAccuracy.on_validation_batch_end">on_validation_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLAccuracy.on_test_start">on_test_start</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLAccuracy.on_test_batch_end">on_test_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLAccuracy.on_test_epoch_end">on_test_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLAccuracy.save_test_acc_to_csv">save_test_acc_to_csv</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLAccuracy.plot_test_acc_from_csv">plot_test_acc_from_csv</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#MTLLoss">MTLLoss</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MTLLoss.__init__">MTLLoss</a>
                        </li>
                        <li>
                                <a class="variable" href="#MTLLoss.test_loss_cls_csv_path">test_loss_cls_csv_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#MTLLoss.loss_cls_training_epoch">loss_cls_training_epoch</a>
                        </li>
                        <li>
                                <a class="variable" href="#MTLLoss.loss_cls_val">loss_cls_val</a>
                        </li>
                        <li>
                                <a class="variable" href="#MTLLoss.loss_cls_test">loss_cls_test</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLLoss.on_fit_start">on_fit_start</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLLoss.on_train_batch_end">on_train_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLLoss.on_train_epoch_end">on_train_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLLoss.on_validation_batch_end">on_validation_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLLoss.on_validation_epoch_end">on_validation_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLLoss.on_test_start">on_test_start</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLLoss.on_test_batch_end">on_test_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLLoss.on_test_epoch_end">on_test_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLLoss.save_test_loss_cls_to_csv">save_test_loss_cls_to_csv</a>
                        </li>
                        <li>
                                <a class="function" href="#MTLLoss.plot_test_loss_cls_from_csv">plot_test_loss_cls_from_csv</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#STLAccuracy">STLAccuracy</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#STLAccuracy.__init__">STLAccuracy</a>
                        </li>
                        <li>
                                <a class="variable" href="#STLAccuracy.test_acc_csv_path">test_acc_csv_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#STLAccuracy.acc_training_epoch">acc_training_epoch</a>
                        </li>
                        <li>
                                <a class="variable" href="#STLAccuracy.acc_val">acc_val</a>
                        </li>
                        <li>
                                <a class="variable" href="#STLAccuracy.acc_test">acc_test</a>
                        </li>
                        <li>
                                <a class="function" href="#STLAccuracy.on_fit_start">on_fit_start</a>
                        </li>
                        <li>
                                <a class="function" href="#STLAccuracy.on_train_batch_end">on_train_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#STLAccuracy.on_train_epoch_end">on_train_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#STLAccuracy.on_validation_batch_end">on_validation_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#STLAccuracy.on_validation_epoch_end">on_validation_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#STLAccuracy.on_test_start">on_test_start</a>
                        </li>
                        <li>
                                <a class="function" href="#STLAccuracy.on_test_batch_end">on_test_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#STLAccuracy.on_test_epoch_end">on_test_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#STLAccuracy.save_test_acc_to_csv">save_test_acc_to_csv</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#STLLoss">STLLoss</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#STLLoss.__init__">STLLoss</a>
                        </li>
                        <li>
                                <a class="variable" href="#STLLoss.test_loss_cls_csv_path">test_loss_cls_csv_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#STLLoss.loss_cls_training_epoch">loss_cls_training_epoch</a>
                        </li>
                        <li>
                                <a class="variable" href="#STLLoss.loss_cls_val">loss_cls_val</a>
                        </li>
                        <li>
                                <a class="variable" href="#STLLoss.loss_cls_test">loss_cls_test</a>
                        </li>
                        <li>
                                <a class="function" href="#STLLoss.on_fit_start">on_fit_start</a>
                        </li>
                        <li>
                                <a class="function" href="#STLLoss.on_train_batch_end">on_train_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#STLLoss.on_train_epoch_end">on_train_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#STLLoss.on_validation_batch_end">on_validation_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#STLLoss.on_validation_epoch_end">on_validation_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#STLLoss.on_test_start">on_test_start</a>
                        </li>
                        <li>
                                <a class="function" href="#STLLoss.on_test_batch_end">on_test_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#STLLoss.on_test_epoch_end">on_test_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#STLLoss.save_test_loss_cls_to_csv">save_test_loss_cls_to_csv</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../clarena.html">clarena</a><wbr>.metrics    </h1>

                        <div class="docstring"><h1 id="metrics">Metrics</h1>

<p>This submodule provides the <strong>metrics</strong> in CLArena. This includes:</p>

<ul>
<li>Callbacks that control each metric's calculation, logging and visualization process. They are implemented as subclasses of <code><a href="#MetricCallback">MetricCallback</a></code>.</li>
<li>Custom metrics that can be used in continual learning experiments. They are implemented as classes in <code>torchmetrics</code>.</li>
</ul>

<p>Please note that this is an API documentation. Please refer to the main documentation pages for more information about the metrics and how to configure and implement them:</p>

<ul>
<li><a href="https://pengxiang-wang.com/projects/continual-learning-arena/docs/configure-your-experiment/metrics"><strong>Configure Metrics</strong></a></li>
<li><a href="https://pengxiang-wang.com/projects/continual-learning-arena/docs/implement-your-cl-modules/metrics"><strong>Implement Your Metrics</strong></a></li>
<li><a href="https://pengxiang-wang.com/posts/continual-learning-metrics"><strong>A Summary of Continual Learning Metrics</strong></a></li>
</ul>
</div>

                        <input id="mod-metrics-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-metrics-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos"> 1</span></a><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos"> 2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos"> 3</span></a><span class="sd"># Metrics</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos"> 4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos"> 5</span></a><span class="sd">This submodule provides the **metrics** in CLArena. This includes:</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos"> 6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos"> 7</span></a><span class="sd">- Callbacks that control each metric&#39;s calculation, logging and visualization process. They are implemented as subclasses of `MetricCallback`.</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos"> 8</span></a><span class="sd">- Custom metrics that can be used in continual learning experiments. They are implemented as classes in `torchmetrics`.</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos"> 9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos">10</span></a><span class="sd">Please note that this is an API documentation. Please refer to the main documentation pages for more information about the metrics and how to configure and implement them:</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos">12</span></a><span class="sd">- [**Configure Metrics**](https://pengxiang-wang.com/projects/continual-learning-arena/docs/configure-your-experiment/metrics)</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">13</span></a><span class="sd">- [**Implement Your Metrics**](https://pengxiang-wang.com/projects/continual-learning-arena/docs/implement-your-cl-modules/metrics)</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">14</span></a><span class="sd">- [**A Summary of Continual Learning Metrics**](https://pengxiang-wang.com/posts/continual-learning-metrics)</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos">16</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos">18</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetricCallback</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">19</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.cl_acc</span><span class="w"> </span><span class="kn">import</span> <span class="n">CLAccuracy</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">20</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.cl_loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">CLLoss</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">21</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.cul_dd</span><span class="w"> </span><span class="kn">import</span> <span class="n">CULDistributionDistance</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">22</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.cul_ad</span><span class="w"> </span><span class="kn">import</span> <span class="n">CULAccuracyDifference</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">23</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.hat_adjustment_rate</span><span class="w"> </span><span class="kn">import</span> <span class="n">HATAdjustmentRate</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">24</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.hat_network_capacity</span><span class="w"> </span><span class="kn">import</span> <span class="n">HATNetworkCapacity</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">25</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.hat_masks</span><span class="w"> </span><span class="kn">import</span> <span class="n">HATMasks</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">26</span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos">27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos">28</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.mtl_acc</span><span class="w"> </span><span class="kn">import</span> <span class="n">MTLAccuracy</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">29</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.mtl_loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">MTLLoss</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">30</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.stl_acc</span><span class="w"> </span><span class="kn">import</span> <span class="n">STLAccuracy</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">31</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.stl_loss</span><span class="w"> </span><span class="kn">import</span> <span class="n">STLLoss</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos">33</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">34</span></a>    <span class="s2">&quot;MetricCallback&quot;</span><span class="p">,</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">35</span></a>    <span class="s2">&quot;CLAccuracy&quot;</span><span class="p">,</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">36</span></a>    <span class="s2">&quot;CLLoss&quot;</span><span class="p">,</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">37</span></a>    <span class="s2">&quot;CULDistributionDistance&quot;</span><span class="p">,</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">38</span></a>    <span class="s2">&quot;CULAccuracyDifference&quot;</span><span class="p">,</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">39</span></a>    <span class="s2">&quot;HATAdjustmentRate&quot;</span><span class="p">,</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">40</span></a>    <span class="s2">&quot;HATNetworkCapacity&quot;</span><span class="p">,</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">41</span></a>    <span class="s2">&quot;HATMasks&quot;</span><span class="p">,</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">42</span></a>    <span class="s2">&quot;MTLAccuracy&quot;</span><span class="p">,</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">43</span></a>    <span class="s2">&quot;MTLLoss&quot;</span><span class="p">,</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">44</span></a>    <span class="s2">&quot;STLAccuracy&quot;</span><span class="p">,</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">45</span></a>    <span class="s2">&quot;STLLoss&quot;</span><span class="p">,</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">46</span></a><span class="p">]</span>
</span></pre></div>


            </section>
                <section id="MetricCallback">
                            <input id="MetricCallback-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MetricCallback</span><wbr>(<span class="base">lightning.pytorch.callbacks.callback.Callback</span>):

                <label class="view-source-button" for="MetricCallback-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MetricCallback"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MetricCallback-19"><a href="#MetricCallback-19"><span class="linenos">19</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MetricCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
</span><span id="MetricCallback-20"><a href="#MetricCallback-20"><span class="linenos">20</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MetricCallback-21"><a href="#MetricCallback-21"><span class="linenos">21</span></a><span class="sd">    The base class for all metrics callbacks in CLArena.</span>
</span><span id="MetricCallback-22"><a href="#MetricCallback-22"><span class="linenos">22</span></a>
</span><span id="MetricCallback-23"><a href="#MetricCallback-23"><span class="linenos">23</span></a><span class="sd">    This class is a placeholder for future metrics callbacks that can be used in continual learning experiments.</span>
</span><span id="MetricCallback-24"><a href="#MetricCallback-24"><span class="linenos">24</span></a><span class="sd">    It is not intended to be instantiated directly, but rather to be subclassed by specific metrics callbacks.</span>
</span><span id="MetricCallback-25"><a href="#MetricCallback-25"><span class="linenos">25</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="MetricCallback-26"><a href="#MetricCallback-26"><span class="linenos">26</span></a>
</span><span id="MetricCallback-27"><a href="#MetricCallback-27"><span class="linenos">27</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MetricCallback-28"><a href="#MetricCallback-28"><span class="linenos">28</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `MetricCallback`.</span>
</span><span id="MetricCallback-29"><a href="#MetricCallback-29"><span class="linenos">29</span></a>
</span><span id="MetricCallback-30"><a href="#MetricCallback-30"><span class="linenos">30</span></a><span class="sd">        **Args:**</span>
</span><span id="MetricCallback-31"><a href="#MetricCallback-31"><span class="linenos">31</span></a><span class="sd">        - **save_dir** (`str`): The directory where data and figures of metrics will be saved. Better inside the output folder.</span>
</span><span id="MetricCallback-32"><a href="#MetricCallback-32"><span class="linenos">32</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MetricCallback-33"><a href="#MetricCallback-33"><span class="linenos">33</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="MetricCallback-34"><a href="#MetricCallback-34"><span class="linenos">34</span></a>
</span><span id="MetricCallback-35"><a href="#MetricCallback-35"><span class="linenos">35</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="MetricCallback-36"><a href="#MetricCallback-36"><span class="linenos">36</span></a>
</span><span id="MetricCallback-37"><a href="#MetricCallback-37"><span class="linenos">37</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">save_dir</span>
</span><span id="MetricCallback-38"><a href="#MetricCallback-38"><span class="linenos">38</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the directory where data and figures of metrics will be saved.&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>The base class for all metrics callbacks in CLArena.</p>

<p>This class is a placeholder for future metrics callbacks that can be used in continual learning experiments.
It is not intended to be instantiated directly, but rather to be subclassed by specific metrics callbacks.</p>
</div>


                            <div id="MetricCallback.__init__" class="classattr">
                                        <input id="MetricCallback.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">MetricCallback</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span></span>)</span>

                <label class="view-source-button" for="MetricCallback.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MetricCallback.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MetricCallback.__init__-27"><a href="#MetricCallback.__init__-27"><span class="linenos">27</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MetricCallback.__init__-28"><a href="#MetricCallback.__init__-28"><span class="linenos">28</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `MetricCallback`.</span>
</span><span id="MetricCallback.__init__-29"><a href="#MetricCallback.__init__-29"><span class="linenos">29</span></a>
</span><span id="MetricCallback.__init__-30"><a href="#MetricCallback.__init__-30"><span class="linenos">30</span></a><span class="sd">        **Args:**</span>
</span><span id="MetricCallback.__init__-31"><a href="#MetricCallback.__init__-31"><span class="linenos">31</span></a><span class="sd">        - **save_dir** (`str`): The directory where data and figures of metrics will be saved. Better inside the output folder.</span>
</span><span id="MetricCallback.__init__-32"><a href="#MetricCallback.__init__-32"><span class="linenos">32</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MetricCallback.__init__-33"><a href="#MetricCallback.__init__-33"><span class="linenos">33</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="MetricCallback.__init__-34"><a href="#MetricCallback.__init__-34"><span class="linenos">34</span></a>
</span><span id="MetricCallback.__init__-35"><a href="#MetricCallback.__init__-35"><span class="linenos">35</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="MetricCallback.__init__-36"><a href="#MetricCallback.__init__-36"><span class="linenos">36</span></a>
</span><span id="MetricCallback.__init__-37"><a href="#MetricCallback.__init__-37"><span class="linenos">37</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">save_dir</span>
</span><span id="MetricCallback.__init__-38"><a href="#MetricCallback.__init__-38"><span class="linenos">38</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the directory where data and figures of metrics will be saved.&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the <code><a href="#MetricCallback">MetricCallback</a></code>.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>save_dir</strong> (<code>str</code>): The directory where data and figures of metrics will be saved. Better inside the output folder.</li>
</ul>
</div>


                            </div>
                            <div id="MetricCallback.save_dir" class="classattr">
                                <div class="attr variable">
            <span class="name">save_dir</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#MetricCallback.save_dir"></a>
    
            <div class="docstring"><p>Store the directory where data and figures of metrics will be saved.</p>
</div>


                            </div>
                </section>
                <section id="CLAccuracy">
                            <input id="CLAccuracy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CLAccuracy</span><wbr>(<span class="base"><a href="#MetricCallback">clarena.metrics.MetricCallback</a></span>):

                <label class="view-source-button" for="CLAccuracy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLAccuracy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLAccuracy-27"><a href="#CLAccuracy-27"><span class="linenos"> 27</span></a><span class="k">class</span><span class="w"> </span><span class="nc">CLAccuracy</span><span class="p">(</span><span class="n">MetricCallback</span><span class="p">):</span>
</span><span id="CLAccuracy-28"><a href="#CLAccuracy-28"><span class="linenos"> 28</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Provides all actions that are related to CL accuracy metric, which include:</span>
</span><span id="CLAccuracy-29"><a href="#CLAccuracy-29"><span class="linenos"> 29</span></a>
</span><span id="CLAccuracy-30"><a href="#CLAccuracy-30"><span class="linenos"> 30</span></a><span class="sd">    - Defining, initializing and recording accuracy metric.</span>
</span><span id="CLAccuracy-31"><a href="#CLAccuracy-31"><span class="linenos"> 31</span></a><span class="sd">    - Logging training and validation accuracy metric to Lightning loggers in real time.</span>
</span><span id="CLAccuracy-32"><a href="#CLAccuracy-32"><span class="linenos"> 32</span></a><span class="sd">    - Saving test accuracy metric to files.</span>
</span><span id="CLAccuracy-33"><a href="#CLAccuracy-33"><span class="linenos"> 33</span></a><span class="sd">    - Visualizing test accuracy metric as plots.</span>
</span><span id="CLAccuracy-34"><a href="#CLAccuracy-34"><span class="linenos"> 34</span></a>
</span><span id="CLAccuracy-35"><a href="#CLAccuracy-35"><span class="linenos"> 35</span></a><span class="sd">    The callback is able to produce the following outputs:</span>
</span><span id="CLAccuracy-36"><a href="#CLAccuracy-36"><span class="linenos"> 36</span></a>
</span><span id="CLAccuracy-37"><a href="#CLAccuracy-37"><span class="linenos"> 37</span></a><span class="sd">    - CSV files for test accuracy (lower triangular) matrix and average accuracy. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-test-performance-of-previous-tasks) for details.</span>
</span><span id="CLAccuracy-38"><a href="#CLAccuracy-38"><span class="linenos"> 38</span></a><span class="sd">    - Coloured plot for test accuracy (lower triangular) matrix. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-test-performance-of-previous-tasks) for details.</span>
</span><span id="CLAccuracy-39"><a href="#CLAccuracy-39"><span class="linenos"> 39</span></a><span class="sd">    - Curve plots for test average accuracy over different training tasks. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-average-test-performance-over-tasks) for details.</span>
</span><span id="CLAccuracy-40"><a href="#CLAccuracy-40"><span class="linenos"> 40</span></a>
</span><span id="CLAccuracy-41"><a href="#CLAccuracy-41"><span class="linenos"> 41</span></a><span class="sd">    Please refer to the [A Summary of Continual Learning Metrics](https://pengxiang-wang.com/posts/continual-learning-metrics) to learn about this metric.</span>
</span><span id="CLAccuracy-42"><a href="#CLAccuracy-42"><span class="linenos"> 42</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="CLAccuracy-43"><a href="#CLAccuracy-43"><span class="linenos"> 43</span></a>
</span><span id="CLAccuracy-44"><a href="#CLAccuracy-44"><span class="linenos"> 44</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="CLAccuracy-45"><a href="#CLAccuracy-45"><span class="linenos"> 45</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLAccuracy-46"><a href="#CLAccuracy-46"><span class="linenos"> 46</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CLAccuracy-47"><a href="#CLAccuracy-47"><span class="linenos"> 47</span></a>        <span class="n">test_acc_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;acc.csv&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy-48"><a href="#CLAccuracy-48"><span class="linenos"> 48</span></a>        <span class="n">test_acc_matrix_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CLAccuracy-49"><a href="#CLAccuracy-49"><span class="linenos"> 49</span></a>        <span class="n">test_ave_acc_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CLAccuracy-50"><a href="#CLAccuracy-50"><span class="linenos"> 50</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy-51"><a href="#CLAccuracy-51"><span class="linenos"> 51</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `CLAccuracy`.</span>
</span><span id="CLAccuracy-52"><a href="#CLAccuracy-52"><span class="linenos"> 52</span></a>
</span><span id="CLAccuracy-53"><a href="#CLAccuracy-53"><span class="linenos"> 53</span></a><span class="sd">        **Args:**</span>
</span><span id="CLAccuracy-54"><a href="#CLAccuracy-54"><span class="linenos"> 54</span></a><span class="sd">        - **save_dir** (`str`): The directory where data and figures of metrics will be saved. Better inside the output folder.</span>
</span><span id="CLAccuracy-55"><a href="#CLAccuracy-55"><span class="linenos"> 55</span></a><span class="sd">        - **test_acc_csv_name** (`str`): file name to save test accuracy matrix and average accuracy as CSV file.</span>
</span><span id="CLAccuracy-56"><a href="#CLAccuracy-56"><span class="linenos"> 56</span></a><span class="sd">        - **test_acc_matrix_plot_name** (`str` | `None`): file name to save accuracy matrix plot. If `None`, no file will be saved.</span>
</span><span id="CLAccuracy-57"><a href="#CLAccuracy-57"><span class="linenos"> 57</span></a><span class="sd">        - **test_ave_acc_plot_name** (`str` | `None`): file name to save average accuracy as curve plot over different training tasks. If `None`, no file will be saved.</span>
</span><span id="CLAccuracy-58"><a href="#CLAccuracy-58"><span class="linenos"> 58</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLAccuracy-59"><a href="#CLAccuracy-59"><span class="linenos"> 59</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="CLAccuracy-60"><a href="#CLAccuracy-60"><span class="linenos"> 60</span></a>
</span><span id="CLAccuracy-61"><a href="#CLAccuracy-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_acc_csv_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">test_acc_csv_name</span><span class="p">)</span>
</span><span id="CLAccuracy-62"><a href="#CLAccuracy-62"><span class="linenos"> 62</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The path to save test accuracy matrix and average accuracy CSV file.&quot;&quot;&quot;</span>
</span><span id="CLAccuracy-63"><a href="#CLAccuracy-63"><span class="linenos"> 63</span></a>        <span class="k">if</span> <span class="n">test_acc_matrix_plot_name</span><span class="p">:</span>
</span><span id="CLAccuracy-64"><a href="#CLAccuracy-64"><span class="linenos"> 64</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_acc_matrix_plot_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="CLAccuracy-65"><a href="#CLAccuracy-65"><span class="linenos"> 65</span></a>                <span class="n">save_dir</span><span class="p">,</span> <span class="n">test_acc_matrix_plot_name</span>
</span><span id="CLAccuracy-66"><a href="#CLAccuracy-66"><span class="linenos"> 66</span></a>            <span class="p">)</span>
</span><span id="CLAccuracy-67"><a href="#CLAccuracy-67"><span class="linenos"> 67</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The path to save test accuracy matrix plot.&quot;&quot;&quot;</span>
</span><span id="CLAccuracy-68"><a href="#CLAccuracy-68"><span class="linenos"> 68</span></a>        <span class="k">if</span> <span class="n">test_ave_acc_plot_name</span><span class="p">:</span>
</span><span id="CLAccuracy-69"><a href="#CLAccuracy-69"><span class="linenos"> 69</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_ave_acc_plot_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="CLAccuracy-70"><a href="#CLAccuracy-70"><span class="linenos"> 70</span></a>                <span class="n">save_dir</span><span class="p">,</span> <span class="n">test_ave_acc_plot_name</span>
</span><span id="CLAccuracy-71"><a href="#CLAccuracy-71"><span class="linenos"> 71</span></a>            <span class="p">)</span>
</span><span id="CLAccuracy-72"><a href="#CLAccuracy-72"><span class="linenos"> 72</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The path to save test average accuracy curve plot.&quot;&quot;&quot;</span>
</span><span id="CLAccuracy-73"><a href="#CLAccuracy-73"><span class="linenos"> 73</span></a>
</span><span id="CLAccuracy-74"><a href="#CLAccuracy-74"><span class="linenos"> 74</span></a>        <span class="c1"># training accumulated metrics</span>
</span><span id="CLAccuracy-75"><a href="#CLAccuracy-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="CLAccuracy-76"><a href="#CLAccuracy-76"><span class="linenos"> 76</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Classification accuracy of training epoch. Accumulated and calculated from the training batches. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-performance-of-training-epoch) for details. &quot;&quot;&quot;</span>
</span><span id="CLAccuracy-77"><a href="#CLAccuracy-77"><span class="linenos"> 77</span></a>
</span><span id="CLAccuracy-78"><a href="#CLAccuracy-78"><span class="linenos"> 78</span></a>        <span class="c1"># validation accumulated metrics</span>
</span><span id="CLAccuracy-79"><a href="#CLAccuracy-79"><span class="linenos"> 79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="CLAccuracy-80"><a href="#CLAccuracy-80"><span class="linenos"> 80</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Validation classification accuracy of the model after training epoch. Accumulated and calculated from the validation batches. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-validation-performace) for details. &quot;&quot;&quot;</span>
</span><span id="CLAccuracy-81"><a href="#CLAccuracy-81"><span class="linenos"> 81</span></a>
</span><span id="CLAccuracy-82"><a href="#CLAccuracy-82"><span class="linenos"> 82</span></a>        <span class="c1"># test accumulated metrics</span>
</span><span id="CLAccuracy-83"><a href="#CLAccuracy-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">]</span>
</span><span id="CLAccuracy-84"><a href="#CLAccuracy-84"><span class="linenos"> 84</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Test classification accuracy of the current model (`self.task_id`) on current and previous tasks. Accumulated and calculated from the test batches. Keys are task IDs and values are the corresponding metrics. It is the last row of the lower triangular matrix. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-test-performance-of-previous-tasks) for details. &quot;&quot;&quot;</span>
</span><span id="CLAccuracy-85"><a href="#CLAccuracy-85"><span class="linenos"> 85</span></a>
</span><span id="CLAccuracy-86"><a href="#CLAccuracy-86"><span class="linenos"> 86</span></a>        <span class="c1"># task ID controls</span>
</span><span id="CLAccuracy-87"><a href="#CLAccuracy-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="CLAccuracy-88"><a href="#CLAccuracy-88"><span class="linenos"> 88</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Task ID counter indicating which task is being processed. Self updated during the task loop. Valid from 1 to `cl_dataset.num_tasks`.&quot;&quot;&quot;</span>
</span><span id="CLAccuracy-89"><a href="#CLAccuracy-89"><span class="linenos"> 89</span></a>
</span><span id="CLAccuracy-90"><a href="#CLAccuracy-90"><span class="linenos"> 90</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLAccuracy-91"><a href="#CLAccuracy-91"><span class="linenos"> 91</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_fit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy-92"><a href="#CLAccuracy-92"><span class="linenos"> 92</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize training and validation metrics.&quot;&quot;&quot;</span>
</span><span id="CLAccuracy-93"><a href="#CLAccuracy-93"><span class="linenos"> 93</span></a>
</span><span id="CLAccuracy-94"><a href="#CLAccuracy-94"><span class="linenos"> 94</span></a>        <span class="c1"># set the current task_id from the `CLAlgorithm` object</span>
</span><span id="CLAccuracy-95"><a href="#CLAccuracy-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">task_id</span>
</span><span id="CLAccuracy-96"><a href="#CLAccuracy-96"><span class="linenos"> 96</span></a>
</span><span id="CLAccuracy-97"><a href="#CLAccuracy-97"><span class="linenos"> 97</span></a>        <span class="c1"># get the device to put the metrics on the same device</span>
</span><span id="CLAccuracy-98"><a href="#CLAccuracy-98"><span class="linenos"> 98</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">device</span>
</span><span id="CLAccuracy-99"><a href="#CLAccuracy-99"><span class="linenos"> 99</span></a>
</span><span id="CLAccuracy-100"><a href="#CLAccuracy-100"><span class="linenos">100</span></a>        <span class="c1"># initialize training metrics</span>
</span><span id="CLAccuracy-101"><a href="#CLAccuracy-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="CLAccuracy-102"><a href="#CLAccuracy-102"><span class="linenos">102</span></a>
</span><span id="CLAccuracy-103"><a href="#CLAccuracy-103"><span class="linenos">103</span></a>        <span class="c1"># initialize validation metrics</span>
</span><span id="CLAccuracy-104"><a href="#CLAccuracy-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="CLAccuracy-105"><a href="#CLAccuracy-105"><span class="linenos">105</span></a>
</span><span id="CLAccuracy-106"><a href="#CLAccuracy-106"><span class="linenos">106</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLAccuracy-107"><a href="#CLAccuracy-107"><span class="linenos">107</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span>
</span><span id="CLAccuracy-108"><a href="#CLAccuracy-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLAccuracy-109"><a href="#CLAccuracy-109"><span class="linenos">109</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLAccuracy-110"><a href="#CLAccuracy-110"><span class="linenos">110</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLAccuracy-111"><a href="#CLAccuracy-111"><span class="linenos">111</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="CLAccuracy-112"><a href="#CLAccuracy-112"><span class="linenos">112</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="CLAccuracy-113"><a href="#CLAccuracy-113"><span class="linenos">113</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CLAccuracy-114"><a href="#CLAccuracy-114"><span class="linenos">114</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy-115"><a href="#CLAccuracy-115"><span class="linenos">115</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Record training metrics from training batch, log metrics of training batch and accumulated metrics of the epoch to Lightning loggers.</span>
</span><span id="CLAccuracy-116"><a href="#CLAccuracy-116"><span class="linenos">116</span></a>
</span><span id="CLAccuracy-117"><a href="#CLAccuracy-117"><span class="linenos">117</span></a><span class="sd">        **Args:**</span>
</span><span id="CLAccuracy-118"><a href="#CLAccuracy-118"><span class="linenos">118</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the training step, the returns of the `training_step()` method in the `CLAlgorithm`.</span>
</span><span id="CLAccuracy-119"><a href="#CLAccuracy-119"><span class="linenos">119</span></a><span class="sd">        - **batch** (`Any`): the training data batch.</span>
</span><span id="CLAccuracy-120"><a href="#CLAccuracy-120"><span class="linenos">120</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLAccuracy-121"><a href="#CLAccuracy-121"><span class="linenos">121</span></a>        <span class="c1"># get the batch size</span>
</span><span id="CLAccuracy-122"><a href="#CLAccuracy-122"><span class="linenos">122</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="CLAccuracy-123"><a href="#CLAccuracy-123"><span class="linenos">123</span></a>
</span><span id="CLAccuracy-124"><a href="#CLAccuracy-124"><span class="linenos">124</span></a>        <span class="c1"># get training metrics values of current training batch from the outputs of the `training_step()`</span>
</span><span id="CLAccuracy-125"><a href="#CLAccuracy-125"><span class="linenos">125</span></a>        <span class="n">acc_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
</span><span id="CLAccuracy-126"><a href="#CLAccuracy-126"><span class="linenos">126</span></a>
</span><span id="CLAccuracy-127"><a href="#CLAccuracy-127"><span class="linenos">127</span></a>        <span class="c1"># update accumulated training metrics to calculate training metrics of the epoch</span>
</span><span id="CLAccuracy-128"><a href="#CLAccuracy-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="CLAccuracy-129"><a href="#CLAccuracy-129"><span class="linenos">129</span></a>
</span><span id="CLAccuracy-130"><a href="#CLAccuracy-130"><span class="linenos">130</span></a>        <span class="c1"># log training metrics of current training batch to Lightning loggers</span>
</span><span id="CLAccuracy-131"><a href="#CLAccuracy-131"><span class="linenos">131</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/train/acc_batch&quot;</span><span class="p">,</span> <span class="n">acc_batch</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="CLAccuracy-132"><a href="#CLAccuracy-132"><span class="linenos">132</span></a>
</span><span id="CLAccuracy-133"><a href="#CLAccuracy-133"><span class="linenos">133</span></a>        <span class="c1"># log accumulated training metrics till this training batch to Lightning loggers</span>
</span><span id="CLAccuracy-134"><a href="#CLAccuracy-134"><span class="linenos">134</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="CLAccuracy-135"><a href="#CLAccuracy-135"><span class="linenos">135</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/train/acc&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy-136"><a href="#CLAccuracy-136"><span class="linenos">136</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="CLAccuracy-137"><a href="#CLAccuracy-137"><span class="linenos">137</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLAccuracy-138"><a href="#CLAccuracy-138"><span class="linenos">138</span></a>        <span class="p">)</span>
</span><span id="CLAccuracy-139"><a href="#CLAccuracy-139"><span class="linenos">139</span></a>
</span><span id="CLAccuracy-140"><a href="#CLAccuracy-140"><span class="linenos">140</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLAccuracy-141"><a href="#CLAccuracy-141"><span class="linenos">141</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_epoch_end</span><span class="p">(</span>
</span><span id="CLAccuracy-142"><a href="#CLAccuracy-142"><span class="linenos">142</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLAccuracy-143"><a href="#CLAccuracy-143"><span class="linenos">143</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLAccuracy-144"><a href="#CLAccuracy-144"><span class="linenos">144</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLAccuracy-145"><a href="#CLAccuracy-145"><span class="linenos">145</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy-146"><a href="#CLAccuracy-146"><span class="linenos">146</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log metrics of training epoch to plot learning curves and reset the metrics accumulation at the end of training epoch.&quot;&quot;&quot;</span>
</span><span id="CLAccuracy-147"><a href="#CLAccuracy-147"><span class="linenos">147</span></a>
</span><span id="CLAccuracy-148"><a href="#CLAccuracy-148"><span class="linenos">148</span></a>        <span class="c1"># log the accumulated and computed metrics of the epoch to Lightning loggers, specially for plotting learning curves</span>
</span><span id="CLAccuracy-149"><a href="#CLAccuracy-149"><span class="linenos">149</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="CLAccuracy-150"><a href="#CLAccuracy-150"><span class="linenos">150</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/learning_curve/train/acc&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy-151"><a href="#CLAccuracy-151"><span class="linenos">151</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="CLAccuracy-152"><a href="#CLAccuracy-152"><span class="linenos">152</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLAccuracy-153"><a href="#CLAccuracy-153"><span class="linenos">153</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLAccuracy-154"><a href="#CLAccuracy-154"><span class="linenos">154</span></a>        <span class="p">)</span>
</span><span id="CLAccuracy-155"><a href="#CLAccuracy-155"><span class="linenos">155</span></a>
</span><span id="CLAccuracy-156"><a href="#CLAccuracy-156"><span class="linenos">156</span></a>        <span class="c1"># reset the metrics of training epoch as there are more epochs to go and not only one epoch like in the validation and test</span>
</span><span id="CLAccuracy-157"><a href="#CLAccuracy-157"><span class="linenos">157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span><span id="CLAccuracy-158"><a href="#CLAccuracy-158"><span class="linenos">158</span></a>
</span><span id="CLAccuracy-159"><a href="#CLAccuracy-159"><span class="linenos">159</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLAccuracy-160"><a href="#CLAccuracy-160"><span class="linenos">160</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_batch_end</span><span class="p">(</span>
</span><span id="CLAccuracy-161"><a href="#CLAccuracy-161"><span class="linenos">161</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLAccuracy-162"><a href="#CLAccuracy-162"><span class="linenos">162</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLAccuracy-163"><a href="#CLAccuracy-163"><span class="linenos">163</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLAccuracy-164"><a href="#CLAccuracy-164"><span class="linenos">164</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="CLAccuracy-165"><a href="#CLAccuracy-165"><span class="linenos">165</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="CLAccuracy-166"><a href="#CLAccuracy-166"><span class="linenos">166</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CLAccuracy-167"><a href="#CLAccuracy-167"><span class="linenos">167</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy-168"><a href="#CLAccuracy-168"><span class="linenos">168</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from validation batch. We don&#39;t need to log and monitor the metrics of validation batches.</span>
</span><span id="CLAccuracy-169"><a href="#CLAccuracy-169"><span class="linenos">169</span></a>
</span><span id="CLAccuracy-170"><a href="#CLAccuracy-170"><span class="linenos">170</span></a><span class="sd">        **Args:**</span>
</span><span id="CLAccuracy-171"><a href="#CLAccuracy-171"><span class="linenos">171</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the validation step, which is the returns of the `validation_step()` method in the `CLAlgorithm`.</span>
</span><span id="CLAccuracy-172"><a href="#CLAccuracy-172"><span class="linenos">172</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="CLAccuracy-173"><a href="#CLAccuracy-173"><span class="linenos">173</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLAccuracy-174"><a href="#CLAccuracy-174"><span class="linenos">174</span></a>
</span><span id="CLAccuracy-175"><a href="#CLAccuracy-175"><span class="linenos">175</span></a>        <span class="c1"># get the batch size</span>
</span><span id="CLAccuracy-176"><a href="#CLAccuracy-176"><span class="linenos">176</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="CLAccuracy-177"><a href="#CLAccuracy-177"><span class="linenos">177</span></a>
</span><span id="CLAccuracy-178"><a href="#CLAccuracy-178"><span class="linenos">178</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="CLAccuracy-179"><a href="#CLAccuracy-179"><span class="linenos">179</span></a>        <span class="n">acc_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
</span><span id="CLAccuracy-180"><a href="#CLAccuracy-180"><span class="linenos">180</span></a>
</span><span id="CLAccuracy-181"><a href="#CLAccuracy-181"><span class="linenos">181</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the validation metrics</span>
</span><span id="CLAccuracy-182"><a href="#CLAccuracy-182"><span class="linenos">182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="CLAccuracy-183"><a href="#CLAccuracy-183"><span class="linenos">183</span></a>
</span><span id="CLAccuracy-184"><a href="#CLAccuracy-184"><span class="linenos">184</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLAccuracy-185"><a href="#CLAccuracy-185"><span class="linenos">185</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_epoch_end</span><span class="p">(</span>
</span><span id="CLAccuracy-186"><a href="#CLAccuracy-186"><span class="linenos">186</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLAccuracy-187"><a href="#CLAccuracy-187"><span class="linenos">187</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLAccuracy-188"><a href="#CLAccuracy-188"><span class="linenos">188</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLAccuracy-189"><a href="#CLAccuracy-189"><span class="linenos">189</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy-190"><a href="#CLAccuracy-190"><span class="linenos">190</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log validation metrics to plot learning curves.&quot;&quot;&quot;</span>
</span><span id="CLAccuracy-191"><a href="#CLAccuracy-191"><span class="linenos">191</span></a>
</span><span id="CLAccuracy-192"><a href="#CLAccuracy-192"><span class="linenos">192</span></a>        <span class="c1"># log the accumulated and computed metrics of the epoch to Lightning loggers, specially for plotting learning curves</span>
</span><span id="CLAccuracy-193"><a href="#CLAccuracy-193"><span class="linenos">193</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="CLAccuracy-194"><a href="#CLAccuracy-194"><span class="linenos">194</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/learning_curve/val/acc&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy-195"><a href="#CLAccuracy-195"><span class="linenos">195</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="CLAccuracy-196"><a href="#CLAccuracy-196"><span class="linenos">196</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLAccuracy-197"><a href="#CLAccuracy-197"><span class="linenos">197</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLAccuracy-198"><a href="#CLAccuracy-198"><span class="linenos">198</span></a>        <span class="p">)</span>
</span><span id="CLAccuracy-199"><a href="#CLAccuracy-199"><span class="linenos">199</span></a>
</span><span id="CLAccuracy-200"><a href="#CLAccuracy-200"><span class="linenos">200</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLAccuracy-201"><a href="#CLAccuracy-201"><span class="linenos">201</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_start</span><span class="p">(</span>
</span><span id="CLAccuracy-202"><a href="#CLAccuracy-202"><span class="linenos">202</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLAccuracy-203"><a href="#CLAccuracy-203"><span class="linenos">203</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLAccuracy-204"><a href="#CLAccuracy-204"><span class="linenos">204</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLAccuracy-205"><a href="#CLAccuracy-205"><span class="linenos">205</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy-206"><a href="#CLAccuracy-206"><span class="linenos">206</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the metrics for testing each seen task in the beginning of a task&#39;s testing.&quot;&quot;&quot;</span>
</span><span id="CLAccuracy-207"><a href="#CLAccuracy-207"><span class="linenos">207</span></a>
</span><span id="CLAccuracy-208"><a href="#CLAccuracy-208"><span class="linenos">208</span></a>        <span class="c1"># set the current task_id again (double checking) from the `CLAlgorithm` object</span>
</span><span id="CLAccuracy-209"><a href="#CLAccuracy-209"><span class="linenos">209</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">task_id</span>
</span><span id="CLAccuracy-210"><a href="#CLAccuracy-210"><span class="linenos">210</span></a>
</span><span id="CLAccuracy-211"><a href="#CLAccuracy-211"><span class="linenos">211</span></a>        <span class="c1"># get the device to put the metrics on the same device</span>
</span><span id="CLAccuracy-212"><a href="#CLAccuracy-212"><span class="linenos">212</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">device</span>
</span><span id="CLAccuracy-213"><a href="#CLAccuracy-213"><span class="linenos">213</span></a>
</span><span id="CLAccuracy-214"><a href="#CLAccuracy-214"><span class="linenos">214</span></a>        <span class="c1"># initialize test metrics for current and previous tasks</span>
</span><span id="CLAccuracy-215"><a href="#CLAccuracy-215"><span class="linenos">215</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="CLAccuracy-216"><a href="#CLAccuracy-216"><span class="linenos">216</span></a>            <span class="n">task_id</span><span class="p">:</span> <span class="n">MeanMetricBatch</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">processed_task_ids</span>
</span><span id="CLAccuracy-217"><a href="#CLAccuracy-217"><span class="linenos">217</span></a>        <span class="p">}</span>
</span><span id="CLAccuracy-218"><a href="#CLAccuracy-218"><span class="linenos">218</span></a>
</span><span id="CLAccuracy-219"><a href="#CLAccuracy-219"><span class="linenos">219</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLAccuracy-220"><a href="#CLAccuracy-220"><span class="linenos">220</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_batch_end</span><span class="p">(</span>
</span><span id="CLAccuracy-221"><a href="#CLAccuracy-221"><span class="linenos">221</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLAccuracy-222"><a href="#CLAccuracy-222"><span class="linenos">222</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLAccuracy-223"><a href="#CLAccuracy-223"><span class="linenos">223</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLAccuracy-224"><a href="#CLAccuracy-224"><span class="linenos">224</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="CLAccuracy-225"><a href="#CLAccuracy-225"><span class="linenos">225</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="CLAccuracy-226"><a href="#CLAccuracy-226"><span class="linenos">226</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CLAccuracy-227"><a href="#CLAccuracy-227"><span class="linenos">227</span></a>        <span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="CLAccuracy-228"><a href="#CLAccuracy-228"><span class="linenos">228</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy-229"><a href="#CLAccuracy-229"><span class="linenos">229</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from test batch. We don&#39;t need to log and monitor the metrics of test batches.</span>
</span><span id="CLAccuracy-230"><a href="#CLAccuracy-230"><span class="linenos">230</span></a>
</span><span id="CLAccuracy-231"><a href="#CLAccuracy-231"><span class="linenos">231</span></a><span class="sd">        **Args:**</span>
</span><span id="CLAccuracy-232"><a href="#CLAccuracy-232"><span class="linenos">232</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the test step, which is the returns of the `test_step()` method in the `CLAlgorithm`.</span>
</span><span id="CLAccuracy-233"><a href="#CLAccuracy-233"><span class="linenos">233</span></a><span class="sd">        - **batch** (`Any`): the test data batch.</span>
</span><span id="CLAccuracy-234"><a href="#CLAccuracy-234"><span class="linenos">234</span></a><span class="sd">        - **dataloader_idx** (`int`): the task ID of seen tasks to be tested. A default value of 0 is given otherwise the LightningModule will raise a `RuntimeError`.</span>
</span><span id="CLAccuracy-235"><a href="#CLAccuracy-235"><span class="linenos">235</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLAccuracy-236"><a href="#CLAccuracy-236"><span class="linenos">236</span></a>
</span><span id="CLAccuracy-237"><a href="#CLAccuracy-237"><span class="linenos">237</span></a>        <span class="c1"># get the batch size</span>
</span><span id="CLAccuracy-238"><a href="#CLAccuracy-238"><span class="linenos">238</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="CLAccuracy-239"><a href="#CLAccuracy-239"><span class="linenos">239</span></a>
</span><span id="CLAccuracy-240"><a href="#CLAccuracy-240"><span class="linenos">240</span></a>        <span class="n">test_task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">get_test_task_id_from_dataloader_idx</span><span class="p">(</span><span class="n">dataloader_idx</span><span class="p">)</span>
</span><span id="CLAccuracy-241"><a href="#CLAccuracy-241"><span class="linenos">241</span></a>
</span><span id="CLAccuracy-242"><a href="#CLAccuracy-242"><span class="linenos">242</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="CLAccuracy-243"><a href="#CLAccuracy-243"><span class="linenos">243</span></a>        <span class="n">acc_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
</span><span id="CLAccuracy-244"><a href="#CLAccuracy-244"><span class="linenos">244</span></a>
</span><span id="CLAccuracy-245"><a href="#CLAccuracy-245"><span class="linenos">245</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the metrics of the epoch</span>
</span><span id="CLAccuracy-246"><a href="#CLAccuracy-246"><span class="linenos">246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="p">[</span><span class="n">test_task_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="CLAccuracy-247"><a href="#CLAccuracy-247"><span class="linenos">247</span></a>
</span><span id="CLAccuracy-248"><a href="#CLAccuracy-248"><span class="linenos">248</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLAccuracy-249"><a href="#CLAccuracy-249"><span class="linenos">249</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_epoch_end</span><span class="p">(</span>
</span><span id="CLAccuracy-250"><a href="#CLAccuracy-250"><span class="linenos">250</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLAccuracy-251"><a href="#CLAccuracy-251"><span class="linenos">251</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLAccuracy-252"><a href="#CLAccuracy-252"><span class="linenos">252</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLAccuracy-253"><a href="#CLAccuracy-253"><span class="linenos">253</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy-254"><a href="#CLAccuracy-254"><span class="linenos">254</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save and plot test metrics at the end of test.&quot;&quot;&quot;</span>
</span><span id="CLAccuracy-255"><a href="#CLAccuracy-255"><span class="linenos">255</span></a>
</span><span id="CLAccuracy-256"><a href="#CLAccuracy-256"><span class="linenos">256</span></a>        <span class="c1"># save (update) the test metrics to CSV files</span>
</span><span id="CLAccuracy-257"><a href="#CLAccuracy-257"><span class="linenos">257</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_test_acc_to_csv</span><span class="p">(</span>
</span><span id="CLAccuracy-258"><a href="#CLAccuracy-258"><span class="linenos">258</span></a>            <span class="n">after_training_task_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
</span><span id="CLAccuracy-259"><a href="#CLAccuracy-259"><span class="linenos">259</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_acc_csv_path</span><span class="p">,</span>
</span><span id="CLAccuracy-260"><a href="#CLAccuracy-260"><span class="linenos">260</span></a>        <span class="p">)</span>
</span><span id="CLAccuracy-261"><a href="#CLAccuracy-261"><span class="linenos">261</span></a>
</span><span id="CLAccuracy-262"><a href="#CLAccuracy-262"><span class="linenos">262</span></a>        <span class="c1"># plot the test metrics</span>
</span><span id="CLAccuracy-263"><a href="#CLAccuracy-263"><span class="linenos">263</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_acc_matrix_plot_path</span><span class="p">:</span>
</span><span id="CLAccuracy-264"><a href="#CLAccuracy-264"><span class="linenos">264</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plot_test_acc_matrix_from_csv</span><span class="p">(</span>
</span><span id="CLAccuracy-265"><a href="#CLAccuracy-265"><span class="linenos">265</span></a>                <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_acc_csv_path</span><span class="p">,</span>
</span><span id="CLAccuracy-266"><a href="#CLAccuracy-266"><span class="linenos">266</span></a>                <span class="n">plot_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_acc_matrix_plot_path</span><span class="p">,</span>
</span><span id="CLAccuracy-267"><a href="#CLAccuracy-267"><span class="linenos">267</span></a>            <span class="p">)</span>
</span><span id="CLAccuracy-268"><a href="#CLAccuracy-268"><span class="linenos">268</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_ave_acc_plot_path</span><span class="p">:</span>
</span><span id="CLAccuracy-269"><a href="#CLAccuracy-269"><span class="linenos">269</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plot_test_ave_acc_curve_from_csv</span><span class="p">(</span>
</span><span id="CLAccuracy-270"><a href="#CLAccuracy-270"><span class="linenos">270</span></a>                <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_acc_csv_path</span><span class="p">,</span>
</span><span id="CLAccuracy-271"><a href="#CLAccuracy-271"><span class="linenos">271</span></a>                <span class="n">plot_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_ave_acc_plot_path</span><span class="p">,</span>
</span><span id="CLAccuracy-272"><a href="#CLAccuracy-272"><span class="linenos">272</span></a>            <span class="p">)</span>
</span><span id="CLAccuracy-273"><a href="#CLAccuracy-273"><span class="linenos">273</span></a>
</span><span id="CLAccuracy-274"><a href="#CLAccuracy-274"><span class="linenos">274</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_test_acc_to_csv</span><span class="p">(</span>
</span><span id="CLAccuracy-275"><a href="#CLAccuracy-275"><span class="linenos">275</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLAccuracy-276"><a href="#CLAccuracy-276"><span class="linenos">276</span></a>        <span class="n">after_training_task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CLAccuracy-277"><a href="#CLAccuracy-277"><span class="linenos">277</span></a>        <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CLAccuracy-278"><a href="#CLAccuracy-278"><span class="linenos">278</span></a>        <span class="n">skipped_task_ids_for_ave</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CLAccuracy-279"><a href="#CLAccuracy-279"><span class="linenos">279</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy-280"><a href="#CLAccuracy-280"><span class="linenos">280</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Update the test accuracy metrics of seen tasks at the last line to an existing CSV file. A new file will be created if not existing.</span>
</span><span id="CLAccuracy-281"><a href="#CLAccuracy-281"><span class="linenos">281</span></a>
</span><span id="CLAccuracy-282"><a href="#CLAccuracy-282"><span class="linenos">282</span></a><span class="sd">        **Args:**</span>
</span><span id="CLAccuracy-283"><a href="#CLAccuracy-283"><span class="linenos">283</span></a><span class="sd">        - **after_training_task_id** (`int`): the task ID after training.</span>
</span><span id="CLAccuracy-284"><a href="#CLAccuracy-284"><span class="linenos">284</span></a><span class="sd">        - **csv_path** (`str`): save the test metric to path. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/acc.csv&#39;.</span>
</span><span id="CLAccuracy-285"><a href="#CLAccuracy-285"><span class="linenos">285</span></a><span class="sd">        - **skipped_task_ids_for_ave** (`list[int]` | `None`): the task IDs that are skipped to calculate average accuracy. If `None`, no task is skipped. Default: `None`.</span>
</span><span id="CLAccuracy-286"><a href="#CLAccuracy-286"><span class="linenos">286</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLAccuracy-287"><a href="#CLAccuracy-287"><span class="linenos">287</span></a>        <span class="n">processed_task_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="CLAccuracy-288"><a href="#CLAccuracy-288"><span class="linenos">288</span></a>        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;after_training_task&quot;</span><span class="p">,</span> <span class="s2">&quot;average_accuracy&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="CLAccuracy-289"><a href="#CLAccuracy-289"><span class="linenos">289</span></a>            <span class="sa">f</span><span class="s2">&quot;test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">processed_task_ids</span>
</span><span id="CLAccuracy-290"><a href="#CLAccuracy-290"><span class="linenos">290</span></a>        <span class="p">]</span>
</span><span id="CLAccuracy-291"><a href="#CLAccuracy-291"><span class="linenos">291</span></a>
</span><span id="CLAccuracy-292"><a href="#CLAccuracy-292"><span class="linenos">292</span></a>        <span class="n">new_line</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="CLAccuracy-293"><a href="#CLAccuracy-293"><span class="linenos">293</span></a>            <span class="s2">&quot;after_training_task&quot;</span><span class="p">:</span> <span class="n">after_training_task_id</span>
</span><span id="CLAccuracy-294"><a href="#CLAccuracy-294"><span class="linenos">294</span></a>        <span class="p">}</span>  <span class="c1"># construct the first column</span>
</span><span id="CLAccuracy-295"><a href="#CLAccuracy-295"><span class="linenos">295</span></a>
</span><span id="CLAccuracy-296"><a href="#CLAccuracy-296"><span class="linenos">296</span></a>        <span class="c1"># construct the columns and calculate the average accuracy over tasks at the same time</span>
</span><span id="CLAccuracy-297"><a href="#CLAccuracy-297"><span class="linenos">297</span></a>        <span class="n">average_accuracy_over_tasks</span> <span class="o">=</span> <span class="n">MeanMetric</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
</span><span id="CLAccuracy-298"><a href="#CLAccuracy-298"><span class="linenos">298</span></a>            <span class="n">device</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">device</span>
</span><span id="CLAccuracy-299"><a href="#CLAccuracy-299"><span class="linenos">299</span></a>        <span class="p">)</span>
</span><span id="CLAccuracy-300"><a href="#CLAccuracy-300"><span class="linenos">300</span></a>        <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">processed_task_ids</span><span class="p">:</span>
</span><span id="CLAccuracy-301"><a href="#CLAccuracy-301"><span class="linenos">301</span></a>            <span class="n">acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="CLAccuracy-302"><a href="#CLAccuracy-302"><span class="linenos">302</span></a>            <span class="n">new_line</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc</span>
</span><span id="CLAccuracy-303"><a href="#CLAccuracy-303"><span class="linenos">303</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="CLAccuracy-304"><a href="#CLAccuracy-304"><span class="linenos">304</span></a>                <span class="n">skipped_task_ids_for_ave</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="CLAccuracy-305"><a href="#CLAccuracy-305"><span class="linenos">305</span></a>                <span class="ow">or</span> <span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skipped_task_ids_for_ave</span>
</span><span id="CLAccuracy-306"><a href="#CLAccuracy-306"><span class="linenos">306</span></a>            <span class="p">):</span>
</span><span id="CLAccuracy-307"><a href="#CLAccuracy-307"><span class="linenos">307</span></a>                <span class="n">average_accuracy_over_tasks</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
</span><span id="CLAccuracy-308"><a href="#CLAccuracy-308"><span class="linenos">308</span></a>        <span class="n">new_line</span><span class="p">[</span><span class="s2">&quot;average_accuracy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">average_accuracy_over_tasks</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="CLAccuracy-309"><a href="#CLAccuracy-309"><span class="linenos">309</span></a>
</span><span id="CLAccuracy-310"><a href="#CLAccuracy-310"><span class="linenos">310</span></a>        <span class="c1"># write to the csv file</span>
</span><span id="CLAccuracy-311"><a href="#CLAccuracy-311"><span class="linenos">311</span></a>        <span class="n">is_first</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CLAccuracy-312"><a href="#CLAccuracy-312"><span class="linenos">312</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
</span><span id="CLAccuracy-313"><a href="#CLAccuracy-313"><span class="linenos">313</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CLAccuracy-314"><a href="#CLAccuracy-314"><span class="linenos">314</span></a>                <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span id="CLAccuracy-315"><a href="#CLAccuracy-315"><span class="linenos">315</span></a>                <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CLAccuracy-316"><a href="#CLAccuracy-316"><span class="linenos">316</span></a>        <span class="c1"># write header</span>
</span><span id="CLAccuracy-317"><a href="#CLAccuracy-317"><span class="linenos">317</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CLAccuracy-318"><a href="#CLAccuracy-318"><span class="linenos">318</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="CLAccuracy-319"><a href="#CLAccuracy-319"><span class="linenos">319</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="CLAccuracy-320"><a href="#CLAccuracy-320"><span class="linenos">320</span></a>        <span class="c1"># write metrics</span>
</span><span id="CLAccuracy-321"><a href="#CLAccuracy-321"><span class="linenos">321</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CLAccuracy-322"><a href="#CLAccuracy-322"><span class="linenos">322</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
</span><span id="CLAccuracy-323"><a href="#CLAccuracy-323"><span class="linenos">323</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>  <span class="c1"># write the previous lines</span>
</span><span id="CLAccuracy-324"><a href="#CLAccuracy-324"><span class="linenos">324</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="CLAccuracy-325"><a href="#CLAccuracy-325"><span class="linenos">325</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
</span><span id="CLAccuracy-326"><a href="#CLAccuracy-326"><span class="linenos">326</span></a>
</span><span id="CLAccuracy-327"><a href="#CLAccuracy-327"><span class="linenos">327</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_test_acc_matrix_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy-328"><a href="#CLAccuracy-328"><span class="linenos">328</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the test accuracy matrix from saved CSV file and save the plot to the designated directory.</span>
</span><span id="CLAccuracy-329"><a href="#CLAccuracy-329"><span class="linenos">329</span></a>
</span><span id="CLAccuracy-330"><a href="#CLAccuracy-330"><span class="linenos">330</span></a><span class="sd">        **Args:**</span>
</span><span id="CLAccuracy-331"><a href="#CLAccuracy-331"><span class="linenos">331</span></a><span class="sd">        - **csv_path** (`str`): the path to the CSV file where the `utils.update_test_acc_to_csv()` saved the test accuracy metric.</span>
</span><span id="CLAccuracy-332"><a href="#CLAccuracy-332"><span class="linenos">332</span></a><span class="sd">        - **plot_path** (`str`): the path to save plot. Better same as the output directory of the experiment. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/acc_matrix.png&#39;.</span>
</span><span id="CLAccuracy-333"><a href="#CLAccuracy-333"><span class="linenos">333</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLAccuracy-334"><a href="#CLAccuracy-334"><span class="linenos">334</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CLAccuracy-335"><a href="#CLAccuracy-335"><span class="linenos">335</span></a>        <span class="n">processed_task_ids</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="CLAccuracy-336"><a href="#CLAccuracy-336"><span class="linenos">336</span></a>            <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;test_on_task_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</span><span id="CLAccuracy-337"><a href="#CLAccuracy-337"><span class="linenos">337</span></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="CLAccuracy-338"><a href="#CLAccuracy-338"><span class="linenos">338</span></a>            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;test_on_task_&quot;</span><span class="p">)</span>
</span><span id="CLAccuracy-339"><a href="#CLAccuracy-339"><span class="linenos">339</span></a>        <span class="p">]</span>
</span><span id="CLAccuracy-340"><a href="#CLAccuracy-340"><span class="linenos">340</span></a>
</span><span id="CLAccuracy-341"><a href="#CLAccuracy-341"><span class="linenos">341</span></a>        <span class="c1"># Get all columns that start with &quot;test_on_task_&quot;</span>
</span><span id="CLAccuracy-342"><a href="#CLAccuracy-342"><span class="linenos">342</span></a>        <span class="n">test_task_cols</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="CLAccuracy-343"><a href="#CLAccuracy-343"><span class="linenos">343</span></a>            <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;test_on_task_&quot;</span><span class="p">)</span>
</span><span id="CLAccuracy-344"><a href="#CLAccuracy-344"><span class="linenos">344</span></a>        <span class="p">]</span>
</span><span id="CLAccuracy-345"><a href="#CLAccuracy-345"><span class="linenos">345</span></a>        <span class="n">num_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_task_ids</span><span class="p">)</span>
</span><span id="CLAccuracy-346"><a href="#CLAccuracy-346"><span class="linenos">346</span></a>        <span class="n">num_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="CLAccuracy-347"><a href="#CLAccuracy-347"><span class="linenos">347</span></a>
</span><span id="CLAccuracy-348"><a href="#CLAccuracy-348"><span class="linenos">348</span></a>        <span class="c1"># Build the accuracy matrix</span>
</span><span id="CLAccuracy-349"><a href="#CLAccuracy-349"><span class="linenos">349</span></a>        <span class="n">acc_matrix</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">test_task_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="CLAccuracy-350"><a href="#CLAccuracy-350"><span class="linenos">350</span></a>
</span><span id="CLAccuracy-351"><a href="#CLAccuracy-351"><span class="linenos">351</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="CLAccuracy-352"><a href="#CLAccuracy-352"><span class="linenos">352</span></a>            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num_tasks</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_rows</span><span class="p">)</span>
</span><span id="CLAccuracy-353"><a href="#CLAccuracy-353"><span class="linenos">353</span></a>        <span class="p">)</span>  <span class="c1"># adaptive figure size</span>
</span><span id="CLAccuracy-354"><a href="#CLAccuracy-354"><span class="linenos">354</span></a>
</span><span id="CLAccuracy-355"><a href="#CLAccuracy-355"><span class="linenos">355</span></a>        <span class="n">cax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
</span><span id="CLAccuracy-356"><a href="#CLAccuracy-356"><span class="linenos">356</span></a>            <span class="n">acc_matrix</span><span class="p">,</span>
</span><span id="CLAccuracy-357"><a href="#CLAccuracy-357"><span class="linenos">357</span></a>            <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy-358"><a href="#CLAccuracy-358"><span class="linenos">358</span></a>            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greens&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy-359"><a href="#CLAccuracy-359"><span class="linenos">359</span></a>            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="CLAccuracy-360"><a href="#CLAccuracy-360"><span class="linenos">360</span></a>            <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="CLAccuracy-361"><a href="#CLAccuracy-361"><span class="linenos">361</span></a>            <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy-362"><a href="#CLAccuracy-362"><span class="linenos">362</span></a>        <span class="p">)</span>
</span><span id="CLAccuracy-363"><a href="#CLAccuracy-363"><span class="linenos">363</span></a>
</span><span id="CLAccuracy-364"><a href="#CLAccuracy-364"><span class="linenos">364</span></a>        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cax</span><span class="p">)</span>
</span><span id="CLAccuracy-365"><a href="#CLAccuracy-365"><span class="linenos">365</span></a>        <span class="n">yticks</span> <span class="o">=</span> <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()</span>
</span><span id="CLAccuracy-366"><a href="#CLAccuracy-366"><span class="linenos">366</span></a>        <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
</span><span id="CLAccuracy-367"><a href="#CLAccuracy-367"><span class="linenos">367</span></a>        <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="CLAccuracy-368"><a href="#CLAccuracy-368"><span class="linenos">368</span></a>            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">yticks</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CLAccuracy-369"><a href="#CLAccuracy-369"><span class="linenos">369</span></a>        <span class="p">)</span>
</span><span id="CLAccuracy-370"><a href="#CLAccuracy-370"><span class="linenos">370</span></a>
</span><span id="CLAccuracy-371"><a href="#CLAccuracy-371"><span class="linenos">371</span></a>        <span class="c1"># Annotate each cell</span>
</span><span id="CLAccuracy-372"><a href="#CLAccuracy-372"><span class="linenos">372</span></a>        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_rows</span><span class="p">):</span>
</span><span id="CLAccuracy-373"><a href="#CLAccuracy-373"><span class="linenos">373</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="CLAccuracy-374"><a href="#CLAccuracy-374"><span class="linenos">374</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="CLAccuracy-375"><a href="#CLAccuracy-375"><span class="linenos">375</span></a>                    <span class="n">c</span><span class="p">,</span>
</span><span id="CLAccuracy-376"><a href="#CLAccuracy-376"><span class="linenos">376</span></a>                    <span class="n">r</span><span class="p">,</span>
</span><span id="CLAccuracy-377"><a href="#CLAccuracy-377"><span class="linenos">377</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">acc_matrix</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy-378"><a href="#CLAccuracy-378"><span class="linenos">378</span></a>                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy-379"><a href="#CLAccuracy-379"><span class="linenos">379</span></a>                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy-380"><a href="#CLAccuracy-380"><span class="linenos">380</span></a>                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy-381"><a href="#CLAccuracy-381"><span class="linenos">381</span></a>                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">,</span>
</span><span id="CLAccuracy-382"><a href="#CLAccuracy-382"><span class="linenos">382</span></a>                <span class="p">)</span>
</span><span id="CLAccuracy-383"><a href="#CLAccuracy-383"><span class="linenos">383</span></a>
</span><span id="CLAccuracy-384"><a href="#CLAccuracy-384"><span class="linenos">384</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">))</span>
</span><span id="CLAccuracy-385"><a href="#CLAccuracy-385"><span class="linenos">385</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_rows</span><span class="p">))</span>
</span><span id="CLAccuracy-386"><a href="#CLAccuracy-386"><span class="linenos">386</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">processed_task_ids</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">)</span>
</span><span id="CLAccuracy-387"><a href="#CLAccuracy-387"><span class="linenos">387</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="CLAccuracy-388"><a href="#CLAccuracy-388"><span class="linenos">388</span></a>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;after_training_task&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CLAccuracy-389"><a href="#CLAccuracy-389"><span class="linenos">389</span></a>        <span class="p">)</span>
</span><span id="CLAccuracy-390"><a href="#CLAccuracy-390"><span class="linenos">390</span></a>
</span><span id="CLAccuracy-391"><a href="#CLAccuracy-391"><span class="linenos">391</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Testing on task &quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">)</span>
</span><span id="CLAccuracy-392"><a href="#CLAccuracy-392"><span class="linenos">392</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;After training task t&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">)</span>
</span><span id="CLAccuracy-393"><a href="#CLAccuracy-393"><span class="linenos">393</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CLAccuracy-394"><a href="#CLAccuracy-394"><span class="linenos">394</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="CLAccuracy-395"><a href="#CLAccuracy-395"><span class="linenos">395</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span><span id="CLAccuracy-396"><a href="#CLAccuracy-396"><span class="linenos">396</span></a>
</span><span id="CLAccuracy-397"><a href="#CLAccuracy-397"><span class="linenos">397</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_test_ave_acc_curve_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy-398"><a href="#CLAccuracy-398"><span class="linenos">398</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the test average accuracy curve over different training tasks from saved CSV file and save the plot to the designated directory.</span>
</span><span id="CLAccuracy-399"><a href="#CLAccuracy-399"><span class="linenos">399</span></a>
</span><span id="CLAccuracy-400"><a href="#CLAccuracy-400"><span class="linenos">400</span></a><span class="sd">        **Args:**</span>
</span><span id="CLAccuracy-401"><a href="#CLAccuracy-401"><span class="linenos">401</span></a><span class="sd">        - **csv_path** (`str`): the path to the CSV file where the `utils.update_test_acc_to_csv()` saved the test accuracy metric.</span>
</span><span id="CLAccuracy-402"><a href="#CLAccuracy-402"><span class="linenos">402</span></a><span class="sd">        - **plot_path** (`str`): the path to save plot. Better same as the output directory of the experiment. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/ave_acc.png&#39;.</span>
</span><span id="CLAccuracy-403"><a href="#CLAccuracy-403"><span class="linenos">403</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLAccuracy-404"><a href="#CLAccuracy-404"><span class="linenos">404</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CLAccuracy-405"><a href="#CLAccuracy-405"><span class="linenos">405</span></a>        <span class="n">after_training_tasks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;after_training_task&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="CLAccuracy-406"><a href="#CLAccuracy-406"><span class="linenos">406</span></a>
</span><span id="CLAccuracy-407"><a href="#CLAccuracy-407"><span class="linenos">407</span></a>        <span class="c1"># plot the average accuracy curve over different training tasks</span>
</span><span id="CLAccuracy-408"><a href="#CLAccuracy-408"><span class="linenos">408</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
</span><span id="CLAccuracy-409"><a href="#CLAccuracy-409"><span class="linenos">409</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="CLAccuracy-410"><a href="#CLAccuracy-410"><span class="linenos">410</span></a>            <span class="n">after_training_tasks</span><span class="p">,</span>
</span><span id="CLAccuracy-411"><a href="#CLAccuracy-411"><span class="linenos">411</span></a>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;average_accuracy&quot;</span><span class="p">],</span>
</span><span id="CLAccuracy-412"><a href="#CLAccuracy-412"><span class="linenos">412</span></a>            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy-413"><a href="#CLAccuracy-413"><span class="linenos">413</span></a>            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="CLAccuracy-414"><a href="#CLAccuracy-414"><span class="linenos">414</span></a>        <span class="p">)</span>
</span><span id="CLAccuracy-415"><a href="#CLAccuracy-415"><span class="linenos">415</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;After training task $t$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="CLAccuracy-416"><a href="#CLAccuracy-416"><span class="linenos">416</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Average Accuracy (AA)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="CLAccuracy-417"><a href="#CLAccuracy-417"><span class="linenos">417</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="CLAccuracy-418"><a href="#CLAccuracy-418"><span class="linenos">418</span></a>        <span class="n">xticks</span> <span class="o">=</span> <span class="n">after_training_tasks</span>
</span><span id="CLAccuracy-419"><a href="#CLAccuracy-419"><span class="linenos">419</span></a>        <span class="n">yticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mf">0.05</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">)]</span>
</span><span id="CLAccuracy-420"><a href="#CLAccuracy-420"><span class="linenos">420</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
</span><span id="CLAccuracy-421"><a href="#CLAccuracy-421"><span class="linenos">421</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
</span><span id="CLAccuracy-422"><a href="#CLAccuracy-422"><span class="linenos">422</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="CLAccuracy-423"><a href="#CLAccuracy-423"><span class="linenos">423</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">yticks</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="CLAccuracy-424"><a href="#CLAccuracy-424"><span class="linenos">424</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="CLAccuracy-425"><a href="#CLAccuracy-425"><span class="linenos">425</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Provides all actions that are related to CL accuracy metric, which include:</p>

<ul>
<li>Defining, initializing and recording accuracy metric.</li>
<li>Logging training and validation accuracy metric to Lightning loggers in real time.</li>
<li>Saving test accuracy metric to files.</li>
<li>Visualizing test accuracy metric as plots.</li>
</ul>

<p>The callback is able to produce the following outputs:</p>

<ul>
<li>CSV files for test accuracy (lower triangular) matrix and average accuracy. See <a href="https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-test-performance-of-previous-tasks">here</a> for details.</li>
<li>Coloured plot for test accuracy (lower triangular) matrix. See <a href="https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-test-performance-of-previous-tasks">here</a> for details.</li>
<li>Curve plots for test average accuracy over different training tasks. See <a href="https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-average-test-performance-over-tasks">here</a> for details.</li>
</ul>

<p>Please refer to the <a href="https://pengxiang-wang.com/posts/continual-learning-metrics">A Summary of Continual Learning Metrics</a> to learn about this metric.</p>
</div>


                            <div id="CLAccuracy.__init__" class="classattr">
                                        <input id="CLAccuracy.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">CLAccuracy</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">test_acc_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;acc.csv&#39;</span>,</span><span class="param">	<span class="n">test_acc_matrix_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">test_ave_acc_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="CLAccuracy.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLAccuracy.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLAccuracy.__init__-44"><a href="#CLAccuracy.__init__-44"><span class="linenos">44</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="CLAccuracy.__init__-45"><a href="#CLAccuracy.__init__-45"><span class="linenos">45</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLAccuracy.__init__-46"><a href="#CLAccuracy.__init__-46"><span class="linenos">46</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CLAccuracy.__init__-47"><a href="#CLAccuracy.__init__-47"><span class="linenos">47</span></a>        <span class="n">test_acc_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;acc.csv&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy.__init__-48"><a href="#CLAccuracy.__init__-48"><span class="linenos">48</span></a>        <span class="n">test_acc_matrix_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CLAccuracy.__init__-49"><a href="#CLAccuracy.__init__-49"><span class="linenos">49</span></a>        <span class="n">test_ave_acc_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CLAccuracy.__init__-50"><a href="#CLAccuracy.__init__-50"><span class="linenos">50</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy.__init__-51"><a href="#CLAccuracy.__init__-51"><span class="linenos">51</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `CLAccuracy`.</span>
</span><span id="CLAccuracy.__init__-52"><a href="#CLAccuracy.__init__-52"><span class="linenos">52</span></a>
</span><span id="CLAccuracy.__init__-53"><a href="#CLAccuracy.__init__-53"><span class="linenos">53</span></a><span class="sd">        **Args:**</span>
</span><span id="CLAccuracy.__init__-54"><a href="#CLAccuracy.__init__-54"><span class="linenos">54</span></a><span class="sd">        - **save_dir** (`str`): The directory where data and figures of metrics will be saved. Better inside the output folder.</span>
</span><span id="CLAccuracy.__init__-55"><a href="#CLAccuracy.__init__-55"><span class="linenos">55</span></a><span class="sd">        - **test_acc_csv_name** (`str`): file name to save test accuracy matrix and average accuracy as CSV file.</span>
</span><span id="CLAccuracy.__init__-56"><a href="#CLAccuracy.__init__-56"><span class="linenos">56</span></a><span class="sd">        - **test_acc_matrix_plot_name** (`str` | `None`): file name to save accuracy matrix plot. If `None`, no file will be saved.</span>
</span><span id="CLAccuracy.__init__-57"><a href="#CLAccuracy.__init__-57"><span class="linenos">57</span></a><span class="sd">        - **test_ave_acc_plot_name** (`str` | `None`): file name to save average accuracy as curve plot over different training tasks. If `None`, no file will be saved.</span>
</span><span id="CLAccuracy.__init__-58"><a href="#CLAccuracy.__init__-58"><span class="linenos">58</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLAccuracy.__init__-59"><a href="#CLAccuracy.__init__-59"><span class="linenos">59</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="CLAccuracy.__init__-60"><a href="#CLAccuracy.__init__-60"><span class="linenos">60</span></a>
</span><span id="CLAccuracy.__init__-61"><a href="#CLAccuracy.__init__-61"><span class="linenos">61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_acc_csv_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">test_acc_csv_name</span><span class="p">)</span>
</span><span id="CLAccuracy.__init__-62"><a href="#CLAccuracy.__init__-62"><span class="linenos">62</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The path to save test accuracy matrix and average accuracy CSV file.&quot;&quot;&quot;</span>
</span><span id="CLAccuracy.__init__-63"><a href="#CLAccuracy.__init__-63"><span class="linenos">63</span></a>        <span class="k">if</span> <span class="n">test_acc_matrix_plot_name</span><span class="p">:</span>
</span><span id="CLAccuracy.__init__-64"><a href="#CLAccuracy.__init__-64"><span class="linenos">64</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_acc_matrix_plot_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="CLAccuracy.__init__-65"><a href="#CLAccuracy.__init__-65"><span class="linenos">65</span></a>                <span class="n">save_dir</span><span class="p">,</span> <span class="n">test_acc_matrix_plot_name</span>
</span><span id="CLAccuracy.__init__-66"><a href="#CLAccuracy.__init__-66"><span class="linenos">66</span></a>            <span class="p">)</span>
</span><span id="CLAccuracy.__init__-67"><a href="#CLAccuracy.__init__-67"><span class="linenos">67</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The path to save test accuracy matrix plot.&quot;&quot;&quot;</span>
</span><span id="CLAccuracy.__init__-68"><a href="#CLAccuracy.__init__-68"><span class="linenos">68</span></a>        <span class="k">if</span> <span class="n">test_ave_acc_plot_name</span><span class="p">:</span>
</span><span id="CLAccuracy.__init__-69"><a href="#CLAccuracy.__init__-69"><span class="linenos">69</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_ave_acc_plot_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="CLAccuracy.__init__-70"><a href="#CLAccuracy.__init__-70"><span class="linenos">70</span></a>                <span class="n">save_dir</span><span class="p">,</span> <span class="n">test_ave_acc_plot_name</span>
</span><span id="CLAccuracy.__init__-71"><a href="#CLAccuracy.__init__-71"><span class="linenos">71</span></a>            <span class="p">)</span>
</span><span id="CLAccuracy.__init__-72"><a href="#CLAccuracy.__init__-72"><span class="linenos">72</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The path to save test average accuracy curve plot.&quot;&quot;&quot;</span>
</span><span id="CLAccuracy.__init__-73"><a href="#CLAccuracy.__init__-73"><span class="linenos">73</span></a>
</span><span id="CLAccuracy.__init__-74"><a href="#CLAccuracy.__init__-74"><span class="linenos">74</span></a>        <span class="c1"># training accumulated metrics</span>
</span><span id="CLAccuracy.__init__-75"><a href="#CLAccuracy.__init__-75"><span class="linenos">75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="CLAccuracy.__init__-76"><a href="#CLAccuracy.__init__-76"><span class="linenos">76</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Classification accuracy of training epoch. Accumulated and calculated from the training batches. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-performance-of-training-epoch) for details. &quot;&quot;&quot;</span>
</span><span id="CLAccuracy.__init__-77"><a href="#CLAccuracy.__init__-77"><span class="linenos">77</span></a>
</span><span id="CLAccuracy.__init__-78"><a href="#CLAccuracy.__init__-78"><span class="linenos">78</span></a>        <span class="c1"># validation accumulated metrics</span>
</span><span id="CLAccuracy.__init__-79"><a href="#CLAccuracy.__init__-79"><span class="linenos">79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="CLAccuracy.__init__-80"><a href="#CLAccuracy.__init__-80"><span class="linenos">80</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Validation classification accuracy of the model after training epoch. Accumulated and calculated from the validation batches. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-validation-performace) for details. &quot;&quot;&quot;</span>
</span><span id="CLAccuracy.__init__-81"><a href="#CLAccuracy.__init__-81"><span class="linenos">81</span></a>
</span><span id="CLAccuracy.__init__-82"><a href="#CLAccuracy.__init__-82"><span class="linenos">82</span></a>        <span class="c1"># test accumulated metrics</span>
</span><span id="CLAccuracy.__init__-83"><a href="#CLAccuracy.__init__-83"><span class="linenos">83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">]</span>
</span><span id="CLAccuracy.__init__-84"><a href="#CLAccuracy.__init__-84"><span class="linenos">84</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Test classification accuracy of the current model (`self.task_id`) on current and previous tasks. Accumulated and calculated from the test batches. Keys are task IDs and values are the corresponding metrics. It is the last row of the lower triangular matrix. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-test-performance-of-previous-tasks) for details. &quot;&quot;&quot;</span>
</span><span id="CLAccuracy.__init__-85"><a href="#CLAccuracy.__init__-85"><span class="linenos">85</span></a>
</span><span id="CLAccuracy.__init__-86"><a href="#CLAccuracy.__init__-86"><span class="linenos">86</span></a>        <span class="c1"># task ID controls</span>
</span><span id="CLAccuracy.__init__-87"><a href="#CLAccuracy.__init__-87"><span class="linenos">87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="CLAccuracy.__init__-88"><a href="#CLAccuracy.__init__-88"><span class="linenos">88</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Task ID counter indicating which task is being processed. Self updated during the task loop. Valid from 1 to `cl_dataset.num_tasks`.&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the <code><a href="#CLAccuracy">CLAccuracy</a></code>.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>save_dir</strong> (<code>str</code>): The directory where data and figures of metrics will be saved. Better inside the output folder.</li>
<li><strong>test_acc_csv_name</strong> (<code>str</code>): file name to save test accuracy matrix and average accuracy as CSV file.</li>
<li><strong>test_acc_matrix_plot_name</strong> (<code>str</code> | <code>None</code>): file name to save accuracy matrix plot. If <code>None</code>, no file will be saved.</li>
<li><strong>test_ave_acc_plot_name</strong> (<code>str</code> | <code>None</code>): file name to save average accuracy as curve plot over different training tasks. If <code>None</code>, no file will be saved.</li>
</ul>
</div>


                            </div>
                            <div id="CLAccuracy.test_acc_csv_path" class="classattr">
                                <div class="attr variable">
            <span class="name">test_acc_csv_path</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#CLAccuracy.test_acc_csv_path"></a>
    
            <div class="docstring"><p>The path to save test accuracy matrix and average accuracy CSV file.</p>
</div>


                            </div>
                            <div id="CLAccuracy.acc_training_epoch" class="classattr">
                                <div class="attr variable">
            <span class="name">acc_training_epoch</span><span class="annotation">: <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a></span>

        
    </div>
    <a class="headerlink" href="#CLAccuracy.acc_training_epoch"></a>
    
            <div class="docstring"><p>Classification accuracy of training epoch. Accumulated and calculated from the training batches. See <a href="https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-performance-of-training-epoch">here</a> for details.</p>
</div>


                            </div>
                            <div id="CLAccuracy.acc_val" class="classattr">
                                <div class="attr variable">
            <span class="name">acc_val</span><span class="annotation">: <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a></span>

        
    </div>
    <a class="headerlink" href="#CLAccuracy.acc_val"></a>
    
            <div class="docstring"><p>Validation classification accuracy of the model after training epoch. Accumulated and calculated from the validation batches. See <a href="https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-validation-performace">here</a> for details.</p>
</div>


                            </div>
                            <div id="CLAccuracy.acc_test" class="classattr">
                                <div class="attr variable">
            <span class="name">acc_test</span><span class="annotation">: dict[int, <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a>]</span>

        
    </div>
    <a class="headerlink" href="#CLAccuracy.acc_test"></a>
    
            <div class="docstring"><p>Test classification accuracy of the current model (<code>self.task_id</code>) on current and previous tasks. Accumulated and calculated from the test batches. Keys are task IDs and values are the corresponding metrics. It is the last row of the lower triangular matrix. See <a href="https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-test-performance-of-previous-tasks">here</a> for details.</p>
</div>


                            </div>
                            <div id="CLAccuracy.task_id" class="classattr">
                                <div class="attr variable">
            <span class="name">task_id</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#CLAccuracy.task_id"></a>
    
            <div class="docstring"><p>Task ID counter indicating which task is being processed. Self updated during the task loop. Valid from 1 to <code>cl_dataset.num_tasks</code>.</p>
</div>


                            </div>
                            <div id="CLAccuracy.on_fit_start" class="classattr">
                                        <input id="CLAccuracy.on_fit_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_fit_start</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLAccuracy.on_fit_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLAccuracy.on_fit_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLAccuracy.on_fit_start-90"><a href="#CLAccuracy.on_fit_start-90"><span class="linenos"> 90</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLAccuracy.on_fit_start-91"><a href="#CLAccuracy.on_fit_start-91"><span class="linenos"> 91</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_fit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy.on_fit_start-92"><a href="#CLAccuracy.on_fit_start-92"><span class="linenos"> 92</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize training and validation metrics.&quot;&quot;&quot;</span>
</span><span id="CLAccuracy.on_fit_start-93"><a href="#CLAccuracy.on_fit_start-93"><span class="linenos"> 93</span></a>
</span><span id="CLAccuracy.on_fit_start-94"><a href="#CLAccuracy.on_fit_start-94"><span class="linenos"> 94</span></a>        <span class="c1"># set the current task_id from the `CLAlgorithm` object</span>
</span><span id="CLAccuracy.on_fit_start-95"><a href="#CLAccuracy.on_fit_start-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">task_id</span>
</span><span id="CLAccuracy.on_fit_start-96"><a href="#CLAccuracy.on_fit_start-96"><span class="linenos"> 96</span></a>
</span><span id="CLAccuracy.on_fit_start-97"><a href="#CLAccuracy.on_fit_start-97"><span class="linenos"> 97</span></a>        <span class="c1"># get the device to put the metrics on the same device</span>
</span><span id="CLAccuracy.on_fit_start-98"><a href="#CLAccuracy.on_fit_start-98"><span class="linenos"> 98</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">device</span>
</span><span id="CLAccuracy.on_fit_start-99"><a href="#CLAccuracy.on_fit_start-99"><span class="linenos"> 99</span></a>
</span><span id="CLAccuracy.on_fit_start-100"><a href="#CLAccuracy.on_fit_start-100"><span class="linenos">100</span></a>        <span class="c1"># initialize training metrics</span>
</span><span id="CLAccuracy.on_fit_start-101"><a href="#CLAccuracy.on_fit_start-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="CLAccuracy.on_fit_start-102"><a href="#CLAccuracy.on_fit_start-102"><span class="linenos">102</span></a>
</span><span id="CLAccuracy.on_fit_start-103"><a href="#CLAccuracy.on_fit_start-103"><span class="linenos">103</span></a>        <span class="c1"># initialize validation metrics</span>
</span><span id="CLAccuracy.on_fit_start-104"><a href="#CLAccuracy.on_fit_start-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize training and validation metrics.</p>
</div>


                            </div>
                            <div id="CLAccuracy.on_train_batch_end" class="classattr">
                                        <input id="CLAccuracy.on_train_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_train_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLAccuracy.on_train_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLAccuracy.on_train_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLAccuracy.on_train_batch_end-106"><a href="#CLAccuracy.on_train_batch_end-106"><span class="linenos">106</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLAccuracy.on_train_batch_end-107"><a href="#CLAccuracy.on_train_batch_end-107"><span class="linenos">107</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span>
</span><span id="CLAccuracy.on_train_batch_end-108"><a href="#CLAccuracy.on_train_batch_end-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLAccuracy.on_train_batch_end-109"><a href="#CLAccuracy.on_train_batch_end-109"><span class="linenos">109</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLAccuracy.on_train_batch_end-110"><a href="#CLAccuracy.on_train_batch_end-110"><span class="linenos">110</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLAccuracy.on_train_batch_end-111"><a href="#CLAccuracy.on_train_batch_end-111"><span class="linenos">111</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="CLAccuracy.on_train_batch_end-112"><a href="#CLAccuracy.on_train_batch_end-112"><span class="linenos">112</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="CLAccuracy.on_train_batch_end-113"><a href="#CLAccuracy.on_train_batch_end-113"><span class="linenos">113</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CLAccuracy.on_train_batch_end-114"><a href="#CLAccuracy.on_train_batch_end-114"><span class="linenos">114</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy.on_train_batch_end-115"><a href="#CLAccuracy.on_train_batch_end-115"><span class="linenos">115</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Record training metrics from training batch, log metrics of training batch and accumulated metrics of the epoch to Lightning loggers.</span>
</span><span id="CLAccuracy.on_train_batch_end-116"><a href="#CLAccuracy.on_train_batch_end-116"><span class="linenos">116</span></a>
</span><span id="CLAccuracy.on_train_batch_end-117"><a href="#CLAccuracy.on_train_batch_end-117"><span class="linenos">117</span></a><span class="sd">        **Args:**</span>
</span><span id="CLAccuracy.on_train_batch_end-118"><a href="#CLAccuracy.on_train_batch_end-118"><span class="linenos">118</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the training step, the returns of the `training_step()` method in the `CLAlgorithm`.</span>
</span><span id="CLAccuracy.on_train_batch_end-119"><a href="#CLAccuracy.on_train_batch_end-119"><span class="linenos">119</span></a><span class="sd">        - **batch** (`Any`): the training data batch.</span>
</span><span id="CLAccuracy.on_train_batch_end-120"><a href="#CLAccuracy.on_train_batch_end-120"><span class="linenos">120</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLAccuracy.on_train_batch_end-121"><a href="#CLAccuracy.on_train_batch_end-121"><span class="linenos">121</span></a>        <span class="c1"># get the batch size</span>
</span><span id="CLAccuracy.on_train_batch_end-122"><a href="#CLAccuracy.on_train_batch_end-122"><span class="linenos">122</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="CLAccuracy.on_train_batch_end-123"><a href="#CLAccuracy.on_train_batch_end-123"><span class="linenos">123</span></a>
</span><span id="CLAccuracy.on_train_batch_end-124"><a href="#CLAccuracy.on_train_batch_end-124"><span class="linenos">124</span></a>        <span class="c1"># get training metrics values of current training batch from the outputs of the `training_step()`</span>
</span><span id="CLAccuracy.on_train_batch_end-125"><a href="#CLAccuracy.on_train_batch_end-125"><span class="linenos">125</span></a>        <span class="n">acc_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
</span><span id="CLAccuracy.on_train_batch_end-126"><a href="#CLAccuracy.on_train_batch_end-126"><span class="linenos">126</span></a>
</span><span id="CLAccuracy.on_train_batch_end-127"><a href="#CLAccuracy.on_train_batch_end-127"><span class="linenos">127</span></a>        <span class="c1"># update accumulated training metrics to calculate training metrics of the epoch</span>
</span><span id="CLAccuracy.on_train_batch_end-128"><a href="#CLAccuracy.on_train_batch_end-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="CLAccuracy.on_train_batch_end-129"><a href="#CLAccuracy.on_train_batch_end-129"><span class="linenos">129</span></a>
</span><span id="CLAccuracy.on_train_batch_end-130"><a href="#CLAccuracy.on_train_batch_end-130"><span class="linenos">130</span></a>        <span class="c1"># log training metrics of current training batch to Lightning loggers</span>
</span><span id="CLAccuracy.on_train_batch_end-131"><a href="#CLAccuracy.on_train_batch_end-131"><span class="linenos">131</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/train/acc_batch&quot;</span><span class="p">,</span> <span class="n">acc_batch</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="CLAccuracy.on_train_batch_end-132"><a href="#CLAccuracy.on_train_batch_end-132"><span class="linenos">132</span></a>
</span><span id="CLAccuracy.on_train_batch_end-133"><a href="#CLAccuracy.on_train_batch_end-133"><span class="linenos">133</span></a>        <span class="c1"># log accumulated training metrics till this training batch to Lightning loggers</span>
</span><span id="CLAccuracy.on_train_batch_end-134"><a href="#CLAccuracy.on_train_batch_end-134"><span class="linenos">134</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="CLAccuracy.on_train_batch_end-135"><a href="#CLAccuracy.on_train_batch_end-135"><span class="linenos">135</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/train/acc&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy.on_train_batch_end-136"><a href="#CLAccuracy.on_train_batch_end-136"><span class="linenos">136</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="CLAccuracy.on_train_batch_end-137"><a href="#CLAccuracy.on_train_batch_end-137"><span class="linenos">137</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLAccuracy.on_train_batch_end-138"><a href="#CLAccuracy.on_train_batch_end-138"><span class="linenos">138</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Record training metrics from training batch, log metrics of training batch and accumulated metrics of the epoch to Lightning loggers.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the training step, the returns of the <code>training_step()</code> method in the <code>CLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the training data batch.</li>
</ul>
</div>


                            </div>
                            <div id="CLAccuracy.on_train_epoch_end" class="classattr">
                                        <input id="CLAccuracy.on_train_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_train_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLAccuracy.on_train_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLAccuracy.on_train_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLAccuracy.on_train_epoch_end-140"><a href="#CLAccuracy.on_train_epoch_end-140"><span class="linenos">140</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLAccuracy.on_train_epoch_end-141"><a href="#CLAccuracy.on_train_epoch_end-141"><span class="linenos">141</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_epoch_end</span><span class="p">(</span>
</span><span id="CLAccuracy.on_train_epoch_end-142"><a href="#CLAccuracy.on_train_epoch_end-142"><span class="linenos">142</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLAccuracy.on_train_epoch_end-143"><a href="#CLAccuracy.on_train_epoch_end-143"><span class="linenos">143</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLAccuracy.on_train_epoch_end-144"><a href="#CLAccuracy.on_train_epoch_end-144"><span class="linenos">144</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLAccuracy.on_train_epoch_end-145"><a href="#CLAccuracy.on_train_epoch_end-145"><span class="linenos">145</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy.on_train_epoch_end-146"><a href="#CLAccuracy.on_train_epoch_end-146"><span class="linenos">146</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log metrics of training epoch to plot learning curves and reset the metrics accumulation at the end of training epoch.&quot;&quot;&quot;</span>
</span><span id="CLAccuracy.on_train_epoch_end-147"><a href="#CLAccuracy.on_train_epoch_end-147"><span class="linenos">147</span></a>
</span><span id="CLAccuracy.on_train_epoch_end-148"><a href="#CLAccuracy.on_train_epoch_end-148"><span class="linenos">148</span></a>        <span class="c1"># log the accumulated and computed metrics of the epoch to Lightning loggers, specially for plotting learning curves</span>
</span><span id="CLAccuracy.on_train_epoch_end-149"><a href="#CLAccuracy.on_train_epoch_end-149"><span class="linenos">149</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="CLAccuracy.on_train_epoch_end-150"><a href="#CLAccuracy.on_train_epoch_end-150"><span class="linenos">150</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/learning_curve/train/acc&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy.on_train_epoch_end-151"><a href="#CLAccuracy.on_train_epoch_end-151"><span class="linenos">151</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="CLAccuracy.on_train_epoch_end-152"><a href="#CLAccuracy.on_train_epoch_end-152"><span class="linenos">152</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLAccuracy.on_train_epoch_end-153"><a href="#CLAccuracy.on_train_epoch_end-153"><span class="linenos">153</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLAccuracy.on_train_epoch_end-154"><a href="#CLAccuracy.on_train_epoch_end-154"><span class="linenos">154</span></a>        <span class="p">)</span>
</span><span id="CLAccuracy.on_train_epoch_end-155"><a href="#CLAccuracy.on_train_epoch_end-155"><span class="linenos">155</span></a>
</span><span id="CLAccuracy.on_train_epoch_end-156"><a href="#CLAccuracy.on_train_epoch_end-156"><span class="linenos">156</span></a>        <span class="c1"># reset the metrics of training epoch as there are more epochs to go and not only one epoch like in the validation and test</span>
</span><span id="CLAccuracy.on_train_epoch_end-157"><a href="#CLAccuracy.on_train_epoch_end-157"><span class="linenos">157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Log metrics of training epoch to plot learning curves and reset the metrics accumulation at the end of training epoch.</p>
</div>


                            </div>
                            <div id="CLAccuracy.on_validation_batch_end" class="classattr">
                                        <input id="CLAccuracy.on_validation_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_validation_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLAccuracy.on_validation_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLAccuracy.on_validation_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLAccuracy.on_validation_batch_end-159"><a href="#CLAccuracy.on_validation_batch_end-159"><span class="linenos">159</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLAccuracy.on_validation_batch_end-160"><a href="#CLAccuracy.on_validation_batch_end-160"><span class="linenos">160</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_batch_end</span><span class="p">(</span>
</span><span id="CLAccuracy.on_validation_batch_end-161"><a href="#CLAccuracy.on_validation_batch_end-161"><span class="linenos">161</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLAccuracy.on_validation_batch_end-162"><a href="#CLAccuracy.on_validation_batch_end-162"><span class="linenos">162</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLAccuracy.on_validation_batch_end-163"><a href="#CLAccuracy.on_validation_batch_end-163"><span class="linenos">163</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLAccuracy.on_validation_batch_end-164"><a href="#CLAccuracy.on_validation_batch_end-164"><span class="linenos">164</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="CLAccuracy.on_validation_batch_end-165"><a href="#CLAccuracy.on_validation_batch_end-165"><span class="linenos">165</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="CLAccuracy.on_validation_batch_end-166"><a href="#CLAccuracy.on_validation_batch_end-166"><span class="linenos">166</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CLAccuracy.on_validation_batch_end-167"><a href="#CLAccuracy.on_validation_batch_end-167"><span class="linenos">167</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy.on_validation_batch_end-168"><a href="#CLAccuracy.on_validation_batch_end-168"><span class="linenos">168</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from validation batch. We don&#39;t need to log and monitor the metrics of validation batches.</span>
</span><span id="CLAccuracy.on_validation_batch_end-169"><a href="#CLAccuracy.on_validation_batch_end-169"><span class="linenos">169</span></a>
</span><span id="CLAccuracy.on_validation_batch_end-170"><a href="#CLAccuracy.on_validation_batch_end-170"><span class="linenos">170</span></a><span class="sd">        **Args:**</span>
</span><span id="CLAccuracy.on_validation_batch_end-171"><a href="#CLAccuracy.on_validation_batch_end-171"><span class="linenos">171</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the validation step, which is the returns of the `validation_step()` method in the `CLAlgorithm`.</span>
</span><span id="CLAccuracy.on_validation_batch_end-172"><a href="#CLAccuracy.on_validation_batch_end-172"><span class="linenos">172</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="CLAccuracy.on_validation_batch_end-173"><a href="#CLAccuracy.on_validation_batch_end-173"><span class="linenos">173</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLAccuracy.on_validation_batch_end-174"><a href="#CLAccuracy.on_validation_batch_end-174"><span class="linenos">174</span></a>
</span><span id="CLAccuracy.on_validation_batch_end-175"><a href="#CLAccuracy.on_validation_batch_end-175"><span class="linenos">175</span></a>        <span class="c1"># get the batch size</span>
</span><span id="CLAccuracy.on_validation_batch_end-176"><a href="#CLAccuracy.on_validation_batch_end-176"><span class="linenos">176</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="CLAccuracy.on_validation_batch_end-177"><a href="#CLAccuracy.on_validation_batch_end-177"><span class="linenos">177</span></a>
</span><span id="CLAccuracy.on_validation_batch_end-178"><a href="#CLAccuracy.on_validation_batch_end-178"><span class="linenos">178</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="CLAccuracy.on_validation_batch_end-179"><a href="#CLAccuracy.on_validation_batch_end-179"><span class="linenos">179</span></a>        <span class="n">acc_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
</span><span id="CLAccuracy.on_validation_batch_end-180"><a href="#CLAccuracy.on_validation_batch_end-180"><span class="linenos">180</span></a>
</span><span id="CLAccuracy.on_validation_batch_end-181"><a href="#CLAccuracy.on_validation_batch_end-181"><span class="linenos">181</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the validation metrics</span>
</span><span id="CLAccuracy.on_validation_batch_end-182"><a href="#CLAccuracy.on_validation_batch_end-182"><span class="linenos">182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Accumulating metrics from validation batch. We don't need to log and monitor the metrics of validation batches.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the validation step, which is the returns of the <code>validation_step()</code> method in the <code>CLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the validation data batch.</li>
</ul>
</div>


                            </div>
                            <div id="CLAccuracy.on_validation_epoch_end" class="classattr">
                                        <input id="CLAccuracy.on_validation_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_validation_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLAccuracy.on_validation_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLAccuracy.on_validation_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLAccuracy.on_validation_epoch_end-184"><a href="#CLAccuracy.on_validation_epoch_end-184"><span class="linenos">184</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLAccuracy.on_validation_epoch_end-185"><a href="#CLAccuracy.on_validation_epoch_end-185"><span class="linenos">185</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_epoch_end</span><span class="p">(</span>
</span><span id="CLAccuracy.on_validation_epoch_end-186"><a href="#CLAccuracy.on_validation_epoch_end-186"><span class="linenos">186</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLAccuracy.on_validation_epoch_end-187"><a href="#CLAccuracy.on_validation_epoch_end-187"><span class="linenos">187</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLAccuracy.on_validation_epoch_end-188"><a href="#CLAccuracy.on_validation_epoch_end-188"><span class="linenos">188</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLAccuracy.on_validation_epoch_end-189"><a href="#CLAccuracy.on_validation_epoch_end-189"><span class="linenos">189</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy.on_validation_epoch_end-190"><a href="#CLAccuracy.on_validation_epoch_end-190"><span class="linenos">190</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log validation metrics to plot learning curves.&quot;&quot;&quot;</span>
</span><span id="CLAccuracy.on_validation_epoch_end-191"><a href="#CLAccuracy.on_validation_epoch_end-191"><span class="linenos">191</span></a>
</span><span id="CLAccuracy.on_validation_epoch_end-192"><a href="#CLAccuracy.on_validation_epoch_end-192"><span class="linenos">192</span></a>        <span class="c1"># log the accumulated and computed metrics of the epoch to Lightning loggers, specially for plotting learning curves</span>
</span><span id="CLAccuracy.on_validation_epoch_end-193"><a href="#CLAccuracy.on_validation_epoch_end-193"><span class="linenos">193</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="CLAccuracy.on_validation_epoch_end-194"><a href="#CLAccuracy.on_validation_epoch_end-194"><span class="linenos">194</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/learning_curve/val/acc&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy.on_validation_epoch_end-195"><a href="#CLAccuracy.on_validation_epoch_end-195"><span class="linenos">195</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="CLAccuracy.on_validation_epoch_end-196"><a href="#CLAccuracy.on_validation_epoch_end-196"><span class="linenos">196</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLAccuracy.on_validation_epoch_end-197"><a href="#CLAccuracy.on_validation_epoch_end-197"><span class="linenos">197</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLAccuracy.on_validation_epoch_end-198"><a href="#CLAccuracy.on_validation_epoch_end-198"><span class="linenos">198</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Log validation metrics to plot learning curves.</p>
</div>


                            </div>
                            <div id="CLAccuracy.on_test_start" class="classattr">
                                        <input id="CLAccuracy.on_test_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_test_start</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLAccuracy.on_test_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLAccuracy.on_test_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLAccuracy.on_test_start-200"><a href="#CLAccuracy.on_test_start-200"><span class="linenos">200</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLAccuracy.on_test_start-201"><a href="#CLAccuracy.on_test_start-201"><span class="linenos">201</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_start</span><span class="p">(</span>
</span><span id="CLAccuracy.on_test_start-202"><a href="#CLAccuracy.on_test_start-202"><span class="linenos">202</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLAccuracy.on_test_start-203"><a href="#CLAccuracy.on_test_start-203"><span class="linenos">203</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLAccuracy.on_test_start-204"><a href="#CLAccuracy.on_test_start-204"><span class="linenos">204</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLAccuracy.on_test_start-205"><a href="#CLAccuracy.on_test_start-205"><span class="linenos">205</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy.on_test_start-206"><a href="#CLAccuracy.on_test_start-206"><span class="linenos">206</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the metrics for testing each seen task in the beginning of a task&#39;s testing.&quot;&quot;&quot;</span>
</span><span id="CLAccuracy.on_test_start-207"><a href="#CLAccuracy.on_test_start-207"><span class="linenos">207</span></a>
</span><span id="CLAccuracy.on_test_start-208"><a href="#CLAccuracy.on_test_start-208"><span class="linenos">208</span></a>        <span class="c1"># set the current task_id again (double checking) from the `CLAlgorithm` object</span>
</span><span id="CLAccuracy.on_test_start-209"><a href="#CLAccuracy.on_test_start-209"><span class="linenos">209</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">task_id</span>
</span><span id="CLAccuracy.on_test_start-210"><a href="#CLAccuracy.on_test_start-210"><span class="linenos">210</span></a>
</span><span id="CLAccuracy.on_test_start-211"><a href="#CLAccuracy.on_test_start-211"><span class="linenos">211</span></a>        <span class="c1"># get the device to put the metrics on the same device</span>
</span><span id="CLAccuracy.on_test_start-212"><a href="#CLAccuracy.on_test_start-212"><span class="linenos">212</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">device</span>
</span><span id="CLAccuracy.on_test_start-213"><a href="#CLAccuracy.on_test_start-213"><span class="linenos">213</span></a>
</span><span id="CLAccuracy.on_test_start-214"><a href="#CLAccuracy.on_test_start-214"><span class="linenos">214</span></a>        <span class="c1"># initialize test metrics for current and previous tasks</span>
</span><span id="CLAccuracy.on_test_start-215"><a href="#CLAccuracy.on_test_start-215"><span class="linenos">215</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="CLAccuracy.on_test_start-216"><a href="#CLAccuracy.on_test_start-216"><span class="linenos">216</span></a>            <span class="n">task_id</span><span class="p">:</span> <span class="n">MeanMetricBatch</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">processed_task_ids</span>
</span><span id="CLAccuracy.on_test_start-217"><a href="#CLAccuracy.on_test_start-217"><span class="linenos">217</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the metrics for testing each seen task in the beginning of a task's testing.</p>
</div>


                            </div>
                            <div id="CLAccuracy.on_test_batch_end" class="classattr">
                                        <input id="CLAccuracy.on_test_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_test_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLAccuracy.on_test_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLAccuracy.on_test_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLAccuracy.on_test_batch_end-219"><a href="#CLAccuracy.on_test_batch_end-219"><span class="linenos">219</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLAccuracy.on_test_batch_end-220"><a href="#CLAccuracy.on_test_batch_end-220"><span class="linenos">220</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_batch_end</span><span class="p">(</span>
</span><span id="CLAccuracy.on_test_batch_end-221"><a href="#CLAccuracy.on_test_batch_end-221"><span class="linenos">221</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLAccuracy.on_test_batch_end-222"><a href="#CLAccuracy.on_test_batch_end-222"><span class="linenos">222</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLAccuracy.on_test_batch_end-223"><a href="#CLAccuracy.on_test_batch_end-223"><span class="linenos">223</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLAccuracy.on_test_batch_end-224"><a href="#CLAccuracy.on_test_batch_end-224"><span class="linenos">224</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="CLAccuracy.on_test_batch_end-225"><a href="#CLAccuracy.on_test_batch_end-225"><span class="linenos">225</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="CLAccuracy.on_test_batch_end-226"><a href="#CLAccuracy.on_test_batch_end-226"><span class="linenos">226</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CLAccuracy.on_test_batch_end-227"><a href="#CLAccuracy.on_test_batch_end-227"><span class="linenos">227</span></a>        <span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="CLAccuracy.on_test_batch_end-228"><a href="#CLAccuracy.on_test_batch_end-228"><span class="linenos">228</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy.on_test_batch_end-229"><a href="#CLAccuracy.on_test_batch_end-229"><span class="linenos">229</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from test batch. We don&#39;t need to log and monitor the metrics of test batches.</span>
</span><span id="CLAccuracy.on_test_batch_end-230"><a href="#CLAccuracy.on_test_batch_end-230"><span class="linenos">230</span></a>
</span><span id="CLAccuracy.on_test_batch_end-231"><a href="#CLAccuracy.on_test_batch_end-231"><span class="linenos">231</span></a><span class="sd">        **Args:**</span>
</span><span id="CLAccuracy.on_test_batch_end-232"><a href="#CLAccuracy.on_test_batch_end-232"><span class="linenos">232</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the test step, which is the returns of the `test_step()` method in the `CLAlgorithm`.</span>
</span><span id="CLAccuracy.on_test_batch_end-233"><a href="#CLAccuracy.on_test_batch_end-233"><span class="linenos">233</span></a><span class="sd">        - **batch** (`Any`): the test data batch.</span>
</span><span id="CLAccuracy.on_test_batch_end-234"><a href="#CLAccuracy.on_test_batch_end-234"><span class="linenos">234</span></a><span class="sd">        - **dataloader_idx** (`int`): the task ID of seen tasks to be tested. A default value of 0 is given otherwise the LightningModule will raise a `RuntimeError`.</span>
</span><span id="CLAccuracy.on_test_batch_end-235"><a href="#CLAccuracy.on_test_batch_end-235"><span class="linenos">235</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLAccuracy.on_test_batch_end-236"><a href="#CLAccuracy.on_test_batch_end-236"><span class="linenos">236</span></a>
</span><span id="CLAccuracy.on_test_batch_end-237"><a href="#CLAccuracy.on_test_batch_end-237"><span class="linenos">237</span></a>        <span class="c1"># get the batch size</span>
</span><span id="CLAccuracy.on_test_batch_end-238"><a href="#CLAccuracy.on_test_batch_end-238"><span class="linenos">238</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="CLAccuracy.on_test_batch_end-239"><a href="#CLAccuracy.on_test_batch_end-239"><span class="linenos">239</span></a>
</span><span id="CLAccuracy.on_test_batch_end-240"><a href="#CLAccuracy.on_test_batch_end-240"><span class="linenos">240</span></a>        <span class="n">test_task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">get_test_task_id_from_dataloader_idx</span><span class="p">(</span><span class="n">dataloader_idx</span><span class="p">)</span>
</span><span id="CLAccuracy.on_test_batch_end-241"><a href="#CLAccuracy.on_test_batch_end-241"><span class="linenos">241</span></a>
</span><span id="CLAccuracy.on_test_batch_end-242"><a href="#CLAccuracy.on_test_batch_end-242"><span class="linenos">242</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="CLAccuracy.on_test_batch_end-243"><a href="#CLAccuracy.on_test_batch_end-243"><span class="linenos">243</span></a>        <span class="n">acc_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
</span><span id="CLAccuracy.on_test_batch_end-244"><a href="#CLAccuracy.on_test_batch_end-244"><span class="linenos">244</span></a>
</span><span id="CLAccuracy.on_test_batch_end-245"><a href="#CLAccuracy.on_test_batch_end-245"><span class="linenos">245</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the metrics of the epoch</span>
</span><span id="CLAccuracy.on_test_batch_end-246"><a href="#CLAccuracy.on_test_batch_end-246"><span class="linenos">246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="p">[</span><span class="n">test_task_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Accumulating metrics from test batch. We don't need to log and monitor the metrics of test batches.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the test step, which is the returns of the <code>test_step()</code> method in the <code>CLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the test data batch.</li>
<li><strong>dataloader_idx</strong> (<code>int</code>): the task ID of seen tasks to be tested. A default value of 0 is given otherwise the LightningModule will raise a <code>RuntimeError</code>.</li>
</ul>
</div>


                            </div>
                            <div id="CLAccuracy.on_test_epoch_end" class="classattr">
                                        <input id="CLAccuracy.on_test_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_test_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLAccuracy.on_test_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLAccuracy.on_test_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLAccuracy.on_test_epoch_end-248"><a href="#CLAccuracy.on_test_epoch_end-248"><span class="linenos">248</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLAccuracy.on_test_epoch_end-249"><a href="#CLAccuracy.on_test_epoch_end-249"><span class="linenos">249</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_epoch_end</span><span class="p">(</span>
</span><span id="CLAccuracy.on_test_epoch_end-250"><a href="#CLAccuracy.on_test_epoch_end-250"><span class="linenos">250</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLAccuracy.on_test_epoch_end-251"><a href="#CLAccuracy.on_test_epoch_end-251"><span class="linenos">251</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLAccuracy.on_test_epoch_end-252"><a href="#CLAccuracy.on_test_epoch_end-252"><span class="linenos">252</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLAccuracy.on_test_epoch_end-253"><a href="#CLAccuracy.on_test_epoch_end-253"><span class="linenos">253</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy.on_test_epoch_end-254"><a href="#CLAccuracy.on_test_epoch_end-254"><span class="linenos">254</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save and plot test metrics at the end of test.&quot;&quot;&quot;</span>
</span><span id="CLAccuracy.on_test_epoch_end-255"><a href="#CLAccuracy.on_test_epoch_end-255"><span class="linenos">255</span></a>
</span><span id="CLAccuracy.on_test_epoch_end-256"><a href="#CLAccuracy.on_test_epoch_end-256"><span class="linenos">256</span></a>        <span class="c1"># save (update) the test metrics to CSV files</span>
</span><span id="CLAccuracy.on_test_epoch_end-257"><a href="#CLAccuracy.on_test_epoch_end-257"><span class="linenos">257</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_test_acc_to_csv</span><span class="p">(</span>
</span><span id="CLAccuracy.on_test_epoch_end-258"><a href="#CLAccuracy.on_test_epoch_end-258"><span class="linenos">258</span></a>            <span class="n">after_training_task_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
</span><span id="CLAccuracy.on_test_epoch_end-259"><a href="#CLAccuracy.on_test_epoch_end-259"><span class="linenos">259</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_acc_csv_path</span><span class="p">,</span>
</span><span id="CLAccuracy.on_test_epoch_end-260"><a href="#CLAccuracy.on_test_epoch_end-260"><span class="linenos">260</span></a>        <span class="p">)</span>
</span><span id="CLAccuracy.on_test_epoch_end-261"><a href="#CLAccuracy.on_test_epoch_end-261"><span class="linenos">261</span></a>
</span><span id="CLAccuracy.on_test_epoch_end-262"><a href="#CLAccuracy.on_test_epoch_end-262"><span class="linenos">262</span></a>        <span class="c1"># plot the test metrics</span>
</span><span id="CLAccuracy.on_test_epoch_end-263"><a href="#CLAccuracy.on_test_epoch_end-263"><span class="linenos">263</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_acc_matrix_plot_path</span><span class="p">:</span>
</span><span id="CLAccuracy.on_test_epoch_end-264"><a href="#CLAccuracy.on_test_epoch_end-264"><span class="linenos">264</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plot_test_acc_matrix_from_csv</span><span class="p">(</span>
</span><span id="CLAccuracy.on_test_epoch_end-265"><a href="#CLAccuracy.on_test_epoch_end-265"><span class="linenos">265</span></a>                <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_acc_csv_path</span><span class="p">,</span>
</span><span id="CLAccuracy.on_test_epoch_end-266"><a href="#CLAccuracy.on_test_epoch_end-266"><span class="linenos">266</span></a>                <span class="n">plot_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_acc_matrix_plot_path</span><span class="p">,</span>
</span><span id="CLAccuracy.on_test_epoch_end-267"><a href="#CLAccuracy.on_test_epoch_end-267"><span class="linenos">267</span></a>            <span class="p">)</span>
</span><span id="CLAccuracy.on_test_epoch_end-268"><a href="#CLAccuracy.on_test_epoch_end-268"><span class="linenos">268</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_ave_acc_plot_path</span><span class="p">:</span>
</span><span id="CLAccuracy.on_test_epoch_end-269"><a href="#CLAccuracy.on_test_epoch_end-269"><span class="linenos">269</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plot_test_ave_acc_curve_from_csv</span><span class="p">(</span>
</span><span id="CLAccuracy.on_test_epoch_end-270"><a href="#CLAccuracy.on_test_epoch_end-270"><span class="linenos">270</span></a>                <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_acc_csv_path</span><span class="p">,</span>
</span><span id="CLAccuracy.on_test_epoch_end-271"><a href="#CLAccuracy.on_test_epoch_end-271"><span class="linenos">271</span></a>                <span class="n">plot_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_ave_acc_plot_path</span><span class="p">,</span>
</span><span id="CLAccuracy.on_test_epoch_end-272"><a href="#CLAccuracy.on_test_epoch_end-272"><span class="linenos">272</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save and plot test metrics at the end of test.</p>
</div>


                            </div>
                            <div id="CLAccuracy.update_test_acc_to_csv" class="classattr">
                                        <input id="CLAccuracy.update_test_acc_to_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_test_acc_to_csv</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">after_training_task_id</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">skipped_task_ids_for_ave</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLAccuracy.update_test_acc_to_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLAccuracy.update_test_acc_to_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLAccuracy.update_test_acc_to_csv-274"><a href="#CLAccuracy.update_test_acc_to_csv-274"><span class="linenos">274</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_test_acc_to_csv</span><span class="p">(</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-275"><a href="#CLAccuracy.update_test_acc_to_csv-275"><span class="linenos">275</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-276"><a href="#CLAccuracy.update_test_acc_to_csv-276"><span class="linenos">276</span></a>        <span class="n">after_training_task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-277"><a href="#CLAccuracy.update_test_acc_to_csv-277"><span class="linenos">277</span></a>        <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-278"><a href="#CLAccuracy.update_test_acc_to_csv-278"><span class="linenos">278</span></a>        <span class="n">skipped_task_ids_for_ave</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-279"><a href="#CLAccuracy.update_test_acc_to_csv-279"><span class="linenos">279</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-280"><a href="#CLAccuracy.update_test_acc_to_csv-280"><span class="linenos">280</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Update the test accuracy metrics of seen tasks at the last line to an existing CSV file. A new file will be created if not existing.</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-281"><a href="#CLAccuracy.update_test_acc_to_csv-281"><span class="linenos">281</span></a>
</span><span id="CLAccuracy.update_test_acc_to_csv-282"><a href="#CLAccuracy.update_test_acc_to_csv-282"><span class="linenos">282</span></a><span class="sd">        **Args:**</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-283"><a href="#CLAccuracy.update_test_acc_to_csv-283"><span class="linenos">283</span></a><span class="sd">        - **after_training_task_id** (`int`): the task ID after training.</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-284"><a href="#CLAccuracy.update_test_acc_to_csv-284"><span class="linenos">284</span></a><span class="sd">        - **csv_path** (`str`): save the test metric to path. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/acc.csv&#39;.</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-285"><a href="#CLAccuracy.update_test_acc_to_csv-285"><span class="linenos">285</span></a><span class="sd">        - **skipped_task_ids_for_ave** (`list[int]` | `None`): the task IDs that are skipped to calculate average accuracy. If `None`, no task is skipped. Default: `None`.</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-286"><a href="#CLAccuracy.update_test_acc_to_csv-286"><span class="linenos">286</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-287"><a href="#CLAccuracy.update_test_acc_to_csv-287"><span class="linenos">287</span></a>        <span class="n">processed_task_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-288"><a href="#CLAccuracy.update_test_acc_to_csv-288"><span class="linenos">288</span></a>        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;after_training_task&quot;</span><span class="p">,</span> <span class="s2">&quot;average_accuracy&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-289"><a href="#CLAccuracy.update_test_acc_to_csv-289"><span class="linenos">289</span></a>            <span class="sa">f</span><span class="s2">&quot;test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">processed_task_ids</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-290"><a href="#CLAccuracy.update_test_acc_to_csv-290"><span class="linenos">290</span></a>        <span class="p">]</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-291"><a href="#CLAccuracy.update_test_acc_to_csv-291"><span class="linenos">291</span></a>
</span><span id="CLAccuracy.update_test_acc_to_csv-292"><a href="#CLAccuracy.update_test_acc_to_csv-292"><span class="linenos">292</span></a>        <span class="n">new_line</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-293"><a href="#CLAccuracy.update_test_acc_to_csv-293"><span class="linenos">293</span></a>            <span class="s2">&quot;after_training_task&quot;</span><span class="p">:</span> <span class="n">after_training_task_id</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-294"><a href="#CLAccuracy.update_test_acc_to_csv-294"><span class="linenos">294</span></a>        <span class="p">}</span>  <span class="c1"># construct the first column</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-295"><a href="#CLAccuracy.update_test_acc_to_csv-295"><span class="linenos">295</span></a>
</span><span id="CLAccuracy.update_test_acc_to_csv-296"><a href="#CLAccuracy.update_test_acc_to_csv-296"><span class="linenos">296</span></a>        <span class="c1"># construct the columns and calculate the average accuracy over tasks at the same time</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-297"><a href="#CLAccuracy.update_test_acc_to_csv-297"><span class="linenos">297</span></a>        <span class="n">average_accuracy_over_tasks</span> <span class="o">=</span> <span class="n">MeanMetric</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-298"><a href="#CLAccuracy.update_test_acc_to_csv-298"><span class="linenos">298</span></a>            <span class="n">device</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">device</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-299"><a href="#CLAccuracy.update_test_acc_to_csv-299"><span class="linenos">299</span></a>        <span class="p">)</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-300"><a href="#CLAccuracy.update_test_acc_to_csv-300"><span class="linenos">300</span></a>        <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">processed_task_ids</span><span class="p">:</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-301"><a href="#CLAccuracy.update_test_acc_to_csv-301"><span class="linenos">301</span></a>            <span class="n">acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-302"><a href="#CLAccuracy.update_test_acc_to_csv-302"><span class="linenos">302</span></a>            <span class="n">new_line</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-303"><a href="#CLAccuracy.update_test_acc_to_csv-303"><span class="linenos">303</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-304"><a href="#CLAccuracy.update_test_acc_to_csv-304"><span class="linenos">304</span></a>                <span class="n">skipped_task_ids_for_ave</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-305"><a href="#CLAccuracy.update_test_acc_to_csv-305"><span class="linenos">305</span></a>                <span class="ow">or</span> <span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skipped_task_ids_for_ave</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-306"><a href="#CLAccuracy.update_test_acc_to_csv-306"><span class="linenos">306</span></a>            <span class="p">):</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-307"><a href="#CLAccuracy.update_test_acc_to_csv-307"><span class="linenos">307</span></a>                <span class="n">average_accuracy_over_tasks</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-308"><a href="#CLAccuracy.update_test_acc_to_csv-308"><span class="linenos">308</span></a>        <span class="n">new_line</span><span class="p">[</span><span class="s2">&quot;average_accuracy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">average_accuracy_over_tasks</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-309"><a href="#CLAccuracy.update_test_acc_to_csv-309"><span class="linenos">309</span></a>
</span><span id="CLAccuracy.update_test_acc_to_csv-310"><a href="#CLAccuracy.update_test_acc_to_csv-310"><span class="linenos">310</span></a>        <span class="c1"># write to the csv file</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-311"><a href="#CLAccuracy.update_test_acc_to_csv-311"><span class="linenos">311</span></a>        <span class="n">is_first</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-312"><a href="#CLAccuracy.update_test_acc_to_csv-312"><span class="linenos">312</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-313"><a href="#CLAccuracy.update_test_acc_to_csv-313"><span class="linenos">313</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-314"><a href="#CLAccuracy.update_test_acc_to_csv-314"><span class="linenos">314</span></a>                <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-315"><a href="#CLAccuracy.update_test_acc_to_csv-315"><span class="linenos">315</span></a>                <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-316"><a href="#CLAccuracy.update_test_acc_to_csv-316"><span class="linenos">316</span></a>        <span class="c1"># write header</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-317"><a href="#CLAccuracy.update_test_acc_to_csv-317"><span class="linenos">317</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-318"><a href="#CLAccuracy.update_test_acc_to_csv-318"><span class="linenos">318</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-319"><a href="#CLAccuracy.update_test_acc_to_csv-319"><span class="linenos">319</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-320"><a href="#CLAccuracy.update_test_acc_to_csv-320"><span class="linenos">320</span></a>        <span class="c1"># write metrics</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-321"><a href="#CLAccuracy.update_test_acc_to_csv-321"><span class="linenos">321</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-322"><a href="#CLAccuracy.update_test_acc_to_csv-322"><span class="linenos">322</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-323"><a href="#CLAccuracy.update_test_acc_to_csv-323"><span class="linenos">323</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>  <span class="c1"># write the previous lines</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-324"><a href="#CLAccuracy.update_test_acc_to_csv-324"><span class="linenos">324</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="CLAccuracy.update_test_acc_to_csv-325"><a href="#CLAccuracy.update_test_acc_to_csv-325"><span class="linenos">325</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Update the test accuracy metrics of seen tasks at the last line to an existing CSV file. A new file will be created if not existing.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>after_training_task_id</strong> (<code>int</code>): the task ID after training.</li>
<li><strong>csv_path</strong> (<code>str</code>): save the test metric to path. E.g. './outputs/expr_name/1970-01-01_00-00-00/results/acc.csv'.</li>
<li><strong>skipped_task_ids_for_ave</strong> (<code>list[int]</code> | <code>None</code>): the task IDs that are skipped to calculate average accuracy. If <code>None</code>, no task is skipped. Default: <code>None</code>.</li>
</ul>
</div>


                            </div>
                            <div id="CLAccuracy.plot_test_acc_matrix_from_csv" class="classattr">
                                        <input id="CLAccuracy.plot_test_acc_matrix_from_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_test_acc_matrix_from_csv</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLAccuracy.plot_test_acc_matrix_from_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLAccuracy.plot_test_acc_matrix_from_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-327"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-327"><span class="linenos">327</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_test_acc_matrix_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-328"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-328"><span class="linenos">328</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the test accuracy matrix from saved CSV file and save the plot to the designated directory.</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-329"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-329"><span class="linenos">329</span></a>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-330"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-330"><span class="linenos">330</span></a><span class="sd">        **Args:**</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-331"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-331"><span class="linenos">331</span></a><span class="sd">        - **csv_path** (`str`): the path to the CSV file where the `utils.update_test_acc_to_csv()` saved the test accuracy metric.</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-332"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-332"><span class="linenos">332</span></a><span class="sd">        - **plot_path** (`str`): the path to save plot. Better same as the output directory of the experiment. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/acc_matrix.png&#39;.</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-333"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-333"><span class="linenos">333</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-334"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-334"><span class="linenos">334</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-335"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-335"><span class="linenos">335</span></a>        <span class="n">processed_task_ids</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-336"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-336"><span class="linenos">336</span></a>            <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;test_on_task_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-337"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-337"><span class="linenos">337</span></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-338"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-338"><span class="linenos">338</span></a>            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;test_on_task_&quot;</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-339"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-339"><span class="linenos">339</span></a>        <span class="p">]</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-340"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-340"><span class="linenos">340</span></a>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-341"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-341"><span class="linenos">341</span></a>        <span class="c1"># Get all columns that start with &quot;test_on_task_&quot;</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-342"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-342"><span class="linenos">342</span></a>        <span class="n">test_task_cols</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-343"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-343"><span class="linenos">343</span></a>            <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;test_on_task_&quot;</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-344"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-344"><span class="linenos">344</span></a>        <span class="p">]</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-345"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-345"><span class="linenos">345</span></a>        <span class="n">num_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_task_ids</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-346"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-346"><span class="linenos">346</span></a>        <span class="n">num_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-347"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-347"><span class="linenos">347</span></a>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-348"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-348"><span class="linenos">348</span></a>        <span class="c1"># Build the accuracy matrix</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-349"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-349"><span class="linenos">349</span></a>        <span class="n">acc_matrix</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">test_task_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-350"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-350"><span class="linenos">350</span></a>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-351"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-351"><span class="linenos">351</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-352"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-352"><span class="linenos">352</span></a>            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num_tasks</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_rows</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-353"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-353"><span class="linenos">353</span></a>        <span class="p">)</span>  <span class="c1"># adaptive figure size</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-354"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-354"><span class="linenos">354</span></a>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-355"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-355"><span class="linenos">355</span></a>        <span class="n">cax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-356"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-356"><span class="linenos">356</span></a>            <span class="n">acc_matrix</span><span class="p">,</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-357"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-357"><span class="linenos">357</span></a>            <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-358"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-358"><span class="linenos">358</span></a>            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greens&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-359"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-359"><span class="linenos">359</span></a>            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-360"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-360"><span class="linenos">360</span></a>            <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-361"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-361"><span class="linenos">361</span></a>            <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-362"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-362"><span class="linenos">362</span></a>        <span class="p">)</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-363"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-363"><span class="linenos">363</span></a>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-364"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-364"><span class="linenos">364</span></a>        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cax</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-365"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-365"><span class="linenos">365</span></a>        <span class="n">yticks</span> <span class="o">=</span> <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-366"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-366"><span class="linenos">366</span></a>        <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-367"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-367"><span class="linenos">367</span></a>        <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-368"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-368"><span class="linenos">368</span></a>            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">yticks</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-369"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-369"><span class="linenos">369</span></a>        <span class="p">)</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-370"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-370"><span class="linenos">370</span></a>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-371"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-371"><span class="linenos">371</span></a>        <span class="c1"># Annotate each cell</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-372"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-372"><span class="linenos">372</span></a>        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_rows</span><span class="p">):</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-373"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-373"><span class="linenos">373</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-374"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-374"><span class="linenos">374</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-375"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-375"><span class="linenos">375</span></a>                    <span class="n">c</span><span class="p">,</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-376"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-376"><span class="linenos">376</span></a>                    <span class="n">r</span><span class="p">,</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-377"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-377"><span class="linenos">377</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">acc_matrix</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-378"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-378"><span class="linenos">378</span></a>                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-379"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-379"><span class="linenos">379</span></a>                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-380"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-380"><span class="linenos">380</span></a>                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-381"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-381"><span class="linenos">381</span></a>                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">,</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-382"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-382"><span class="linenos">382</span></a>                <span class="p">)</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-383"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-383"><span class="linenos">383</span></a>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-384"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-384"><span class="linenos">384</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">))</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-385"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-385"><span class="linenos">385</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_rows</span><span class="p">))</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-386"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-386"><span class="linenos">386</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">processed_task_ids</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-387"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-387"><span class="linenos">387</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-388"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-388"><span class="linenos">388</span></a>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;after_training_task&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-389"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-389"><span class="linenos">389</span></a>        <span class="p">)</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-390"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-390"><span class="linenos">390</span></a>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-391"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-391"><span class="linenos">391</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Testing on task &quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-392"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-392"><span class="linenos">392</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;After training task t&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-393"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-393"><span class="linenos">393</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-394"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-394"><span class="linenos">394</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_acc_matrix_from_csv-395"><a href="#CLAccuracy.plot_test_acc_matrix_from_csv-395"><span class="linenos">395</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plot the test accuracy matrix from saved CSV file and save the plot to the designated directory.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>csv_path</strong> (<code>str</code>): the path to the CSV file where the <code>utils.update_test_acc_to_csv()</code> saved the test accuracy metric.</li>
<li><strong>plot_path</strong> (<code>str</code>): the path to save plot. Better same as the output directory of the experiment. E.g. './outputs/expr_name/1970-01-01_00-00-00/acc_matrix.png'.</li>
</ul>
</div>


                            </div>
                            <div id="CLAccuracy.plot_test_ave_acc_curve_from_csv" class="classattr">
                                        <input id="CLAccuracy.plot_test_ave_acc_curve_from_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_test_ave_acc_curve_from_csv</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLAccuracy.plot_test_ave_acc_curve_from_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLAccuracy.plot_test_ave_acc_curve_from_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-397"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-397"><span class="linenos">397</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_test_ave_acc_curve_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-398"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-398"><span class="linenos">398</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the test average accuracy curve over different training tasks from saved CSV file and save the plot to the designated directory.</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-399"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-399"><span class="linenos">399</span></a>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-400"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-400"><span class="linenos">400</span></a><span class="sd">        **Args:**</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-401"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-401"><span class="linenos">401</span></a><span class="sd">        - **csv_path** (`str`): the path to the CSV file where the `utils.update_test_acc_to_csv()` saved the test accuracy metric.</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-402"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-402"><span class="linenos">402</span></a><span class="sd">        - **plot_path** (`str`): the path to save plot. Better same as the output directory of the experiment. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/ave_acc.png&#39;.</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-403"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-403"><span class="linenos">403</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-404"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-404"><span class="linenos">404</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-405"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-405"><span class="linenos">405</span></a>        <span class="n">after_training_tasks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;after_training_task&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-406"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-406"><span class="linenos">406</span></a>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-407"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-407"><span class="linenos">407</span></a>        <span class="c1"># plot the average accuracy curve over different training tasks</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-408"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-408"><span class="linenos">408</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-409"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-409"><span class="linenos">409</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-410"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-410"><span class="linenos">410</span></a>            <span class="n">after_training_tasks</span><span class="p">,</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-411"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-411"><span class="linenos">411</span></a>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;average_accuracy&quot;</span><span class="p">],</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-412"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-412"><span class="linenos">412</span></a>            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-413"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-413"><span class="linenos">413</span></a>            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-414"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-414"><span class="linenos">414</span></a>        <span class="p">)</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-415"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-415"><span class="linenos">415</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;After training task $t$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-416"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-416"><span class="linenos">416</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Average Accuracy (AA)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-417"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-417"><span class="linenos">417</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-418"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-418"><span class="linenos">418</span></a>        <span class="n">xticks</span> <span class="o">=</span> <span class="n">after_training_tasks</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-419"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-419"><span class="linenos">419</span></a>        <span class="n">yticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mf">0.05</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">)]</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-420"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-420"><span class="linenos">420</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-421"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-421"><span class="linenos">421</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-422"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-422"><span class="linenos">422</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-423"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-423"><span class="linenos">423</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">yticks</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-424"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-424"><span class="linenos">424</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="CLAccuracy.plot_test_ave_acc_curve_from_csv-425"><a href="#CLAccuracy.plot_test_ave_acc_curve_from_csv-425"><span class="linenos">425</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plot the test average accuracy curve over different training tasks from saved CSV file and save the plot to the designated directory.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>csv_path</strong> (<code>str</code>): the path to the CSV file where the <code>utils.update_test_acc_to_csv()</code> saved the test accuracy metric.</li>
<li><strong>plot_path</strong> (<code>str</code>): the path to save plot. Better same as the output directory of the experiment. E.g. './outputs/expr_name/1970-01-01_00-00-00/ave_acc.png'.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="CLLoss">
                            <input id="CLLoss-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CLLoss</span><wbr>(<span class="base"><a href="#MetricCallback">clarena.metrics.MetricCallback</a></span>):

                <label class="view-source-button" for="CLLoss-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLLoss"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLLoss-27"><a href="#CLLoss-27"><span class="linenos"> 27</span></a><span class="k">class</span><span class="w"> </span><span class="nc">CLLoss</span><span class="p">(</span><span class="n">MetricCallback</span><span class="p">):</span>
</span><span id="CLLoss-28"><a href="#CLLoss-28"><span class="linenos"> 28</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Provides all actions that are related to CL loss metrics, which include:</span>
</span><span id="CLLoss-29"><a href="#CLLoss-29"><span class="linenos"> 29</span></a>
</span><span id="CLLoss-30"><a href="#CLLoss-30"><span class="linenos"> 30</span></a><span class="sd">    - Defining, initializing and recording loss metrics.</span>
</span><span id="CLLoss-31"><a href="#CLLoss-31"><span class="linenos"> 31</span></a><span class="sd">    - Logging training and validation loss metrics to Lightning loggers in real time.</span>
</span><span id="CLLoss-32"><a href="#CLLoss-32"><span class="linenos"> 32</span></a><span class="sd">    - Saving test loss metrics to files.</span>
</span><span id="CLLoss-33"><a href="#CLLoss-33"><span class="linenos"> 33</span></a><span class="sd">    - Visualizing test loss metrics as plots.</span>
</span><span id="CLLoss-34"><a href="#CLLoss-34"><span class="linenos"> 34</span></a>
</span><span id="CLLoss-35"><a href="#CLLoss-35"><span class="linenos"> 35</span></a>
</span><span id="CLLoss-36"><a href="#CLLoss-36"><span class="linenos"> 36</span></a><span class="sd">    The callback is able to produce the following outputs:</span>
</span><span id="CLLoss-37"><a href="#CLLoss-37"><span class="linenos"> 37</span></a>
</span><span id="CLLoss-38"><a href="#CLLoss-38"><span class="linenos"> 38</span></a><span class="sd">    - CSV files for classification loss (lower triangular) matrix and average classification loss. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-test-performance-of-previous-tasks) for details.</span>
</span><span id="CLLoss-39"><a href="#CLLoss-39"><span class="linenos"> 39</span></a><span class="sd">    - Coloured plot for test classification loss (lower triangular) matrix. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-test-performance-of-previous-tasks) for details.</span>
</span><span id="CLLoss-40"><a href="#CLLoss-40"><span class="linenos"> 40</span></a><span class="sd">    - Curve plots for test average classification loss over different training tasks. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-average-test-performance-over-tasks) for details.</span>
</span><span id="CLLoss-41"><a href="#CLLoss-41"><span class="linenos"> 41</span></a>
</span><span id="CLLoss-42"><a href="#CLLoss-42"><span class="linenos"> 42</span></a><span class="sd">    Please refer to the [A Summary of Continual Learning Metrics](https://pengxiang-wang.com/posts/continual-learning-metrics) to learn about this metric.</span>
</span><span id="CLLoss-43"><a href="#CLLoss-43"><span class="linenos"> 43</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="CLLoss-44"><a href="#CLLoss-44"><span class="linenos"> 44</span></a>
</span><span id="CLLoss-45"><a href="#CLLoss-45"><span class="linenos"> 45</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="CLLoss-46"><a href="#CLLoss-46"><span class="linenos"> 46</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLLoss-47"><a href="#CLLoss-47"><span class="linenos"> 47</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CLLoss-48"><a href="#CLLoss-48"><span class="linenos"> 48</span></a>        <span class="n">test_loss_cls_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;loss_cls.csv&quot;</span><span class="p">,</span>
</span><span id="CLLoss-49"><a href="#CLLoss-49"><span class="linenos"> 49</span></a>        <span class="n">test_loss_cls_matrix_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CLLoss-50"><a href="#CLLoss-50"><span class="linenos"> 50</span></a>        <span class="n">test_ave_loss_cls_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CLLoss-51"><a href="#CLLoss-51"><span class="linenos"> 51</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss-52"><a href="#CLLoss-52"><span class="linenos"> 52</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `CLLoss`.</span>
</span><span id="CLLoss-53"><a href="#CLLoss-53"><span class="linenos"> 53</span></a>
</span><span id="CLLoss-54"><a href="#CLLoss-54"><span class="linenos"> 54</span></a><span class="sd">        **Args:**</span>
</span><span id="CLLoss-55"><a href="#CLLoss-55"><span class="linenos"> 55</span></a><span class="sd">        - **save_dir** (`str`): The directory where data and figures of metrics will be saved. Better inside the output folder.</span>
</span><span id="CLLoss-56"><a href="#CLLoss-56"><span class="linenos"> 56</span></a><span class="sd">        - **test_loss_cls_csv_name**(`str`): file name to save classification loss matrix and average classification loss as CSV file.</span>
</span><span id="CLLoss-57"><a href="#CLLoss-57"><span class="linenos"> 57</span></a><span class="sd">        - **test_loss_cls_matrix_plot_name** (`str` | `None`): file name to save classification loss matrix plot. If `None`, no file will be saved.</span>
</span><span id="CLLoss-58"><a href="#CLLoss-58"><span class="linenos"> 58</span></a><span class="sd">        - **test_ave_loss_cls_plot_name** (`str` | `None`): file name to save average classification loss as curve plot over different training tasks. If `None`, no file will be saved.</span>
</span><span id="CLLoss-59"><a href="#CLLoss-59"><span class="linenos"> 59</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLLoss-60"><a href="#CLLoss-60"><span class="linenos"> 60</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="CLLoss-61"><a href="#CLLoss-61"><span class="linenos"> 61</span></a>
</span><span id="CLLoss-62"><a href="#CLLoss-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_csv_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="CLLoss-63"><a href="#CLLoss-63"><span class="linenos"> 63</span></a>            <span class="n">save_dir</span><span class="p">,</span> <span class="n">test_loss_cls_csv_name</span>
</span><span id="CLLoss-64"><a href="#CLLoss-64"><span class="linenos"> 64</span></a>        <span class="p">)</span>
</span><span id="CLLoss-65"><a href="#CLLoss-65"><span class="linenos"> 65</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the path to save test classification loss matrix and average classification loss CSV file.&quot;&quot;&quot;</span>
</span><span id="CLLoss-66"><a href="#CLLoss-66"><span class="linenos"> 66</span></a>        <span class="k">if</span> <span class="n">test_loss_cls_matrix_plot_name</span><span class="p">:</span>
</span><span id="CLLoss-67"><a href="#CLLoss-67"><span class="linenos"> 67</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_matrix_plot_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="CLLoss-68"><a href="#CLLoss-68"><span class="linenos"> 68</span></a>                <span class="n">save_dir</span><span class="p">,</span> <span class="n">test_loss_cls_matrix_plot_name</span>
</span><span id="CLLoss-69"><a href="#CLLoss-69"><span class="linenos"> 69</span></a>            <span class="p">)</span>
</span><span id="CLLoss-70"><a href="#CLLoss-70"><span class="linenos"> 70</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the path to save test classification loss matrix plot.&quot;&quot;&quot;</span>
</span><span id="CLLoss-71"><a href="#CLLoss-71"><span class="linenos"> 71</span></a>        <span class="k">if</span> <span class="n">test_ave_loss_cls_plot_name</span><span class="p">:</span>
</span><span id="CLLoss-72"><a href="#CLLoss-72"><span class="linenos"> 72</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_ave_loss_cls_plot_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="CLLoss-73"><a href="#CLLoss-73"><span class="linenos"> 73</span></a>                <span class="n">save_dir</span><span class="p">,</span> <span class="n">test_ave_loss_cls_plot_name</span>
</span><span id="CLLoss-74"><a href="#CLLoss-74"><span class="linenos"> 74</span></a>            <span class="p">)</span>
</span><span id="CLLoss-75"><a href="#CLLoss-75"><span class="linenos"> 75</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the path to save test average classification loss curve plot.&quot;&quot;&quot;</span>
</span><span id="CLLoss-76"><a href="#CLLoss-76"><span class="linenos"> 76</span></a>
</span><span id="CLLoss-77"><a href="#CLLoss-77"><span class="linenos"> 77</span></a>        <span class="c1"># training accumulated metrics</span>
</span><span id="CLLoss-78"><a href="#CLLoss-78"><span class="linenos"> 78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="CLLoss-79"><a href="#CLLoss-79"><span class="linenos"> 79</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Classification loss of training epoch. Accumulated and calculated from the training batches. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-performance-of-training-epoch) for details. &quot;&quot;&quot;</span>
</span><span id="CLLoss-80"><a href="#CLLoss-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_training_epoch</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="CLLoss-81"><a href="#CLLoss-81"><span class="linenos"> 81</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Total loss of training epoch. Accumulated and calculated from the training batches. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-performance-of-training-epoch) for details. &quot;&quot;&quot;</span>
</span><span id="CLLoss-82"><a href="#CLLoss-82"><span class="linenos"> 82</span></a>
</span><span id="CLLoss-83"><a href="#CLLoss-83"><span class="linenos"> 83</span></a>        <span class="c1"># validation accumulated metrics</span>
</span><span id="CLLoss-84"><a href="#CLLoss-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="CLLoss-85"><a href="#CLLoss-85"><span class="linenos"> 85</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Validation classification of the model loss after training epoch. Accumulated and calculated from the validation batches. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-validation-performace) for details. &quot;&quot;&quot;</span>
</span><span id="CLLoss-86"><a href="#CLLoss-86"><span class="linenos"> 86</span></a>
</span><span id="CLLoss-87"><a href="#CLLoss-87"><span class="linenos"> 87</span></a>        <span class="c1"># test accumulated metrics</span>
</span><span id="CLLoss-88"><a href="#CLLoss-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">]</span>
</span><span id="CLLoss-89"><a href="#CLLoss-89"><span class="linenos"> 89</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Test classification loss of the current model (`self.task_id`) on current and previous tasks. Accumulated and calculated from the test batches. Keys are task IDs and values are the corresponding metrics. It is the last row of the lower triangular matrix. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-test-performance-of-previous-tasks) for details. &quot;&quot;&quot;</span>
</span><span id="CLLoss-90"><a href="#CLLoss-90"><span class="linenos"> 90</span></a>
</span><span id="CLLoss-91"><a href="#CLLoss-91"><span class="linenos"> 91</span></a>        <span class="c1"># task ID controls</span>
</span><span id="CLLoss-92"><a href="#CLLoss-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="CLLoss-93"><a href="#CLLoss-93"><span class="linenos"> 93</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Task ID counter indicating which task is being processed. Self updated during the task loop. Starting from 1. &quot;&quot;&quot;</span>
</span><span id="CLLoss-94"><a href="#CLLoss-94"><span class="linenos"> 94</span></a>
</span><span id="CLLoss-95"><a href="#CLLoss-95"><span class="linenos"> 95</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLLoss-96"><a href="#CLLoss-96"><span class="linenos"> 96</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_fit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss-97"><a href="#CLLoss-97"><span class="linenos"> 97</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize training and validation metrics.&quot;&quot;&quot;</span>
</span><span id="CLLoss-98"><a href="#CLLoss-98"><span class="linenos"> 98</span></a>
</span><span id="CLLoss-99"><a href="#CLLoss-99"><span class="linenos"> 99</span></a>        <span class="c1"># set the current task_id from the `CLAlgorithm` object</span>
</span><span id="CLLoss-100"><a href="#CLLoss-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">task_id</span>
</span><span id="CLLoss-101"><a href="#CLLoss-101"><span class="linenos">101</span></a>
</span><span id="CLLoss-102"><a href="#CLLoss-102"><span class="linenos">102</span></a>        <span class="c1"># get the device to put the metrics on the same device</span>
</span><span id="CLLoss-103"><a href="#CLLoss-103"><span class="linenos">103</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">device</span>
</span><span id="CLLoss-104"><a href="#CLLoss-104"><span class="linenos">104</span></a>
</span><span id="CLLoss-105"><a href="#CLLoss-105"><span class="linenos">105</span></a>        <span class="c1"># initialize training metrics</span>
</span><span id="CLLoss-106"><a href="#CLLoss-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="CLLoss-107"><a href="#CLLoss-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_training_epoch</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="CLLoss-108"><a href="#CLLoss-108"><span class="linenos">108</span></a>
</span><span id="CLLoss-109"><a href="#CLLoss-109"><span class="linenos">109</span></a>        <span class="c1"># initialize validation metrics</span>
</span><span id="CLLoss-110"><a href="#CLLoss-110"><span class="linenos">110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="CLLoss-111"><a href="#CLLoss-111"><span class="linenos">111</span></a>
</span><span id="CLLoss-112"><a href="#CLLoss-112"><span class="linenos">112</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLLoss-113"><a href="#CLLoss-113"><span class="linenos">113</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span>
</span><span id="CLLoss-114"><a href="#CLLoss-114"><span class="linenos">114</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLLoss-115"><a href="#CLLoss-115"><span class="linenos">115</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLLoss-116"><a href="#CLLoss-116"><span class="linenos">116</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLLoss-117"><a href="#CLLoss-117"><span class="linenos">117</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="CLLoss-118"><a href="#CLLoss-118"><span class="linenos">118</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="CLLoss-119"><a href="#CLLoss-119"><span class="linenos">119</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CLLoss-120"><a href="#CLLoss-120"><span class="linenos">120</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss-121"><a href="#CLLoss-121"><span class="linenos">121</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Record training metrics from training batch, log metrics of training batch and accumulated metrics of the epoch to Lightning loggers.</span>
</span><span id="CLLoss-122"><a href="#CLLoss-122"><span class="linenos">122</span></a>
</span><span id="CLLoss-123"><a href="#CLLoss-123"><span class="linenos">123</span></a><span class="sd">        **Args:**</span>
</span><span id="CLLoss-124"><a href="#CLLoss-124"><span class="linenos">124</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the training step, the returns of the `training_step()` method in the `CLAlgorithm`.</span>
</span><span id="CLLoss-125"><a href="#CLLoss-125"><span class="linenos">125</span></a><span class="sd">        - **batch** (`Any`): the training data batch.</span>
</span><span id="CLLoss-126"><a href="#CLLoss-126"><span class="linenos">126</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLLoss-127"><a href="#CLLoss-127"><span class="linenos">127</span></a>        <span class="c1"># get the batch size</span>
</span><span id="CLLoss-128"><a href="#CLLoss-128"><span class="linenos">128</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="CLLoss-129"><a href="#CLLoss-129"><span class="linenos">129</span></a>
</span><span id="CLLoss-130"><a href="#CLLoss-130"><span class="linenos">130</span></a>        <span class="c1"># get training metrics values of current training batch from the outputs of the `training_step()`</span>
</span><span id="CLLoss-131"><a href="#CLLoss-131"><span class="linenos">131</span></a>        <span class="n">loss_cls_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="CLLoss-132"><a href="#CLLoss-132"><span class="linenos">132</span></a>        <span class="n">loss_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span>
</span><span id="CLLoss-133"><a href="#CLLoss-133"><span class="linenos">133</span></a>
</span><span id="CLLoss-134"><a href="#CLLoss-134"><span class="linenos">134</span></a>        <span class="c1"># update accumulated training metrics to calculate training metrics of the epoch</span>
</span><span id="CLLoss-135"><a href="#CLLoss-135"><span class="linenos">135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="CLLoss-136"><a href="#CLLoss-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_training_epoch</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="CLLoss-137"><a href="#CLLoss-137"><span class="linenos">137</span></a>
</span><span id="CLLoss-138"><a href="#CLLoss-138"><span class="linenos">138</span></a>        <span class="c1"># log training metrics of current training batch to Lightning loggers</span>
</span><span id="CLLoss-139"><a href="#CLLoss-139"><span class="linenos">139</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="CLLoss-140"><a href="#CLLoss-140"><span class="linenos">140</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/train/loss_cls_batch&quot;</span><span class="p">,</span> <span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span>
</span><span id="CLLoss-141"><a href="#CLLoss-141"><span class="linenos">141</span></a>        <span class="p">)</span>
</span><span id="CLLoss-142"><a href="#CLLoss-142"><span class="linenos">142</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="CLLoss-143"><a href="#CLLoss-143"><span class="linenos">143</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/train/loss_batch&quot;</span><span class="p">,</span> <span class="n">loss_batch</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span>
</span><span id="CLLoss-144"><a href="#CLLoss-144"><span class="linenos">144</span></a>        <span class="p">)</span>
</span><span id="CLLoss-145"><a href="#CLLoss-145"><span class="linenos">145</span></a>
</span><span id="CLLoss-146"><a href="#CLLoss-146"><span class="linenos">146</span></a>        <span class="c1"># log accumulated training metrics till this training batch to Lightning loggers</span>
</span><span id="CLLoss-147"><a href="#CLLoss-147"><span class="linenos">147</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="CLLoss-148"><a href="#CLLoss-148"><span class="linenos">148</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/train/loss_cls&quot;</span><span class="p">,</span>
</span><span id="CLLoss-149"><a href="#CLLoss-149"><span class="linenos">149</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="CLLoss-150"><a href="#CLLoss-150"><span class="linenos">150</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLLoss-151"><a href="#CLLoss-151"><span class="linenos">151</span></a>        <span class="p">)</span>
</span><span id="CLLoss-152"><a href="#CLLoss-152"><span class="linenos">152</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="CLLoss-153"><a href="#CLLoss-153"><span class="linenos">153</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/train/loss&quot;</span><span class="p">,</span>
</span><span id="CLLoss-154"><a href="#CLLoss-154"><span class="linenos">154</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="CLLoss-155"><a href="#CLLoss-155"><span class="linenos">155</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLLoss-156"><a href="#CLLoss-156"><span class="linenos">156</span></a>        <span class="p">)</span>
</span><span id="CLLoss-157"><a href="#CLLoss-157"><span class="linenos">157</span></a>
</span><span id="CLLoss-158"><a href="#CLLoss-158"><span class="linenos">158</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLLoss-159"><a href="#CLLoss-159"><span class="linenos">159</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_epoch_end</span><span class="p">(</span>
</span><span id="CLLoss-160"><a href="#CLLoss-160"><span class="linenos">160</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLLoss-161"><a href="#CLLoss-161"><span class="linenos">161</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLLoss-162"><a href="#CLLoss-162"><span class="linenos">162</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLLoss-163"><a href="#CLLoss-163"><span class="linenos">163</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss-164"><a href="#CLLoss-164"><span class="linenos">164</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log metrics of training epoch to plot learning curves and reset the metrics accumulation at the end of training epoch.&quot;&quot;&quot;</span>
</span><span id="CLLoss-165"><a href="#CLLoss-165"><span class="linenos">165</span></a>
</span><span id="CLLoss-166"><a href="#CLLoss-166"><span class="linenos">166</span></a>        <span class="c1"># log the accumulated and computed metrics of the epoch to Lightning loggers, specially for plotting learning curves</span>
</span><span id="CLLoss-167"><a href="#CLLoss-167"><span class="linenos">167</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="CLLoss-168"><a href="#CLLoss-168"><span class="linenos">168</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/learning_curve/train/loss_cls&quot;</span><span class="p">,</span>
</span><span id="CLLoss-169"><a href="#CLLoss-169"><span class="linenos">169</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="CLLoss-170"><a href="#CLLoss-170"><span class="linenos">170</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLLoss-171"><a href="#CLLoss-171"><span class="linenos">171</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLLoss-172"><a href="#CLLoss-172"><span class="linenos">172</span></a>        <span class="p">)</span>
</span><span id="CLLoss-173"><a href="#CLLoss-173"><span class="linenos">173</span></a>
</span><span id="CLLoss-174"><a href="#CLLoss-174"><span class="linenos">174</span></a>        <span class="c1"># reset the metrics of training epoch as there are more epochs to go and not only one epoch like in the validation and test</span>
</span><span id="CLLoss-175"><a href="#CLLoss-175"><span class="linenos">175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span><span id="CLLoss-176"><a href="#CLLoss-176"><span class="linenos">176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_training_epoch</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span><span id="CLLoss-177"><a href="#CLLoss-177"><span class="linenos">177</span></a>
</span><span id="CLLoss-178"><a href="#CLLoss-178"><span class="linenos">178</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLLoss-179"><a href="#CLLoss-179"><span class="linenos">179</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_batch_end</span><span class="p">(</span>
</span><span id="CLLoss-180"><a href="#CLLoss-180"><span class="linenos">180</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLLoss-181"><a href="#CLLoss-181"><span class="linenos">181</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLLoss-182"><a href="#CLLoss-182"><span class="linenos">182</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLLoss-183"><a href="#CLLoss-183"><span class="linenos">183</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="CLLoss-184"><a href="#CLLoss-184"><span class="linenos">184</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="CLLoss-185"><a href="#CLLoss-185"><span class="linenos">185</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CLLoss-186"><a href="#CLLoss-186"><span class="linenos">186</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss-187"><a href="#CLLoss-187"><span class="linenos">187</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from validation batch. We don&#39;t need to log and monitor the metrics of validation batches.</span>
</span><span id="CLLoss-188"><a href="#CLLoss-188"><span class="linenos">188</span></a>
</span><span id="CLLoss-189"><a href="#CLLoss-189"><span class="linenos">189</span></a><span class="sd">        **Args:**</span>
</span><span id="CLLoss-190"><a href="#CLLoss-190"><span class="linenos">190</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the validation step, which is the returns of the `validation_step()` method in the `CLAlgorithm`.</span>
</span><span id="CLLoss-191"><a href="#CLLoss-191"><span class="linenos">191</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="CLLoss-192"><a href="#CLLoss-192"><span class="linenos">192</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLLoss-193"><a href="#CLLoss-193"><span class="linenos">193</span></a>
</span><span id="CLLoss-194"><a href="#CLLoss-194"><span class="linenos">194</span></a>        <span class="c1"># get the batch size</span>
</span><span id="CLLoss-195"><a href="#CLLoss-195"><span class="linenos">195</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="CLLoss-196"><a href="#CLLoss-196"><span class="linenos">196</span></a>
</span><span id="CLLoss-197"><a href="#CLLoss-197"><span class="linenos">197</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="CLLoss-198"><a href="#CLLoss-198"><span class="linenos">198</span></a>        <span class="n">loss_cls_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="CLLoss-199"><a href="#CLLoss-199"><span class="linenos">199</span></a>
</span><span id="CLLoss-200"><a href="#CLLoss-200"><span class="linenos">200</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the validation metrics</span>
</span><span id="CLLoss-201"><a href="#CLLoss-201"><span class="linenos">201</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="CLLoss-202"><a href="#CLLoss-202"><span class="linenos">202</span></a>
</span><span id="CLLoss-203"><a href="#CLLoss-203"><span class="linenos">203</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLLoss-204"><a href="#CLLoss-204"><span class="linenos">204</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_epoch_end</span><span class="p">(</span>
</span><span id="CLLoss-205"><a href="#CLLoss-205"><span class="linenos">205</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLLoss-206"><a href="#CLLoss-206"><span class="linenos">206</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLLoss-207"><a href="#CLLoss-207"><span class="linenos">207</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLLoss-208"><a href="#CLLoss-208"><span class="linenos">208</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss-209"><a href="#CLLoss-209"><span class="linenos">209</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log validation metrics to plot learning curves.&quot;&quot;&quot;</span>
</span><span id="CLLoss-210"><a href="#CLLoss-210"><span class="linenos">210</span></a>
</span><span id="CLLoss-211"><a href="#CLLoss-211"><span class="linenos">211</span></a>        <span class="c1"># log the accumulated and computed metrics of the epoch to Lightning loggers, specially for plotting learning curves</span>
</span><span id="CLLoss-212"><a href="#CLLoss-212"><span class="linenos">212</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="CLLoss-213"><a href="#CLLoss-213"><span class="linenos">213</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/learning_curve/val/loss_cls&quot;</span><span class="p">,</span>
</span><span id="CLLoss-214"><a href="#CLLoss-214"><span class="linenos">214</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="CLLoss-215"><a href="#CLLoss-215"><span class="linenos">215</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLLoss-216"><a href="#CLLoss-216"><span class="linenos">216</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLLoss-217"><a href="#CLLoss-217"><span class="linenos">217</span></a>        <span class="p">)</span>
</span><span id="CLLoss-218"><a href="#CLLoss-218"><span class="linenos">218</span></a>
</span><span id="CLLoss-219"><a href="#CLLoss-219"><span class="linenos">219</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLLoss-220"><a href="#CLLoss-220"><span class="linenos">220</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_start</span><span class="p">(</span>
</span><span id="CLLoss-221"><a href="#CLLoss-221"><span class="linenos">221</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLLoss-222"><a href="#CLLoss-222"><span class="linenos">222</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLLoss-223"><a href="#CLLoss-223"><span class="linenos">223</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLLoss-224"><a href="#CLLoss-224"><span class="linenos">224</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss-225"><a href="#CLLoss-225"><span class="linenos">225</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the metrics for testing each seen task in the beginning of a task&#39;s testing.&quot;&quot;&quot;</span>
</span><span id="CLLoss-226"><a href="#CLLoss-226"><span class="linenos">226</span></a>
</span><span id="CLLoss-227"><a href="#CLLoss-227"><span class="linenos">227</span></a>        <span class="c1"># set the current task_id again (double checking) from the `CLAlgorithm` object</span>
</span><span id="CLLoss-228"><a href="#CLLoss-228"><span class="linenos">228</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">task_id</span>
</span><span id="CLLoss-229"><a href="#CLLoss-229"><span class="linenos">229</span></a>
</span><span id="CLLoss-230"><a href="#CLLoss-230"><span class="linenos">230</span></a>        <span class="c1"># get the device to put the metrics on the same device</span>
</span><span id="CLLoss-231"><a href="#CLLoss-231"><span class="linenos">231</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">device</span>
</span><span id="CLLoss-232"><a href="#CLLoss-232"><span class="linenos">232</span></a>
</span><span id="CLLoss-233"><a href="#CLLoss-233"><span class="linenos">233</span></a>        <span class="c1"># initialize test metrics for current and previous tasks</span>
</span><span id="CLLoss-234"><a href="#CLLoss-234"><span class="linenos">234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="CLLoss-235"><a href="#CLLoss-235"><span class="linenos">235</span></a>            <span class="n">task_id</span><span class="p">:</span> <span class="n">MeanMetricBatch</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">processed_task_ids</span>
</span><span id="CLLoss-236"><a href="#CLLoss-236"><span class="linenos">236</span></a>        <span class="p">}</span>
</span><span id="CLLoss-237"><a href="#CLLoss-237"><span class="linenos">237</span></a>
</span><span id="CLLoss-238"><a href="#CLLoss-238"><span class="linenos">238</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLLoss-239"><a href="#CLLoss-239"><span class="linenos">239</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_batch_end</span><span class="p">(</span>
</span><span id="CLLoss-240"><a href="#CLLoss-240"><span class="linenos">240</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLLoss-241"><a href="#CLLoss-241"><span class="linenos">241</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLLoss-242"><a href="#CLLoss-242"><span class="linenos">242</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLLoss-243"><a href="#CLLoss-243"><span class="linenos">243</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="CLLoss-244"><a href="#CLLoss-244"><span class="linenos">244</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="CLLoss-245"><a href="#CLLoss-245"><span class="linenos">245</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CLLoss-246"><a href="#CLLoss-246"><span class="linenos">246</span></a>        <span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="CLLoss-247"><a href="#CLLoss-247"><span class="linenos">247</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss-248"><a href="#CLLoss-248"><span class="linenos">248</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from test batch. We don&#39;t need to log and monitor the metrics of test batches.</span>
</span><span id="CLLoss-249"><a href="#CLLoss-249"><span class="linenos">249</span></a>
</span><span id="CLLoss-250"><a href="#CLLoss-250"><span class="linenos">250</span></a><span class="sd">        **Args:**</span>
</span><span id="CLLoss-251"><a href="#CLLoss-251"><span class="linenos">251</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the test step, which is the returns of the `test_step()` method in the `CLAlgorithm`.</span>
</span><span id="CLLoss-252"><a href="#CLLoss-252"><span class="linenos">252</span></a><span class="sd">        - **batch** (`Any`): the test data batch.</span>
</span><span id="CLLoss-253"><a href="#CLLoss-253"><span class="linenos">253</span></a><span class="sd">        - **dataloader_idx** (`int`): the task ID of seen tasks to be tested. A default value of 0 is given otherwise the LightningModule will raise a `RuntimeError`.</span>
</span><span id="CLLoss-254"><a href="#CLLoss-254"><span class="linenos">254</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLLoss-255"><a href="#CLLoss-255"><span class="linenos">255</span></a>
</span><span id="CLLoss-256"><a href="#CLLoss-256"><span class="linenos">256</span></a>        <span class="c1"># get the batch size</span>
</span><span id="CLLoss-257"><a href="#CLLoss-257"><span class="linenos">257</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="CLLoss-258"><a href="#CLLoss-258"><span class="linenos">258</span></a>
</span><span id="CLLoss-259"><a href="#CLLoss-259"><span class="linenos">259</span></a>        <span class="n">test_task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">get_test_task_id_from_dataloader_idx</span><span class="p">(</span><span class="n">dataloader_idx</span><span class="p">)</span>
</span><span id="CLLoss-260"><a href="#CLLoss-260"><span class="linenos">260</span></a>
</span><span id="CLLoss-261"><a href="#CLLoss-261"><span class="linenos">261</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="CLLoss-262"><a href="#CLLoss-262"><span class="linenos">262</span></a>        <span class="n">loss_cls_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="CLLoss-263"><a href="#CLLoss-263"><span class="linenos">263</span></a>
</span><span id="CLLoss-264"><a href="#CLLoss-264"><span class="linenos">264</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the metrics of the epoch</span>
</span><span id="CLLoss-265"><a href="#CLLoss-265"><span class="linenos">265</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="p">[</span><span class="n">test_task_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="CLLoss-266"><a href="#CLLoss-266"><span class="linenos">266</span></a>
</span><span id="CLLoss-267"><a href="#CLLoss-267"><span class="linenos">267</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLLoss-268"><a href="#CLLoss-268"><span class="linenos">268</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_epoch_end</span><span class="p">(</span>
</span><span id="CLLoss-269"><a href="#CLLoss-269"><span class="linenos">269</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLLoss-270"><a href="#CLLoss-270"><span class="linenos">270</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLLoss-271"><a href="#CLLoss-271"><span class="linenos">271</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLLoss-272"><a href="#CLLoss-272"><span class="linenos">272</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss-273"><a href="#CLLoss-273"><span class="linenos">273</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save and plot test metrics at the end of test.&quot;&quot;&quot;</span>
</span><span id="CLLoss-274"><a href="#CLLoss-274"><span class="linenos">274</span></a>
</span><span id="CLLoss-275"><a href="#CLLoss-275"><span class="linenos">275</span></a>        <span class="c1"># save (update) the test metrics to CSV files</span>
</span><span id="CLLoss-276"><a href="#CLLoss-276"><span class="linenos">276</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_test_loss_cls_to_csv</span><span class="p">(</span>
</span><span id="CLLoss-277"><a href="#CLLoss-277"><span class="linenos">277</span></a>            <span class="n">after_training_task_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
</span><span id="CLLoss-278"><a href="#CLLoss-278"><span class="linenos">278</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_csv_path</span><span class="p">,</span>
</span><span id="CLLoss-279"><a href="#CLLoss-279"><span class="linenos">279</span></a>        <span class="p">)</span>
</span><span id="CLLoss-280"><a href="#CLLoss-280"><span class="linenos">280</span></a>
</span><span id="CLLoss-281"><a href="#CLLoss-281"><span class="linenos">281</span></a>        <span class="c1"># plot the test metrics</span>
</span><span id="CLLoss-282"><a href="#CLLoss-282"><span class="linenos">282</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_matrix_plot_path</span><span class="p">:</span>
</span><span id="CLLoss-283"><a href="#CLLoss-283"><span class="linenos">283</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plot_test_loss_cls_matrix_from_csv</span><span class="p">(</span>
</span><span id="CLLoss-284"><a href="#CLLoss-284"><span class="linenos">284</span></a>                <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_csv_path</span><span class="p">,</span>
</span><span id="CLLoss-285"><a href="#CLLoss-285"><span class="linenos">285</span></a>                <span class="n">plot_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_matrix_plot_path</span><span class="p">,</span>
</span><span id="CLLoss-286"><a href="#CLLoss-286"><span class="linenos">286</span></a>            <span class="p">)</span>
</span><span id="CLLoss-287"><a href="#CLLoss-287"><span class="linenos">287</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_ave_loss_cls_plot_path</span><span class="p">:</span>
</span><span id="CLLoss-288"><a href="#CLLoss-288"><span class="linenos">288</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plot_test_ave_loss_cls_curve_from_csv</span><span class="p">(</span>
</span><span id="CLLoss-289"><a href="#CLLoss-289"><span class="linenos">289</span></a>                <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_csv_path</span><span class="p">,</span>
</span><span id="CLLoss-290"><a href="#CLLoss-290"><span class="linenos">290</span></a>                <span class="n">plot_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_ave_loss_cls_plot_path</span><span class="p">,</span>
</span><span id="CLLoss-291"><a href="#CLLoss-291"><span class="linenos">291</span></a>            <span class="p">)</span>
</span><span id="CLLoss-292"><a href="#CLLoss-292"><span class="linenos">292</span></a>
</span><span id="CLLoss-293"><a href="#CLLoss-293"><span class="linenos">293</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_test_loss_cls_to_csv</span><span class="p">(</span>
</span><span id="CLLoss-294"><a href="#CLLoss-294"><span class="linenos">294</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLLoss-295"><a href="#CLLoss-295"><span class="linenos">295</span></a>        <span class="n">after_training_task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CLLoss-296"><a href="#CLLoss-296"><span class="linenos">296</span></a>        <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CLLoss-297"><a href="#CLLoss-297"><span class="linenos">297</span></a>        <span class="n">skipped_task_ids_for_ave</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CLLoss-298"><a href="#CLLoss-298"><span class="linenos">298</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss-299"><a href="#CLLoss-299"><span class="linenos">299</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the test classification loss metrics of seen tasks at the last line to an existing CSV file. A new file will be created if not existing.</span>
</span><span id="CLLoss-300"><a href="#CLLoss-300"><span class="linenos">300</span></a>
</span><span id="CLLoss-301"><a href="#CLLoss-301"><span class="linenos">301</span></a><span class="sd">        **Args:**</span>
</span><span id="CLLoss-302"><a href="#CLLoss-302"><span class="linenos">302</span></a><span class="sd">        - **after_training_task_id** (`int`): the task ID after training.</span>
</span><span id="CLLoss-303"><a href="#CLLoss-303"><span class="linenos">303</span></a><span class="sd">        - **csv_path** (`str`): save the test metric to path. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/loss_cls.csv&#39;.</span>
</span><span id="CLLoss-304"><a href="#CLLoss-304"><span class="linenos">304</span></a><span class="sd">        - **skipped_task_ids_for_ave** (`list[int]` | `None`): the task IDs that are skipped to calculate average accuracy. If `None`, no task is skipped. Default: `None`.</span>
</span><span id="CLLoss-305"><a href="#CLLoss-305"><span class="linenos">305</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLLoss-306"><a href="#CLLoss-306"><span class="linenos">306</span></a>        <span class="n">processed_task_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="CLLoss-307"><a href="#CLLoss-307"><span class="linenos">307</span></a>        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;after_training_task&quot;</span><span class="p">,</span> <span class="s2">&quot;average_classification_loss&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="CLLoss-308"><a href="#CLLoss-308"><span class="linenos">308</span></a>            <span class="sa">f</span><span class="s2">&quot;test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">processed_task_ids</span>
</span><span id="CLLoss-309"><a href="#CLLoss-309"><span class="linenos">309</span></a>        <span class="p">]</span>
</span><span id="CLLoss-310"><a href="#CLLoss-310"><span class="linenos">310</span></a>
</span><span id="CLLoss-311"><a href="#CLLoss-311"><span class="linenos">311</span></a>        <span class="n">new_line</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="CLLoss-312"><a href="#CLLoss-312"><span class="linenos">312</span></a>            <span class="s2">&quot;after_training_task&quot;</span><span class="p">:</span> <span class="n">after_training_task_id</span>
</span><span id="CLLoss-313"><a href="#CLLoss-313"><span class="linenos">313</span></a>        <span class="p">}</span>  <span class="c1"># construct the first column</span>
</span><span id="CLLoss-314"><a href="#CLLoss-314"><span class="linenos">314</span></a>
</span><span id="CLLoss-315"><a href="#CLLoss-315"><span class="linenos">315</span></a>        <span class="c1"># write to the columns and calculate the average classification loss over tasks at the same time</span>
</span><span id="CLLoss-316"><a href="#CLLoss-316"><span class="linenos">316</span></a>        <span class="n">average_classification_loss_over_tasks</span> <span class="o">=</span> <span class="n">MeanMetric</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
</span><span id="CLLoss-317"><a href="#CLLoss-317"><span class="linenos">317</span></a>            <span class="n">device</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">device</span>
</span><span id="CLLoss-318"><a href="#CLLoss-318"><span class="linenos">318</span></a>        <span class="p">)</span>
</span><span id="CLLoss-319"><a href="#CLLoss-319"><span class="linenos">319</span></a>        <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">processed_task_ids</span><span class="p">:</span>
</span><span id="CLLoss-320"><a href="#CLLoss-320"><span class="linenos">320</span></a>            <span class="n">loss_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="CLLoss-321"><a href="#CLLoss-321"><span class="linenos">321</span></a>            <span class="n">new_line</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_cls</span>
</span><span id="CLLoss-322"><a href="#CLLoss-322"><span class="linenos">322</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="CLLoss-323"><a href="#CLLoss-323"><span class="linenos">323</span></a>                <span class="n">skipped_task_ids_for_ave</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="CLLoss-324"><a href="#CLLoss-324"><span class="linenos">324</span></a>                <span class="ow">or</span> <span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skipped_task_ids_for_ave</span>
</span><span id="CLLoss-325"><a href="#CLLoss-325"><span class="linenos">325</span></a>            <span class="p">):</span>
</span><span id="CLLoss-326"><a href="#CLLoss-326"><span class="linenos">326</span></a>                <span class="n">average_classification_loss_over_tasks</span><span class="p">(</span><span class="n">loss_cls</span><span class="p">)</span>
</span><span id="CLLoss-327"><a href="#CLLoss-327"><span class="linenos">327</span></a>        <span class="n">new_line</span><span class="p">[</span><span class="s2">&quot;average_classification_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CLLoss-328"><a href="#CLLoss-328"><span class="linenos">328</span></a>            <span class="n">average_classification_loss_over_tasks</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="CLLoss-329"><a href="#CLLoss-329"><span class="linenos">329</span></a>        <span class="p">)</span>
</span><span id="CLLoss-330"><a href="#CLLoss-330"><span class="linenos">330</span></a>
</span><span id="CLLoss-331"><a href="#CLLoss-331"><span class="linenos">331</span></a>        <span class="c1"># write to the csv file</span>
</span><span id="CLLoss-332"><a href="#CLLoss-332"><span class="linenos">332</span></a>        <span class="n">is_first</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CLLoss-333"><a href="#CLLoss-333"><span class="linenos">333</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
</span><span id="CLLoss-334"><a href="#CLLoss-334"><span class="linenos">334</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CLLoss-335"><a href="#CLLoss-335"><span class="linenos">335</span></a>                <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span id="CLLoss-336"><a href="#CLLoss-336"><span class="linenos">336</span></a>                <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CLLoss-337"><a href="#CLLoss-337"><span class="linenos">337</span></a>        <span class="c1"># write header</span>
</span><span id="CLLoss-338"><a href="#CLLoss-338"><span class="linenos">338</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CLLoss-339"><a href="#CLLoss-339"><span class="linenos">339</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="CLLoss-340"><a href="#CLLoss-340"><span class="linenos">340</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="CLLoss-341"><a href="#CLLoss-341"><span class="linenos">341</span></a>        <span class="c1"># write metrics</span>
</span><span id="CLLoss-342"><a href="#CLLoss-342"><span class="linenos">342</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CLLoss-343"><a href="#CLLoss-343"><span class="linenos">343</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
</span><span id="CLLoss-344"><a href="#CLLoss-344"><span class="linenos">344</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>  <span class="c1"># write the previous lines</span>
</span><span id="CLLoss-345"><a href="#CLLoss-345"><span class="linenos">345</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="CLLoss-346"><a href="#CLLoss-346"><span class="linenos">346</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
</span><span id="CLLoss-347"><a href="#CLLoss-347"><span class="linenos">347</span></a>
</span><span id="CLLoss-348"><a href="#CLLoss-348"><span class="linenos">348</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_test_loss_cls_matrix_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss-349"><a href="#CLLoss-349"><span class="linenos">349</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the test classification loss matrix from saved CSV file and save the plot to the designated directory.</span>
</span><span id="CLLoss-350"><a href="#CLLoss-350"><span class="linenos">350</span></a>
</span><span id="CLLoss-351"><a href="#CLLoss-351"><span class="linenos">351</span></a><span class="sd">        **Args:**</span>
</span><span id="CLLoss-352"><a href="#CLLoss-352"><span class="linenos">352</span></a><span class="sd">        - **csv_path** (`str`): the path to the CSV file where the `utils.update_loss_cls_to_csv()` saved the test classification loss metric.</span>
</span><span id="CLLoss-353"><a href="#CLLoss-353"><span class="linenos">353</span></a><span class="sd">        - **plot_path** (`str`): the path to save plot. Better same as the output directory of the experiment. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/loss_cls_matrix.png&#39;.</span>
</span><span id="CLLoss-354"><a href="#CLLoss-354"><span class="linenos">354</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLLoss-355"><a href="#CLLoss-355"><span class="linenos">355</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CLLoss-356"><a href="#CLLoss-356"><span class="linenos">356</span></a>        <span class="n">processed_task_ids</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="CLLoss-357"><a href="#CLLoss-357"><span class="linenos">357</span></a>            <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;test_on_task_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</span><span id="CLLoss-358"><a href="#CLLoss-358"><span class="linenos">358</span></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="CLLoss-359"><a href="#CLLoss-359"><span class="linenos">359</span></a>            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;test_on_task_&quot;</span><span class="p">)</span>
</span><span id="CLLoss-360"><a href="#CLLoss-360"><span class="linenos">360</span></a>        <span class="p">]</span>
</span><span id="CLLoss-361"><a href="#CLLoss-361"><span class="linenos">361</span></a>
</span><span id="CLLoss-362"><a href="#CLLoss-362"><span class="linenos">362</span></a>        <span class="c1"># Get all columns that start with &quot;test_on_task_&quot;</span>
</span><span id="CLLoss-363"><a href="#CLLoss-363"><span class="linenos">363</span></a>        <span class="n">test_task_cols</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="CLLoss-364"><a href="#CLLoss-364"><span class="linenos">364</span></a>            <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;test_on_task_&quot;</span><span class="p">)</span>
</span><span id="CLLoss-365"><a href="#CLLoss-365"><span class="linenos">365</span></a>        <span class="p">]</span>
</span><span id="CLLoss-366"><a href="#CLLoss-366"><span class="linenos">366</span></a>        <span class="n">num_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_task_ids</span><span class="p">)</span>
</span><span id="CLLoss-367"><a href="#CLLoss-367"><span class="linenos">367</span></a>        <span class="n">num_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="CLLoss-368"><a href="#CLLoss-368"><span class="linenos">368</span></a>
</span><span id="CLLoss-369"><a href="#CLLoss-369"><span class="linenos">369</span></a>        <span class="c1"># Build the loss matrix</span>
</span><span id="CLLoss-370"><a href="#CLLoss-370"><span class="linenos">370</span></a>        <span class="n">loss_matrix</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">test_task_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="CLLoss-371"><a href="#CLLoss-371"><span class="linenos">371</span></a>
</span><span id="CLLoss-372"><a href="#CLLoss-372"><span class="linenos">372</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="CLLoss-373"><a href="#CLLoss-373"><span class="linenos">373</span></a>            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num_tasks</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_rows</span><span class="p">)</span>
</span><span id="CLLoss-374"><a href="#CLLoss-374"><span class="linenos">374</span></a>        <span class="p">)</span>  <span class="c1"># adaptive figure size</span>
</span><span id="CLLoss-375"><a href="#CLLoss-375"><span class="linenos">375</span></a>
</span><span id="CLLoss-376"><a href="#CLLoss-376"><span class="linenos">376</span></a>        <span class="n">cax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
</span><span id="CLLoss-377"><a href="#CLLoss-377"><span class="linenos">377</span></a>            <span class="n">loss_matrix</span><span class="p">,</span>
</span><span id="CLLoss-378"><a href="#CLLoss-378"><span class="linenos">378</span></a>            <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
</span><span id="CLLoss-379"><a href="#CLLoss-379"><span class="linenos">379</span></a>            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greens&quot;</span><span class="p">,</span>
</span><span id="CLLoss-380"><a href="#CLLoss-380"><span class="linenos">380</span></a>            <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="CLLoss-381"><a href="#CLLoss-381"><span class="linenos">381</span></a>        <span class="p">)</span>
</span><span id="CLLoss-382"><a href="#CLLoss-382"><span class="linenos">382</span></a>
</span><span id="CLLoss-383"><a href="#CLLoss-383"><span class="linenos">383</span></a>        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cax</span><span class="p">)</span>
</span><span id="CLLoss-384"><a href="#CLLoss-384"><span class="linenos">384</span></a>        <span class="n">yticks</span> <span class="o">=</span> <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()</span>
</span><span id="CLLoss-385"><a href="#CLLoss-385"><span class="linenos">385</span></a>        <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
</span><span id="CLLoss-386"><a href="#CLLoss-386"><span class="linenos">386</span></a>        <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="CLLoss-387"><a href="#CLLoss-387"><span class="linenos">387</span></a>            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">yticks</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CLLoss-388"><a href="#CLLoss-388"><span class="linenos">388</span></a>        <span class="p">)</span>
</span><span id="CLLoss-389"><a href="#CLLoss-389"><span class="linenos">389</span></a>
</span><span id="CLLoss-390"><a href="#CLLoss-390"><span class="linenos">390</span></a>        <span class="c1"># Annotate each cell</span>
</span><span id="CLLoss-391"><a href="#CLLoss-391"><span class="linenos">391</span></a>        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_rows</span><span class="p">):</span>
</span><span id="CLLoss-392"><a href="#CLLoss-392"><span class="linenos">392</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="CLLoss-393"><a href="#CLLoss-393"><span class="linenos">393</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="CLLoss-394"><a href="#CLLoss-394"><span class="linenos">394</span></a>                    <span class="n">c</span><span class="p">,</span>
</span><span id="CLLoss-395"><a href="#CLLoss-395"><span class="linenos">395</span></a>                    <span class="n">r</span><span class="p">,</span>
</span><span id="CLLoss-396"><a href="#CLLoss-396"><span class="linenos">396</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">loss_matrix</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="CLLoss-397"><a href="#CLLoss-397"><span class="linenos">397</span></a>                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="CLLoss-398"><a href="#CLLoss-398"><span class="linenos">398</span></a>                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="CLLoss-399"><a href="#CLLoss-399"><span class="linenos">399</span></a>                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="CLLoss-400"><a href="#CLLoss-400"><span class="linenos">400</span></a>                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">,</span>
</span><span id="CLLoss-401"><a href="#CLLoss-401"><span class="linenos">401</span></a>                <span class="p">)</span>
</span><span id="CLLoss-402"><a href="#CLLoss-402"><span class="linenos">402</span></a>
</span><span id="CLLoss-403"><a href="#CLLoss-403"><span class="linenos">403</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">))</span>
</span><span id="CLLoss-404"><a href="#CLLoss-404"><span class="linenos">404</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_rows</span><span class="p">))</span>
</span><span id="CLLoss-405"><a href="#CLLoss-405"><span class="linenos">405</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">processed_task_ids</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">)</span>
</span><span id="CLLoss-406"><a href="#CLLoss-406"><span class="linenos">406</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="CLLoss-407"><a href="#CLLoss-407"><span class="linenos">407</span></a>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;after_training_task&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CLLoss-408"><a href="#CLLoss-408"><span class="linenos">408</span></a>        <span class="p">)</span>
</span><span id="CLLoss-409"><a href="#CLLoss-409"><span class="linenos">409</span></a>
</span><span id="CLLoss-410"><a href="#CLLoss-410"><span class="linenos">410</span></a>        <span class="c1"># Labeling the axes</span>
</span><span id="CLLoss-411"><a href="#CLLoss-411"><span class="linenos">411</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Testing on task &quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">)</span>
</span><span id="CLLoss-412"><a href="#CLLoss-412"><span class="linenos">412</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;After training task t&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">)</span>
</span><span id="CLLoss-413"><a href="#CLLoss-413"><span class="linenos">413</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CLLoss-414"><a href="#CLLoss-414"><span class="linenos">414</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="CLLoss-415"><a href="#CLLoss-415"><span class="linenos">415</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span><span id="CLLoss-416"><a href="#CLLoss-416"><span class="linenos">416</span></a>
</span><span id="CLLoss-417"><a href="#CLLoss-417"><span class="linenos">417</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_test_ave_loss_cls_curve_from_csv</span><span class="p">(</span>
</span><span id="CLLoss-418"><a href="#CLLoss-418"><span class="linenos">418</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="CLLoss-419"><a href="#CLLoss-419"><span class="linenos">419</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss-420"><a href="#CLLoss-420"><span class="linenos">420</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the test average classfication loss curve over different training tasks from saved CSV file and save the plot to the designated directory.</span>
</span><span id="CLLoss-421"><a href="#CLLoss-421"><span class="linenos">421</span></a>
</span><span id="CLLoss-422"><a href="#CLLoss-422"><span class="linenos">422</span></a><span class="sd">        **Args:**</span>
</span><span id="CLLoss-423"><a href="#CLLoss-423"><span class="linenos">423</span></a><span class="sd">        - **csv_path** (`str`): the path to the CSV file where the `utils.update_test_acc_to_csv()` saved the test classfication loss metric.</span>
</span><span id="CLLoss-424"><a href="#CLLoss-424"><span class="linenos">424</span></a><span class="sd">        - **plot_path** (`str`): the path to save plot. Better same as the output directory of the experiment. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/ave_loss_cls.png&#39;.</span>
</span><span id="CLLoss-425"><a href="#CLLoss-425"><span class="linenos">425</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLLoss-426"><a href="#CLLoss-426"><span class="linenos">426</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CLLoss-427"><a href="#CLLoss-427"><span class="linenos">427</span></a>        <span class="n">after_training_tasks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;after_training_task&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="CLLoss-428"><a href="#CLLoss-428"><span class="linenos">428</span></a>
</span><span id="CLLoss-429"><a href="#CLLoss-429"><span class="linenos">429</span></a>        <span class="c1"># plot the average accuracy curve over different training tasks</span>
</span><span id="CLLoss-430"><a href="#CLLoss-430"><span class="linenos">430</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
</span><span id="CLLoss-431"><a href="#CLLoss-431"><span class="linenos">431</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="CLLoss-432"><a href="#CLLoss-432"><span class="linenos">432</span></a>            <span class="n">after_training_tasks</span><span class="p">,</span>
</span><span id="CLLoss-433"><a href="#CLLoss-433"><span class="linenos">433</span></a>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;average_classification_loss&quot;</span><span class="p">],</span>
</span><span id="CLLoss-434"><a href="#CLLoss-434"><span class="linenos">434</span></a>            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
</span><span id="CLLoss-435"><a href="#CLLoss-435"><span class="linenos">435</span></a>            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="CLLoss-436"><a href="#CLLoss-436"><span class="linenos">436</span></a>        <span class="p">)</span>
</span><span id="CLLoss-437"><a href="#CLLoss-437"><span class="linenos">437</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;After training task $t$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="CLLoss-438"><a href="#CLLoss-438"><span class="linenos">438</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Average Classification Loss&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="CLLoss-439"><a href="#CLLoss-439"><span class="linenos">439</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="CLLoss-440"><a href="#CLLoss-440"><span class="linenos">440</span></a>        <span class="n">xticks</span> <span class="o">=</span> <span class="n">after_training_tasks</span>
</span><span id="CLLoss-441"><a href="#CLLoss-441"><span class="linenos">441</span></a>        <span class="n">yticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mf">0.05</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">)]</span>
</span><span id="CLLoss-442"><a href="#CLLoss-442"><span class="linenos">442</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
</span><span id="CLLoss-443"><a href="#CLLoss-443"><span class="linenos">443</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
</span><span id="CLLoss-444"><a href="#CLLoss-444"><span class="linenos">444</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="CLLoss-445"><a href="#CLLoss-445"><span class="linenos">445</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">yticks</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="CLLoss-446"><a href="#CLLoss-446"><span class="linenos">446</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="CLLoss-447"><a href="#CLLoss-447"><span class="linenos">447</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Provides all actions that are related to CL loss metrics, which include:</p>

<ul>
<li>Defining, initializing and recording loss metrics.</li>
<li>Logging training and validation loss metrics to Lightning loggers in real time.</li>
<li>Saving test loss metrics to files.</li>
<li>Visualizing test loss metrics as plots.</li>
</ul>

<p>The callback is able to produce the following outputs:</p>

<ul>
<li>CSV files for classification loss (lower triangular) matrix and average classification loss. See <a href="https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-test-performance-of-previous-tasks">here</a> for details.</li>
<li>Coloured plot for test classification loss (lower triangular) matrix. See <a href="https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-test-performance-of-previous-tasks">here</a> for details.</li>
<li>Curve plots for test average classification loss over different training tasks. See <a href="https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-average-test-performance-over-tasks">here</a> for details.</li>
</ul>

<p>Please refer to the <a href="https://pengxiang-wang.com/posts/continual-learning-metrics">A Summary of Continual Learning Metrics</a> to learn about this metric.</p>
</div>


                            <div id="CLLoss.__init__" class="classattr">
                                        <input id="CLLoss.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">CLLoss</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">test_loss_cls_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;loss_cls.csv&#39;</span>,</span><span class="param">	<span class="n">test_loss_cls_matrix_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">test_ave_loss_cls_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="CLLoss.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLLoss.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLLoss.__init__-45"><a href="#CLLoss.__init__-45"><span class="linenos">45</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="CLLoss.__init__-46"><a href="#CLLoss.__init__-46"><span class="linenos">46</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLLoss.__init__-47"><a href="#CLLoss.__init__-47"><span class="linenos">47</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CLLoss.__init__-48"><a href="#CLLoss.__init__-48"><span class="linenos">48</span></a>        <span class="n">test_loss_cls_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;loss_cls.csv&quot;</span><span class="p">,</span>
</span><span id="CLLoss.__init__-49"><a href="#CLLoss.__init__-49"><span class="linenos">49</span></a>        <span class="n">test_loss_cls_matrix_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CLLoss.__init__-50"><a href="#CLLoss.__init__-50"><span class="linenos">50</span></a>        <span class="n">test_ave_loss_cls_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CLLoss.__init__-51"><a href="#CLLoss.__init__-51"><span class="linenos">51</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss.__init__-52"><a href="#CLLoss.__init__-52"><span class="linenos">52</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `CLLoss`.</span>
</span><span id="CLLoss.__init__-53"><a href="#CLLoss.__init__-53"><span class="linenos">53</span></a>
</span><span id="CLLoss.__init__-54"><a href="#CLLoss.__init__-54"><span class="linenos">54</span></a><span class="sd">        **Args:**</span>
</span><span id="CLLoss.__init__-55"><a href="#CLLoss.__init__-55"><span class="linenos">55</span></a><span class="sd">        - **save_dir** (`str`): The directory where data and figures of metrics will be saved. Better inside the output folder.</span>
</span><span id="CLLoss.__init__-56"><a href="#CLLoss.__init__-56"><span class="linenos">56</span></a><span class="sd">        - **test_loss_cls_csv_name**(`str`): file name to save classification loss matrix and average classification loss as CSV file.</span>
</span><span id="CLLoss.__init__-57"><a href="#CLLoss.__init__-57"><span class="linenos">57</span></a><span class="sd">        - **test_loss_cls_matrix_plot_name** (`str` | `None`): file name to save classification loss matrix plot. If `None`, no file will be saved.</span>
</span><span id="CLLoss.__init__-58"><a href="#CLLoss.__init__-58"><span class="linenos">58</span></a><span class="sd">        - **test_ave_loss_cls_plot_name** (`str` | `None`): file name to save average classification loss as curve plot over different training tasks. If `None`, no file will be saved.</span>
</span><span id="CLLoss.__init__-59"><a href="#CLLoss.__init__-59"><span class="linenos">59</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLLoss.__init__-60"><a href="#CLLoss.__init__-60"><span class="linenos">60</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="CLLoss.__init__-61"><a href="#CLLoss.__init__-61"><span class="linenos">61</span></a>
</span><span id="CLLoss.__init__-62"><a href="#CLLoss.__init__-62"><span class="linenos">62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_csv_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="CLLoss.__init__-63"><a href="#CLLoss.__init__-63"><span class="linenos">63</span></a>            <span class="n">save_dir</span><span class="p">,</span> <span class="n">test_loss_cls_csv_name</span>
</span><span id="CLLoss.__init__-64"><a href="#CLLoss.__init__-64"><span class="linenos">64</span></a>        <span class="p">)</span>
</span><span id="CLLoss.__init__-65"><a href="#CLLoss.__init__-65"><span class="linenos">65</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the path to save test classification loss matrix and average classification loss CSV file.&quot;&quot;&quot;</span>
</span><span id="CLLoss.__init__-66"><a href="#CLLoss.__init__-66"><span class="linenos">66</span></a>        <span class="k">if</span> <span class="n">test_loss_cls_matrix_plot_name</span><span class="p">:</span>
</span><span id="CLLoss.__init__-67"><a href="#CLLoss.__init__-67"><span class="linenos">67</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_matrix_plot_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="CLLoss.__init__-68"><a href="#CLLoss.__init__-68"><span class="linenos">68</span></a>                <span class="n">save_dir</span><span class="p">,</span> <span class="n">test_loss_cls_matrix_plot_name</span>
</span><span id="CLLoss.__init__-69"><a href="#CLLoss.__init__-69"><span class="linenos">69</span></a>            <span class="p">)</span>
</span><span id="CLLoss.__init__-70"><a href="#CLLoss.__init__-70"><span class="linenos">70</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the path to save test classification loss matrix plot.&quot;&quot;&quot;</span>
</span><span id="CLLoss.__init__-71"><a href="#CLLoss.__init__-71"><span class="linenos">71</span></a>        <span class="k">if</span> <span class="n">test_ave_loss_cls_plot_name</span><span class="p">:</span>
</span><span id="CLLoss.__init__-72"><a href="#CLLoss.__init__-72"><span class="linenos">72</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_ave_loss_cls_plot_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="CLLoss.__init__-73"><a href="#CLLoss.__init__-73"><span class="linenos">73</span></a>                <span class="n">save_dir</span><span class="p">,</span> <span class="n">test_ave_loss_cls_plot_name</span>
</span><span id="CLLoss.__init__-74"><a href="#CLLoss.__init__-74"><span class="linenos">74</span></a>            <span class="p">)</span>
</span><span id="CLLoss.__init__-75"><a href="#CLLoss.__init__-75"><span class="linenos">75</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the path to save test average classification loss curve plot.&quot;&quot;&quot;</span>
</span><span id="CLLoss.__init__-76"><a href="#CLLoss.__init__-76"><span class="linenos">76</span></a>
</span><span id="CLLoss.__init__-77"><a href="#CLLoss.__init__-77"><span class="linenos">77</span></a>        <span class="c1"># training accumulated metrics</span>
</span><span id="CLLoss.__init__-78"><a href="#CLLoss.__init__-78"><span class="linenos">78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="CLLoss.__init__-79"><a href="#CLLoss.__init__-79"><span class="linenos">79</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Classification loss of training epoch. Accumulated and calculated from the training batches. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-performance-of-training-epoch) for details. &quot;&quot;&quot;</span>
</span><span id="CLLoss.__init__-80"><a href="#CLLoss.__init__-80"><span class="linenos">80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_training_epoch</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="CLLoss.__init__-81"><a href="#CLLoss.__init__-81"><span class="linenos">81</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Total loss of training epoch. Accumulated and calculated from the training batches. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-performance-of-training-epoch) for details. &quot;&quot;&quot;</span>
</span><span id="CLLoss.__init__-82"><a href="#CLLoss.__init__-82"><span class="linenos">82</span></a>
</span><span id="CLLoss.__init__-83"><a href="#CLLoss.__init__-83"><span class="linenos">83</span></a>        <span class="c1"># validation accumulated metrics</span>
</span><span id="CLLoss.__init__-84"><a href="#CLLoss.__init__-84"><span class="linenos">84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="CLLoss.__init__-85"><a href="#CLLoss.__init__-85"><span class="linenos">85</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Validation classification of the model loss after training epoch. Accumulated and calculated from the validation batches. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-validation-performace) for details. &quot;&quot;&quot;</span>
</span><span id="CLLoss.__init__-86"><a href="#CLLoss.__init__-86"><span class="linenos">86</span></a>
</span><span id="CLLoss.__init__-87"><a href="#CLLoss.__init__-87"><span class="linenos">87</span></a>        <span class="c1"># test accumulated metrics</span>
</span><span id="CLLoss.__init__-88"><a href="#CLLoss.__init__-88"><span class="linenos">88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">]</span>
</span><span id="CLLoss.__init__-89"><a href="#CLLoss.__init__-89"><span class="linenos">89</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Test classification loss of the current model (`self.task_id`) on current and previous tasks. Accumulated and calculated from the test batches. Keys are task IDs and values are the corresponding metrics. It is the last row of the lower triangular matrix. See [here](https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-test-performance-of-previous-tasks) for details. &quot;&quot;&quot;</span>
</span><span id="CLLoss.__init__-90"><a href="#CLLoss.__init__-90"><span class="linenos">90</span></a>
</span><span id="CLLoss.__init__-91"><a href="#CLLoss.__init__-91"><span class="linenos">91</span></a>        <span class="c1"># task ID controls</span>
</span><span id="CLLoss.__init__-92"><a href="#CLLoss.__init__-92"><span class="linenos">92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="CLLoss.__init__-93"><a href="#CLLoss.__init__-93"><span class="linenos">93</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Task ID counter indicating which task is being processed. Self updated during the task loop. Starting from 1. &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the <code><a href="#CLLoss">CLLoss</a></code>.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>save_dir</strong> (<code>str</code>): The directory where data and figures of metrics will be saved. Better inside the output folder.</li>
<li><strong>test_loss_cls_csv_name</strong>(<code>str</code>): file name to save classification loss matrix and average classification loss as CSV file.</li>
<li><strong>test_loss_cls_matrix_plot_name</strong> (<code>str</code> | <code>None</code>): file name to save classification loss matrix plot. If <code>None</code>, no file will be saved.</li>
<li><strong>test_ave_loss_cls_plot_name</strong> (<code>str</code> | <code>None</code>): file name to save average classification loss as curve plot over different training tasks. If <code>None</code>, no file will be saved.</li>
</ul>
</div>


                            </div>
                            <div id="CLLoss.test_loss_cls_csv_path" class="classattr">
                                <div class="attr variable">
            <span class="name">test_loss_cls_csv_path</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#CLLoss.test_loss_cls_csv_path"></a>
    
            <div class="docstring"><p>Store the path to save test classification loss matrix and average classification loss CSV file.</p>
</div>


                            </div>
                            <div id="CLLoss.loss_cls_training_epoch" class="classattr">
                                <div class="attr variable">
            <span class="name">loss_cls_training_epoch</span><span class="annotation">: <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a></span>

        
    </div>
    <a class="headerlink" href="#CLLoss.loss_cls_training_epoch"></a>
    
            <div class="docstring"><p>Classification loss of training epoch. Accumulated and calculated from the training batches. See <a href="https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-performance-of-training-epoch">here</a> for details.</p>
</div>


                            </div>
                            <div id="CLLoss.loss_training_epoch" class="classattr">
                                <div class="attr variable">
            <span class="name">loss_training_epoch</span><span class="annotation">: <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a></span>

        
    </div>
    <a class="headerlink" href="#CLLoss.loss_training_epoch"></a>
    
            <div class="docstring"><p>Total loss of training epoch. Accumulated and calculated from the training batches. See <a href="https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-performance-of-training-epoch">here</a> for details.</p>
</div>


                            </div>
                            <div id="CLLoss.loss_cls_val" class="classattr">
                                <div class="attr variable">
            <span class="name">loss_cls_val</span><span class="annotation">: <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a></span>

        
    </div>
    <a class="headerlink" href="#CLLoss.loss_cls_val"></a>
    
            <div class="docstring"><p>Validation classification of the model loss after training epoch. Accumulated and calculated from the validation batches. See <a href="https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-validation-performace">here</a> for details.</p>
</div>


                            </div>
                            <div id="CLLoss.loss_cls_test" class="classattr">
                                <div class="attr variable">
            <span class="name">loss_cls_test</span><span class="annotation">: dict[int, <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a>]</span>

        
    </div>
    <a class="headerlink" href="#CLLoss.loss_cls_test"></a>
    
            <div class="docstring"><p>Test classification loss of the current model (<code>self.task_id</code>) on current and previous tasks. Accumulated and calculated from the test batches. Keys are task IDs and values are the corresponding metrics. It is the last row of the lower triangular matrix. See <a href="https://pengxiang-wang.com/posts/continual-learning-metrics.html#sec-test-performance-of-previous-tasks">here</a> for details.</p>
</div>


                            </div>
                            <div id="CLLoss.task_id" class="classattr">
                                <div class="attr variable">
            <span class="name">task_id</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#CLLoss.task_id"></a>
    
            <div class="docstring"><p>Task ID counter indicating which task is being processed. Self updated during the task loop. Starting from 1.</p>
</div>


                            </div>
                            <div id="CLLoss.on_fit_start" class="classattr">
                                        <input id="CLLoss.on_fit_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_fit_start</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLLoss.on_fit_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLLoss.on_fit_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLLoss.on_fit_start-95"><a href="#CLLoss.on_fit_start-95"><span class="linenos"> 95</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLLoss.on_fit_start-96"><a href="#CLLoss.on_fit_start-96"><span class="linenos"> 96</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_fit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss.on_fit_start-97"><a href="#CLLoss.on_fit_start-97"><span class="linenos"> 97</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize training and validation metrics.&quot;&quot;&quot;</span>
</span><span id="CLLoss.on_fit_start-98"><a href="#CLLoss.on_fit_start-98"><span class="linenos"> 98</span></a>
</span><span id="CLLoss.on_fit_start-99"><a href="#CLLoss.on_fit_start-99"><span class="linenos"> 99</span></a>        <span class="c1"># set the current task_id from the `CLAlgorithm` object</span>
</span><span id="CLLoss.on_fit_start-100"><a href="#CLLoss.on_fit_start-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">task_id</span>
</span><span id="CLLoss.on_fit_start-101"><a href="#CLLoss.on_fit_start-101"><span class="linenos">101</span></a>
</span><span id="CLLoss.on_fit_start-102"><a href="#CLLoss.on_fit_start-102"><span class="linenos">102</span></a>        <span class="c1"># get the device to put the metrics on the same device</span>
</span><span id="CLLoss.on_fit_start-103"><a href="#CLLoss.on_fit_start-103"><span class="linenos">103</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">device</span>
</span><span id="CLLoss.on_fit_start-104"><a href="#CLLoss.on_fit_start-104"><span class="linenos">104</span></a>
</span><span id="CLLoss.on_fit_start-105"><a href="#CLLoss.on_fit_start-105"><span class="linenos">105</span></a>        <span class="c1"># initialize training metrics</span>
</span><span id="CLLoss.on_fit_start-106"><a href="#CLLoss.on_fit_start-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="CLLoss.on_fit_start-107"><a href="#CLLoss.on_fit_start-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_training_epoch</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="CLLoss.on_fit_start-108"><a href="#CLLoss.on_fit_start-108"><span class="linenos">108</span></a>
</span><span id="CLLoss.on_fit_start-109"><a href="#CLLoss.on_fit_start-109"><span class="linenos">109</span></a>        <span class="c1"># initialize validation metrics</span>
</span><span id="CLLoss.on_fit_start-110"><a href="#CLLoss.on_fit_start-110"><span class="linenos">110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize training and validation metrics.</p>
</div>


                            </div>
                            <div id="CLLoss.on_train_batch_end" class="classattr">
                                        <input id="CLLoss.on_train_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_train_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLLoss.on_train_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLLoss.on_train_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLLoss.on_train_batch_end-112"><a href="#CLLoss.on_train_batch_end-112"><span class="linenos">112</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLLoss.on_train_batch_end-113"><a href="#CLLoss.on_train_batch_end-113"><span class="linenos">113</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span>
</span><span id="CLLoss.on_train_batch_end-114"><a href="#CLLoss.on_train_batch_end-114"><span class="linenos">114</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLLoss.on_train_batch_end-115"><a href="#CLLoss.on_train_batch_end-115"><span class="linenos">115</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLLoss.on_train_batch_end-116"><a href="#CLLoss.on_train_batch_end-116"><span class="linenos">116</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLLoss.on_train_batch_end-117"><a href="#CLLoss.on_train_batch_end-117"><span class="linenos">117</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="CLLoss.on_train_batch_end-118"><a href="#CLLoss.on_train_batch_end-118"><span class="linenos">118</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="CLLoss.on_train_batch_end-119"><a href="#CLLoss.on_train_batch_end-119"><span class="linenos">119</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CLLoss.on_train_batch_end-120"><a href="#CLLoss.on_train_batch_end-120"><span class="linenos">120</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss.on_train_batch_end-121"><a href="#CLLoss.on_train_batch_end-121"><span class="linenos">121</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Record training metrics from training batch, log metrics of training batch and accumulated metrics of the epoch to Lightning loggers.</span>
</span><span id="CLLoss.on_train_batch_end-122"><a href="#CLLoss.on_train_batch_end-122"><span class="linenos">122</span></a>
</span><span id="CLLoss.on_train_batch_end-123"><a href="#CLLoss.on_train_batch_end-123"><span class="linenos">123</span></a><span class="sd">        **Args:**</span>
</span><span id="CLLoss.on_train_batch_end-124"><a href="#CLLoss.on_train_batch_end-124"><span class="linenos">124</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the training step, the returns of the `training_step()` method in the `CLAlgorithm`.</span>
</span><span id="CLLoss.on_train_batch_end-125"><a href="#CLLoss.on_train_batch_end-125"><span class="linenos">125</span></a><span class="sd">        - **batch** (`Any`): the training data batch.</span>
</span><span id="CLLoss.on_train_batch_end-126"><a href="#CLLoss.on_train_batch_end-126"><span class="linenos">126</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLLoss.on_train_batch_end-127"><a href="#CLLoss.on_train_batch_end-127"><span class="linenos">127</span></a>        <span class="c1"># get the batch size</span>
</span><span id="CLLoss.on_train_batch_end-128"><a href="#CLLoss.on_train_batch_end-128"><span class="linenos">128</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="CLLoss.on_train_batch_end-129"><a href="#CLLoss.on_train_batch_end-129"><span class="linenos">129</span></a>
</span><span id="CLLoss.on_train_batch_end-130"><a href="#CLLoss.on_train_batch_end-130"><span class="linenos">130</span></a>        <span class="c1"># get training metrics values of current training batch from the outputs of the `training_step()`</span>
</span><span id="CLLoss.on_train_batch_end-131"><a href="#CLLoss.on_train_batch_end-131"><span class="linenos">131</span></a>        <span class="n">loss_cls_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="CLLoss.on_train_batch_end-132"><a href="#CLLoss.on_train_batch_end-132"><span class="linenos">132</span></a>        <span class="n">loss_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span>
</span><span id="CLLoss.on_train_batch_end-133"><a href="#CLLoss.on_train_batch_end-133"><span class="linenos">133</span></a>
</span><span id="CLLoss.on_train_batch_end-134"><a href="#CLLoss.on_train_batch_end-134"><span class="linenos">134</span></a>        <span class="c1"># update accumulated training metrics to calculate training metrics of the epoch</span>
</span><span id="CLLoss.on_train_batch_end-135"><a href="#CLLoss.on_train_batch_end-135"><span class="linenos">135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="CLLoss.on_train_batch_end-136"><a href="#CLLoss.on_train_batch_end-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_training_epoch</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="CLLoss.on_train_batch_end-137"><a href="#CLLoss.on_train_batch_end-137"><span class="linenos">137</span></a>
</span><span id="CLLoss.on_train_batch_end-138"><a href="#CLLoss.on_train_batch_end-138"><span class="linenos">138</span></a>        <span class="c1"># log training metrics of current training batch to Lightning loggers</span>
</span><span id="CLLoss.on_train_batch_end-139"><a href="#CLLoss.on_train_batch_end-139"><span class="linenos">139</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="CLLoss.on_train_batch_end-140"><a href="#CLLoss.on_train_batch_end-140"><span class="linenos">140</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/train/loss_cls_batch&quot;</span><span class="p">,</span> <span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span>
</span><span id="CLLoss.on_train_batch_end-141"><a href="#CLLoss.on_train_batch_end-141"><span class="linenos">141</span></a>        <span class="p">)</span>
</span><span id="CLLoss.on_train_batch_end-142"><a href="#CLLoss.on_train_batch_end-142"><span class="linenos">142</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="CLLoss.on_train_batch_end-143"><a href="#CLLoss.on_train_batch_end-143"><span class="linenos">143</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/train/loss_batch&quot;</span><span class="p">,</span> <span class="n">loss_batch</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span>
</span><span id="CLLoss.on_train_batch_end-144"><a href="#CLLoss.on_train_batch_end-144"><span class="linenos">144</span></a>        <span class="p">)</span>
</span><span id="CLLoss.on_train_batch_end-145"><a href="#CLLoss.on_train_batch_end-145"><span class="linenos">145</span></a>
</span><span id="CLLoss.on_train_batch_end-146"><a href="#CLLoss.on_train_batch_end-146"><span class="linenos">146</span></a>        <span class="c1"># log accumulated training metrics till this training batch to Lightning loggers</span>
</span><span id="CLLoss.on_train_batch_end-147"><a href="#CLLoss.on_train_batch_end-147"><span class="linenos">147</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="CLLoss.on_train_batch_end-148"><a href="#CLLoss.on_train_batch_end-148"><span class="linenos">148</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/train/loss_cls&quot;</span><span class="p">,</span>
</span><span id="CLLoss.on_train_batch_end-149"><a href="#CLLoss.on_train_batch_end-149"><span class="linenos">149</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="CLLoss.on_train_batch_end-150"><a href="#CLLoss.on_train_batch_end-150"><span class="linenos">150</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLLoss.on_train_batch_end-151"><a href="#CLLoss.on_train_batch_end-151"><span class="linenos">151</span></a>        <span class="p">)</span>
</span><span id="CLLoss.on_train_batch_end-152"><a href="#CLLoss.on_train_batch_end-152"><span class="linenos">152</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="CLLoss.on_train_batch_end-153"><a href="#CLLoss.on_train_batch_end-153"><span class="linenos">153</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/train/loss&quot;</span><span class="p">,</span>
</span><span id="CLLoss.on_train_batch_end-154"><a href="#CLLoss.on_train_batch_end-154"><span class="linenos">154</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="CLLoss.on_train_batch_end-155"><a href="#CLLoss.on_train_batch_end-155"><span class="linenos">155</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLLoss.on_train_batch_end-156"><a href="#CLLoss.on_train_batch_end-156"><span class="linenos">156</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Record training metrics from training batch, log metrics of training batch and accumulated metrics of the epoch to Lightning loggers.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the training step, the returns of the <code>training_step()</code> method in the <code>CLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the training data batch.</li>
</ul>
</div>


                            </div>
                            <div id="CLLoss.on_train_epoch_end" class="classattr">
                                        <input id="CLLoss.on_train_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_train_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLLoss.on_train_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLLoss.on_train_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLLoss.on_train_epoch_end-158"><a href="#CLLoss.on_train_epoch_end-158"><span class="linenos">158</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLLoss.on_train_epoch_end-159"><a href="#CLLoss.on_train_epoch_end-159"><span class="linenos">159</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_epoch_end</span><span class="p">(</span>
</span><span id="CLLoss.on_train_epoch_end-160"><a href="#CLLoss.on_train_epoch_end-160"><span class="linenos">160</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLLoss.on_train_epoch_end-161"><a href="#CLLoss.on_train_epoch_end-161"><span class="linenos">161</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLLoss.on_train_epoch_end-162"><a href="#CLLoss.on_train_epoch_end-162"><span class="linenos">162</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLLoss.on_train_epoch_end-163"><a href="#CLLoss.on_train_epoch_end-163"><span class="linenos">163</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss.on_train_epoch_end-164"><a href="#CLLoss.on_train_epoch_end-164"><span class="linenos">164</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log metrics of training epoch to plot learning curves and reset the metrics accumulation at the end of training epoch.&quot;&quot;&quot;</span>
</span><span id="CLLoss.on_train_epoch_end-165"><a href="#CLLoss.on_train_epoch_end-165"><span class="linenos">165</span></a>
</span><span id="CLLoss.on_train_epoch_end-166"><a href="#CLLoss.on_train_epoch_end-166"><span class="linenos">166</span></a>        <span class="c1"># log the accumulated and computed metrics of the epoch to Lightning loggers, specially for plotting learning curves</span>
</span><span id="CLLoss.on_train_epoch_end-167"><a href="#CLLoss.on_train_epoch_end-167"><span class="linenos">167</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="CLLoss.on_train_epoch_end-168"><a href="#CLLoss.on_train_epoch_end-168"><span class="linenos">168</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/learning_curve/train/loss_cls&quot;</span><span class="p">,</span>
</span><span id="CLLoss.on_train_epoch_end-169"><a href="#CLLoss.on_train_epoch_end-169"><span class="linenos">169</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="CLLoss.on_train_epoch_end-170"><a href="#CLLoss.on_train_epoch_end-170"><span class="linenos">170</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLLoss.on_train_epoch_end-171"><a href="#CLLoss.on_train_epoch_end-171"><span class="linenos">171</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLLoss.on_train_epoch_end-172"><a href="#CLLoss.on_train_epoch_end-172"><span class="linenos">172</span></a>        <span class="p">)</span>
</span><span id="CLLoss.on_train_epoch_end-173"><a href="#CLLoss.on_train_epoch_end-173"><span class="linenos">173</span></a>
</span><span id="CLLoss.on_train_epoch_end-174"><a href="#CLLoss.on_train_epoch_end-174"><span class="linenos">174</span></a>        <span class="c1"># reset the metrics of training epoch as there are more epochs to go and not only one epoch like in the validation and test</span>
</span><span id="CLLoss.on_train_epoch_end-175"><a href="#CLLoss.on_train_epoch_end-175"><span class="linenos">175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span><span id="CLLoss.on_train_epoch_end-176"><a href="#CLLoss.on_train_epoch_end-176"><span class="linenos">176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_training_epoch</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Log metrics of training epoch to plot learning curves and reset the metrics accumulation at the end of training epoch.</p>
</div>


                            </div>
                            <div id="CLLoss.on_validation_batch_end" class="classattr">
                                        <input id="CLLoss.on_validation_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_validation_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLLoss.on_validation_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLLoss.on_validation_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLLoss.on_validation_batch_end-178"><a href="#CLLoss.on_validation_batch_end-178"><span class="linenos">178</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLLoss.on_validation_batch_end-179"><a href="#CLLoss.on_validation_batch_end-179"><span class="linenos">179</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_batch_end</span><span class="p">(</span>
</span><span id="CLLoss.on_validation_batch_end-180"><a href="#CLLoss.on_validation_batch_end-180"><span class="linenos">180</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLLoss.on_validation_batch_end-181"><a href="#CLLoss.on_validation_batch_end-181"><span class="linenos">181</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLLoss.on_validation_batch_end-182"><a href="#CLLoss.on_validation_batch_end-182"><span class="linenos">182</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLLoss.on_validation_batch_end-183"><a href="#CLLoss.on_validation_batch_end-183"><span class="linenos">183</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="CLLoss.on_validation_batch_end-184"><a href="#CLLoss.on_validation_batch_end-184"><span class="linenos">184</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="CLLoss.on_validation_batch_end-185"><a href="#CLLoss.on_validation_batch_end-185"><span class="linenos">185</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CLLoss.on_validation_batch_end-186"><a href="#CLLoss.on_validation_batch_end-186"><span class="linenos">186</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss.on_validation_batch_end-187"><a href="#CLLoss.on_validation_batch_end-187"><span class="linenos">187</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from validation batch. We don&#39;t need to log and monitor the metrics of validation batches.</span>
</span><span id="CLLoss.on_validation_batch_end-188"><a href="#CLLoss.on_validation_batch_end-188"><span class="linenos">188</span></a>
</span><span id="CLLoss.on_validation_batch_end-189"><a href="#CLLoss.on_validation_batch_end-189"><span class="linenos">189</span></a><span class="sd">        **Args:**</span>
</span><span id="CLLoss.on_validation_batch_end-190"><a href="#CLLoss.on_validation_batch_end-190"><span class="linenos">190</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the validation step, which is the returns of the `validation_step()` method in the `CLAlgorithm`.</span>
</span><span id="CLLoss.on_validation_batch_end-191"><a href="#CLLoss.on_validation_batch_end-191"><span class="linenos">191</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="CLLoss.on_validation_batch_end-192"><a href="#CLLoss.on_validation_batch_end-192"><span class="linenos">192</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLLoss.on_validation_batch_end-193"><a href="#CLLoss.on_validation_batch_end-193"><span class="linenos">193</span></a>
</span><span id="CLLoss.on_validation_batch_end-194"><a href="#CLLoss.on_validation_batch_end-194"><span class="linenos">194</span></a>        <span class="c1"># get the batch size</span>
</span><span id="CLLoss.on_validation_batch_end-195"><a href="#CLLoss.on_validation_batch_end-195"><span class="linenos">195</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="CLLoss.on_validation_batch_end-196"><a href="#CLLoss.on_validation_batch_end-196"><span class="linenos">196</span></a>
</span><span id="CLLoss.on_validation_batch_end-197"><a href="#CLLoss.on_validation_batch_end-197"><span class="linenos">197</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="CLLoss.on_validation_batch_end-198"><a href="#CLLoss.on_validation_batch_end-198"><span class="linenos">198</span></a>        <span class="n">loss_cls_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="CLLoss.on_validation_batch_end-199"><a href="#CLLoss.on_validation_batch_end-199"><span class="linenos">199</span></a>
</span><span id="CLLoss.on_validation_batch_end-200"><a href="#CLLoss.on_validation_batch_end-200"><span class="linenos">200</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the validation metrics</span>
</span><span id="CLLoss.on_validation_batch_end-201"><a href="#CLLoss.on_validation_batch_end-201"><span class="linenos">201</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Accumulating metrics from validation batch. We don't need to log and monitor the metrics of validation batches.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the validation step, which is the returns of the <code>validation_step()</code> method in the <code>CLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the validation data batch.</li>
</ul>
</div>


                            </div>
                            <div id="CLLoss.on_validation_epoch_end" class="classattr">
                                        <input id="CLLoss.on_validation_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_validation_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLLoss.on_validation_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLLoss.on_validation_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLLoss.on_validation_epoch_end-203"><a href="#CLLoss.on_validation_epoch_end-203"><span class="linenos">203</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLLoss.on_validation_epoch_end-204"><a href="#CLLoss.on_validation_epoch_end-204"><span class="linenos">204</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_epoch_end</span><span class="p">(</span>
</span><span id="CLLoss.on_validation_epoch_end-205"><a href="#CLLoss.on_validation_epoch_end-205"><span class="linenos">205</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLLoss.on_validation_epoch_end-206"><a href="#CLLoss.on_validation_epoch_end-206"><span class="linenos">206</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLLoss.on_validation_epoch_end-207"><a href="#CLLoss.on_validation_epoch_end-207"><span class="linenos">207</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLLoss.on_validation_epoch_end-208"><a href="#CLLoss.on_validation_epoch_end-208"><span class="linenos">208</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss.on_validation_epoch_end-209"><a href="#CLLoss.on_validation_epoch_end-209"><span class="linenos">209</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log validation metrics to plot learning curves.&quot;&quot;&quot;</span>
</span><span id="CLLoss.on_validation_epoch_end-210"><a href="#CLLoss.on_validation_epoch_end-210"><span class="linenos">210</span></a>
</span><span id="CLLoss.on_validation_epoch_end-211"><a href="#CLLoss.on_validation_epoch_end-211"><span class="linenos">211</span></a>        <span class="c1"># log the accumulated and computed metrics of the epoch to Lightning loggers, specially for plotting learning curves</span>
</span><span id="CLLoss.on_validation_epoch_end-212"><a href="#CLLoss.on_validation_epoch_end-212"><span class="linenos">212</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="CLLoss.on_validation_epoch_end-213"><a href="#CLLoss.on_validation_epoch_end-213"><span class="linenos">213</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/learning_curve/val/loss_cls&quot;</span><span class="p">,</span>
</span><span id="CLLoss.on_validation_epoch_end-214"><a href="#CLLoss.on_validation_epoch_end-214"><span class="linenos">214</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="CLLoss.on_validation_epoch_end-215"><a href="#CLLoss.on_validation_epoch_end-215"><span class="linenos">215</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLLoss.on_validation_epoch_end-216"><a href="#CLLoss.on_validation_epoch_end-216"><span class="linenos">216</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CLLoss.on_validation_epoch_end-217"><a href="#CLLoss.on_validation_epoch_end-217"><span class="linenos">217</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Log validation metrics to plot learning curves.</p>
</div>


                            </div>
                            <div id="CLLoss.on_test_start" class="classattr">
                                        <input id="CLLoss.on_test_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_test_start</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLLoss.on_test_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLLoss.on_test_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLLoss.on_test_start-219"><a href="#CLLoss.on_test_start-219"><span class="linenos">219</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLLoss.on_test_start-220"><a href="#CLLoss.on_test_start-220"><span class="linenos">220</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_start</span><span class="p">(</span>
</span><span id="CLLoss.on_test_start-221"><a href="#CLLoss.on_test_start-221"><span class="linenos">221</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLLoss.on_test_start-222"><a href="#CLLoss.on_test_start-222"><span class="linenos">222</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLLoss.on_test_start-223"><a href="#CLLoss.on_test_start-223"><span class="linenos">223</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLLoss.on_test_start-224"><a href="#CLLoss.on_test_start-224"><span class="linenos">224</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss.on_test_start-225"><a href="#CLLoss.on_test_start-225"><span class="linenos">225</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the metrics for testing each seen task in the beginning of a task&#39;s testing.&quot;&quot;&quot;</span>
</span><span id="CLLoss.on_test_start-226"><a href="#CLLoss.on_test_start-226"><span class="linenos">226</span></a>
</span><span id="CLLoss.on_test_start-227"><a href="#CLLoss.on_test_start-227"><span class="linenos">227</span></a>        <span class="c1"># set the current task_id again (double checking) from the `CLAlgorithm` object</span>
</span><span id="CLLoss.on_test_start-228"><a href="#CLLoss.on_test_start-228"><span class="linenos">228</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">task_id</span>
</span><span id="CLLoss.on_test_start-229"><a href="#CLLoss.on_test_start-229"><span class="linenos">229</span></a>
</span><span id="CLLoss.on_test_start-230"><a href="#CLLoss.on_test_start-230"><span class="linenos">230</span></a>        <span class="c1"># get the device to put the metrics on the same device</span>
</span><span id="CLLoss.on_test_start-231"><a href="#CLLoss.on_test_start-231"><span class="linenos">231</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">device</span>
</span><span id="CLLoss.on_test_start-232"><a href="#CLLoss.on_test_start-232"><span class="linenos">232</span></a>
</span><span id="CLLoss.on_test_start-233"><a href="#CLLoss.on_test_start-233"><span class="linenos">233</span></a>        <span class="c1"># initialize test metrics for current and previous tasks</span>
</span><span id="CLLoss.on_test_start-234"><a href="#CLLoss.on_test_start-234"><span class="linenos">234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="CLLoss.on_test_start-235"><a href="#CLLoss.on_test_start-235"><span class="linenos">235</span></a>            <span class="n">task_id</span><span class="p">:</span> <span class="n">MeanMetricBatch</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">processed_task_ids</span>
</span><span id="CLLoss.on_test_start-236"><a href="#CLLoss.on_test_start-236"><span class="linenos">236</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the metrics for testing each seen task in the beginning of a task's testing.</p>
</div>


                            </div>
                            <div id="CLLoss.on_test_batch_end" class="classattr">
                                        <input id="CLLoss.on_test_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_test_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLLoss.on_test_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLLoss.on_test_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLLoss.on_test_batch_end-238"><a href="#CLLoss.on_test_batch_end-238"><span class="linenos">238</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLLoss.on_test_batch_end-239"><a href="#CLLoss.on_test_batch_end-239"><span class="linenos">239</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_batch_end</span><span class="p">(</span>
</span><span id="CLLoss.on_test_batch_end-240"><a href="#CLLoss.on_test_batch_end-240"><span class="linenos">240</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLLoss.on_test_batch_end-241"><a href="#CLLoss.on_test_batch_end-241"><span class="linenos">241</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLLoss.on_test_batch_end-242"><a href="#CLLoss.on_test_batch_end-242"><span class="linenos">242</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLLoss.on_test_batch_end-243"><a href="#CLLoss.on_test_batch_end-243"><span class="linenos">243</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="CLLoss.on_test_batch_end-244"><a href="#CLLoss.on_test_batch_end-244"><span class="linenos">244</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="CLLoss.on_test_batch_end-245"><a href="#CLLoss.on_test_batch_end-245"><span class="linenos">245</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CLLoss.on_test_batch_end-246"><a href="#CLLoss.on_test_batch_end-246"><span class="linenos">246</span></a>        <span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="CLLoss.on_test_batch_end-247"><a href="#CLLoss.on_test_batch_end-247"><span class="linenos">247</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss.on_test_batch_end-248"><a href="#CLLoss.on_test_batch_end-248"><span class="linenos">248</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from test batch. We don&#39;t need to log and monitor the metrics of test batches.</span>
</span><span id="CLLoss.on_test_batch_end-249"><a href="#CLLoss.on_test_batch_end-249"><span class="linenos">249</span></a>
</span><span id="CLLoss.on_test_batch_end-250"><a href="#CLLoss.on_test_batch_end-250"><span class="linenos">250</span></a><span class="sd">        **Args:**</span>
</span><span id="CLLoss.on_test_batch_end-251"><a href="#CLLoss.on_test_batch_end-251"><span class="linenos">251</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the test step, which is the returns of the `test_step()` method in the `CLAlgorithm`.</span>
</span><span id="CLLoss.on_test_batch_end-252"><a href="#CLLoss.on_test_batch_end-252"><span class="linenos">252</span></a><span class="sd">        - **batch** (`Any`): the test data batch.</span>
</span><span id="CLLoss.on_test_batch_end-253"><a href="#CLLoss.on_test_batch_end-253"><span class="linenos">253</span></a><span class="sd">        - **dataloader_idx** (`int`): the task ID of seen tasks to be tested. A default value of 0 is given otherwise the LightningModule will raise a `RuntimeError`.</span>
</span><span id="CLLoss.on_test_batch_end-254"><a href="#CLLoss.on_test_batch_end-254"><span class="linenos">254</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLLoss.on_test_batch_end-255"><a href="#CLLoss.on_test_batch_end-255"><span class="linenos">255</span></a>
</span><span id="CLLoss.on_test_batch_end-256"><a href="#CLLoss.on_test_batch_end-256"><span class="linenos">256</span></a>        <span class="c1"># get the batch size</span>
</span><span id="CLLoss.on_test_batch_end-257"><a href="#CLLoss.on_test_batch_end-257"><span class="linenos">257</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="CLLoss.on_test_batch_end-258"><a href="#CLLoss.on_test_batch_end-258"><span class="linenos">258</span></a>
</span><span id="CLLoss.on_test_batch_end-259"><a href="#CLLoss.on_test_batch_end-259"><span class="linenos">259</span></a>        <span class="n">test_task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">get_test_task_id_from_dataloader_idx</span><span class="p">(</span><span class="n">dataloader_idx</span><span class="p">)</span>
</span><span id="CLLoss.on_test_batch_end-260"><a href="#CLLoss.on_test_batch_end-260"><span class="linenos">260</span></a>
</span><span id="CLLoss.on_test_batch_end-261"><a href="#CLLoss.on_test_batch_end-261"><span class="linenos">261</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="CLLoss.on_test_batch_end-262"><a href="#CLLoss.on_test_batch_end-262"><span class="linenos">262</span></a>        <span class="n">loss_cls_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="CLLoss.on_test_batch_end-263"><a href="#CLLoss.on_test_batch_end-263"><span class="linenos">263</span></a>
</span><span id="CLLoss.on_test_batch_end-264"><a href="#CLLoss.on_test_batch_end-264"><span class="linenos">264</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the metrics of the epoch</span>
</span><span id="CLLoss.on_test_batch_end-265"><a href="#CLLoss.on_test_batch_end-265"><span class="linenos">265</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="p">[</span><span class="n">test_task_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Accumulating metrics from test batch. We don't need to log and monitor the metrics of test batches.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the test step, which is the returns of the <code>test_step()</code> method in the <code>CLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the test data batch.</li>
<li><strong>dataloader_idx</strong> (<code>int</code>): the task ID of seen tasks to be tested. A default value of 0 is given otherwise the LightningModule will raise a <code>RuntimeError</code>.</li>
</ul>
</div>


                            </div>
                            <div id="CLLoss.on_test_epoch_end" class="classattr">
                                        <input id="CLLoss.on_test_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_test_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLLoss.on_test_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLLoss.on_test_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLLoss.on_test_epoch_end-267"><a href="#CLLoss.on_test_epoch_end-267"><span class="linenos">267</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CLLoss.on_test_epoch_end-268"><a href="#CLLoss.on_test_epoch_end-268"><span class="linenos">268</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_epoch_end</span><span class="p">(</span>
</span><span id="CLLoss.on_test_epoch_end-269"><a href="#CLLoss.on_test_epoch_end-269"><span class="linenos">269</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLLoss.on_test_epoch_end-270"><a href="#CLLoss.on_test_epoch_end-270"><span class="linenos">270</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CLLoss.on_test_epoch_end-271"><a href="#CLLoss.on_test_epoch_end-271"><span class="linenos">271</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="CLLoss.on_test_epoch_end-272"><a href="#CLLoss.on_test_epoch_end-272"><span class="linenos">272</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss.on_test_epoch_end-273"><a href="#CLLoss.on_test_epoch_end-273"><span class="linenos">273</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save and plot test metrics at the end of test.&quot;&quot;&quot;</span>
</span><span id="CLLoss.on_test_epoch_end-274"><a href="#CLLoss.on_test_epoch_end-274"><span class="linenos">274</span></a>
</span><span id="CLLoss.on_test_epoch_end-275"><a href="#CLLoss.on_test_epoch_end-275"><span class="linenos">275</span></a>        <span class="c1"># save (update) the test metrics to CSV files</span>
</span><span id="CLLoss.on_test_epoch_end-276"><a href="#CLLoss.on_test_epoch_end-276"><span class="linenos">276</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_test_loss_cls_to_csv</span><span class="p">(</span>
</span><span id="CLLoss.on_test_epoch_end-277"><a href="#CLLoss.on_test_epoch_end-277"><span class="linenos">277</span></a>            <span class="n">after_training_task_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
</span><span id="CLLoss.on_test_epoch_end-278"><a href="#CLLoss.on_test_epoch_end-278"><span class="linenos">278</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_csv_path</span><span class="p">,</span>
</span><span id="CLLoss.on_test_epoch_end-279"><a href="#CLLoss.on_test_epoch_end-279"><span class="linenos">279</span></a>        <span class="p">)</span>
</span><span id="CLLoss.on_test_epoch_end-280"><a href="#CLLoss.on_test_epoch_end-280"><span class="linenos">280</span></a>
</span><span id="CLLoss.on_test_epoch_end-281"><a href="#CLLoss.on_test_epoch_end-281"><span class="linenos">281</span></a>        <span class="c1"># plot the test metrics</span>
</span><span id="CLLoss.on_test_epoch_end-282"><a href="#CLLoss.on_test_epoch_end-282"><span class="linenos">282</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_matrix_plot_path</span><span class="p">:</span>
</span><span id="CLLoss.on_test_epoch_end-283"><a href="#CLLoss.on_test_epoch_end-283"><span class="linenos">283</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plot_test_loss_cls_matrix_from_csv</span><span class="p">(</span>
</span><span id="CLLoss.on_test_epoch_end-284"><a href="#CLLoss.on_test_epoch_end-284"><span class="linenos">284</span></a>                <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_csv_path</span><span class="p">,</span>
</span><span id="CLLoss.on_test_epoch_end-285"><a href="#CLLoss.on_test_epoch_end-285"><span class="linenos">285</span></a>                <span class="n">plot_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_matrix_plot_path</span><span class="p">,</span>
</span><span id="CLLoss.on_test_epoch_end-286"><a href="#CLLoss.on_test_epoch_end-286"><span class="linenos">286</span></a>            <span class="p">)</span>
</span><span id="CLLoss.on_test_epoch_end-287"><a href="#CLLoss.on_test_epoch_end-287"><span class="linenos">287</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_ave_loss_cls_plot_path</span><span class="p">:</span>
</span><span id="CLLoss.on_test_epoch_end-288"><a href="#CLLoss.on_test_epoch_end-288"><span class="linenos">288</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plot_test_ave_loss_cls_curve_from_csv</span><span class="p">(</span>
</span><span id="CLLoss.on_test_epoch_end-289"><a href="#CLLoss.on_test_epoch_end-289"><span class="linenos">289</span></a>                <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_csv_path</span><span class="p">,</span>
</span><span id="CLLoss.on_test_epoch_end-290"><a href="#CLLoss.on_test_epoch_end-290"><span class="linenos">290</span></a>                <span class="n">plot_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_ave_loss_cls_plot_path</span><span class="p">,</span>
</span><span id="CLLoss.on_test_epoch_end-291"><a href="#CLLoss.on_test_epoch_end-291"><span class="linenos">291</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save and plot test metrics at the end of test.</p>
</div>


                            </div>
                            <div id="CLLoss.update_test_loss_cls_to_csv" class="classattr">
                                        <input id="CLLoss.update_test_loss_cls_to_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_test_loss_cls_to_csv</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">after_training_task_id</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">skipped_task_ids_for_ave</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLLoss.update_test_loss_cls_to_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLLoss.update_test_loss_cls_to_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLLoss.update_test_loss_cls_to_csv-293"><a href="#CLLoss.update_test_loss_cls_to_csv-293"><span class="linenos">293</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_test_loss_cls_to_csv</span><span class="p">(</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-294"><a href="#CLLoss.update_test_loss_cls_to_csv-294"><span class="linenos">294</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-295"><a href="#CLLoss.update_test_loss_cls_to_csv-295"><span class="linenos">295</span></a>        <span class="n">after_training_task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-296"><a href="#CLLoss.update_test_loss_cls_to_csv-296"><span class="linenos">296</span></a>        <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-297"><a href="#CLLoss.update_test_loss_cls_to_csv-297"><span class="linenos">297</span></a>        <span class="n">skipped_task_ids_for_ave</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-298"><a href="#CLLoss.update_test_loss_cls_to_csv-298"><span class="linenos">298</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-299"><a href="#CLLoss.update_test_loss_cls_to_csv-299"><span class="linenos">299</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the test classification loss metrics of seen tasks at the last line to an existing CSV file. A new file will be created if not existing.</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-300"><a href="#CLLoss.update_test_loss_cls_to_csv-300"><span class="linenos">300</span></a>
</span><span id="CLLoss.update_test_loss_cls_to_csv-301"><a href="#CLLoss.update_test_loss_cls_to_csv-301"><span class="linenos">301</span></a><span class="sd">        **Args:**</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-302"><a href="#CLLoss.update_test_loss_cls_to_csv-302"><span class="linenos">302</span></a><span class="sd">        - **after_training_task_id** (`int`): the task ID after training.</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-303"><a href="#CLLoss.update_test_loss_cls_to_csv-303"><span class="linenos">303</span></a><span class="sd">        - **csv_path** (`str`): save the test metric to path. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/loss_cls.csv&#39;.</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-304"><a href="#CLLoss.update_test_loss_cls_to_csv-304"><span class="linenos">304</span></a><span class="sd">        - **skipped_task_ids_for_ave** (`list[int]` | `None`): the task IDs that are skipped to calculate average accuracy. If `None`, no task is skipped. Default: `None`.</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-305"><a href="#CLLoss.update_test_loss_cls_to_csv-305"><span class="linenos">305</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-306"><a href="#CLLoss.update_test_loss_cls_to_csv-306"><span class="linenos">306</span></a>        <span class="n">processed_task_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-307"><a href="#CLLoss.update_test_loss_cls_to_csv-307"><span class="linenos">307</span></a>        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;after_training_task&quot;</span><span class="p">,</span> <span class="s2">&quot;average_classification_loss&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-308"><a href="#CLLoss.update_test_loss_cls_to_csv-308"><span class="linenos">308</span></a>            <span class="sa">f</span><span class="s2">&quot;test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">processed_task_ids</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-309"><a href="#CLLoss.update_test_loss_cls_to_csv-309"><span class="linenos">309</span></a>        <span class="p">]</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-310"><a href="#CLLoss.update_test_loss_cls_to_csv-310"><span class="linenos">310</span></a>
</span><span id="CLLoss.update_test_loss_cls_to_csv-311"><a href="#CLLoss.update_test_loss_cls_to_csv-311"><span class="linenos">311</span></a>        <span class="n">new_line</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-312"><a href="#CLLoss.update_test_loss_cls_to_csv-312"><span class="linenos">312</span></a>            <span class="s2">&quot;after_training_task&quot;</span><span class="p">:</span> <span class="n">after_training_task_id</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-313"><a href="#CLLoss.update_test_loss_cls_to_csv-313"><span class="linenos">313</span></a>        <span class="p">}</span>  <span class="c1"># construct the first column</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-314"><a href="#CLLoss.update_test_loss_cls_to_csv-314"><span class="linenos">314</span></a>
</span><span id="CLLoss.update_test_loss_cls_to_csv-315"><a href="#CLLoss.update_test_loss_cls_to_csv-315"><span class="linenos">315</span></a>        <span class="c1"># write to the columns and calculate the average classification loss over tasks at the same time</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-316"><a href="#CLLoss.update_test_loss_cls_to_csv-316"><span class="linenos">316</span></a>        <span class="n">average_classification_loss_over_tasks</span> <span class="o">=</span> <span class="n">MeanMetric</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-317"><a href="#CLLoss.update_test_loss_cls_to_csv-317"><span class="linenos">317</span></a>            <span class="n">device</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">device</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-318"><a href="#CLLoss.update_test_loss_cls_to_csv-318"><span class="linenos">318</span></a>        <span class="p">)</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-319"><a href="#CLLoss.update_test_loss_cls_to_csv-319"><span class="linenos">319</span></a>        <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">processed_task_ids</span><span class="p">:</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-320"><a href="#CLLoss.update_test_loss_cls_to_csv-320"><span class="linenos">320</span></a>            <span class="n">loss_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-321"><a href="#CLLoss.update_test_loss_cls_to_csv-321"><span class="linenos">321</span></a>            <span class="n">new_line</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_cls</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-322"><a href="#CLLoss.update_test_loss_cls_to_csv-322"><span class="linenos">322</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-323"><a href="#CLLoss.update_test_loss_cls_to_csv-323"><span class="linenos">323</span></a>                <span class="n">skipped_task_ids_for_ave</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-324"><a href="#CLLoss.update_test_loss_cls_to_csv-324"><span class="linenos">324</span></a>                <span class="ow">or</span> <span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skipped_task_ids_for_ave</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-325"><a href="#CLLoss.update_test_loss_cls_to_csv-325"><span class="linenos">325</span></a>            <span class="p">):</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-326"><a href="#CLLoss.update_test_loss_cls_to_csv-326"><span class="linenos">326</span></a>                <span class="n">average_classification_loss_over_tasks</span><span class="p">(</span><span class="n">loss_cls</span><span class="p">)</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-327"><a href="#CLLoss.update_test_loss_cls_to_csv-327"><span class="linenos">327</span></a>        <span class="n">new_line</span><span class="p">[</span><span class="s2">&quot;average_classification_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-328"><a href="#CLLoss.update_test_loss_cls_to_csv-328"><span class="linenos">328</span></a>            <span class="n">average_classification_loss_over_tasks</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-329"><a href="#CLLoss.update_test_loss_cls_to_csv-329"><span class="linenos">329</span></a>        <span class="p">)</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-330"><a href="#CLLoss.update_test_loss_cls_to_csv-330"><span class="linenos">330</span></a>
</span><span id="CLLoss.update_test_loss_cls_to_csv-331"><a href="#CLLoss.update_test_loss_cls_to_csv-331"><span class="linenos">331</span></a>        <span class="c1"># write to the csv file</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-332"><a href="#CLLoss.update_test_loss_cls_to_csv-332"><span class="linenos">332</span></a>        <span class="n">is_first</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-333"><a href="#CLLoss.update_test_loss_cls_to_csv-333"><span class="linenos">333</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-334"><a href="#CLLoss.update_test_loss_cls_to_csv-334"><span class="linenos">334</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-335"><a href="#CLLoss.update_test_loss_cls_to_csv-335"><span class="linenos">335</span></a>                <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-336"><a href="#CLLoss.update_test_loss_cls_to_csv-336"><span class="linenos">336</span></a>                <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-337"><a href="#CLLoss.update_test_loss_cls_to_csv-337"><span class="linenos">337</span></a>        <span class="c1"># write header</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-338"><a href="#CLLoss.update_test_loss_cls_to_csv-338"><span class="linenos">338</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-339"><a href="#CLLoss.update_test_loss_cls_to_csv-339"><span class="linenos">339</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-340"><a href="#CLLoss.update_test_loss_cls_to_csv-340"><span class="linenos">340</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-341"><a href="#CLLoss.update_test_loss_cls_to_csv-341"><span class="linenos">341</span></a>        <span class="c1"># write metrics</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-342"><a href="#CLLoss.update_test_loss_cls_to_csv-342"><span class="linenos">342</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-343"><a href="#CLLoss.update_test_loss_cls_to_csv-343"><span class="linenos">343</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-344"><a href="#CLLoss.update_test_loss_cls_to_csv-344"><span class="linenos">344</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>  <span class="c1"># write the previous lines</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-345"><a href="#CLLoss.update_test_loss_cls_to_csv-345"><span class="linenos">345</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="CLLoss.update_test_loss_cls_to_csv-346"><a href="#CLLoss.update_test_loss_cls_to_csv-346"><span class="linenos">346</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Update the test classification loss metrics of seen tasks at the last line to an existing CSV file. A new file will be created if not existing.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>after_training_task_id</strong> (<code>int</code>): the task ID after training.</li>
<li><strong>csv_path</strong> (<code>str</code>): save the test metric to path. E.g. './outputs/expr_name/1970-01-01_00-00-00/results/loss_cls.csv'.</li>
<li><strong>skipped_task_ids_for_ave</strong> (<code>list[int]</code> | <code>None</code>): the task IDs that are skipped to calculate average accuracy. If <code>None</code>, no task is skipped. Default: <code>None</code>.</li>
</ul>
</div>


                            </div>
                            <div id="CLLoss.plot_test_loss_cls_matrix_from_csv" class="classattr">
                                        <input id="CLLoss.plot_test_loss_cls_matrix_from_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_test_loss_cls_matrix_from_csv</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLLoss.plot_test_loss_cls_matrix_from_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLLoss.plot_test_loss_cls_matrix_from_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-348"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-348"><span class="linenos">348</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_test_loss_cls_matrix_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-349"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-349"><span class="linenos">349</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the test classification loss matrix from saved CSV file and save the plot to the designated directory.</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-350"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-350"><span class="linenos">350</span></a>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-351"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-351"><span class="linenos">351</span></a><span class="sd">        **Args:**</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-352"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-352"><span class="linenos">352</span></a><span class="sd">        - **csv_path** (`str`): the path to the CSV file where the `utils.update_loss_cls_to_csv()` saved the test classification loss metric.</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-353"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-353"><span class="linenos">353</span></a><span class="sd">        - **plot_path** (`str`): the path to save plot. Better same as the output directory of the experiment. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/loss_cls_matrix.png&#39;.</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-354"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-354"><span class="linenos">354</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-355"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-355"><span class="linenos">355</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-356"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-356"><span class="linenos">356</span></a>        <span class="n">processed_task_ids</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-357"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-357"><span class="linenos">357</span></a>            <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;test_on_task_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-358"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-358"><span class="linenos">358</span></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-359"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-359"><span class="linenos">359</span></a>            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;test_on_task_&quot;</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-360"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-360"><span class="linenos">360</span></a>        <span class="p">]</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-361"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-361"><span class="linenos">361</span></a>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-362"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-362"><span class="linenos">362</span></a>        <span class="c1"># Get all columns that start with &quot;test_on_task_&quot;</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-363"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-363"><span class="linenos">363</span></a>        <span class="n">test_task_cols</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-364"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-364"><span class="linenos">364</span></a>            <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;test_on_task_&quot;</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-365"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-365"><span class="linenos">365</span></a>        <span class="p">]</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-366"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-366"><span class="linenos">366</span></a>        <span class="n">num_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_task_ids</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-367"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-367"><span class="linenos">367</span></a>        <span class="n">num_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-368"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-368"><span class="linenos">368</span></a>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-369"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-369"><span class="linenos">369</span></a>        <span class="c1"># Build the loss matrix</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-370"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-370"><span class="linenos">370</span></a>        <span class="n">loss_matrix</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">test_task_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-371"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-371"><span class="linenos">371</span></a>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-372"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-372"><span class="linenos">372</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-373"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-373"><span class="linenos">373</span></a>            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num_tasks</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_rows</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-374"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-374"><span class="linenos">374</span></a>        <span class="p">)</span>  <span class="c1"># adaptive figure size</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-375"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-375"><span class="linenos">375</span></a>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-376"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-376"><span class="linenos">376</span></a>        <span class="n">cax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-377"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-377"><span class="linenos">377</span></a>            <span class="n">loss_matrix</span><span class="p">,</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-378"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-378"><span class="linenos">378</span></a>            <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-379"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-379"><span class="linenos">379</span></a>            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greens&quot;</span><span class="p">,</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-380"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-380"><span class="linenos">380</span></a>            <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-381"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-381"><span class="linenos">381</span></a>        <span class="p">)</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-382"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-382"><span class="linenos">382</span></a>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-383"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-383"><span class="linenos">383</span></a>        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cax</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-384"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-384"><span class="linenos">384</span></a>        <span class="n">yticks</span> <span class="o">=</span> <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-385"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-385"><span class="linenos">385</span></a>        <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-386"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-386"><span class="linenos">386</span></a>        <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-387"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-387"><span class="linenos">387</span></a>            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">yticks</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-388"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-388"><span class="linenos">388</span></a>        <span class="p">)</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-389"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-389"><span class="linenos">389</span></a>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-390"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-390"><span class="linenos">390</span></a>        <span class="c1"># Annotate each cell</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-391"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-391"><span class="linenos">391</span></a>        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_rows</span><span class="p">):</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-392"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-392"><span class="linenos">392</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-393"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-393"><span class="linenos">393</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-394"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-394"><span class="linenos">394</span></a>                    <span class="n">c</span><span class="p">,</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-395"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-395"><span class="linenos">395</span></a>                    <span class="n">r</span><span class="p">,</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-396"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-396"><span class="linenos">396</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">loss_matrix</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-397"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-397"><span class="linenos">397</span></a>                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-398"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-398"><span class="linenos">398</span></a>                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-399"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-399"><span class="linenos">399</span></a>                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-400"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-400"><span class="linenos">400</span></a>                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">,</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-401"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-401"><span class="linenos">401</span></a>                <span class="p">)</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-402"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-402"><span class="linenos">402</span></a>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-403"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-403"><span class="linenos">403</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">))</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-404"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-404"><span class="linenos">404</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_rows</span><span class="p">))</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-405"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-405"><span class="linenos">405</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">processed_task_ids</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-406"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-406"><span class="linenos">406</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-407"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-407"><span class="linenos">407</span></a>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;after_training_task&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-408"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-408"><span class="linenos">408</span></a>        <span class="p">)</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-409"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-409"><span class="linenos">409</span></a>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-410"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-410"><span class="linenos">410</span></a>        <span class="c1"># Labeling the axes</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-411"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-411"><span class="linenos">411</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Testing on task &quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-412"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-412"><span class="linenos">412</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;After training task t&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-413"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-413"><span class="linenos">413</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-414"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-414"><span class="linenos">414</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_loss_cls_matrix_from_csv-415"><a href="#CLLoss.plot_test_loss_cls_matrix_from_csv-415"><span class="linenos">415</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plot the test classification loss matrix from saved CSV file and save the plot to the designated directory.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>csv_path</strong> (<code>str</code>): the path to the CSV file where the <code>utils.update_loss_cls_to_csv()</code> saved the test classification loss metric.</li>
<li><strong>plot_path</strong> (<code>str</code>): the path to save plot. Better same as the output directory of the experiment. E.g. './outputs/expr_name/1970-01-01_00-00-00/loss_cls_matrix.png'.</li>
</ul>
</div>


                            </div>
                            <div id="CLLoss.plot_test_ave_loss_cls_curve_from_csv" class="classattr">
                                        <input id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_test_ave_loss_cls_curve_from_csv</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CLLoss.plot_test_ave_loss_cls_curve_from_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-417"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-417"><span class="linenos">417</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_test_ave_loss_cls_curve_from_csv</span><span class="p">(</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-418"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-418"><span class="linenos">418</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-419"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-419"><span class="linenos">419</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-420"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-420"><span class="linenos">420</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the test average classfication loss curve over different training tasks from saved CSV file and save the plot to the designated directory.</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-421"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-421"><span class="linenos">421</span></a>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-422"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-422"><span class="linenos">422</span></a><span class="sd">        **Args:**</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-423"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-423"><span class="linenos">423</span></a><span class="sd">        - **csv_path** (`str`): the path to the CSV file where the `utils.update_test_acc_to_csv()` saved the test classfication loss metric.</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-424"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-424"><span class="linenos">424</span></a><span class="sd">        - **plot_path** (`str`): the path to save plot. Better same as the output directory of the experiment. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/ave_loss_cls.png&#39;.</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-425"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-425"><span class="linenos">425</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-426"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-426"><span class="linenos">426</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-427"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-427"><span class="linenos">427</span></a>        <span class="n">after_training_tasks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;after_training_task&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-428"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-428"><span class="linenos">428</span></a>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-429"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-429"><span class="linenos">429</span></a>        <span class="c1"># plot the average accuracy curve over different training tasks</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-430"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-430"><span class="linenos">430</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-431"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-431"><span class="linenos">431</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-432"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-432"><span class="linenos">432</span></a>            <span class="n">after_training_tasks</span><span class="p">,</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-433"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-433"><span class="linenos">433</span></a>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;average_classification_loss&quot;</span><span class="p">],</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-434"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-434"><span class="linenos">434</span></a>            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-435"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-435"><span class="linenos">435</span></a>            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-436"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-436"><span class="linenos">436</span></a>        <span class="p">)</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-437"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-437"><span class="linenos">437</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;After training task $t$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-438"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-438"><span class="linenos">438</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Average Classification Loss&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-439"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-439"><span class="linenos">439</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-440"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-440"><span class="linenos">440</span></a>        <span class="n">xticks</span> <span class="o">=</span> <span class="n">after_training_tasks</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-441"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-441"><span class="linenos">441</span></a>        <span class="n">yticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mf">0.05</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">)]</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-442"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-442"><span class="linenos">442</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-443"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-443"><span class="linenos">443</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-444"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-444"><span class="linenos">444</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-445"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-445"><span class="linenos">445</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">yticks</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-446"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-446"><span class="linenos">446</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="CLLoss.plot_test_ave_loss_cls_curve_from_csv-447"><a href="#CLLoss.plot_test_ave_loss_cls_curve_from_csv-447"><span class="linenos">447</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plot the test average classfication loss curve over different training tasks from saved CSV file and save the plot to the designated directory.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>csv_path</strong> (<code>str</code>): the path to the CSV file where the <code>utils.update_test_acc_to_csv()</code> saved the test classfication loss metric.</li>
<li><strong>plot_path</strong> (<code>str</code>): the path to save plot. Better same as the output directory of the experiment. E.g. './outputs/expr_name/1970-01-01_00-00-00/ave_loss_cls.png'.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="CULDistributionDistance">
                            <input id="CULDistributionDistance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CULDistributionDistance</span><wbr>(<span class="base"><a href="#MetricCallback">clarena.metrics.MetricCallback</a></span>):

                <label class="view-source-button" for="CULDistributionDistance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CULDistributionDistance"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CULDistributionDistance-29"><a href="#CULDistributionDistance-29"><span class="linenos"> 29</span></a><span class="k">class</span><span class="w"> </span><span class="nc">CULDistributionDistance</span><span class="p">(</span><span class="n">MetricCallback</span><span class="p">):</span>
</span><span id="CULDistributionDistance-30"><a href="#CULDistributionDistance-30"><span class="linenos"> 30</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Provides all actions that are related to CUL distribution distance (DD) metric, which include:</span>
</span><span id="CULDistributionDistance-31"><a href="#CULDistributionDistance-31"><span class="linenos"> 31</span></a>
</span><span id="CULDistributionDistance-32"><a href="#CULDistributionDistance-32"><span class="linenos"> 32</span></a><span class="sd">    - Defining, initializing and recording DD metric.</span>
</span><span id="CULDistributionDistance-33"><a href="#CULDistributionDistance-33"><span class="linenos"> 33</span></a><span class="sd">    - Saving DD metric to files.</span>
</span><span id="CULDistributionDistance-34"><a href="#CULDistributionDistance-34"><span class="linenos"> 34</span></a><span class="sd">    - Visualizing DD metric as plots.</span>
</span><span id="CULDistributionDistance-35"><a href="#CULDistributionDistance-35"><span class="linenos"> 35</span></a>
</span><span id="CULDistributionDistance-36"><a href="#CULDistributionDistance-36"><span class="linenos"> 36</span></a><span class="sd">    The callback is able to produce the following outputs:</span>
</span><span id="CULDistributionDistance-37"><a href="#CULDistributionDistance-37"><span class="linenos"> 37</span></a>
</span><span id="CULDistributionDistance-38"><a href="#CULDistributionDistance-38"><span class="linenos"> 38</span></a><span class="sd">    - CSV files for DD in each task.</span>
</span><span id="CULDistributionDistance-39"><a href="#CULDistributionDistance-39"><span class="linenos"> 39</span></a><span class="sd">    - Coloured plot for DD in each task.</span>
</span><span id="CULDistributionDistance-40"><a href="#CULDistributionDistance-40"><span class="linenos"> 40</span></a>
</span><span id="CULDistributionDistance-41"><a href="#CULDistributionDistance-41"><span class="linenos"> 41</span></a><span class="sd">    Note that this callback is designed to be used with the `CULEvaluation` module, which is a special evaluation module for continual unlearning. It is not a typical test step in the algorithm, but rather a test protocol that evaluates the performance of the model on unlearned tasks.</span>
</span><span id="CULDistributionDistance-42"><a href="#CULDistributionDistance-42"><span class="linenos"> 42</span></a>
</span><span id="CULDistributionDistance-43"><a href="#CULDistributionDistance-43"><span class="linenos"> 43</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance-44"><a href="#CULDistributionDistance-44"><span class="linenos"> 44</span></a>
</span><span id="CULDistributionDistance-45"><a href="#CULDistributionDistance-45"><span class="linenos"> 45</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="CULDistributionDistance-46"><a href="#CULDistributionDistance-46"><span class="linenos"> 46</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULDistributionDistance-47"><a href="#CULDistributionDistance-47"><span class="linenos"> 47</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CULDistributionDistance-48"><a href="#CULDistributionDistance-48"><span class="linenos"> 48</span></a>        <span class="n">distribution_distance_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CULDistributionDistance-49"><a href="#CULDistributionDistance-49"><span class="linenos"> 49</span></a>        <span class="n">distribution_distance_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;dd.csv&quot;</span><span class="p">,</span>
</span><span id="CULDistributionDistance-50"><a href="#CULDistributionDistance-50"><span class="linenos"> 50</span></a>        <span class="n">distribution_distance_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CULDistributionDistance-51"><a href="#CULDistributionDistance-51"><span class="linenos"> 51</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULDistributionDistance-52"><a href="#CULDistributionDistance-52"><span class="linenos"> 52</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `CULDistributionDistance`.</span>
</span><span id="CULDistributionDistance-53"><a href="#CULDistributionDistance-53"><span class="linenos"> 53</span></a>
</span><span id="CULDistributionDistance-54"><a href="#CULDistributionDistance-54"><span class="linenos"> 54</span></a><span class="sd">        **Args:**</span>
</span><span id="CULDistributionDistance-55"><a href="#CULDistributionDistance-55"><span class="linenos"> 55</span></a><span class="sd">        - **save_dir** (`str`): The directory where data and figures of metrics will be saved. Better inside the output folder.</span>
</span><span id="CULDistributionDistance-56"><a href="#CULDistributionDistance-56"><span class="linenos"> 56</span></a><span class="sd">        - **distribution_distance_type** (`str`): the type of distribution distance to use. Should be one of the following:</span>
</span><span id="CULDistributionDistance-57"><a href="#CULDistributionDistance-57"><span class="linenos"> 57</span></a><span class="sd">            - &#39;euclidean&#39;: Eulidean distance.</span>
</span><span id="CULDistributionDistance-58"><a href="#CULDistributionDistance-58"><span class="linenos"> 58</span></a><span class="sd">            - &#39;cosine&#39;: Cosine distance.</span>
</span><span id="CULDistributionDistance-59"><a href="#CULDistributionDistance-59"><span class="linenos"> 59</span></a><span class="sd">            - &#39;manhattan&#39;: Manhattan distance.</span>
</span><span id="CULDistributionDistance-60"><a href="#CULDistributionDistance-60"><span class="linenos"> 60</span></a><span class="sd">        - **distribution_distance_csv_name** (`str`): file name to save test distribution distance metrics as CSV file.</span>
</span><span id="CULDistributionDistance-61"><a href="#CULDistributionDistance-61"><span class="linenos"> 61</span></a><span class="sd">        - **distribution_distance_plot_name** (`str` | `None`): file name to save test distribution distance metrics as plot. If `None`, no plot will be saved.</span>
</span><span id="CULDistributionDistance-62"><a href="#CULDistributionDistance-62"><span class="linenos"> 62</span></a>
</span><span id="CULDistributionDistance-63"><a href="#CULDistributionDistance-63"><span class="linenos"> 63</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance-64"><a href="#CULDistributionDistance-64"><span class="linenos"> 64</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="CULDistributionDistance-65"><a href="#CULDistributionDistance-65"><span class="linenos"> 65</span></a>
</span><span id="CULDistributionDistance-66"><a href="#CULDistributionDistance-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">distribution_distance_type</span>
</span><span id="CULDistributionDistance-67"><a href="#CULDistributionDistance-67"><span class="linenos"> 67</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the type of distribution distance to use. &quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance-68"><a href="#CULDistributionDistance-68"><span class="linenos"> 68</span></a>
</span><span id="CULDistributionDistance-69"><a href="#CULDistributionDistance-69"><span class="linenos"> 69</span></a>        <span class="c1"># paths</span>
</span><span id="CULDistributionDistance-70"><a href="#CULDistributionDistance-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance_csv_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="CULDistributionDistance-71"><a href="#CULDistributionDistance-71"><span class="linenos"> 71</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">distribution_distance_csv_name</span>
</span><span id="CULDistributionDistance-72"><a href="#CULDistributionDistance-72"><span class="linenos"> 72</span></a>        <span class="p">)</span>
</span><span id="CULDistributionDistance-73"><a href="#CULDistributionDistance-73"><span class="linenos"> 73</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the path to save the test distribution distance metrics CSV file.&quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance-74"><a href="#CULDistributionDistance-74"><span class="linenos"> 74</span></a>        <span class="k">if</span> <span class="n">distribution_distance_plot_name</span><span class="p">:</span>
</span><span id="CULDistributionDistance-75"><a href="#CULDistributionDistance-75"><span class="linenos"> 75</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">unlearning_test_distance_plot_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="CULDistributionDistance-76"><a href="#CULDistributionDistance-76"><span class="linenos"> 76</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">distribution_distance_plot_name</span>
</span><span id="CULDistributionDistance-77"><a href="#CULDistributionDistance-77"><span class="linenos"> 77</span></a>            <span class="p">)</span>
</span><span id="CULDistributionDistance-78"><a href="#CULDistributionDistance-78"><span class="linenos"> 78</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the path to save the test distribution distance metrics plot file.&quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance-79"><a href="#CULDistributionDistance-79"><span class="linenos"> 79</span></a>
</span><span id="CULDistributionDistance-80"><a href="#CULDistributionDistance-80"><span class="linenos"> 80</span></a>        <span class="c1"># test accumulated metrics</span>
</span><span id="CULDistributionDistance-81"><a href="#CULDistributionDistance-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">]</span>
</span><span id="CULDistributionDistance-82"><a href="#CULDistributionDistance-82"><span class="linenos"> 82</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Distribution distance unlearning metrics for each seen task. Accumulated and calculated from the test batches. Keys are task IDs and values are the corresponding metrics.&quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance-83"><a href="#CULDistributionDistance-83"><span class="linenos"> 83</span></a>
</span><span id="CULDistributionDistance-84"><a href="#CULDistributionDistance-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="CULDistributionDistance-85"><a href="#CULDistributionDistance-85"><span class="linenos"> 85</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Task ID counter indicating which task is being processed. Self updated during the task loop. Starting from 1. &quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance-86"><a href="#CULDistributionDistance-86"><span class="linenos"> 86</span></a>
</span><span id="CULDistributionDistance-87"><a href="#CULDistributionDistance-87"><span class="linenos"> 87</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CULDistributionDistance-88"><a href="#CULDistributionDistance-88"><span class="linenos"> 88</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_start</span><span class="p">(</span>
</span><span id="CULDistributionDistance-89"><a href="#CULDistributionDistance-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULDistributionDistance-90"><a href="#CULDistributionDistance-90"><span class="linenos"> 90</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CULDistributionDistance-91"><a href="#CULDistributionDistance-91"><span class="linenos"> 91</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CULEvaluation</span><span class="p">,</span>
</span><span id="CULDistributionDistance-92"><a href="#CULDistributionDistance-92"><span class="linenos"> 92</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULDistributionDistance-93"><a href="#CULDistributionDistance-93"><span class="linenos"> 93</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the metrics for testing each seen task in the beginning of a task&#39;s testing.&quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance-94"><a href="#CULDistributionDistance-94"><span class="linenos"> 94</span></a>
</span><span id="CULDistributionDistance-95"><a href="#CULDistributionDistance-95"><span class="linenos"> 95</span></a>        <span class="c1"># get the device to put the metrics on the same device</span>
</span><span id="CULDistributionDistance-96"><a href="#CULDistributionDistance-96"><span class="linenos"> 96</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">device</span>
</span><span id="CULDistributionDistance-97"><a href="#CULDistributionDistance-97"><span class="linenos"> 97</span></a>
</span><span id="CULDistributionDistance-98"><a href="#CULDistributionDistance-98"><span class="linenos"> 98</span></a>        <span class="c1"># initialize test metrics for evaluation tasks</span>
</span><span id="CULDistributionDistance-99"><a href="#CULDistributionDistance-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="CULDistributionDistance-100"><a href="#CULDistributionDistance-100"><span class="linenos">100</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">MeanMetricBatch</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="CULDistributionDistance-101"><a href="#CULDistributionDistance-101"><span class="linenos">101</span></a>            <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">dd_eval_task_ids</span>
</span><span id="CULDistributionDistance-102"><a href="#CULDistributionDistance-102"><span class="linenos">102</span></a>        <span class="p">}</span>
</span><span id="CULDistributionDistance-103"><a href="#CULDistributionDistance-103"><span class="linenos">103</span></a>
</span><span id="CULDistributionDistance-104"><a href="#CULDistributionDistance-104"><span class="linenos">104</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CULDistributionDistance-105"><a href="#CULDistributionDistance-105"><span class="linenos">105</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_batch_end</span><span class="p">(</span>
</span><span id="CULDistributionDistance-106"><a href="#CULDistributionDistance-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULDistributionDistance-107"><a href="#CULDistributionDistance-107"><span class="linenos">107</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CULDistributionDistance-108"><a href="#CULDistributionDistance-108"><span class="linenos">108</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CULEvaluation</span><span class="p">,</span>
</span><span id="CULDistributionDistance-109"><a href="#CULDistributionDistance-109"><span class="linenos">109</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="CULDistributionDistance-110"><a href="#CULDistributionDistance-110"><span class="linenos">110</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="CULDistributionDistance-111"><a href="#CULDistributionDistance-111"><span class="linenos">111</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CULDistributionDistance-112"><a href="#CULDistributionDistance-112"><span class="linenos">112</span></a>        <span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="CULDistributionDistance-113"><a href="#CULDistributionDistance-113"><span class="linenos">113</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULDistributionDistance-114"><a href="#CULDistributionDistance-114"><span class="linenos">114</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from test batch. We don&#39;t need to log and monitor the metrics of test batches.</span>
</span><span id="CULDistributionDistance-115"><a href="#CULDistributionDistance-115"><span class="linenos">115</span></a>
</span><span id="CULDistributionDistance-116"><a href="#CULDistributionDistance-116"><span class="linenos">116</span></a><span class="sd">        **Args:**</span>
</span><span id="CULDistributionDistance-117"><a href="#CULDistributionDistance-117"><span class="linenos">117</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the test step, which is the returns of the `test_step()` method in the `CULEvaluation`.</span>
</span><span id="CULDistributionDistance-118"><a href="#CULDistributionDistance-118"><span class="linenos">118</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="CULDistributionDistance-119"><a href="#CULDistributionDistance-119"><span class="linenos">119</span></a><span class="sd">        - **dataloader_idx** (`int`): the task ID of seen tasks to be tested. A default value of 0 is given otherwise the LightningModule will raise a `RuntimeError`.</span>
</span><span id="CULDistributionDistance-120"><a href="#CULDistributionDistance-120"><span class="linenos">120</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance-121"><a href="#CULDistributionDistance-121"><span class="linenos">121</span></a>
</span><span id="CULDistributionDistance-122"><a href="#CULDistributionDistance-122"><span class="linenos">122</span></a>        <span class="c1"># get the batch size</span>
</span><span id="CULDistributionDistance-123"><a href="#CULDistributionDistance-123"><span class="linenos">123</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="CULDistributionDistance-124"><a href="#CULDistributionDistance-124"><span class="linenos">124</span></a>
</span><span id="CULDistributionDistance-125"><a href="#CULDistributionDistance-125"><span class="linenos">125</span></a>        <span class="n">test_task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">get_test_task_id_from_dataloader_idx</span><span class="p">(</span><span class="n">dataloader_idx</span><span class="p">)</span>
</span><span id="CULDistributionDistance-126"><a href="#CULDistributionDistance-126"><span class="linenos">126</span></a>
</span><span id="CULDistributionDistance-127"><a href="#CULDistributionDistance-127"><span class="linenos">127</span></a>        <span class="c1"># get the raw outputs from the outputs dictionary</span>
</span><span id="CULDistributionDistance-128"><a href="#CULDistributionDistance-128"><span class="linenos">128</span></a>        <span class="n">agg_out_main</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;agg_out_main&quot;</span><span class="p">]</span>  <span class="c1"># aggregated outputs from the main model</span>
</span><span id="CULDistributionDistance-129"><a href="#CULDistributionDistance-129"><span class="linenos">129</span></a>        <span class="n">agg_out_ref</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span>
</span><span id="CULDistributionDistance-130"><a href="#CULDistributionDistance-130"><span class="linenos">130</span></a>            <span class="s2">&quot;agg_out_ref&quot;</span>
</span><span id="CULDistributionDistance-131"><a href="#CULDistributionDistance-131"><span class="linenos">131</span></a>        <span class="p">]</span>  <span class="c1"># aggregated outputs from the reference model</span>
</span><span id="CULDistributionDistance-132"><a href="#CULDistributionDistance-132"><span class="linenos">132</span></a>
</span><span id="CULDistributionDistance-133"><a href="#CULDistributionDistance-133"><span class="linenos">133</span></a>        <span class="k">if</span> <span class="n">agg_out_main</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="CULDistributionDistance-134"><a href="#CULDistributionDistance-134"><span class="linenos">134</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="CULDistributionDistance-135"><a href="#CULDistributionDistance-135"><span class="linenos">135</span></a>                <span class="sa">f</span><span class="s2">&quot;Expected aggregated outputs to be (batch_size, flattened feature), i.e. 2 dimension, but got </span><span class="si">{</span><span class="n">agg_out_main</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="CULDistributionDistance-136"><a href="#CULDistributionDistance-136"><span class="linenos">136</span></a>            <span class="p">)</span>
</span><span id="CULDistributionDistance-137"><a href="#CULDistributionDistance-137"><span class="linenos">137</span></a>
</span><span id="CULDistributionDistance-138"><a href="#CULDistributionDistance-138"><span class="linenos">138</span></a>        <span class="k">if</span> <span class="n">agg_out_ref</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="CULDistributionDistance-139"><a href="#CULDistributionDistance-139"><span class="linenos">139</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="CULDistributionDistance-140"><a href="#CULDistributionDistance-140"><span class="linenos">140</span></a>                <span class="sa">f</span><span class="s2">&quot;Expected aggregated outputs to be (batch_size, flattened feature), i.e. 2 dimension, but got </span><span class="si">{</span><span class="n">agg_out_ref</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="CULDistributionDistance-141"><a href="#CULDistributionDistance-141"><span class="linenos">141</span></a>            <span class="p">)</span>
</span><span id="CULDistributionDistance-142"><a href="#CULDistributionDistance-142"><span class="linenos">142</span></a>
</span><span id="CULDistributionDistance-143"><a href="#CULDistributionDistance-143"><span class="linenos">143</span></a>        <span class="c1"># calculate the distribution distance between the main and reference model outputs</span>
</span><span id="CULDistributionDistance-144"><a href="#CULDistributionDistance-144"><span class="linenos">144</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance_type</span> <span class="o">==</span> <span class="s2">&quot;euclidean&quot;</span><span class="p">:</span>
</span><span id="CULDistributionDistance-145"><a href="#CULDistributionDistance-145"><span class="linenos">145</span></a>            <span class="n">distance</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
</span><span id="CULDistributionDistance-146"><a href="#CULDistributionDistance-146"><span class="linenos">146</span></a>                <span class="n">agg_out_main</span> <span class="o">-</span> <span class="n">agg_out_ref</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span>
</span><span id="CULDistributionDistance-147"><a href="#CULDistributionDistance-147"><span class="linenos">147</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># Euclidean distance</span>
</span><span id="CULDistributionDistance-148"><a href="#CULDistributionDistance-148"><span class="linenos">148</span></a>
</span><span id="CULDistributionDistance-149"><a href="#CULDistributionDistance-149"><span class="linenos">149</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance_type</span> <span class="o">==</span> <span class="s2">&quot;cosine&quot;</span><span class="p">:</span>
</span><span id="CULDistributionDistance-150"><a href="#CULDistributionDistance-150"><span class="linenos">150</span></a>            <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CULDistributionDistance-151"><a href="#CULDistributionDistance-151"><span class="linenos">151</span></a>                <span class="mi">1</span>
</span><span id="CULDistributionDistance-152"><a href="#CULDistributionDistance-152"><span class="linenos">152</span></a>                <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">cosine_similarity</span><span class="p">(</span>
</span><span id="CULDistributionDistance-153"><a href="#CULDistributionDistance-153"><span class="linenos">153</span></a>                    <span class="n">agg_out_main</span><span class="p">,</span> <span class="n">agg_out_ref</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span>
</span><span id="CULDistributionDistance-154"><a href="#CULDistributionDistance-154"><span class="linenos">154</span></a>                <span class="p">)</span>
</span><span id="CULDistributionDistance-155"><a href="#CULDistributionDistance-155"><span class="linenos">155</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># cosine distance</span>
</span><span id="CULDistributionDistance-156"><a href="#CULDistributionDistance-156"><span class="linenos">156</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance_type</span> <span class="o">==</span> <span class="s2">&quot;manhattan&quot;</span><span class="p">:</span>
</span><span id="CULDistributionDistance-157"><a href="#CULDistributionDistance-157"><span class="linenos">157</span></a>            <span class="n">distance</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
</span><span id="CULDistributionDistance-158"><a href="#CULDistributionDistance-158"><span class="linenos">158</span></a>                <span class="n">agg_out_main</span> <span class="o">-</span> <span class="n">agg_out_ref</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span>
</span><span id="CULDistributionDistance-159"><a href="#CULDistributionDistance-159"><span class="linenos">159</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># Manhattan distance</span>
</span><span id="CULDistributionDistance-160"><a href="#CULDistributionDistance-160"><span class="linenos">160</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CULDistributionDistance-161"><a href="#CULDistributionDistance-161"><span class="linenos">161</span></a>            <span class="n">distance</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CULDistributionDistance-162"><a href="#CULDistributionDistance-162"><span class="linenos">162</span></a>
</span><span id="CULDistributionDistance-163"><a href="#CULDistributionDistance-163"><span class="linenos">163</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the metrics of the epoch</span>
</span><span id="CULDistributionDistance-164"><a href="#CULDistributionDistance-164"><span class="linenos">164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">test_task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="CULDistributionDistance-165"><a href="#CULDistributionDistance-165"><span class="linenos">165</span></a>
</span><span id="CULDistributionDistance-166"><a href="#CULDistributionDistance-166"><span class="linenos">166</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CULDistributionDistance-167"><a href="#CULDistributionDistance-167"><span class="linenos">167</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_epoch_end</span><span class="p">(</span>
</span><span id="CULDistributionDistance-168"><a href="#CULDistributionDistance-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULDistributionDistance-169"><a href="#CULDistributionDistance-169"><span class="linenos">169</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CULDistributionDistance-170"><a href="#CULDistributionDistance-170"><span class="linenos">170</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CULEvaluation</span><span class="p">,</span>
</span><span id="CULDistributionDistance-171"><a href="#CULDistributionDistance-171"><span class="linenos">171</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULDistributionDistance-172"><a href="#CULDistributionDistance-172"><span class="linenos">172</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save and plot test metrics at the end of test.&quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance-173"><a href="#CULDistributionDistance-173"><span class="linenos">173</span></a>
</span><span id="CULDistributionDistance-174"><a href="#CULDistributionDistance-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_unlearning_test_distance_to_csv</span><span class="p">(</span>
</span><span id="CULDistributionDistance-175"><a href="#CULDistributionDistance-175"><span class="linenos">175</span></a>            <span class="n">distance_metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance</span><span class="p">,</span>
</span><span id="CULDistributionDistance-176"><a href="#CULDistributionDistance-176"><span class="linenos">176</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance_csv_path</span><span class="p">,</span>
</span><span id="CULDistributionDistance-177"><a href="#CULDistributionDistance-177"><span class="linenos">177</span></a>        <span class="p">)</span>
</span><span id="CULDistributionDistance-178"><a href="#CULDistributionDistance-178"><span class="linenos">178</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot_unlearning_test_distance_from_csv</span><span class="p">(</span>
</span><span id="CULDistributionDistance-179"><a href="#CULDistributionDistance-179"><span class="linenos">179</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance_csv_path</span><span class="p">,</span>
</span><span id="CULDistributionDistance-180"><a href="#CULDistributionDistance-180"><span class="linenos">180</span></a>            <span class="n">plot_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unlearning_test_distance_plot_path</span><span class="p">,</span>
</span><span id="CULDistributionDistance-181"><a href="#CULDistributionDistance-181"><span class="linenos">181</span></a>        <span class="p">)</span>
</span><span id="CULDistributionDistance-182"><a href="#CULDistributionDistance-182"><span class="linenos">182</span></a>
</span><span id="CULDistributionDistance-183"><a href="#CULDistributionDistance-183"><span class="linenos">183</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_unlearning_test_distance_to_csv</span><span class="p">(</span>
</span><span id="CULDistributionDistance-184"><a href="#CULDistributionDistance-184"><span class="linenos">184</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULDistributionDistance-185"><a href="#CULDistributionDistance-185"><span class="linenos">185</span></a>        <span class="n">distance_metric</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">],</span>
</span><span id="CULDistributionDistance-186"><a href="#CULDistributionDistance-186"><span class="linenos">186</span></a>        <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CULDistributionDistance-187"><a href="#CULDistributionDistance-187"><span class="linenos">187</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULDistributionDistance-188"><a href="#CULDistributionDistance-188"><span class="linenos">188</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Update the unlearning test distance metrics of unlearning tasks to CSV file.</span>
</span><span id="CULDistributionDistance-189"><a href="#CULDistributionDistance-189"><span class="linenos">189</span></a>
</span><span id="CULDistributionDistance-190"><a href="#CULDistributionDistance-190"><span class="linenos">190</span></a><span class="sd">        **Args:**</span>
</span><span id="CULDistributionDistance-191"><a href="#CULDistributionDistance-191"><span class="linenos">191</span></a><span class="sd">        - **distance_metric** (`dict[str, MeanMetricBatch]`): the distance metric of unlearned tasks. Accumulated and calculated from the unlearning test batches.</span>
</span><span id="CULDistributionDistance-192"><a href="#CULDistributionDistance-192"><span class="linenos">192</span></a><span class="sd">        - **csv_path** (`str`): save the test metric to path. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/unlearning_test_after_task_X/distance.csv&#39;.</span>
</span><span id="CULDistributionDistance-193"><a href="#CULDistributionDistance-193"><span class="linenos">193</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance-194"><a href="#CULDistributionDistance-194"><span class="linenos">194</span></a>
</span><span id="CULDistributionDistance-195"><a href="#CULDistributionDistance-195"><span class="linenos">195</span></a>        <span class="n">eval_task_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">distance_metric</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="CULDistributionDistance-196"><a href="#CULDistributionDistance-196"><span class="linenos">196</span></a>        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;average_distribution_distance&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="CULDistributionDistance-197"><a href="#CULDistributionDistance-197"><span class="linenos">197</span></a>            <span class="sa">f</span><span class="s2">&quot;unlearning_test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">eval_task_ids</span>
</span><span id="CULDistributionDistance-198"><a href="#CULDistributionDistance-198"><span class="linenos">198</span></a>        <span class="p">]</span>
</span><span id="CULDistributionDistance-199"><a href="#CULDistributionDistance-199"><span class="linenos">199</span></a>
</span><span id="CULDistributionDistance-200"><a href="#CULDistributionDistance-200"><span class="linenos">200</span></a>        <span class="n">new_line</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="CULDistributionDistance-201"><a href="#CULDistributionDistance-201"><span class="linenos">201</span></a>
</span><span id="CULDistributionDistance-202"><a href="#CULDistributionDistance-202"><span class="linenos">202</span></a>        <span class="c1"># write to the columns and calculate the average distribution distance over tasks at the same time</span>
</span><span id="CULDistributionDistance-203"><a href="#CULDistributionDistance-203"><span class="linenos">203</span></a>        <span class="n">average_distribution_distance_over_unlearned_tasks</span> <span class="o">=</span> <span class="n">MeanMetric</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
</span><span id="CULDistributionDistance-204"><a href="#CULDistributionDistance-204"><span class="linenos">204</span></a>            <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">distance_metric</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">device</span>
</span><span id="CULDistributionDistance-205"><a href="#CULDistributionDistance-205"><span class="linenos">205</span></a>        <span class="p">)</span>
</span><span id="CULDistributionDistance-206"><a href="#CULDistributionDistance-206"><span class="linenos">206</span></a>        <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">eval_task_ids</span><span class="p">:</span>
</span><span id="CULDistributionDistance-207"><a href="#CULDistributionDistance-207"><span class="linenos">207</span></a>            <span class="n">loss_cls</span> <span class="o">=</span> <span class="n">distance_metric</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="CULDistributionDistance-208"><a href="#CULDistributionDistance-208"><span class="linenos">208</span></a>            <span class="n">new_line</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;unlearning_test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_cls</span>
</span><span id="CULDistributionDistance-209"><a href="#CULDistributionDistance-209"><span class="linenos">209</span></a>            <span class="n">average_distribution_distance_over_unlearned_tasks</span><span class="p">(</span><span class="n">loss_cls</span><span class="p">)</span>
</span><span id="CULDistributionDistance-210"><a href="#CULDistributionDistance-210"><span class="linenos">210</span></a>        <span class="n">new_line</span><span class="p">[</span><span class="s2">&quot;average_distribution_distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CULDistributionDistance-211"><a href="#CULDistributionDistance-211"><span class="linenos">211</span></a>            <span class="n">average_distribution_distance_over_unlearned_tasks</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="CULDistributionDistance-212"><a href="#CULDistributionDistance-212"><span class="linenos">212</span></a>        <span class="p">)</span>
</span><span id="CULDistributionDistance-213"><a href="#CULDistributionDistance-213"><span class="linenos">213</span></a>
</span><span id="CULDistributionDistance-214"><a href="#CULDistributionDistance-214"><span class="linenos">214</span></a>        <span class="c1"># write to the csv file</span>
</span><span id="CULDistributionDistance-215"><a href="#CULDistributionDistance-215"><span class="linenos">215</span></a>        <span class="n">is_first</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CULDistributionDistance-216"><a href="#CULDistributionDistance-216"><span class="linenos">216</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
</span><span id="CULDistributionDistance-217"><a href="#CULDistributionDistance-217"><span class="linenos">217</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CULDistributionDistance-218"><a href="#CULDistributionDistance-218"><span class="linenos">218</span></a>                <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span id="CULDistributionDistance-219"><a href="#CULDistributionDistance-219"><span class="linenos">219</span></a>                <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CULDistributionDistance-220"><a href="#CULDistributionDistance-220"><span class="linenos">220</span></a>        <span class="c1"># write header</span>
</span><span id="CULDistributionDistance-221"><a href="#CULDistributionDistance-221"><span class="linenos">221</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CULDistributionDistance-222"><a href="#CULDistributionDistance-222"><span class="linenos">222</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="CULDistributionDistance-223"><a href="#CULDistributionDistance-223"><span class="linenos">223</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="CULDistributionDistance-224"><a href="#CULDistributionDistance-224"><span class="linenos">224</span></a>        <span class="c1"># write metrics</span>
</span><span id="CULDistributionDistance-225"><a href="#CULDistributionDistance-225"><span class="linenos">225</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CULDistributionDistance-226"><a href="#CULDistributionDistance-226"><span class="linenos">226</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
</span><span id="CULDistributionDistance-227"><a href="#CULDistributionDistance-227"><span class="linenos">227</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>  <span class="c1"># write the previous lines</span>
</span><span id="CULDistributionDistance-228"><a href="#CULDistributionDistance-228"><span class="linenos">228</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="CULDistributionDistance-229"><a href="#CULDistributionDistance-229"><span class="linenos">229</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
</span><span id="CULDistributionDistance-230"><a href="#CULDistributionDistance-230"><span class="linenos">230</span></a>
</span><span id="CULDistributionDistance-231"><a href="#CULDistributionDistance-231"><span class="linenos">231</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_unlearning_test_distance_from_csv</span><span class="p">(</span>
</span><span id="CULDistributionDistance-232"><a href="#CULDistributionDistance-232"><span class="linenos">232</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="CULDistributionDistance-233"><a href="#CULDistributionDistance-233"><span class="linenos">233</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULDistributionDistance-234"><a href="#CULDistributionDistance-234"><span class="linenos">234</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the unlearning test distance matrix over different unlearned tasks from saved CSV file and save the plot to the designated directory.</span>
</span><span id="CULDistributionDistance-235"><a href="#CULDistributionDistance-235"><span class="linenos">235</span></a>
</span><span id="CULDistributionDistance-236"><a href="#CULDistributionDistance-236"><span class="linenos">236</span></a><span class="sd">        **Args:**</span>
</span><span id="CULDistributionDistance-237"><a href="#CULDistributionDistance-237"><span class="linenos">237</span></a><span class="sd">        - **csv_path** (`str`): the path to the CSV file where the `utils.save_unlearning_test_distance_to_csv()` saved the unlearning test distance metric.</span>
</span><span id="CULDistributionDistance-238"><a href="#CULDistributionDistance-238"><span class="linenos">238</span></a><span class="sd">        - **plot_path** (`str`): the path to save plot. Better same as the output directory of the experiment. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/unlearning_test_after_task_X/distance.png&#39;.</span>
</span><span id="CULDistributionDistance-239"><a href="#CULDistributionDistance-239"><span class="linenos">239</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance-240"><a href="#CULDistributionDistance-240"><span class="linenos">240</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CULDistributionDistance-241"><a href="#CULDistributionDistance-241"><span class="linenos">241</span></a>
</span><span id="CULDistributionDistance-242"><a href="#CULDistributionDistance-242"><span class="linenos">242</span></a>        <span class="n">unlearned_task_ids</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="CULDistributionDistance-243"><a href="#CULDistributionDistance-243"><span class="linenos">243</span></a>            <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;unlearning_test_on_task_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</span><span id="CULDistributionDistance-244"><a href="#CULDistributionDistance-244"><span class="linenos">244</span></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="CULDistributionDistance-245"><a href="#CULDistributionDistance-245"><span class="linenos">245</span></a>            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;unlearning_test_on_task_&quot;</span><span class="p">)</span>
</span><span id="CULDistributionDistance-246"><a href="#CULDistributionDistance-246"><span class="linenos">246</span></a>        <span class="p">]</span>
</span><span id="CULDistributionDistance-247"><a href="#CULDistributionDistance-247"><span class="linenos">247</span></a>        <span class="n">num_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unlearned_task_ids</span><span class="p">)</span>
</span><span id="CULDistributionDistance-248"><a href="#CULDistributionDistance-248"><span class="linenos">248</span></a>        <span class="n">num_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="CULDistributionDistance-249"><a href="#CULDistributionDistance-249"><span class="linenos">249</span></a>
</span><span id="CULDistributionDistance-250"><a href="#CULDistributionDistance-250"><span class="linenos">250</span></a>        <span class="c1"># plot the accuracy matrix</span>
</span><span id="CULDistributionDistance-251"><a href="#CULDistributionDistance-251"><span class="linenos">251</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="CULDistributionDistance-252"><a href="#CULDistributionDistance-252"><span class="linenos">252</span></a>            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_tasks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_tests</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="CULDistributionDistance-253"><a href="#CULDistributionDistance-253"><span class="linenos">253</span></a>        <span class="p">)</span>  <span class="c1"># adaptive figure size</span>
</span><span id="CULDistributionDistance-254"><a href="#CULDistributionDistance-254"><span class="linenos">254</span></a>        <span class="n">cax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
</span><span id="CULDistributionDistance-255"><a href="#CULDistributionDistance-255"><span class="linenos">255</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;average_distribution_distance&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span><span id="CULDistributionDistance-256"><a href="#CULDistributionDistance-256"><span class="linenos">256</span></a>            <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
</span><span id="CULDistributionDistance-257"><a href="#CULDistributionDistance-257"><span class="linenos">257</span></a>            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greens&quot;</span><span class="p">,</span>
</span><span id="CULDistributionDistance-258"><a href="#CULDistributionDistance-258"><span class="linenos">258</span></a>            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="CULDistributionDistance-259"><a href="#CULDistributionDistance-259"><span class="linenos">259</span></a>            <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="CULDistributionDistance-260"><a href="#CULDistributionDistance-260"><span class="linenos">260</span></a>        <span class="p">)</span>
</span><span id="CULDistributionDistance-261"><a href="#CULDistributionDistance-261"><span class="linenos">261</span></a>
</span><span id="CULDistributionDistance-262"><a href="#CULDistributionDistance-262"><span class="linenos">262</span></a>        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cax</span><span class="p">)</span>
</span><span id="CULDistributionDistance-263"><a href="#CULDistributionDistance-263"><span class="linenos">263</span></a>        <span class="n">yticks</span> <span class="o">=</span> <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()</span>
</span><span id="CULDistributionDistance-264"><a href="#CULDistributionDistance-264"><span class="linenos">264</span></a>        <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
</span><span id="CULDistributionDistance-265"><a href="#CULDistributionDistance-265"><span class="linenos">265</span></a>        <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="CULDistributionDistance-266"><a href="#CULDistributionDistance-266"><span class="linenos">266</span></a>            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">yticks</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CULDistributionDistance-267"><a href="#CULDistributionDistance-267"><span class="linenos">267</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULDistributionDistance-268"><a href="#CULDistributionDistance-268"><span class="linenos">268</span></a>
</span><span id="CULDistributionDistance-269"><a href="#CULDistributionDistance-269"><span class="linenos">269</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="CULDistributionDistance-270"><a href="#CULDistributionDistance-270"><span class="linenos">270</span></a>        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tests</span><span class="p">):</span>
</span><span id="CULDistributionDistance-271"><a href="#CULDistributionDistance-271"><span class="linenos">271</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">):</span>
</span><span id="CULDistributionDistance-272"><a href="#CULDistributionDistance-272"><span class="linenos">272</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="n">unlearned_task_ids</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
</span><span id="CULDistributionDistance-273"><a href="#CULDistributionDistance-273"><span class="linenos">273</span></a>                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CULDistributionDistance-274"><a href="#CULDistributionDistance-274"><span class="linenos">274</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;unlearning_test_on_task_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="CULDistributionDistance-275"><a href="#CULDistributionDistance-275"><span class="linenos">275</span></a>                    <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;unlearning_test_on_task_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="CULDistributionDistance-276"><a href="#CULDistributionDistance-276"><span class="linenos">276</span></a>                    <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="CULDistributionDistance-277"><a href="#CULDistributionDistance-277"><span class="linenos">277</span></a>                <span class="p">)</span>
</span><span id="CULDistributionDistance-278"><a href="#CULDistributionDistance-278"><span class="linenos">278</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="CULDistributionDistance-279"><a href="#CULDistributionDistance-279"><span class="linenos">279</span></a>                    <span class="n">c</span><span class="p">,</span>
</span><span id="CULDistributionDistance-280"><a href="#CULDistributionDistance-280"><span class="linenos">280</span></a>                    <span class="n">r</span><span class="p">,</span>
</span><span id="CULDistributionDistance-281"><a href="#CULDistributionDistance-281"><span class="linenos">281</span></a>                    <span class="n">s</span><span class="p">,</span>
</span><span id="CULDistributionDistance-282"><a href="#CULDistributionDistance-282"><span class="linenos">282</span></a>                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="CULDistributionDistance-283"><a href="#CULDistributionDistance-283"><span class="linenos">283</span></a>                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="CULDistributionDistance-284"><a href="#CULDistributionDistance-284"><span class="linenos">284</span></a>                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="CULDistributionDistance-285"><a href="#CULDistributionDistance-285"><span class="linenos">285</span></a>                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">,</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULDistributionDistance-286"><a href="#CULDistributionDistance-286"><span class="linenos">286</span></a>                <span class="p">)</span>
</span><span id="CULDistributionDistance-287"><a href="#CULDistributionDistance-287"><span class="linenos">287</span></a>
</span><span id="CULDistributionDistance-288"><a href="#CULDistributionDistance-288"><span class="linenos">288</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">))</span>
</span><span id="CULDistributionDistance-289"><a href="#CULDistributionDistance-289"><span class="linenos">289</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_tests</span><span class="p">))</span>
</span><span id="CULDistributionDistance-290"><a href="#CULDistributionDistance-290"><span class="linenos">290</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span>
</span><span id="CULDistributionDistance-291"><a href="#CULDistributionDistance-291"><span class="linenos">291</span></a>            <span class="n">unlearned_task_ids</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CULDistributionDistance-292"><a href="#CULDistributionDistance-292"><span class="linenos">292</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULDistributionDistance-293"><a href="#CULDistributionDistance-293"><span class="linenos">293</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="CULDistributionDistance-294"><a href="#CULDistributionDistance-294"><span class="linenos">294</span></a>            <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_tests</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tests</span>
</span><span id="CULDistributionDistance-295"><a href="#CULDistributionDistance-295"><span class="linenos">295</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULDistributionDistance-296"><a href="#CULDistributionDistance-296"><span class="linenos">296</span></a>
</span><span id="CULDistributionDistance-297"><a href="#CULDistributionDistance-297"><span class="linenos">297</span></a>        <span class="c1"># Labeling the axes</span>
</span><span id="CULDistributionDistance-298"><a href="#CULDistributionDistance-298"><span class="linenos">298</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
</span><span id="CULDistributionDistance-299"><a href="#CULDistributionDistance-299"><span class="linenos">299</span></a>            <span class="s2">&quot;Testing unlearning on task &quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CULDistributionDistance-300"><a href="#CULDistributionDistance-300"><span class="linenos">300</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULDistributionDistance-301"><a href="#CULDistributionDistance-301"><span class="linenos">301</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
</span><span id="CULDistributionDistance-302"><a href="#CULDistributionDistance-302"><span class="linenos">302</span></a>            <span class="s2">&quot;Unlearning test after training task t&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CULDistributionDistance-303"><a href="#CULDistributionDistance-303"><span class="linenos">303</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULDistributionDistance-304"><a href="#CULDistributionDistance-304"><span class="linenos">304</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="CULDistributionDistance-305"><a href="#CULDistributionDistance-305"><span class="linenos">305</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span><span id="CULDistributionDistance-306"><a href="#CULDistributionDistance-306"><span class="linenos">306</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Provides all actions that are related to CUL distribution distance (DD) metric, which include:</p>

<ul>
<li>Defining, initializing and recording DD metric.</li>
<li>Saving DD metric to files.</li>
<li>Visualizing DD metric as plots.</li>
</ul>

<p>The callback is able to produce the following outputs:</p>

<ul>
<li>CSV files for DD in each task.</li>
<li>Coloured plot for DD in each task.</li>
</ul>

<p>Note that this callback is designed to be used with the <code>CULEvaluation</code> module, which is a special evaluation module for continual unlearning. It is not a typical test step in the algorithm, but rather a test protocol that evaluates the performance of the model on unlearned tasks.</p>
</div>


                            <div id="CULDistributionDistance.__init__" class="classattr">
                                        <input id="CULDistributionDistance.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">CULDistributionDistance</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">distribution_distance_type</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">distribution_distance_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;dd.csv&#39;</span>,</span><span class="param">	<span class="n">distribution_distance_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="CULDistributionDistance.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CULDistributionDistance.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CULDistributionDistance.__init__-45"><a href="#CULDistributionDistance.__init__-45"><span class="linenos">45</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="CULDistributionDistance.__init__-46"><a href="#CULDistributionDistance.__init__-46"><span class="linenos">46</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULDistributionDistance.__init__-47"><a href="#CULDistributionDistance.__init__-47"><span class="linenos">47</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CULDistributionDistance.__init__-48"><a href="#CULDistributionDistance.__init__-48"><span class="linenos">48</span></a>        <span class="n">distribution_distance_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CULDistributionDistance.__init__-49"><a href="#CULDistributionDistance.__init__-49"><span class="linenos">49</span></a>        <span class="n">distribution_distance_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;dd.csv&quot;</span><span class="p">,</span>
</span><span id="CULDistributionDistance.__init__-50"><a href="#CULDistributionDistance.__init__-50"><span class="linenos">50</span></a>        <span class="n">distribution_distance_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CULDistributionDistance.__init__-51"><a href="#CULDistributionDistance.__init__-51"><span class="linenos">51</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULDistributionDistance.__init__-52"><a href="#CULDistributionDistance.__init__-52"><span class="linenos">52</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `CULDistributionDistance`.</span>
</span><span id="CULDistributionDistance.__init__-53"><a href="#CULDistributionDistance.__init__-53"><span class="linenos">53</span></a>
</span><span id="CULDistributionDistance.__init__-54"><a href="#CULDistributionDistance.__init__-54"><span class="linenos">54</span></a><span class="sd">        **Args:**</span>
</span><span id="CULDistributionDistance.__init__-55"><a href="#CULDistributionDistance.__init__-55"><span class="linenos">55</span></a><span class="sd">        - **save_dir** (`str`): The directory where data and figures of metrics will be saved. Better inside the output folder.</span>
</span><span id="CULDistributionDistance.__init__-56"><a href="#CULDistributionDistance.__init__-56"><span class="linenos">56</span></a><span class="sd">        - **distribution_distance_type** (`str`): the type of distribution distance to use. Should be one of the following:</span>
</span><span id="CULDistributionDistance.__init__-57"><a href="#CULDistributionDistance.__init__-57"><span class="linenos">57</span></a><span class="sd">            - &#39;euclidean&#39;: Eulidean distance.</span>
</span><span id="CULDistributionDistance.__init__-58"><a href="#CULDistributionDistance.__init__-58"><span class="linenos">58</span></a><span class="sd">            - &#39;cosine&#39;: Cosine distance.</span>
</span><span id="CULDistributionDistance.__init__-59"><a href="#CULDistributionDistance.__init__-59"><span class="linenos">59</span></a><span class="sd">            - &#39;manhattan&#39;: Manhattan distance.</span>
</span><span id="CULDistributionDistance.__init__-60"><a href="#CULDistributionDistance.__init__-60"><span class="linenos">60</span></a><span class="sd">        - **distribution_distance_csv_name** (`str`): file name to save test distribution distance metrics as CSV file.</span>
</span><span id="CULDistributionDistance.__init__-61"><a href="#CULDistributionDistance.__init__-61"><span class="linenos">61</span></a><span class="sd">        - **distribution_distance_plot_name** (`str` | `None`): file name to save test distribution distance metrics as plot. If `None`, no plot will be saved.</span>
</span><span id="CULDistributionDistance.__init__-62"><a href="#CULDistributionDistance.__init__-62"><span class="linenos">62</span></a>
</span><span id="CULDistributionDistance.__init__-63"><a href="#CULDistributionDistance.__init__-63"><span class="linenos">63</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance.__init__-64"><a href="#CULDistributionDistance.__init__-64"><span class="linenos">64</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="CULDistributionDistance.__init__-65"><a href="#CULDistributionDistance.__init__-65"><span class="linenos">65</span></a>
</span><span id="CULDistributionDistance.__init__-66"><a href="#CULDistributionDistance.__init__-66"><span class="linenos">66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">distribution_distance_type</span>
</span><span id="CULDistributionDistance.__init__-67"><a href="#CULDistributionDistance.__init__-67"><span class="linenos">67</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the type of distribution distance to use. &quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance.__init__-68"><a href="#CULDistributionDistance.__init__-68"><span class="linenos">68</span></a>
</span><span id="CULDistributionDistance.__init__-69"><a href="#CULDistributionDistance.__init__-69"><span class="linenos">69</span></a>        <span class="c1"># paths</span>
</span><span id="CULDistributionDistance.__init__-70"><a href="#CULDistributionDistance.__init__-70"><span class="linenos">70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance_csv_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="CULDistributionDistance.__init__-71"><a href="#CULDistributionDistance.__init__-71"><span class="linenos">71</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">distribution_distance_csv_name</span>
</span><span id="CULDistributionDistance.__init__-72"><a href="#CULDistributionDistance.__init__-72"><span class="linenos">72</span></a>        <span class="p">)</span>
</span><span id="CULDistributionDistance.__init__-73"><a href="#CULDistributionDistance.__init__-73"><span class="linenos">73</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the path to save the test distribution distance metrics CSV file.&quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance.__init__-74"><a href="#CULDistributionDistance.__init__-74"><span class="linenos">74</span></a>        <span class="k">if</span> <span class="n">distribution_distance_plot_name</span><span class="p">:</span>
</span><span id="CULDistributionDistance.__init__-75"><a href="#CULDistributionDistance.__init__-75"><span class="linenos">75</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">unlearning_test_distance_plot_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="CULDistributionDistance.__init__-76"><a href="#CULDistributionDistance.__init__-76"><span class="linenos">76</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">distribution_distance_plot_name</span>
</span><span id="CULDistributionDistance.__init__-77"><a href="#CULDistributionDistance.__init__-77"><span class="linenos">77</span></a>            <span class="p">)</span>
</span><span id="CULDistributionDistance.__init__-78"><a href="#CULDistributionDistance.__init__-78"><span class="linenos">78</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the path to save the test distribution distance metrics plot file.&quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance.__init__-79"><a href="#CULDistributionDistance.__init__-79"><span class="linenos">79</span></a>
</span><span id="CULDistributionDistance.__init__-80"><a href="#CULDistributionDistance.__init__-80"><span class="linenos">80</span></a>        <span class="c1"># test accumulated metrics</span>
</span><span id="CULDistributionDistance.__init__-81"><a href="#CULDistributionDistance.__init__-81"><span class="linenos">81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">]</span>
</span><span id="CULDistributionDistance.__init__-82"><a href="#CULDistributionDistance.__init__-82"><span class="linenos">82</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Distribution distance unlearning metrics for each seen task. Accumulated and calculated from the test batches. Keys are task IDs and values are the corresponding metrics.&quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance.__init__-83"><a href="#CULDistributionDistance.__init__-83"><span class="linenos">83</span></a>
</span><span id="CULDistributionDistance.__init__-84"><a href="#CULDistributionDistance.__init__-84"><span class="linenos">84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="CULDistributionDistance.__init__-85"><a href="#CULDistributionDistance.__init__-85"><span class="linenos">85</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Task ID counter indicating which task is being processed. Self updated during the task loop. Starting from 1. &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the <code><a href="#CULDistributionDistance">CULDistributionDistance</a></code>.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>save_dir</strong> (<code>str</code>): The directory where data and figures of metrics will be saved. Better inside the output folder.</li>
<li><strong>distribution_distance_type</strong> (<code>str</code>): the type of distribution distance to use. Should be one of the following:
<ul>
<li>'euclidean': Eulidean distance.</li>
<li>'cosine': Cosine distance.</li>
<li>'manhattan': Manhattan distance.</li>
</ul></li>
<li><strong>distribution_distance_csv_name</strong> (<code>str</code>): file name to save test distribution distance metrics as CSV file.</li>
<li><strong>distribution_distance_plot_name</strong> (<code>str</code> | <code>None</code>): file name to save test distribution distance metrics as plot. If <code>None</code>, no plot will be saved.</li>
</ul>
</div>


                            </div>
                            <div id="CULDistributionDistance.distribution_distance_type" class="classattr">
                                <div class="attr variable">
            <span class="name">distribution_distance_type</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#CULDistributionDistance.distribution_distance_type"></a>
    
            <div class="docstring"><p>Store the type of distribution distance to use.</p>
</div>


                            </div>
                            <div id="CULDistributionDistance.distribution_distance_csv_path" class="classattr">
                                <div class="attr variable">
            <span class="name">distribution_distance_csv_path</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#CULDistributionDistance.distribution_distance_csv_path"></a>
    
            <div class="docstring"><p>Store the path to save the test distribution distance metrics CSV file.</p>
</div>


                            </div>
                            <div id="CULDistributionDistance.distribution_distance" class="classattr">
                                <div class="attr variable">
            <span class="name">distribution_distance</span><span class="annotation">: dict[str, <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a>]</span>

        
    </div>
    <a class="headerlink" href="#CULDistributionDistance.distribution_distance"></a>
    
            <div class="docstring"><p>Distribution distance unlearning metrics for each seen task. Accumulated and calculated from the test batches. Keys are task IDs and values are the corresponding metrics.</p>
</div>


                            </div>
                            <div id="CULDistributionDistance.task_id" class="classattr">
                                <div class="attr variable">
            <span class="name">task_id</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#CULDistributionDistance.task_id"></a>
    
            <div class="docstring"><p>Task ID counter indicating which task is being processed. Self updated during the task loop. Starting from 1.</p>
</div>


                            </div>
                            <div id="CULDistributionDistance.on_test_start" class="classattr">
                                        <input id="CULDistributionDistance.on_test_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_test_start</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="utils/eval.html#CULEvaluation">clarena.utils.eval.CULEvaluation</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CULDistributionDistance.on_test_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CULDistributionDistance.on_test_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CULDistributionDistance.on_test_start-87"><a href="#CULDistributionDistance.on_test_start-87"><span class="linenos"> 87</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CULDistributionDistance.on_test_start-88"><a href="#CULDistributionDistance.on_test_start-88"><span class="linenos"> 88</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_start</span><span class="p">(</span>
</span><span id="CULDistributionDistance.on_test_start-89"><a href="#CULDistributionDistance.on_test_start-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULDistributionDistance.on_test_start-90"><a href="#CULDistributionDistance.on_test_start-90"><span class="linenos"> 90</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CULDistributionDistance.on_test_start-91"><a href="#CULDistributionDistance.on_test_start-91"><span class="linenos"> 91</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CULEvaluation</span><span class="p">,</span>
</span><span id="CULDistributionDistance.on_test_start-92"><a href="#CULDistributionDistance.on_test_start-92"><span class="linenos"> 92</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULDistributionDistance.on_test_start-93"><a href="#CULDistributionDistance.on_test_start-93"><span class="linenos"> 93</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the metrics for testing each seen task in the beginning of a task&#39;s testing.&quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance.on_test_start-94"><a href="#CULDistributionDistance.on_test_start-94"><span class="linenos"> 94</span></a>
</span><span id="CULDistributionDistance.on_test_start-95"><a href="#CULDistributionDistance.on_test_start-95"><span class="linenos"> 95</span></a>        <span class="c1"># get the device to put the metrics on the same device</span>
</span><span id="CULDistributionDistance.on_test_start-96"><a href="#CULDistributionDistance.on_test_start-96"><span class="linenos"> 96</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">device</span>
</span><span id="CULDistributionDistance.on_test_start-97"><a href="#CULDistributionDistance.on_test_start-97"><span class="linenos"> 97</span></a>
</span><span id="CULDistributionDistance.on_test_start-98"><a href="#CULDistributionDistance.on_test_start-98"><span class="linenos"> 98</span></a>        <span class="c1"># initialize test metrics for evaluation tasks</span>
</span><span id="CULDistributionDistance.on_test_start-99"><a href="#CULDistributionDistance.on_test_start-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="CULDistributionDistance.on_test_start-100"><a href="#CULDistributionDistance.on_test_start-100"><span class="linenos">100</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">MeanMetricBatch</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="CULDistributionDistance.on_test_start-101"><a href="#CULDistributionDistance.on_test_start-101"><span class="linenos">101</span></a>            <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">dd_eval_task_ids</span>
</span><span id="CULDistributionDistance.on_test_start-102"><a href="#CULDistributionDistance.on_test_start-102"><span class="linenos">102</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the metrics for testing each seen task in the beginning of a task's testing.</p>
</div>


                            </div>
                            <div id="CULDistributionDistance.on_test_batch_end" class="classattr">
                                        <input id="CULDistributionDistance.on_test_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_test_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="utils/eval.html#CULEvaluation">clarena.utils.eval.CULEvaluation</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CULDistributionDistance.on_test_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CULDistributionDistance.on_test_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CULDistributionDistance.on_test_batch_end-104"><a href="#CULDistributionDistance.on_test_batch_end-104"><span class="linenos">104</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CULDistributionDistance.on_test_batch_end-105"><a href="#CULDistributionDistance.on_test_batch_end-105"><span class="linenos">105</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_batch_end</span><span class="p">(</span>
</span><span id="CULDistributionDistance.on_test_batch_end-106"><a href="#CULDistributionDistance.on_test_batch_end-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULDistributionDistance.on_test_batch_end-107"><a href="#CULDistributionDistance.on_test_batch_end-107"><span class="linenos">107</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CULDistributionDistance.on_test_batch_end-108"><a href="#CULDistributionDistance.on_test_batch_end-108"><span class="linenos">108</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CULEvaluation</span><span class="p">,</span>
</span><span id="CULDistributionDistance.on_test_batch_end-109"><a href="#CULDistributionDistance.on_test_batch_end-109"><span class="linenos">109</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="CULDistributionDistance.on_test_batch_end-110"><a href="#CULDistributionDistance.on_test_batch_end-110"><span class="linenos">110</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="CULDistributionDistance.on_test_batch_end-111"><a href="#CULDistributionDistance.on_test_batch_end-111"><span class="linenos">111</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CULDistributionDistance.on_test_batch_end-112"><a href="#CULDistributionDistance.on_test_batch_end-112"><span class="linenos">112</span></a>        <span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="CULDistributionDistance.on_test_batch_end-113"><a href="#CULDistributionDistance.on_test_batch_end-113"><span class="linenos">113</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULDistributionDistance.on_test_batch_end-114"><a href="#CULDistributionDistance.on_test_batch_end-114"><span class="linenos">114</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from test batch. We don&#39;t need to log and monitor the metrics of test batches.</span>
</span><span id="CULDistributionDistance.on_test_batch_end-115"><a href="#CULDistributionDistance.on_test_batch_end-115"><span class="linenos">115</span></a>
</span><span id="CULDistributionDistance.on_test_batch_end-116"><a href="#CULDistributionDistance.on_test_batch_end-116"><span class="linenos">116</span></a><span class="sd">        **Args:**</span>
</span><span id="CULDistributionDistance.on_test_batch_end-117"><a href="#CULDistributionDistance.on_test_batch_end-117"><span class="linenos">117</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the test step, which is the returns of the `test_step()` method in the `CULEvaluation`.</span>
</span><span id="CULDistributionDistance.on_test_batch_end-118"><a href="#CULDistributionDistance.on_test_batch_end-118"><span class="linenos">118</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="CULDistributionDistance.on_test_batch_end-119"><a href="#CULDistributionDistance.on_test_batch_end-119"><span class="linenos">119</span></a><span class="sd">        - **dataloader_idx** (`int`): the task ID of seen tasks to be tested. A default value of 0 is given otherwise the LightningModule will raise a `RuntimeError`.</span>
</span><span id="CULDistributionDistance.on_test_batch_end-120"><a href="#CULDistributionDistance.on_test_batch_end-120"><span class="linenos">120</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance.on_test_batch_end-121"><a href="#CULDistributionDistance.on_test_batch_end-121"><span class="linenos">121</span></a>
</span><span id="CULDistributionDistance.on_test_batch_end-122"><a href="#CULDistributionDistance.on_test_batch_end-122"><span class="linenos">122</span></a>        <span class="c1"># get the batch size</span>
</span><span id="CULDistributionDistance.on_test_batch_end-123"><a href="#CULDistributionDistance.on_test_batch_end-123"><span class="linenos">123</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="CULDistributionDistance.on_test_batch_end-124"><a href="#CULDistributionDistance.on_test_batch_end-124"><span class="linenos">124</span></a>
</span><span id="CULDistributionDistance.on_test_batch_end-125"><a href="#CULDistributionDistance.on_test_batch_end-125"><span class="linenos">125</span></a>        <span class="n">test_task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">get_test_task_id_from_dataloader_idx</span><span class="p">(</span><span class="n">dataloader_idx</span><span class="p">)</span>
</span><span id="CULDistributionDistance.on_test_batch_end-126"><a href="#CULDistributionDistance.on_test_batch_end-126"><span class="linenos">126</span></a>
</span><span id="CULDistributionDistance.on_test_batch_end-127"><a href="#CULDistributionDistance.on_test_batch_end-127"><span class="linenos">127</span></a>        <span class="c1"># get the raw outputs from the outputs dictionary</span>
</span><span id="CULDistributionDistance.on_test_batch_end-128"><a href="#CULDistributionDistance.on_test_batch_end-128"><span class="linenos">128</span></a>        <span class="n">agg_out_main</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;agg_out_main&quot;</span><span class="p">]</span>  <span class="c1"># aggregated outputs from the main model</span>
</span><span id="CULDistributionDistance.on_test_batch_end-129"><a href="#CULDistributionDistance.on_test_batch_end-129"><span class="linenos">129</span></a>        <span class="n">agg_out_ref</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span>
</span><span id="CULDistributionDistance.on_test_batch_end-130"><a href="#CULDistributionDistance.on_test_batch_end-130"><span class="linenos">130</span></a>            <span class="s2">&quot;agg_out_ref&quot;</span>
</span><span id="CULDistributionDistance.on_test_batch_end-131"><a href="#CULDistributionDistance.on_test_batch_end-131"><span class="linenos">131</span></a>        <span class="p">]</span>  <span class="c1"># aggregated outputs from the reference model</span>
</span><span id="CULDistributionDistance.on_test_batch_end-132"><a href="#CULDistributionDistance.on_test_batch_end-132"><span class="linenos">132</span></a>
</span><span id="CULDistributionDistance.on_test_batch_end-133"><a href="#CULDistributionDistance.on_test_batch_end-133"><span class="linenos">133</span></a>        <span class="k">if</span> <span class="n">agg_out_main</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="CULDistributionDistance.on_test_batch_end-134"><a href="#CULDistributionDistance.on_test_batch_end-134"><span class="linenos">134</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="CULDistributionDistance.on_test_batch_end-135"><a href="#CULDistributionDistance.on_test_batch_end-135"><span class="linenos">135</span></a>                <span class="sa">f</span><span class="s2">&quot;Expected aggregated outputs to be (batch_size, flattened feature), i.e. 2 dimension, but got </span><span class="si">{</span><span class="n">agg_out_main</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="CULDistributionDistance.on_test_batch_end-136"><a href="#CULDistributionDistance.on_test_batch_end-136"><span class="linenos">136</span></a>            <span class="p">)</span>
</span><span id="CULDistributionDistance.on_test_batch_end-137"><a href="#CULDistributionDistance.on_test_batch_end-137"><span class="linenos">137</span></a>
</span><span id="CULDistributionDistance.on_test_batch_end-138"><a href="#CULDistributionDistance.on_test_batch_end-138"><span class="linenos">138</span></a>        <span class="k">if</span> <span class="n">agg_out_ref</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="CULDistributionDistance.on_test_batch_end-139"><a href="#CULDistributionDistance.on_test_batch_end-139"><span class="linenos">139</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="CULDistributionDistance.on_test_batch_end-140"><a href="#CULDistributionDistance.on_test_batch_end-140"><span class="linenos">140</span></a>                <span class="sa">f</span><span class="s2">&quot;Expected aggregated outputs to be (batch_size, flattened feature), i.e. 2 dimension, but got </span><span class="si">{</span><span class="n">agg_out_ref</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="CULDistributionDistance.on_test_batch_end-141"><a href="#CULDistributionDistance.on_test_batch_end-141"><span class="linenos">141</span></a>            <span class="p">)</span>
</span><span id="CULDistributionDistance.on_test_batch_end-142"><a href="#CULDistributionDistance.on_test_batch_end-142"><span class="linenos">142</span></a>
</span><span id="CULDistributionDistance.on_test_batch_end-143"><a href="#CULDistributionDistance.on_test_batch_end-143"><span class="linenos">143</span></a>        <span class="c1"># calculate the distribution distance between the main and reference model outputs</span>
</span><span id="CULDistributionDistance.on_test_batch_end-144"><a href="#CULDistributionDistance.on_test_batch_end-144"><span class="linenos">144</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance_type</span> <span class="o">==</span> <span class="s2">&quot;euclidean&quot;</span><span class="p">:</span>
</span><span id="CULDistributionDistance.on_test_batch_end-145"><a href="#CULDistributionDistance.on_test_batch_end-145"><span class="linenos">145</span></a>            <span class="n">distance</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
</span><span id="CULDistributionDistance.on_test_batch_end-146"><a href="#CULDistributionDistance.on_test_batch_end-146"><span class="linenos">146</span></a>                <span class="n">agg_out_main</span> <span class="o">-</span> <span class="n">agg_out_ref</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span>
</span><span id="CULDistributionDistance.on_test_batch_end-147"><a href="#CULDistributionDistance.on_test_batch_end-147"><span class="linenos">147</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># Euclidean distance</span>
</span><span id="CULDistributionDistance.on_test_batch_end-148"><a href="#CULDistributionDistance.on_test_batch_end-148"><span class="linenos">148</span></a>
</span><span id="CULDistributionDistance.on_test_batch_end-149"><a href="#CULDistributionDistance.on_test_batch_end-149"><span class="linenos">149</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance_type</span> <span class="o">==</span> <span class="s2">&quot;cosine&quot;</span><span class="p">:</span>
</span><span id="CULDistributionDistance.on_test_batch_end-150"><a href="#CULDistributionDistance.on_test_batch_end-150"><span class="linenos">150</span></a>            <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CULDistributionDistance.on_test_batch_end-151"><a href="#CULDistributionDistance.on_test_batch_end-151"><span class="linenos">151</span></a>                <span class="mi">1</span>
</span><span id="CULDistributionDistance.on_test_batch_end-152"><a href="#CULDistributionDistance.on_test_batch_end-152"><span class="linenos">152</span></a>                <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">cosine_similarity</span><span class="p">(</span>
</span><span id="CULDistributionDistance.on_test_batch_end-153"><a href="#CULDistributionDistance.on_test_batch_end-153"><span class="linenos">153</span></a>                    <span class="n">agg_out_main</span><span class="p">,</span> <span class="n">agg_out_ref</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span>
</span><span id="CULDistributionDistance.on_test_batch_end-154"><a href="#CULDistributionDistance.on_test_batch_end-154"><span class="linenos">154</span></a>                <span class="p">)</span>
</span><span id="CULDistributionDistance.on_test_batch_end-155"><a href="#CULDistributionDistance.on_test_batch_end-155"><span class="linenos">155</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># cosine distance</span>
</span><span id="CULDistributionDistance.on_test_batch_end-156"><a href="#CULDistributionDistance.on_test_batch_end-156"><span class="linenos">156</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance_type</span> <span class="o">==</span> <span class="s2">&quot;manhattan&quot;</span><span class="p">:</span>
</span><span id="CULDistributionDistance.on_test_batch_end-157"><a href="#CULDistributionDistance.on_test_batch_end-157"><span class="linenos">157</span></a>            <span class="n">distance</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
</span><span id="CULDistributionDistance.on_test_batch_end-158"><a href="#CULDistributionDistance.on_test_batch_end-158"><span class="linenos">158</span></a>                <span class="n">agg_out_main</span> <span class="o">-</span> <span class="n">agg_out_ref</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span>
</span><span id="CULDistributionDistance.on_test_batch_end-159"><a href="#CULDistributionDistance.on_test_batch_end-159"><span class="linenos">159</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># Manhattan distance</span>
</span><span id="CULDistributionDistance.on_test_batch_end-160"><a href="#CULDistributionDistance.on_test_batch_end-160"><span class="linenos">160</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CULDistributionDistance.on_test_batch_end-161"><a href="#CULDistributionDistance.on_test_batch_end-161"><span class="linenos">161</span></a>            <span class="n">distance</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CULDistributionDistance.on_test_batch_end-162"><a href="#CULDistributionDistance.on_test_batch_end-162"><span class="linenos">162</span></a>
</span><span id="CULDistributionDistance.on_test_batch_end-163"><a href="#CULDistributionDistance.on_test_batch_end-163"><span class="linenos">163</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the metrics of the epoch</span>
</span><span id="CULDistributionDistance.on_test_batch_end-164"><a href="#CULDistributionDistance.on_test_batch_end-164"><span class="linenos">164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">test_task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Accumulating metrics from test batch. We don't need to log and monitor the metrics of test batches.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the test step, which is the returns of the <code>test_step()</code> method in the <code>CULEvaluation</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the validation data batch.</li>
<li><strong>dataloader_idx</strong> (<code>int</code>): the task ID of seen tasks to be tested. A default value of 0 is given otherwise the LightningModule will raise a <code>RuntimeError</code>.</li>
</ul>
</div>


                            </div>
                            <div id="CULDistributionDistance.on_test_epoch_end" class="classattr">
                                        <input id="CULDistributionDistance.on_test_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_test_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="utils/eval.html#CULEvaluation">clarena.utils.eval.CULEvaluation</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CULDistributionDistance.on_test_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CULDistributionDistance.on_test_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CULDistributionDistance.on_test_epoch_end-166"><a href="#CULDistributionDistance.on_test_epoch_end-166"><span class="linenos">166</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CULDistributionDistance.on_test_epoch_end-167"><a href="#CULDistributionDistance.on_test_epoch_end-167"><span class="linenos">167</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_epoch_end</span><span class="p">(</span>
</span><span id="CULDistributionDistance.on_test_epoch_end-168"><a href="#CULDistributionDistance.on_test_epoch_end-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULDistributionDistance.on_test_epoch_end-169"><a href="#CULDistributionDistance.on_test_epoch_end-169"><span class="linenos">169</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CULDistributionDistance.on_test_epoch_end-170"><a href="#CULDistributionDistance.on_test_epoch_end-170"><span class="linenos">170</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CULEvaluation</span><span class="p">,</span>
</span><span id="CULDistributionDistance.on_test_epoch_end-171"><a href="#CULDistributionDistance.on_test_epoch_end-171"><span class="linenos">171</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULDistributionDistance.on_test_epoch_end-172"><a href="#CULDistributionDistance.on_test_epoch_end-172"><span class="linenos">172</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save and plot test metrics at the end of test.&quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance.on_test_epoch_end-173"><a href="#CULDistributionDistance.on_test_epoch_end-173"><span class="linenos">173</span></a>
</span><span id="CULDistributionDistance.on_test_epoch_end-174"><a href="#CULDistributionDistance.on_test_epoch_end-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_unlearning_test_distance_to_csv</span><span class="p">(</span>
</span><span id="CULDistributionDistance.on_test_epoch_end-175"><a href="#CULDistributionDistance.on_test_epoch_end-175"><span class="linenos">175</span></a>            <span class="n">distance_metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance</span><span class="p">,</span>
</span><span id="CULDistributionDistance.on_test_epoch_end-176"><a href="#CULDistributionDistance.on_test_epoch_end-176"><span class="linenos">176</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance_csv_path</span><span class="p">,</span>
</span><span id="CULDistributionDistance.on_test_epoch_end-177"><a href="#CULDistributionDistance.on_test_epoch_end-177"><span class="linenos">177</span></a>        <span class="p">)</span>
</span><span id="CULDistributionDistance.on_test_epoch_end-178"><a href="#CULDistributionDistance.on_test_epoch_end-178"><span class="linenos">178</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot_unlearning_test_distance_from_csv</span><span class="p">(</span>
</span><span id="CULDistributionDistance.on_test_epoch_end-179"><a href="#CULDistributionDistance.on_test_epoch_end-179"><span class="linenos">179</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution_distance_csv_path</span><span class="p">,</span>
</span><span id="CULDistributionDistance.on_test_epoch_end-180"><a href="#CULDistributionDistance.on_test_epoch_end-180"><span class="linenos">180</span></a>            <span class="n">plot_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unlearning_test_distance_plot_path</span><span class="p">,</span>
</span><span id="CULDistributionDistance.on_test_epoch_end-181"><a href="#CULDistributionDistance.on_test_epoch_end-181"><span class="linenos">181</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save and plot test metrics at the end of test.</p>
</div>


                            </div>
                            <div id="CULDistributionDistance.update_unlearning_test_distance_to_csv" class="classattr">
                                        <input id="CULDistributionDistance.update_unlearning_test_distance_to_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_unlearning_test_distance_to_csv</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">distance_metric</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CULDistributionDistance.update_unlearning_test_distance_to_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CULDistributionDistance.update_unlearning_test_distance_to_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-183"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-183"><span class="linenos">183</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_unlearning_test_distance_to_csv</span><span class="p">(</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-184"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-184"><span class="linenos">184</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-185"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-185"><span class="linenos">185</span></a>        <span class="n">distance_metric</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">],</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-186"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-186"><span class="linenos">186</span></a>        <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-187"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-187"><span class="linenos">187</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-188"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-188"><span class="linenos">188</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Update the unlearning test distance metrics of unlearning tasks to CSV file.</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-189"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-189"><span class="linenos">189</span></a>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-190"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-190"><span class="linenos">190</span></a><span class="sd">        **Args:**</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-191"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-191"><span class="linenos">191</span></a><span class="sd">        - **distance_metric** (`dict[str, MeanMetricBatch]`): the distance metric of unlearned tasks. Accumulated and calculated from the unlearning test batches.</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-192"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-192"><span class="linenos">192</span></a><span class="sd">        - **csv_path** (`str`): save the test metric to path. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/unlearning_test_after_task_X/distance.csv&#39;.</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-193"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-193"><span class="linenos">193</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-194"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-194"><span class="linenos">194</span></a>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-195"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-195"><span class="linenos">195</span></a>        <span class="n">eval_task_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">distance_metric</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-196"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-196"><span class="linenos">196</span></a>        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;average_distribution_distance&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-197"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-197"><span class="linenos">197</span></a>            <span class="sa">f</span><span class="s2">&quot;unlearning_test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">eval_task_ids</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-198"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-198"><span class="linenos">198</span></a>        <span class="p">]</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-199"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-199"><span class="linenos">199</span></a>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-200"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-200"><span class="linenos">200</span></a>        <span class="n">new_line</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-201"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-201"><span class="linenos">201</span></a>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-202"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-202"><span class="linenos">202</span></a>        <span class="c1"># write to the columns and calculate the average distribution distance over tasks at the same time</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-203"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-203"><span class="linenos">203</span></a>        <span class="n">average_distribution_distance_over_unlearned_tasks</span> <span class="o">=</span> <span class="n">MeanMetric</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-204"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-204"><span class="linenos">204</span></a>            <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">distance_metric</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">device</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-205"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-205"><span class="linenos">205</span></a>        <span class="p">)</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-206"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-206"><span class="linenos">206</span></a>        <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">eval_task_ids</span><span class="p">:</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-207"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-207"><span class="linenos">207</span></a>            <span class="n">loss_cls</span> <span class="o">=</span> <span class="n">distance_metric</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-208"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-208"><span class="linenos">208</span></a>            <span class="n">new_line</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;unlearning_test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_cls</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-209"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-209"><span class="linenos">209</span></a>            <span class="n">average_distribution_distance_over_unlearned_tasks</span><span class="p">(</span><span class="n">loss_cls</span><span class="p">)</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-210"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-210"><span class="linenos">210</span></a>        <span class="n">new_line</span><span class="p">[</span><span class="s2">&quot;average_distribution_distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-211"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-211"><span class="linenos">211</span></a>            <span class="n">average_distribution_distance_over_unlearned_tasks</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-212"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-212"><span class="linenos">212</span></a>        <span class="p">)</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-213"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-213"><span class="linenos">213</span></a>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-214"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-214"><span class="linenos">214</span></a>        <span class="c1"># write to the csv file</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-215"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-215"><span class="linenos">215</span></a>        <span class="n">is_first</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-216"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-216"><span class="linenos">216</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-217"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-217"><span class="linenos">217</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-218"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-218"><span class="linenos">218</span></a>                <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-219"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-219"><span class="linenos">219</span></a>                <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-220"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-220"><span class="linenos">220</span></a>        <span class="c1"># write header</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-221"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-221"><span class="linenos">221</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-222"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-222"><span class="linenos">222</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-223"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-223"><span class="linenos">223</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-224"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-224"><span class="linenos">224</span></a>        <span class="c1"># write metrics</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-225"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-225"><span class="linenos">225</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-226"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-226"><span class="linenos">226</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-227"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-227"><span class="linenos">227</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>  <span class="c1"># write the previous lines</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-228"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-228"><span class="linenos">228</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="CULDistributionDistance.update_unlearning_test_distance_to_csv-229"><a href="#CULDistributionDistance.update_unlearning_test_distance_to_csv-229"><span class="linenos">229</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Update the unlearning test distance metrics of unlearning tasks to CSV file.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>distance_metric</strong> (<code>dict[str, MeanMetricBatch]</code>): the distance metric of unlearned tasks. Accumulated and calculated from the unlearning test batches.</li>
<li><strong>csv_path</strong> (<code>str</code>): save the test metric to path. E.g. './outputs/expr_name/1970-01-01_00-00-00/results/unlearning_test_after_task_X/distance.csv'.</li>
</ul>
</div>


                            </div>
                            <div id="CULDistributionDistance.plot_unlearning_test_distance_from_csv" class="classattr">
                                        <input id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_unlearning_test_distance_from_csv</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CULDistributionDistance.plot_unlearning_test_distance_from_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-231"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-231"><span class="linenos">231</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_unlearning_test_distance_from_csv</span><span class="p">(</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-232"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-232"><span class="linenos">232</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-233"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-233"><span class="linenos">233</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-234"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-234"><span class="linenos">234</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the unlearning test distance matrix over different unlearned tasks from saved CSV file and save the plot to the designated directory.</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-235"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-235"><span class="linenos">235</span></a>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-236"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-236"><span class="linenos">236</span></a><span class="sd">        **Args:**</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-237"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-237"><span class="linenos">237</span></a><span class="sd">        - **csv_path** (`str`): the path to the CSV file where the `utils.save_unlearning_test_distance_to_csv()` saved the unlearning test distance metric.</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-238"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-238"><span class="linenos">238</span></a><span class="sd">        - **plot_path** (`str`): the path to save plot. Better same as the output directory of the experiment. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/unlearning_test_after_task_X/distance.png&#39;.</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-239"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-239"><span class="linenos">239</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-240"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-240"><span class="linenos">240</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-241"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-241"><span class="linenos">241</span></a>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-242"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-242"><span class="linenos">242</span></a>        <span class="n">unlearned_task_ids</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-243"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-243"><span class="linenos">243</span></a>            <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;unlearning_test_on_task_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-244"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-244"><span class="linenos">244</span></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-245"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-245"><span class="linenos">245</span></a>            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;unlearning_test_on_task_&quot;</span><span class="p">)</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-246"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-246"><span class="linenos">246</span></a>        <span class="p">]</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-247"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-247"><span class="linenos">247</span></a>        <span class="n">num_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unlearned_task_ids</span><span class="p">)</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-248"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-248"><span class="linenos">248</span></a>        <span class="n">num_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-249"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-249"><span class="linenos">249</span></a>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-250"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-250"><span class="linenos">250</span></a>        <span class="c1"># plot the accuracy matrix</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-251"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-251"><span class="linenos">251</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-252"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-252"><span class="linenos">252</span></a>            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_tasks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_tests</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-253"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-253"><span class="linenos">253</span></a>        <span class="p">)</span>  <span class="c1"># adaptive figure size</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-254"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-254"><span class="linenos">254</span></a>        <span class="n">cax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-255"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-255"><span class="linenos">255</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;average_distribution_distance&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-256"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-256"><span class="linenos">256</span></a>            <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-257"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-257"><span class="linenos">257</span></a>            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greens&quot;</span><span class="p">,</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-258"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-258"><span class="linenos">258</span></a>            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-259"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-259"><span class="linenos">259</span></a>            <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-260"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-260"><span class="linenos">260</span></a>        <span class="p">)</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-261"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-261"><span class="linenos">261</span></a>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-262"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-262"><span class="linenos">262</span></a>        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cax</span><span class="p">)</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-263"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-263"><span class="linenos">263</span></a>        <span class="n">yticks</span> <span class="o">=</span> <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-264"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-264"><span class="linenos">264</span></a>        <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-265"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-265"><span class="linenos">265</span></a>        <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-266"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-266"><span class="linenos">266</span></a>            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">yticks</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-267"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-267"><span class="linenos">267</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-268"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-268"><span class="linenos">268</span></a>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-269"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-269"><span class="linenos">269</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-270"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-270"><span class="linenos">270</span></a>        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tests</span><span class="p">):</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-271"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-271"><span class="linenos">271</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">):</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-272"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-272"><span class="linenos">272</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="n">unlearned_task_ids</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-273"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-273"><span class="linenos">273</span></a>                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-274"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-274"><span class="linenos">274</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;unlearning_test_on_task_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-275"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-275"><span class="linenos">275</span></a>                    <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;unlearning_test_on_task_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-276"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-276"><span class="linenos">276</span></a>                    <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-277"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-277"><span class="linenos">277</span></a>                <span class="p">)</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-278"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-278"><span class="linenos">278</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-279"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-279"><span class="linenos">279</span></a>                    <span class="n">c</span><span class="p">,</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-280"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-280"><span class="linenos">280</span></a>                    <span class="n">r</span><span class="p">,</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-281"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-281"><span class="linenos">281</span></a>                    <span class="n">s</span><span class="p">,</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-282"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-282"><span class="linenos">282</span></a>                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-283"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-283"><span class="linenos">283</span></a>                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-284"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-284"><span class="linenos">284</span></a>                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-285"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-285"><span class="linenos">285</span></a>                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">,</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-286"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-286"><span class="linenos">286</span></a>                <span class="p">)</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-287"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-287"><span class="linenos">287</span></a>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-288"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-288"><span class="linenos">288</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">))</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-289"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-289"><span class="linenos">289</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_tests</span><span class="p">))</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-290"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-290"><span class="linenos">290</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-291"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-291"><span class="linenos">291</span></a>            <span class="n">unlearned_task_ids</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-292"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-292"><span class="linenos">292</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-293"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-293"><span class="linenos">293</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-294"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-294"><span class="linenos">294</span></a>            <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_tests</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tests</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-295"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-295"><span class="linenos">295</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-296"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-296"><span class="linenos">296</span></a>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-297"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-297"><span class="linenos">297</span></a>        <span class="c1"># Labeling the axes</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-298"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-298"><span class="linenos">298</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-299"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-299"><span class="linenos">299</span></a>            <span class="s2">&quot;Testing unlearning on task &quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-300"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-300"><span class="linenos">300</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-301"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-301"><span class="linenos">301</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-302"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-302"><span class="linenos">302</span></a>            <span class="s2">&quot;Unlearning test after training task t&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-303"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-303"><span class="linenos">303</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-304"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-304"><span class="linenos">304</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-305"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-305"><span class="linenos">305</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span><span id="CULDistributionDistance.plot_unlearning_test_distance_from_csv-306"><a href="#CULDistributionDistance.plot_unlearning_test_distance_from_csv-306"><span class="linenos">306</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plot the unlearning test distance matrix over different unlearned tasks from saved CSV file and save the plot to the designated directory.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>csv_path</strong> (<code>str</code>): the path to the CSV file where the <code>utils.save_unlearning_test_distance_to_csv()</code> saved the unlearning test distance metric.</li>
<li><strong>plot_path</strong> (<code>str</code>): the path to save plot. Better same as the output directory of the experiment. E.g. './outputs/expr_name/1970-01-01_00-00-00/results/unlearning_test_after_task_X/distance.png'.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="CULAccuracyDifference">
                            <input id="CULAccuracyDifference-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CULAccuracyDifference</span><wbr>(<span class="base"><a href="#MetricCallback">clarena.metrics.MetricCallback</a></span>):

                <label class="view-source-button" for="CULAccuracyDifference-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CULAccuracyDifference"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CULAccuracyDifference-27"><a href="#CULAccuracyDifference-27"><span class="linenos"> 27</span></a><span class="k">class</span><span class="w"> </span><span class="nc">CULAccuracyDifference</span><span class="p">(</span><span class="n">MetricCallback</span><span class="p">):</span>
</span><span id="CULAccuracyDifference-28"><a href="#CULAccuracyDifference-28"><span class="linenos"> 28</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Provides all actions that are related to CUL accuracy difference (AD) metric, which include:</span>
</span><span id="CULAccuracyDifference-29"><a href="#CULAccuracyDifference-29"><span class="linenos"> 29</span></a>
</span><span id="CULAccuracyDifference-30"><a href="#CULAccuracyDifference-30"><span class="linenos"> 30</span></a><span class="sd">    - Defining, initializing and recording AD metric.</span>
</span><span id="CULAccuracyDifference-31"><a href="#CULAccuracyDifference-31"><span class="linenos"> 31</span></a><span class="sd">    - Saving AD metric to files.</span>
</span><span id="CULAccuracyDifference-32"><a href="#CULAccuracyDifference-32"><span class="linenos"> 32</span></a><span class="sd">    - Visualizing AD metric as plots.</span>
</span><span id="CULAccuracyDifference-33"><a href="#CULAccuracyDifference-33"><span class="linenos"> 33</span></a>
</span><span id="CULAccuracyDifference-34"><a href="#CULAccuracyDifference-34"><span class="linenos"> 34</span></a><span class="sd">    The callback is able to produce the following outputs:</span>
</span><span id="CULAccuracyDifference-35"><a href="#CULAccuracyDifference-35"><span class="linenos"> 35</span></a>
</span><span id="CULAccuracyDifference-36"><a href="#CULAccuracyDifference-36"><span class="linenos"> 36</span></a><span class="sd">    - CSV files for AD in each task.</span>
</span><span id="CULAccuracyDifference-37"><a href="#CULAccuracyDifference-37"><span class="linenos"> 37</span></a><span class="sd">    - Coloured plot for AD in each task.</span>
</span><span id="CULAccuracyDifference-38"><a href="#CULAccuracyDifference-38"><span class="linenos"> 38</span></a>
</span><span id="CULAccuracyDifference-39"><a href="#CULAccuracyDifference-39"><span class="linenos"> 39</span></a><span class="sd">    Note that this callback is designed to be used with the `CULEvaluation` module, which is a special evaluation module for continual unlearning. It is not a typical test step in the algorithm, but rather a test protocol that evaluates the performance of the model on unlearned tasks.</span>
</span><span id="CULAccuracyDifference-40"><a href="#CULAccuracyDifference-40"><span class="linenos"> 40</span></a>
</span><span id="CULAccuracyDifference-41"><a href="#CULAccuracyDifference-41"><span class="linenos"> 41</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference-42"><a href="#CULAccuracyDifference-42"><span class="linenos"> 42</span></a>
</span><span id="CULAccuracyDifference-43"><a href="#CULAccuracyDifference-43"><span class="linenos"> 43</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-44"><a href="#CULAccuracyDifference-44"><span class="linenos"> 44</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-45"><a href="#CULAccuracyDifference-45"><span class="linenos"> 45</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-46"><a href="#CULAccuracyDifference-46"><span class="linenos"> 46</span></a>        <span class="n">accuracy_difference_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ad.csv&quot;</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-47"><a href="#CULAccuracyDifference-47"><span class="linenos"> 47</span></a>        <span class="n">accuracy_difference_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-48"><a href="#CULAccuracyDifference-48"><span class="linenos"> 48</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULAccuracyDifference-49"><a href="#CULAccuracyDifference-49"><span class="linenos"> 49</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `CULAccuracyDifference`.</span>
</span><span id="CULAccuracyDifference-50"><a href="#CULAccuracyDifference-50"><span class="linenos"> 50</span></a>
</span><span id="CULAccuracyDifference-51"><a href="#CULAccuracyDifference-51"><span class="linenos"> 51</span></a><span class="sd">        **Args:**</span>
</span><span id="CULAccuracyDifference-52"><a href="#CULAccuracyDifference-52"><span class="linenos"> 52</span></a><span class="sd">        - **save_dir** (`str`): The directory where data and figures of metrics will be saved. Better inside the output folder.</span>
</span><span id="CULAccuracyDifference-53"><a href="#CULAccuracyDifference-53"><span class="linenos"> 53</span></a><span class="sd">        - **accuracy_difference_csv_name** (`str`): file name to save test accuracy difference metrics as CSV file.</span>
</span><span id="CULAccuracyDifference-54"><a href="#CULAccuracyDifference-54"><span class="linenos"> 54</span></a><span class="sd">        - **accuracy_difference_plot_name** (`str` | `None`): file name to save test accuracy difference metrics as plot. If `None`, no plot will be saved.</span>
</span><span id="CULAccuracyDifference-55"><a href="#CULAccuracyDifference-55"><span class="linenos"> 55</span></a>
</span><span id="CULAccuracyDifference-56"><a href="#CULAccuracyDifference-56"><span class="linenos"> 56</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference-57"><a href="#CULAccuracyDifference-57"><span class="linenos"> 57</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="CULAccuracyDifference-58"><a href="#CULAccuracyDifference-58"><span class="linenos"> 58</span></a>
</span><span id="CULAccuracyDifference-59"><a href="#CULAccuracyDifference-59"><span class="linenos"> 59</span></a>        <span class="c1"># paths</span>
</span><span id="CULAccuracyDifference-60"><a href="#CULAccuracyDifference-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">accuracy_difference_csv_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-61"><a href="#CULAccuracyDifference-61"><span class="linenos"> 61</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">accuracy_difference_csv_name</span>
</span><span id="CULAccuracyDifference-62"><a href="#CULAccuracyDifference-62"><span class="linenos"> 62</span></a>        <span class="p">)</span>
</span><span id="CULAccuracyDifference-63"><a href="#CULAccuracyDifference-63"><span class="linenos"> 63</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the path to save the test accuracy difference metrics CSV file.&quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference-64"><a href="#CULAccuracyDifference-64"><span class="linenos"> 64</span></a>        <span class="k">if</span> <span class="n">accuracy_difference_plot_name</span><span class="p">:</span>
</span><span id="CULAccuracyDifference-65"><a href="#CULAccuracyDifference-65"><span class="linenos"> 65</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accuracy_difference_plot_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-66"><a href="#CULAccuracyDifference-66"><span class="linenos"> 66</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">accuracy_difference_plot_name</span>
</span><span id="CULAccuracyDifference-67"><a href="#CULAccuracyDifference-67"><span class="linenos"> 67</span></a>            <span class="p">)</span>
</span><span id="CULAccuracyDifference-68"><a href="#CULAccuracyDifference-68"><span class="linenos"> 68</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the path to save the test accuracy difference metrics plot file.&quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference-69"><a href="#CULAccuracyDifference-69"><span class="linenos"> 69</span></a>
</span><span id="CULAccuracyDifference-70"><a href="#CULAccuracyDifference-70"><span class="linenos"> 70</span></a>        <span class="c1"># test accumulated metrics</span>
</span><span id="CULAccuracyDifference-71"><a href="#CULAccuracyDifference-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">accuracy_difference</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="CULAccuracyDifference-72"><a href="#CULAccuracyDifference-72"><span class="linenos"> 72</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accuracy difference (between main and full model) metrics for each seen task. Accumulated and calculated from the test batches. Keys are task IDs and values are the corresponding metrics.&quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference-73"><a href="#CULAccuracyDifference-73"><span class="linenos"> 73</span></a>
</span><span id="CULAccuracyDifference-74"><a href="#CULAccuracyDifference-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="CULAccuracyDifference-75"><a href="#CULAccuracyDifference-75"><span class="linenos"> 75</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Task ID counter indicating which task is being processed. Self updated during the task loop. Starting from 1. &quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference-76"><a href="#CULAccuracyDifference-76"><span class="linenos"> 76</span></a>
</span><span id="CULAccuracyDifference-77"><a href="#CULAccuracyDifference-77"><span class="linenos"> 77</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CULAccuracyDifference-78"><a href="#CULAccuracyDifference-78"><span class="linenos"> 78</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_start</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-79"><a href="#CULAccuracyDifference-79"><span class="linenos"> 79</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-80"><a href="#CULAccuracyDifference-80"><span class="linenos"> 80</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-81"><a href="#CULAccuracyDifference-81"><span class="linenos"> 81</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CULEvaluation</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-82"><a href="#CULAccuracyDifference-82"><span class="linenos"> 82</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULAccuracyDifference-83"><a href="#CULAccuracyDifference-83"><span class="linenos"> 83</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the metrics for testing each seen task in the beginning of a task&#39;s testing.&quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference-84"><a href="#CULAccuracyDifference-84"><span class="linenos"> 84</span></a>
</span><span id="CULAccuracyDifference-85"><a href="#CULAccuracyDifference-85"><span class="linenos"> 85</span></a>        <span class="c1"># get the device to put the metrics on the same device</span>
</span><span id="CULAccuracyDifference-86"><a href="#CULAccuracyDifference-86"><span class="linenos"> 86</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">device</span>
</span><span id="CULAccuracyDifference-87"><a href="#CULAccuracyDifference-87"><span class="linenos"> 87</span></a>
</span><span id="CULAccuracyDifference-88"><a href="#CULAccuracyDifference-88"><span class="linenos"> 88</span></a>        <span class="c1"># initialize test metrics for evaluation tasks</span>
</span><span id="CULAccuracyDifference-89"><a href="#CULAccuracyDifference-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">accuracy_difference</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="CULAccuracyDifference-90"><a href="#CULAccuracyDifference-90"><span class="linenos"> 90</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">MeanMetricBatch</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="CULAccuracyDifference-91"><a href="#CULAccuracyDifference-91"><span class="linenos"> 91</span></a>            <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">ad_eval_task_ids</span>
</span><span id="CULAccuracyDifference-92"><a href="#CULAccuracyDifference-92"><span class="linenos"> 92</span></a>        <span class="p">}</span>
</span><span id="CULAccuracyDifference-93"><a href="#CULAccuracyDifference-93"><span class="linenos"> 93</span></a>
</span><span id="CULAccuracyDifference-94"><a href="#CULAccuracyDifference-94"><span class="linenos"> 94</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CULAccuracyDifference-95"><a href="#CULAccuracyDifference-95"><span class="linenos"> 95</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_batch_end</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-96"><a href="#CULAccuracyDifference-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-97"><a href="#CULAccuracyDifference-97"><span class="linenos"> 97</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-98"><a href="#CULAccuracyDifference-98"><span class="linenos"> 98</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CULEvaluation</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-99"><a href="#CULAccuracyDifference-99"><span class="linenos"> 99</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="CULAccuracyDifference-100"><a href="#CULAccuracyDifference-100"><span class="linenos">100</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-101"><a href="#CULAccuracyDifference-101"><span class="linenos">101</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-102"><a href="#CULAccuracyDifference-102"><span class="linenos">102</span></a>        <span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-103"><a href="#CULAccuracyDifference-103"><span class="linenos">103</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULAccuracyDifference-104"><a href="#CULAccuracyDifference-104"><span class="linenos">104</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from test batch. We don&#39;t need to log and monitor the metrics of test batches.</span>
</span><span id="CULAccuracyDifference-105"><a href="#CULAccuracyDifference-105"><span class="linenos">105</span></a>
</span><span id="CULAccuracyDifference-106"><a href="#CULAccuracyDifference-106"><span class="linenos">106</span></a><span class="sd">        **Args:**</span>
</span><span id="CULAccuracyDifference-107"><a href="#CULAccuracyDifference-107"><span class="linenos">107</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the test step, which is the returns of the `test_step()` method in the `CULEvaluation`.</span>
</span><span id="CULAccuracyDifference-108"><a href="#CULAccuracyDifference-108"><span class="linenos">108</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="CULAccuracyDifference-109"><a href="#CULAccuracyDifference-109"><span class="linenos">109</span></a><span class="sd">        - **dataloader_idx** (`int`): the task ID of seen tasks to be tested. A default value of 0 is given otherwise the LightningModule will raise a `RuntimeError`.</span>
</span><span id="CULAccuracyDifference-110"><a href="#CULAccuracyDifference-110"><span class="linenos">110</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference-111"><a href="#CULAccuracyDifference-111"><span class="linenos">111</span></a>
</span><span id="CULAccuracyDifference-112"><a href="#CULAccuracyDifference-112"><span class="linenos">112</span></a>        <span class="c1"># get the batch size</span>
</span><span id="CULAccuracyDifference-113"><a href="#CULAccuracyDifference-113"><span class="linenos">113</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="CULAccuracyDifference-114"><a href="#CULAccuracyDifference-114"><span class="linenos">114</span></a>
</span><span id="CULAccuracyDifference-115"><a href="#CULAccuracyDifference-115"><span class="linenos">115</span></a>        <span class="n">test_task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">get_test_task_id_from_dataloader_idx</span><span class="p">(</span><span class="n">dataloader_idx</span><span class="p">)</span>
</span><span id="CULAccuracyDifference-116"><a href="#CULAccuracyDifference-116"><span class="linenos">116</span></a>
</span><span id="CULAccuracyDifference-117"><a href="#CULAccuracyDifference-117"><span class="linenos">117</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="CULAccuracyDifference-118"><a href="#CULAccuracyDifference-118"><span class="linenos">118</span></a>        <span class="n">acc_diff</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc_diff&quot;</span><span class="p">]</span>  <span class="c1"># accuracy difference</span>
</span><span id="CULAccuracyDifference-119"><a href="#CULAccuracyDifference-119"><span class="linenos">119</span></a>
</span><span id="CULAccuracyDifference-120"><a href="#CULAccuracyDifference-120"><span class="linenos">120</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the metrics of the epoch</span>
</span><span id="CULAccuracyDifference-121"><a href="#CULAccuracyDifference-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">accuracy_difference</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">test_task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_diff</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="CULAccuracyDifference-122"><a href="#CULAccuracyDifference-122"><span class="linenos">122</span></a>
</span><span id="CULAccuracyDifference-123"><a href="#CULAccuracyDifference-123"><span class="linenos">123</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CULAccuracyDifference-124"><a href="#CULAccuracyDifference-124"><span class="linenos">124</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_epoch_end</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-125"><a href="#CULAccuracyDifference-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-126"><a href="#CULAccuracyDifference-126"><span class="linenos">126</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-127"><a href="#CULAccuracyDifference-127"><span class="linenos">127</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CULEvaluation</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-128"><a href="#CULAccuracyDifference-128"><span class="linenos">128</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULAccuracyDifference-129"><a href="#CULAccuracyDifference-129"><span class="linenos">129</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save and plot test metrics at the end of test.&quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference-130"><a href="#CULAccuracyDifference-130"><span class="linenos">130</span></a>
</span><span id="CULAccuracyDifference-131"><a href="#CULAccuracyDifference-131"><span class="linenos">131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_unlearning_accuracy_difference_to_csv</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-132"><a href="#CULAccuracyDifference-132"><span class="linenos">132</span></a>            <span class="n">accuracy_difference_metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">accuracy_difference</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-133"><a href="#CULAccuracyDifference-133"><span class="linenos">133</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">accuracy_difference_csv_path</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-134"><a href="#CULAccuracyDifference-134"><span class="linenos">134</span></a>        <span class="p">)</span>
</span><span id="CULAccuracyDifference-135"><a href="#CULAccuracyDifference-135"><span class="linenos">135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot_unlearning_accuracy_difference_from_csv</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-136"><a href="#CULAccuracyDifference-136"><span class="linenos">136</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">accuracy_difference_csv_path</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-137"><a href="#CULAccuracyDifference-137"><span class="linenos">137</span></a>            <span class="n">plot_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">accuracy_difference_plot_path</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-138"><a href="#CULAccuracyDifference-138"><span class="linenos">138</span></a>        <span class="p">)</span>
</span><span id="CULAccuracyDifference-139"><a href="#CULAccuracyDifference-139"><span class="linenos">139</span></a>
</span><span id="CULAccuracyDifference-140"><a href="#CULAccuracyDifference-140"><span class="linenos">140</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_unlearning_accuracy_difference_to_csv</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-141"><a href="#CULAccuracyDifference-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-142"><a href="#CULAccuracyDifference-142"><span class="linenos">142</span></a>        <span class="n">accuracy_difference_metric</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">],</span>
</span><span id="CULAccuracyDifference-143"><a href="#CULAccuracyDifference-143"><span class="linenos">143</span></a>        <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-144"><a href="#CULAccuracyDifference-144"><span class="linenos">144</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULAccuracyDifference-145"><a href="#CULAccuracyDifference-145"><span class="linenos">145</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Update the unlearning accuracy difference metrics of unlearning tasks to CSV file.</span>
</span><span id="CULAccuracyDifference-146"><a href="#CULAccuracyDifference-146"><span class="linenos">146</span></a>
</span><span id="CULAccuracyDifference-147"><a href="#CULAccuracyDifference-147"><span class="linenos">147</span></a><span class="sd">        **Args:**</span>
</span><span id="CULAccuracyDifference-148"><a href="#CULAccuracyDifference-148"><span class="linenos">148</span></a><span class="sd">        - **accuracy_difference_metric** (`dict[str, MeanMetricBatch]`): the accuracy difference metric. Accumulated and calculated from the unlearning test batches.</span>
</span><span id="CULAccuracyDifference-149"><a href="#CULAccuracyDifference-149"><span class="linenos">149</span></a><span class="sd">        - **csv_path** (`str`): save the test metric to path. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/unlearning_test_after_task_X/distance.csv&#39;.</span>
</span><span id="CULAccuracyDifference-150"><a href="#CULAccuracyDifference-150"><span class="linenos">150</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference-151"><a href="#CULAccuracyDifference-151"><span class="linenos">151</span></a>
</span><span id="CULAccuracyDifference-152"><a href="#CULAccuracyDifference-152"><span class="linenos">152</span></a>        <span class="n">eval_task_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">accuracy_difference_metric</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="CULAccuracyDifference-153"><a href="#CULAccuracyDifference-153"><span class="linenos">153</span></a>        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;average_accuracy_difference&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="CULAccuracyDifference-154"><a href="#CULAccuracyDifference-154"><span class="linenos">154</span></a>            <span class="sa">f</span><span class="s2">&quot;unlearning_test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">eval_task_ids</span>
</span><span id="CULAccuracyDifference-155"><a href="#CULAccuracyDifference-155"><span class="linenos">155</span></a>        <span class="p">]</span>
</span><span id="CULAccuracyDifference-156"><a href="#CULAccuracyDifference-156"><span class="linenos">156</span></a>
</span><span id="CULAccuracyDifference-157"><a href="#CULAccuracyDifference-157"><span class="linenos">157</span></a>        <span class="n">new_line</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="CULAccuracyDifference-158"><a href="#CULAccuracyDifference-158"><span class="linenos">158</span></a>
</span><span id="CULAccuracyDifference-159"><a href="#CULAccuracyDifference-159"><span class="linenos">159</span></a>        <span class="c1"># write to the columns and calculate the average accuracy difference over tasks at the same time</span>
</span><span id="CULAccuracyDifference-160"><a href="#CULAccuracyDifference-160"><span class="linenos">160</span></a>        <span class="n">average_accuracy_difference_over_unlearned_tasks</span> <span class="o">=</span> <span class="n">MeanMetric</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-161"><a href="#CULAccuracyDifference-161"><span class="linenos">161</span></a>            <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">accuracy_difference_metric</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">device</span>
</span><span id="CULAccuracyDifference-162"><a href="#CULAccuracyDifference-162"><span class="linenos">162</span></a>        <span class="p">)</span>
</span><span id="CULAccuracyDifference-163"><a href="#CULAccuracyDifference-163"><span class="linenos">163</span></a>        <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">eval_task_ids</span><span class="p">:</span>
</span><span id="CULAccuracyDifference-164"><a href="#CULAccuracyDifference-164"><span class="linenos">164</span></a>            <span class="n">loss_cls</span> <span class="o">=</span> <span class="n">accuracy_difference_metric</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="CULAccuracyDifference-165"><a href="#CULAccuracyDifference-165"><span class="linenos">165</span></a>            <span class="n">new_line</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;unlearning_test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_cls</span>
</span><span id="CULAccuracyDifference-166"><a href="#CULAccuracyDifference-166"><span class="linenos">166</span></a>            <span class="n">average_accuracy_difference_over_unlearned_tasks</span><span class="p">(</span><span class="n">loss_cls</span><span class="p">)</span>
</span><span id="CULAccuracyDifference-167"><a href="#CULAccuracyDifference-167"><span class="linenos">167</span></a>        <span class="n">new_line</span><span class="p">[</span><span class="s2">&quot;average_accuracy_difference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CULAccuracyDifference-168"><a href="#CULAccuracyDifference-168"><span class="linenos">168</span></a>            <span class="n">average_accuracy_difference_over_unlearned_tasks</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="CULAccuracyDifference-169"><a href="#CULAccuracyDifference-169"><span class="linenos">169</span></a>        <span class="p">)</span>
</span><span id="CULAccuracyDifference-170"><a href="#CULAccuracyDifference-170"><span class="linenos">170</span></a>
</span><span id="CULAccuracyDifference-171"><a href="#CULAccuracyDifference-171"><span class="linenos">171</span></a>        <span class="c1"># write to the csv file</span>
</span><span id="CULAccuracyDifference-172"><a href="#CULAccuracyDifference-172"><span class="linenos">172</span></a>        <span class="n">is_first</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CULAccuracyDifference-173"><a href="#CULAccuracyDifference-173"><span class="linenos">173</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
</span><span id="CULAccuracyDifference-174"><a href="#CULAccuracyDifference-174"><span class="linenos">174</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CULAccuracyDifference-175"><a href="#CULAccuracyDifference-175"><span class="linenos">175</span></a>                <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span id="CULAccuracyDifference-176"><a href="#CULAccuracyDifference-176"><span class="linenos">176</span></a>                <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CULAccuracyDifference-177"><a href="#CULAccuracyDifference-177"><span class="linenos">177</span></a>        <span class="c1"># write header</span>
</span><span id="CULAccuracyDifference-178"><a href="#CULAccuracyDifference-178"><span class="linenos">178</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CULAccuracyDifference-179"><a href="#CULAccuracyDifference-179"><span class="linenos">179</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="CULAccuracyDifference-180"><a href="#CULAccuracyDifference-180"><span class="linenos">180</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="CULAccuracyDifference-181"><a href="#CULAccuracyDifference-181"><span class="linenos">181</span></a>        <span class="c1"># write metrics</span>
</span><span id="CULAccuracyDifference-182"><a href="#CULAccuracyDifference-182"><span class="linenos">182</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CULAccuracyDifference-183"><a href="#CULAccuracyDifference-183"><span class="linenos">183</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
</span><span id="CULAccuracyDifference-184"><a href="#CULAccuracyDifference-184"><span class="linenos">184</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>  <span class="c1"># write the previous lines</span>
</span><span id="CULAccuracyDifference-185"><a href="#CULAccuracyDifference-185"><span class="linenos">185</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="CULAccuracyDifference-186"><a href="#CULAccuracyDifference-186"><span class="linenos">186</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
</span><span id="CULAccuracyDifference-187"><a href="#CULAccuracyDifference-187"><span class="linenos">187</span></a>
</span><span id="CULAccuracyDifference-188"><a href="#CULAccuracyDifference-188"><span class="linenos">188</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_unlearning_accuracy_difference_from_csv</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-189"><a href="#CULAccuracyDifference-189"><span class="linenos">189</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="CULAccuracyDifference-190"><a href="#CULAccuracyDifference-190"><span class="linenos">190</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULAccuracyDifference-191"><a href="#CULAccuracyDifference-191"><span class="linenos">191</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the unlearning accuracy difference matrix over different unlearned tasks from saved CSV file and save the plot to the designated directory.</span>
</span><span id="CULAccuracyDifference-192"><a href="#CULAccuracyDifference-192"><span class="linenos">192</span></a>
</span><span id="CULAccuracyDifference-193"><a href="#CULAccuracyDifference-193"><span class="linenos">193</span></a><span class="sd">        **Args:**</span>
</span><span id="CULAccuracyDifference-194"><a href="#CULAccuracyDifference-194"><span class="linenos">194</span></a><span class="sd">        - **csv_path** (`str`): the path to the CSV file where the `utils.save_unlearning_test_distance_to_csv()` saved the unlearning test distance metric.</span>
</span><span id="CULAccuracyDifference-195"><a href="#CULAccuracyDifference-195"><span class="linenos">195</span></a><span class="sd">        - **plot_path** (`str`): the path to save plot. Better same as the output directory of the experiment. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/unlearning_test_after_task_X/distance.png&#39;.</span>
</span><span id="CULAccuracyDifference-196"><a href="#CULAccuracyDifference-196"><span class="linenos">196</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference-197"><a href="#CULAccuracyDifference-197"><span class="linenos">197</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CULAccuracyDifference-198"><a href="#CULAccuracyDifference-198"><span class="linenos">198</span></a>
</span><span id="CULAccuracyDifference-199"><a href="#CULAccuracyDifference-199"><span class="linenos">199</span></a>        <span class="n">unlearned_task_ids</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="CULAccuracyDifference-200"><a href="#CULAccuracyDifference-200"><span class="linenos">200</span></a>            <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;unlearning_test_on_task_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</span><span id="CULAccuracyDifference-201"><a href="#CULAccuracyDifference-201"><span class="linenos">201</span></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="CULAccuracyDifference-202"><a href="#CULAccuracyDifference-202"><span class="linenos">202</span></a>            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;unlearning_test_on_task_&quot;</span><span class="p">)</span>
</span><span id="CULAccuracyDifference-203"><a href="#CULAccuracyDifference-203"><span class="linenos">203</span></a>        <span class="p">]</span>
</span><span id="CULAccuracyDifference-204"><a href="#CULAccuracyDifference-204"><span class="linenos">204</span></a>        <span class="n">num_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unlearned_task_ids</span><span class="p">)</span>
</span><span id="CULAccuracyDifference-205"><a href="#CULAccuracyDifference-205"><span class="linenos">205</span></a>        <span class="n">num_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="CULAccuracyDifference-206"><a href="#CULAccuracyDifference-206"><span class="linenos">206</span></a>
</span><span id="CULAccuracyDifference-207"><a href="#CULAccuracyDifference-207"><span class="linenos">207</span></a>        <span class="c1"># plot the accuracy matrix</span>
</span><span id="CULAccuracyDifference-208"><a href="#CULAccuracyDifference-208"><span class="linenos">208</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-209"><a href="#CULAccuracyDifference-209"><span class="linenos">209</span></a>            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_tasks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_tests</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="CULAccuracyDifference-210"><a href="#CULAccuracyDifference-210"><span class="linenos">210</span></a>        <span class="p">)</span>  <span class="c1"># adaptive figure size</span>
</span><span id="CULAccuracyDifference-211"><a href="#CULAccuracyDifference-211"><span class="linenos">211</span></a>        <span class="n">cax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-212"><a href="#CULAccuracyDifference-212"><span class="linenos">212</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;average_accuracy_difference&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span><span id="CULAccuracyDifference-213"><a href="#CULAccuracyDifference-213"><span class="linenos">213</span></a>            <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-214"><a href="#CULAccuracyDifference-214"><span class="linenos">214</span></a>            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greens&quot;</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-215"><a href="#CULAccuracyDifference-215"><span class="linenos">215</span></a>            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-216"><a href="#CULAccuracyDifference-216"><span class="linenos">216</span></a>            <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-217"><a href="#CULAccuracyDifference-217"><span class="linenos">217</span></a>        <span class="p">)</span>
</span><span id="CULAccuracyDifference-218"><a href="#CULAccuracyDifference-218"><span class="linenos">218</span></a>
</span><span id="CULAccuracyDifference-219"><a href="#CULAccuracyDifference-219"><span class="linenos">219</span></a>        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cax</span><span class="p">)</span>
</span><span id="CULAccuracyDifference-220"><a href="#CULAccuracyDifference-220"><span class="linenos">220</span></a>        <span class="n">yticks</span> <span class="o">=</span> <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()</span>
</span><span id="CULAccuracyDifference-221"><a href="#CULAccuracyDifference-221"><span class="linenos">221</span></a>        <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
</span><span id="CULAccuracyDifference-222"><a href="#CULAccuracyDifference-222"><span class="linenos">222</span></a>        <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-223"><a href="#CULAccuracyDifference-223"><span class="linenos">223</span></a>            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">yticks</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CULAccuracyDifference-224"><a href="#CULAccuracyDifference-224"><span class="linenos">224</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULAccuracyDifference-225"><a href="#CULAccuracyDifference-225"><span class="linenos">225</span></a>
</span><span id="CULAccuracyDifference-226"><a href="#CULAccuracyDifference-226"><span class="linenos">226</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="CULAccuracyDifference-227"><a href="#CULAccuracyDifference-227"><span class="linenos">227</span></a>        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tests</span><span class="p">):</span>
</span><span id="CULAccuracyDifference-228"><a href="#CULAccuracyDifference-228"><span class="linenos">228</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">):</span>
</span><span id="CULAccuracyDifference-229"><a href="#CULAccuracyDifference-229"><span class="linenos">229</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="n">unlearned_task_ids</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
</span><span id="CULAccuracyDifference-230"><a href="#CULAccuracyDifference-230"><span class="linenos">230</span></a>                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CULAccuracyDifference-231"><a href="#CULAccuracyDifference-231"><span class="linenos">231</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;unlearning_test_on_task_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="CULAccuracyDifference-232"><a href="#CULAccuracyDifference-232"><span class="linenos">232</span></a>                    <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;unlearning_test_on_task_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="CULAccuracyDifference-233"><a href="#CULAccuracyDifference-233"><span class="linenos">233</span></a>                    <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="CULAccuracyDifference-234"><a href="#CULAccuracyDifference-234"><span class="linenos">234</span></a>                <span class="p">)</span>
</span><span id="CULAccuracyDifference-235"><a href="#CULAccuracyDifference-235"><span class="linenos">235</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-236"><a href="#CULAccuracyDifference-236"><span class="linenos">236</span></a>                    <span class="n">c</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-237"><a href="#CULAccuracyDifference-237"><span class="linenos">237</span></a>                    <span class="n">r</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-238"><a href="#CULAccuracyDifference-238"><span class="linenos">238</span></a>                    <span class="n">s</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-239"><a href="#CULAccuracyDifference-239"><span class="linenos">239</span></a>                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-240"><a href="#CULAccuracyDifference-240"><span class="linenos">240</span></a>                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-241"><a href="#CULAccuracyDifference-241"><span class="linenos">241</span></a>                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="CULAccuracyDifference-242"><a href="#CULAccuracyDifference-242"><span class="linenos">242</span></a>                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">,</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULAccuracyDifference-243"><a href="#CULAccuracyDifference-243"><span class="linenos">243</span></a>                <span class="p">)</span>
</span><span id="CULAccuracyDifference-244"><a href="#CULAccuracyDifference-244"><span class="linenos">244</span></a>
</span><span id="CULAccuracyDifference-245"><a href="#CULAccuracyDifference-245"><span class="linenos">245</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">))</span>
</span><span id="CULAccuracyDifference-246"><a href="#CULAccuracyDifference-246"><span class="linenos">246</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_tests</span><span class="p">))</span>
</span><span id="CULAccuracyDifference-247"><a href="#CULAccuracyDifference-247"><span class="linenos">247</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-248"><a href="#CULAccuracyDifference-248"><span class="linenos">248</span></a>            <span class="n">unlearned_task_ids</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CULAccuracyDifference-249"><a href="#CULAccuracyDifference-249"><span class="linenos">249</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULAccuracyDifference-250"><a href="#CULAccuracyDifference-250"><span class="linenos">250</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-251"><a href="#CULAccuracyDifference-251"><span class="linenos">251</span></a>            <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_tests</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tests</span>
</span><span id="CULAccuracyDifference-252"><a href="#CULAccuracyDifference-252"><span class="linenos">252</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULAccuracyDifference-253"><a href="#CULAccuracyDifference-253"><span class="linenos">253</span></a>
</span><span id="CULAccuracyDifference-254"><a href="#CULAccuracyDifference-254"><span class="linenos">254</span></a>        <span class="c1"># Labeling the axes</span>
</span><span id="CULAccuracyDifference-255"><a href="#CULAccuracyDifference-255"><span class="linenos">255</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-256"><a href="#CULAccuracyDifference-256"><span class="linenos">256</span></a>            <span class="s2">&quot;Testing unlearning on task &quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CULAccuracyDifference-257"><a href="#CULAccuracyDifference-257"><span class="linenos">257</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULAccuracyDifference-258"><a href="#CULAccuracyDifference-258"><span class="linenos">258</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
</span><span id="CULAccuracyDifference-259"><a href="#CULAccuracyDifference-259"><span class="linenos">259</span></a>            <span class="s2">&quot;Unlearning test after training task t&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CULAccuracyDifference-260"><a href="#CULAccuracyDifference-260"><span class="linenos">260</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULAccuracyDifference-261"><a href="#CULAccuracyDifference-261"><span class="linenos">261</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="CULAccuracyDifference-262"><a href="#CULAccuracyDifference-262"><span class="linenos">262</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Provides all actions that are related to CUL accuracy difference (AD) metric, which include:</p>

<ul>
<li>Defining, initializing and recording AD metric.</li>
<li>Saving AD metric to files.</li>
<li>Visualizing AD metric as plots.</li>
</ul>

<p>The callback is able to produce the following outputs:</p>

<ul>
<li>CSV files for AD in each task.</li>
<li>Coloured plot for AD in each task.</li>
</ul>

<p>Note that this callback is designed to be used with the <code>CULEvaluation</code> module, which is a special evaluation module for continual unlearning. It is not a typical test step in the algorithm, but rather a test protocol that evaluates the performance of the model on unlearned tasks.</p>
</div>


                            <div id="CULAccuracyDifference.__init__" class="classattr">
                                        <input id="CULAccuracyDifference.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">CULAccuracyDifference</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">accuracy_difference_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ad.csv&#39;</span>,</span><span class="param">	<span class="n">accuracy_difference_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="CULAccuracyDifference.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CULAccuracyDifference.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CULAccuracyDifference.__init__-43"><a href="#CULAccuracyDifference.__init__-43"><span class="linenos">43</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.__init__-44"><a href="#CULAccuracyDifference.__init__-44"><span class="linenos">44</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.__init__-45"><a href="#CULAccuracyDifference.__init__-45"><span class="linenos">45</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.__init__-46"><a href="#CULAccuracyDifference.__init__-46"><span class="linenos">46</span></a>        <span class="n">accuracy_difference_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ad.csv&quot;</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.__init__-47"><a href="#CULAccuracyDifference.__init__-47"><span class="linenos">47</span></a>        <span class="n">accuracy_difference_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.__init__-48"><a href="#CULAccuracyDifference.__init__-48"><span class="linenos">48</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULAccuracyDifference.__init__-49"><a href="#CULAccuracyDifference.__init__-49"><span class="linenos">49</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `CULAccuracyDifference`.</span>
</span><span id="CULAccuracyDifference.__init__-50"><a href="#CULAccuracyDifference.__init__-50"><span class="linenos">50</span></a>
</span><span id="CULAccuracyDifference.__init__-51"><a href="#CULAccuracyDifference.__init__-51"><span class="linenos">51</span></a><span class="sd">        **Args:**</span>
</span><span id="CULAccuracyDifference.__init__-52"><a href="#CULAccuracyDifference.__init__-52"><span class="linenos">52</span></a><span class="sd">        - **save_dir** (`str`): The directory where data and figures of metrics will be saved. Better inside the output folder.</span>
</span><span id="CULAccuracyDifference.__init__-53"><a href="#CULAccuracyDifference.__init__-53"><span class="linenos">53</span></a><span class="sd">        - **accuracy_difference_csv_name** (`str`): file name to save test accuracy difference metrics as CSV file.</span>
</span><span id="CULAccuracyDifference.__init__-54"><a href="#CULAccuracyDifference.__init__-54"><span class="linenos">54</span></a><span class="sd">        - **accuracy_difference_plot_name** (`str` | `None`): file name to save test accuracy difference metrics as plot. If `None`, no plot will be saved.</span>
</span><span id="CULAccuracyDifference.__init__-55"><a href="#CULAccuracyDifference.__init__-55"><span class="linenos">55</span></a>
</span><span id="CULAccuracyDifference.__init__-56"><a href="#CULAccuracyDifference.__init__-56"><span class="linenos">56</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference.__init__-57"><a href="#CULAccuracyDifference.__init__-57"><span class="linenos">57</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="CULAccuracyDifference.__init__-58"><a href="#CULAccuracyDifference.__init__-58"><span class="linenos">58</span></a>
</span><span id="CULAccuracyDifference.__init__-59"><a href="#CULAccuracyDifference.__init__-59"><span class="linenos">59</span></a>        <span class="c1"># paths</span>
</span><span id="CULAccuracyDifference.__init__-60"><a href="#CULAccuracyDifference.__init__-60"><span class="linenos">60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">accuracy_difference_csv_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.__init__-61"><a href="#CULAccuracyDifference.__init__-61"><span class="linenos">61</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">accuracy_difference_csv_name</span>
</span><span id="CULAccuracyDifference.__init__-62"><a href="#CULAccuracyDifference.__init__-62"><span class="linenos">62</span></a>        <span class="p">)</span>
</span><span id="CULAccuracyDifference.__init__-63"><a href="#CULAccuracyDifference.__init__-63"><span class="linenos">63</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the path to save the test accuracy difference metrics CSV file.&quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference.__init__-64"><a href="#CULAccuracyDifference.__init__-64"><span class="linenos">64</span></a>        <span class="k">if</span> <span class="n">accuracy_difference_plot_name</span><span class="p">:</span>
</span><span id="CULAccuracyDifference.__init__-65"><a href="#CULAccuracyDifference.__init__-65"><span class="linenos">65</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accuracy_difference_plot_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.__init__-66"><a href="#CULAccuracyDifference.__init__-66"><span class="linenos">66</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">accuracy_difference_plot_name</span>
</span><span id="CULAccuracyDifference.__init__-67"><a href="#CULAccuracyDifference.__init__-67"><span class="linenos">67</span></a>            <span class="p">)</span>
</span><span id="CULAccuracyDifference.__init__-68"><a href="#CULAccuracyDifference.__init__-68"><span class="linenos">68</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the path to save the test accuracy difference metrics plot file.&quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference.__init__-69"><a href="#CULAccuracyDifference.__init__-69"><span class="linenos">69</span></a>
</span><span id="CULAccuracyDifference.__init__-70"><a href="#CULAccuracyDifference.__init__-70"><span class="linenos">70</span></a>        <span class="c1"># test accumulated metrics</span>
</span><span id="CULAccuracyDifference.__init__-71"><a href="#CULAccuracyDifference.__init__-71"><span class="linenos">71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">accuracy_difference</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="CULAccuracyDifference.__init__-72"><a href="#CULAccuracyDifference.__init__-72"><span class="linenos">72</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accuracy difference (between main and full model) metrics for each seen task. Accumulated and calculated from the test batches. Keys are task IDs and values are the corresponding metrics.&quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference.__init__-73"><a href="#CULAccuracyDifference.__init__-73"><span class="linenos">73</span></a>
</span><span id="CULAccuracyDifference.__init__-74"><a href="#CULAccuracyDifference.__init__-74"><span class="linenos">74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="CULAccuracyDifference.__init__-75"><a href="#CULAccuracyDifference.__init__-75"><span class="linenos">75</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Task ID counter indicating which task is being processed. Self updated during the task loop. Starting from 1. &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the <code><a href="#CULAccuracyDifference">CULAccuracyDifference</a></code>.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>save_dir</strong> (<code>str</code>): The directory where data and figures of metrics will be saved. Better inside the output folder.</li>
<li><strong>accuracy_difference_csv_name</strong> (<code>str</code>): file name to save test accuracy difference metrics as CSV file.</li>
<li><strong>accuracy_difference_plot_name</strong> (<code>str</code> | <code>None</code>): file name to save test accuracy difference metrics as plot. If <code>None</code>, no plot will be saved.</li>
</ul>
</div>


                            </div>
                            <div id="CULAccuracyDifference.accuracy_difference_csv_path" class="classattr">
                                <div class="attr variable">
            <span class="name">accuracy_difference_csv_path</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#CULAccuracyDifference.accuracy_difference_csv_path"></a>
    
            <div class="docstring"><p>Store the path to save the test accuracy difference metrics CSV file.</p>
</div>


                            </div>
                            <div id="CULAccuracyDifference.accuracy_difference" class="classattr">
                                <div class="attr variable">
            <span class="name">accuracy_difference</span><span class="annotation">: dict[str, <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a>]</span>

        
    </div>
    <a class="headerlink" href="#CULAccuracyDifference.accuracy_difference"></a>
    
            <div class="docstring"><p>Accuracy difference (between main and full model) metrics for each seen task. Accumulated and calculated from the test batches. Keys are task IDs and values are the corresponding metrics.</p>
</div>


                            </div>
                            <div id="CULAccuracyDifference.task_id" class="classattr">
                                <div class="attr variable">
            <span class="name">task_id</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#CULAccuracyDifference.task_id"></a>
    
            <div class="docstring"><p>Task ID counter indicating which task is being processed. Self updated during the task loop. Starting from 1.</p>
</div>


                            </div>
                            <div id="CULAccuracyDifference.on_test_start" class="classattr">
                                        <input id="CULAccuracyDifference.on_test_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_test_start</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="utils/eval.html#CULEvaluation">clarena.utils.eval.CULEvaluation</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CULAccuracyDifference.on_test_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CULAccuracyDifference.on_test_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CULAccuracyDifference.on_test_start-77"><a href="#CULAccuracyDifference.on_test_start-77"><span class="linenos">77</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CULAccuracyDifference.on_test_start-78"><a href="#CULAccuracyDifference.on_test_start-78"><span class="linenos">78</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_start</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.on_test_start-79"><a href="#CULAccuracyDifference.on_test_start-79"><span class="linenos">79</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.on_test_start-80"><a href="#CULAccuracyDifference.on_test_start-80"><span class="linenos">80</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.on_test_start-81"><a href="#CULAccuracyDifference.on_test_start-81"><span class="linenos">81</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CULEvaluation</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.on_test_start-82"><a href="#CULAccuracyDifference.on_test_start-82"><span class="linenos">82</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULAccuracyDifference.on_test_start-83"><a href="#CULAccuracyDifference.on_test_start-83"><span class="linenos">83</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the metrics for testing each seen task in the beginning of a task&#39;s testing.&quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference.on_test_start-84"><a href="#CULAccuracyDifference.on_test_start-84"><span class="linenos">84</span></a>
</span><span id="CULAccuracyDifference.on_test_start-85"><a href="#CULAccuracyDifference.on_test_start-85"><span class="linenos">85</span></a>        <span class="c1"># get the device to put the metrics on the same device</span>
</span><span id="CULAccuracyDifference.on_test_start-86"><a href="#CULAccuracyDifference.on_test_start-86"><span class="linenos">86</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">device</span>
</span><span id="CULAccuracyDifference.on_test_start-87"><a href="#CULAccuracyDifference.on_test_start-87"><span class="linenos">87</span></a>
</span><span id="CULAccuracyDifference.on_test_start-88"><a href="#CULAccuracyDifference.on_test_start-88"><span class="linenos">88</span></a>        <span class="c1"># initialize test metrics for evaluation tasks</span>
</span><span id="CULAccuracyDifference.on_test_start-89"><a href="#CULAccuracyDifference.on_test_start-89"><span class="linenos">89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">accuracy_difference</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="CULAccuracyDifference.on_test_start-90"><a href="#CULAccuracyDifference.on_test_start-90"><span class="linenos">90</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">MeanMetricBatch</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="CULAccuracyDifference.on_test_start-91"><a href="#CULAccuracyDifference.on_test_start-91"><span class="linenos">91</span></a>            <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">ad_eval_task_ids</span>
</span><span id="CULAccuracyDifference.on_test_start-92"><a href="#CULAccuracyDifference.on_test_start-92"><span class="linenos">92</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the metrics for testing each seen task in the beginning of a task's testing.</p>
</div>


                            </div>
                            <div id="CULAccuracyDifference.on_test_batch_end" class="classattr">
                                        <input id="CULAccuracyDifference.on_test_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_test_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="utils/eval.html#CULEvaluation">clarena.utils.eval.CULEvaluation</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CULAccuracyDifference.on_test_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CULAccuracyDifference.on_test_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CULAccuracyDifference.on_test_batch_end-94"><a href="#CULAccuracyDifference.on_test_batch_end-94"><span class="linenos"> 94</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-95"><a href="#CULAccuracyDifference.on_test_batch_end-95"><span class="linenos"> 95</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_batch_end</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-96"><a href="#CULAccuracyDifference.on_test_batch_end-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-97"><a href="#CULAccuracyDifference.on_test_batch_end-97"><span class="linenos"> 97</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-98"><a href="#CULAccuracyDifference.on_test_batch_end-98"><span class="linenos"> 98</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CULEvaluation</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-99"><a href="#CULAccuracyDifference.on_test_batch_end-99"><span class="linenos"> 99</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-100"><a href="#CULAccuracyDifference.on_test_batch_end-100"><span class="linenos">100</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-101"><a href="#CULAccuracyDifference.on_test_batch_end-101"><span class="linenos">101</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-102"><a href="#CULAccuracyDifference.on_test_batch_end-102"><span class="linenos">102</span></a>        <span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-103"><a href="#CULAccuracyDifference.on_test_batch_end-103"><span class="linenos">103</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-104"><a href="#CULAccuracyDifference.on_test_batch_end-104"><span class="linenos">104</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from test batch. We don&#39;t need to log and monitor the metrics of test batches.</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-105"><a href="#CULAccuracyDifference.on_test_batch_end-105"><span class="linenos">105</span></a>
</span><span id="CULAccuracyDifference.on_test_batch_end-106"><a href="#CULAccuracyDifference.on_test_batch_end-106"><span class="linenos">106</span></a><span class="sd">        **Args:**</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-107"><a href="#CULAccuracyDifference.on_test_batch_end-107"><span class="linenos">107</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the test step, which is the returns of the `test_step()` method in the `CULEvaluation`.</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-108"><a href="#CULAccuracyDifference.on_test_batch_end-108"><span class="linenos">108</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-109"><a href="#CULAccuracyDifference.on_test_batch_end-109"><span class="linenos">109</span></a><span class="sd">        - **dataloader_idx** (`int`): the task ID of seen tasks to be tested. A default value of 0 is given otherwise the LightningModule will raise a `RuntimeError`.</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-110"><a href="#CULAccuracyDifference.on_test_batch_end-110"><span class="linenos">110</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-111"><a href="#CULAccuracyDifference.on_test_batch_end-111"><span class="linenos">111</span></a>
</span><span id="CULAccuracyDifference.on_test_batch_end-112"><a href="#CULAccuracyDifference.on_test_batch_end-112"><span class="linenos">112</span></a>        <span class="c1"># get the batch size</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-113"><a href="#CULAccuracyDifference.on_test_batch_end-113"><span class="linenos">113</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-114"><a href="#CULAccuracyDifference.on_test_batch_end-114"><span class="linenos">114</span></a>
</span><span id="CULAccuracyDifference.on_test_batch_end-115"><a href="#CULAccuracyDifference.on_test_batch_end-115"><span class="linenos">115</span></a>        <span class="n">test_task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">get_test_task_id_from_dataloader_idx</span><span class="p">(</span><span class="n">dataloader_idx</span><span class="p">)</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-116"><a href="#CULAccuracyDifference.on_test_batch_end-116"><span class="linenos">116</span></a>
</span><span id="CULAccuracyDifference.on_test_batch_end-117"><a href="#CULAccuracyDifference.on_test_batch_end-117"><span class="linenos">117</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-118"><a href="#CULAccuracyDifference.on_test_batch_end-118"><span class="linenos">118</span></a>        <span class="n">acc_diff</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc_diff&quot;</span><span class="p">]</span>  <span class="c1"># accuracy difference</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-119"><a href="#CULAccuracyDifference.on_test_batch_end-119"><span class="linenos">119</span></a>
</span><span id="CULAccuracyDifference.on_test_batch_end-120"><a href="#CULAccuracyDifference.on_test_batch_end-120"><span class="linenos">120</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the metrics of the epoch</span>
</span><span id="CULAccuracyDifference.on_test_batch_end-121"><a href="#CULAccuracyDifference.on_test_batch_end-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">accuracy_difference</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">test_task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_diff</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Accumulating metrics from test batch. We don't need to log and monitor the metrics of test batches.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the test step, which is the returns of the <code>test_step()</code> method in the <code>CULEvaluation</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the validation data batch.</li>
<li><strong>dataloader_idx</strong> (<code>int</code>): the task ID of seen tasks to be tested. A default value of 0 is given otherwise the LightningModule will raise a <code>RuntimeError</code>.</li>
</ul>
</div>


                            </div>
                            <div id="CULAccuracyDifference.on_test_epoch_end" class="classattr">
                                        <input id="CULAccuracyDifference.on_test_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_test_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="utils/eval.html#CULEvaluation">clarena.utils.eval.CULEvaluation</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CULAccuracyDifference.on_test_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CULAccuracyDifference.on_test_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CULAccuracyDifference.on_test_epoch_end-123"><a href="#CULAccuracyDifference.on_test_epoch_end-123"><span class="linenos">123</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="CULAccuracyDifference.on_test_epoch_end-124"><a href="#CULAccuracyDifference.on_test_epoch_end-124"><span class="linenos">124</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_epoch_end</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.on_test_epoch_end-125"><a href="#CULAccuracyDifference.on_test_epoch_end-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.on_test_epoch_end-126"><a href="#CULAccuracyDifference.on_test_epoch_end-126"><span class="linenos">126</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.on_test_epoch_end-127"><a href="#CULAccuracyDifference.on_test_epoch_end-127"><span class="linenos">127</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CULEvaluation</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.on_test_epoch_end-128"><a href="#CULAccuracyDifference.on_test_epoch_end-128"><span class="linenos">128</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULAccuracyDifference.on_test_epoch_end-129"><a href="#CULAccuracyDifference.on_test_epoch_end-129"><span class="linenos">129</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save and plot test metrics at the end of test.&quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference.on_test_epoch_end-130"><a href="#CULAccuracyDifference.on_test_epoch_end-130"><span class="linenos">130</span></a>
</span><span id="CULAccuracyDifference.on_test_epoch_end-131"><a href="#CULAccuracyDifference.on_test_epoch_end-131"><span class="linenos">131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_unlearning_accuracy_difference_to_csv</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.on_test_epoch_end-132"><a href="#CULAccuracyDifference.on_test_epoch_end-132"><span class="linenos">132</span></a>            <span class="n">accuracy_difference_metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">accuracy_difference</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.on_test_epoch_end-133"><a href="#CULAccuracyDifference.on_test_epoch_end-133"><span class="linenos">133</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">accuracy_difference_csv_path</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.on_test_epoch_end-134"><a href="#CULAccuracyDifference.on_test_epoch_end-134"><span class="linenos">134</span></a>        <span class="p">)</span>
</span><span id="CULAccuracyDifference.on_test_epoch_end-135"><a href="#CULAccuracyDifference.on_test_epoch_end-135"><span class="linenos">135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot_unlearning_accuracy_difference_from_csv</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.on_test_epoch_end-136"><a href="#CULAccuracyDifference.on_test_epoch_end-136"><span class="linenos">136</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">accuracy_difference_csv_path</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.on_test_epoch_end-137"><a href="#CULAccuracyDifference.on_test_epoch_end-137"><span class="linenos">137</span></a>            <span class="n">plot_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">accuracy_difference_plot_path</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.on_test_epoch_end-138"><a href="#CULAccuracyDifference.on_test_epoch_end-138"><span class="linenos">138</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save and plot test metrics at the end of test.</p>
</div>


                            </div>
                            <div id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv" class="classattr">
                                        <input id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_unlearning_accuracy_difference_to_csv</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">accuracy_difference_metric</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-140"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-140"><span class="linenos">140</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_unlearning_accuracy_difference_to_csv</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-141"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-142"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-142"><span class="linenos">142</span></a>        <span class="n">accuracy_difference_metric</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">],</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-143"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-143"><span class="linenos">143</span></a>        <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-144"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-144"><span class="linenos">144</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-145"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-145"><span class="linenos">145</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Update the unlearning accuracy difference metrics of unlearning tasks to CSV file.</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-146"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-146"><span class="linenos">146</span></a>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-147"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-147"><span class="linenos">147</span></a><span class="sd">        **Args:**</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-148"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-148"><span class="linenos">148</span></a><span class="sd">        - **accuracy_difference_metric** (`dict[str, MeanMetricBatch]`): the accuracy difference metric. Accumulated and calculated from the unlearning test batches.</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-149"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-149"><span class="linenos">149</span></a><span class="sd">        - **csv_path** (`str`): save the test metric to path. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/unlearning_test_after_task_X/distance.csv&#39;.</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-150"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-150"><span class="linenos">150</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-151"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-151"><span class="linenos">151</span></a>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-152"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-152"><span class="linenos">152</span></a>        <span class="n">eval_task_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">accuracy_difference_metric</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-153"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-153"><span class="linenos">153</span></a>        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;average_accuracy_difference&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-154"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-154"><span class="linenos">154</span></a>            <span class="sa">f</span><span class="s2">&quot;unlearning_test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">eval_task_ids</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-155"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-155"><span class="linenos">155</span></a>        <span class="p">]</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-156"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-156"><span class="linenos">156</span></a>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-157"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-157"><span class="linenos">157</span></a>        <span class="n">new_line</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-158"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-158"><span class="linenos">158</span></a>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-159"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-159"><span class="linenos">159</span></a>        <span class="c1"># write to the columns and calculate the average accuracy difference over tasks at the same time</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-160"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-160"><span class="linenos">160</span></a>        <span class="n">average_accuracy_difference_over_unlearned_tasks</span> <span class="o">=</span> <span class="n">MeanMetric</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-161"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-161"><span class="linenos">161</span></a>            <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">accuracy_difference_metric</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">device</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-162"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-162"><span class="linenos">162</span></a>        <span class="p">)</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-163"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-163"><span class="linenos">163</span></a>        <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">eval_task_ids</span><span class="p">:</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-164"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-164"><span class="linenos">164</span></a>            <span class="n">loss_cls</span> <span class="o">=</span> <span class="n">accuracy_difference_metric</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-165"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-165"><span class="linenos">165</span></a>            <span class="n">new_line</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;unlearning_test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_cls</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-166"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-166"><span class="linenos">166</span></a>            <span class="n">average_accuracy_difference_over_unlearned_tasks</span><span class="p">(</span><span class="n">loss_cls</span><span class="p">)</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-167"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-167"><span class="linenos">167</span></a>        <span class="n">new_line</span><span class="p">[</span><span class="s2">&quot;average_accuracy_difference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-168"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-168"><span class="linenos">168</span></a>            <span class="n">average_accuracy_difference_over_unlearned_tasks</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-169"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-169"><span class="linenos">169</span></a>        <span class="p">)</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-170"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-170"><span class="linenos">170</span></a>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-171"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-171"><span class="linenos">171</span></a>        <span class="c1"># write to the csv file</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-172"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-172"><span class="linenos">172</span></a>        <span class="n">is_first</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-173"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-173"><span class="linenos">173</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-174"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-174"><span class="linenos">174</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-175"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-175"><span class="linenos">175</span></a>                <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-176"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-176"><span class="linenos">176</span></a>                <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-177"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-177"><span class="linenos">177</span></a>        <span class="c1"># write header</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-178"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-178"><span class="linenos">178</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-179"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-179"><span class="linenos">179</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-180"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-180"><span class="linenos">180</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-181"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-181"><span class="linenos">181</span></a>        <span class="c1"># write metrics</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-182"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-182"><span class="linenos">182</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-183"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-183"><span class="linenos">183</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-184"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-184"><span class="linenos">184</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>  <span class="c1"># write the previous lines</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-185"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-185"><span class="linenos">185</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-186"><a href="#CULAccuracyDifference.update_unlearning_accuracy_difference_to_csv-186"><span class="linenos">186</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Update the unlearning accuracy difference metrics of unlearning tasks to CSV file.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>accuracy_difference_metric</strong> (<code>dict[str, MeanMetricBatch]</code>): the accuracy difference metric. Accumulated and calculated from the unlearning test batches.</li>
<li><strong>csv_path</strong> (<code>str</code>): save the test metric to path. E.g. './outputs/expr_name/1970-01-01_00-00-00/results/unlearning_test_after_task_X/distance.csv'.</li>
</ul>
</div>


                            </div>
                            <div id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv" class="classattr">
                                        <input id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_unlearning_accuracy_difference_from_csv</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-188"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-188"><span class="linenos">188</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_unlearning_accuracy_difference_from_csv</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-189"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-189"><span class="linenos">189</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-190"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-190"><span class="linenos">190</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-191"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-191"><span class="linenos">191</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the unlearning accuracy difference matrix over different unlearned tasks from saved CSV file and save the plot to the designated directory.</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-192"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-192"><span class="linenos">192</span></a>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-193"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-193"><span class="linenos">193</span></a><span class="sd">        **Args:**</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-194"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-194"><span class="linenos">194</span></a><span class="sd">        - **csv_path** (`str`): the path to the CSV file where the `utils.save_unlearning_test_distance_to_csv()` saved the unlearning test distance metric.</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-195"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-195"><span class="linenos">195</span></a><span class="sd">        - **plot_path** (`str`): the path to save plot. Better same as the output directory of the experiment. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/unlearning_test_after_task_X/distance.png&#39;.</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-196"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-196"><span class="linenos">196</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-197"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-197"><span class="linenos">197</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-198"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-198"><span class="linenos">198</span></a>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-199"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-199"><span class="linenos">199</span></a>        <span class="n">unlearned_task_ids</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-200"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-200"><span class="linenos">200</span></a>            <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;unlearning_test_on_task_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-201"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-201"><span class="linenos">201</span></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-202"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-202"><span class="linenos">202</span></a>            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;unlearning_test_on_task_&quot;</span><span class="p">)</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-203"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-203"><span class="linenos">203</span></a>        <span class="p">]</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-204"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-204"><span class="linenos">204</span></a>        <span class="n">num_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unlearned_task_ids</span><span class="p">)</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-205"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-205"><span class="linenos">205</span></a>        <span class="n">num_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-206"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-206"><span class="linenos">206</span></a>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-207"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-207"><span class="linenos">207</span></a>        <span class="c1"># plot the accuracy matrix</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-208"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-208"><span class="linenos">208</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-209"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-209"><span class="linenos">209</span></a>            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_tasks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_tests</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-210"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-210"><span class="linenos">210</span></a>        <span class="p">)</span>  <span class="c1"># adaptive figure size</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-211"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-211"><span class="linenos">211</span></a>        <span class="n">cax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-212"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-212"><span class="linenos">212</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;average_accuracy_difference&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-213"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-213"><span class="linenos">213</span></a>            <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-214"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-214"><span class="linenos">214</span></a>            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greens&quot;</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-215"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-215"><span class="linenos">215</span></a>            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-216"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-216"><span class="linenos">216</span></a>            <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-217"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-217"><span class="linenos">217</span></a>        <span class="p">)</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-218"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-218"><span class="linenos">218</span></a>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-219"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-219"><span class="linenos">219</span></a>        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cax</span><span class="p">)</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-220"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-220"><span class="linenos">220</span></a>        <span class="n">yticks</span> <span class="o">=</span> <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-221"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-221"><span class="linenos">221</span></a>        <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-222"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-222"><span class="linenos">222</span></a>        <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-223"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-223"><span class="linenos">223</span></a>            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">yticks</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-224"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-224"><span class="linenos">224</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-225"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-225"><span class="linenos">225</span></a>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-226"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-226"><span class="linenos">226</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-227"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-227"><span class="linenos">227</span></a>        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tests</span><span class="p">):</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-228"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-228"><span class="linenos">228</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">):</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-229"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-229"><span class="linenos">229</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="n">unlearned_task_ids</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-230"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-230"><span class="linenos">230</span></a>                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-231"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-231"><span class="linenos">231</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;unlearning_test_on_task_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-232"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-232"><span class="linenos">232</span></a>                    <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;unlearning_test_on_task_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-233"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-233"><span class="linenos">233</span></a>                    <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-234"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-234"><span class="linenos">234</span></a>                <span class="p">)</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-235"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-235"><span class="linenos">235</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-236"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-236"><span class="linenos">236</span></a>                    <span class="n">c</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-237"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-237"><span class="linenos">237</span></a>                    <span class="n">r</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-238"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-238"><span class="linenos">238</span></a>                    <span class="n">s</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-239"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-239"><span class="linenos">239</span></a>                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-240"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-240"><span class="linenos">240</span></a>                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-241"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-241"><span class="linenos">241</span></a>                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-242"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-242"><span class="linenos">242</span></a>                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span><span class="p">,</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-243"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-243"><span class="linenos">243</span></a>                <span class="p">)</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-244"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-244"><span class="linenos">244</span></a>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-245"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-245"><span class="linenos">245</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">))</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-246"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-246"><span class="linenos">246</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_tests</span><span class="p">))</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-247"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-247"><span class="linenos">247</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-248"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-248"><span class="linenos">248</span></a>            <span class="n">unlearned_task_ids</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-249"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-249"><span class="linenos">249</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-250"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-250"><span class="linenos">250</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-251"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-251"><span class="linenos">251</span></a>            <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_tests</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tests</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-252"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-252"><span class="linenos">252</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-253"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-253"><span class="linenos">253</span></a>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-254"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-254"><span class="linenos">254</span></a>        <span class="c1"># Labeling the axes</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-255"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-255"><span class="linenos">255</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-256"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-256"><span class="linenos">256</span></a>            <span class="s2">&quot;Testing unlearning on task &quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-257"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-257"><span class="linenos">257</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-258"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-258"><span class="linenos">258</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-259"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-259"><span class="linenos">259</span></a>            <span class="s2">&quot;Unlearning test after training task t&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">num_tasks</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-260"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-260"><span class="linenos">260</span></a>        <span class="p">)</span>  <span class="c1"># adaptive font size</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-261"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-261"><span class="linenos">261</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-262"><a href="#CULAccuracyDifference.plot_unlearning_accuracy_difference_from_csv-262"><span class="linenos">262</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plot the unlearning accuracy difference matrix over different unlearned tasks from saved CSV file and save the plot to the designated directory.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>csv_path</strong> (<code>str</code>): the path to the CSV file where the <code>utils.save_unlearning_test_distance_to_csv()</code> saved the unlearning test distance metric.</li>
<li><strong>plot_path</strong> (<code>str</code>): the path to save plot. Better same as the output directory of the experiment. E.g. './outputs/expr_name/1970-01-01_00-00-00/results/unlearning_test_after_task_X/distance.png'.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="HATAdjustmentRate">
                            <input id="HATAdjustmentRate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">HATAdjustmentRate</span><wbr>(<span class="base"><a href="#MetricCallback">clarena.metrics.MetricCallback</a></span>):

                <label class="view-source-button" for="HATAdjustmentRate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HATAdjustmentRate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HATAdjustmentRate-25"><a href="#HATAdjustmentRate-25"><span class="linenos"> 25</span></a><span class="k">class</span><span class="w"> </span><span class="nc">HATAdjustmentRate</span><span class="p">(</span><span class="n">MetricCallback</span><span class="p">):</span>
</span><span id="HATAdjustmentRate-26"><a href="#HATAdjustmentRate-26"><span class="linenos"> 26</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Provides all actions that are related to adjustment rate of [HAT (Hard Attention to the Task)](http://proceedings.mlr.press/v80/serra18a) algorithm and its extensions, which include:</span>
</span><span id="HATAdjustmentRate-27"><a href="#HATAdjustmentRate-27"><span class="linenos"> 27</span></a>
</span><span id="HATAdjustmentRate-28"><a href="#HATAdjustmentRate-28"><span class="linenos"> 28</span></a><span class="sd">    - Visualizing adjustment rate during training as figures.</span>
</span><span id="HATAdjustmentRate-29"><a href="#HATAdjustmentRate-29"><span class="linenos"> 29</span></a>
</span><span id="HATAdjustmentRate-30"><a href="#HATAdjustmentRate-30"><span class="linenos"> 30</span></a><span class="sd">    The callback is able to produce the following outputs:</span>
</span><span id="HATAdjustmentRate-31"><a href="#HATAdjustmentRate-31"><span class="linenos"> 31</span></a>
</span><span id="HATAdjustmentRate-32"><a href="#HATAdjustmentRate-32"><span class="linenos"> 32</span></a><span class="sd">    - Figures of training adjustment rate.</span>
</span><span id="HATAdjustmentRate-33"><a href="#HATAdjustmentRate-33"><span class="linenos"> 33</span></a>
</span><span id="HATAdjustmentRate-34"><a href="#HATAdjustmentRate-34"><span class="linenos"> 34</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="HATAdjustmentRate-35"><a href="#HATAdjustmentRate-35"><span class="linenos"> 35</span></a>
</span><span id="HATAdjustmentRate-36"><a href="#HATAdjustmentRate-36"><span class="linenos"> 36</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="HATAdjustmentRate-37"><a href="#HATAdjustmentRate-37"><span class="linenos"> 37</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-38"><a href="#HATAdjustmentRate-38"><span class="linenos"> 38</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-39"><a href="#HATAdjustmentRate-39"><span class="linenos"> 39</span></a>        <span class="n">plot_adjustment_rate_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-40"><a href="#HATAdjustmentRate-40"><span class="linenos"> 40</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATAdjustmentRate-41"><a href="#HATAdjustmentRate-41"><span class="linenos"> 41</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `HATAdjustmentRate`.</span>
</span><span id="HATAdjustmentRate-42"><a href="#HATAdjustmentRate-42"><span class="linenos"> 42</span></a>
</span><span id="HATAdjustmentRate-43"><a href="#HATAdjustmentRate-43"><span class="linenos"> 43</span></a><span class="sd">        **Args:**</span>
</span><span id="HATAdjustmentRate-44"><a href="#HATAdjustmentRate-44"><span class="linenos"> 44</span></a><span class="sd">        - **save_dir** (`str` | `None`): The directory to save the adjustment rate figures. Better inside the output folder.</span>
</span><span id="HATAdjustmentRate-45"><a href="#HATAdjustmentRate-45"><span class="linenos"> 45</span></a><span class="sd">        - **plot_adjustment_rate_every_n_steps** (`int` | `None`): the frequency of plotting adjustment rate figures in terms of number of batches during training.</span>
</span><span id="HATAdjustmentRate-46"><a href="#HATAdjustmentRate-46"><span class="linenos"> 46</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATAdjustmentRate-47"><a href="#HATAdjustmentRate-47"><span class="linenos"> 47</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="HATAdjustmentRate-48"><a href="#HATAdjustmentRate-48"><span class="linenos"> 48</span></a>
</span><span id="HATAdjustmentRate-49"><a href="#HATAdjustmentRate-49"><span class="linenos"> 49</span></a>        <span class="c1"># other settings</span>
</span><span id="HATAdjustmentRate-50"><a href="#HATAdjustmentRate-50"><span class="linenos"> 50</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot_adjustment_rate_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="HATAdjustmentRate-51"><a href="#HATAdjustmentRate-51"><span class="linenos"> 51</span></a>            <span class="n">plot_adjustment_rate_every_n_steps</span>
</span><span id="HATAdjustmentRate-52"><a href="#HATAdjustmentRate-52"><span class="linenos"> 52</span></a>        <span class="p">)</span>
</span><span id="HATAdjustmentRate-53"><a href="#HATAdjustmentRate-53"><span class="linenos"> 53</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the frequency of plotting adjustment rate in terms of number of batches.&quot;&quot;&quot;</span>
</span><span id="HATAdjustmentRate-54"><a href="#HATAdjustmentRate-54"><span class="linenos"> 54</span></a>
</span><span id="HATAdjustmentRate-55"><a href="#HATAdjustmentRate-55"><span class="linenos"> 55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="HATAdjustmentRate-56"><a href="#HATAdjustmentRate-56"><span class="linenos"> 56</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Task ID counter indicating which task is being processed. Self updated during the task loop. Starting from 1. &quot;&quot;&quot;</span>
</span><span id="HATAdjustmentRate-57"><a href="#HATAdjustmentRate-57"><span class="linenos"> 57</span></a>
</span><span id="HATAdjustmentRate-58"><a href="#HATAdjustmentRate-58"><span class="linenos"> 58</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_fit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATAdjustmentRate-59"><a href="#HATAdjustmentRate-59"><span class="linenos"> 59</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the current task ID in the beginning of a task&#39;s fitting (training and validation). Sanity check the `pl_module` to be `HAT`.</span>
</span><span id="HATAdjustmentRate-60"><a href="#HATAdjustmentRate-60"><span class="linenos"> 60</span></a>
</span><span id="HATAdjustmentRate-61"><a href="#HATAdjustmentRate-61"><span class="linenos"> 61</span></a><span class="sd">        **Raises:**</span>
</span><span id="HATAdjustmentRate-62"><a href="#HATAdjustmentRate-62"><span class="linenos"> 62</span></a><span class="sd">        -**TypeError**: when the `pl_module` is not `HAT`.</span>
</span><span id="HATAdjustmentRate-63"><a href="#HATAdjustmentRate-63"><span class="linenos"> 63</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATAdjustmentRate-64"><a href="#HATAdjustmentRate-64"><span class="linenos"> 64</span></a>
</span><span id="HATAdjustmentRate-65"><a href="#HATAdjustmentRate-65"><span class="linenos"> 65</span></a>        <span class="c1"># get the current task_id from the `CLAlgorithm` object</span>
</span><span id="HATAdjustmentRate-66"><a href="#HATAdjustmentRate-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">task_id</span>
</span><span id="HATAdjustmentRate-67"><a href="#HATAdjustmentRate-67"><span class="linenos"> 67</span></a>
</span><span id="HATAdjustmentRate-68"><a href="#HATAdjustmentRate-68"><span class="linenos"> 68</span></a>        <span class="c1"># sanity check</span>
</span><span id="HATAdjustmentRate-69"><a href="#HATAdjustmentRate-69"><span class="linenos"> 69</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pl_module</span><span class="p">,</span> <span class="n">HAT</span><span class="p">):</span>
</span><span id="HATAdjustmentRate-70"><a href="#HATAdjustmentRate-70"><span class="linenos"> 70</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="HATAdjustmentRate-71"><a href="#HATAdjustmentRate-71"><span class="linenos"> 71</span></a>                <span class="s2">&quot;The `CLAlgorithm` should be `HAT` to apply `HATAdjustmentRate`!&quot;</span>
</span><span id="HATAdjustmentRate-72"><a href="#HATAdjustmentRate-72"><span class="linenos"> 72</span></a>            <span class="p">)</span>
</span><span id="HATAdjustmentRate-73"><a href="#HATAdjustmentRate-73"><span class="linenos"> 73</span></a>
</span><span id="HATAdjustmentRate-74"><a href="#HATAdjustmentRate-74"><span class="linenos"> 74</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="HATAdjustmentRate-75"><a href="#HATAdjustmentRate-75"><span class="linenos"> 75</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span>
</span><span id="HATAdjustmentRate-76"><a href="#HATAdjustmentRate-76"><span class="linenos"> 76</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-77"><a href="#HATAdjustmentRate-77"><span class="linenos"> 77</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-78"><a href="#HATAdjustmentRate-78"><span class="linenos"> 78</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-79"><a href="#HATAdjustmentRate-79"><span class="linenos"> 79</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="HATAdjustmentRate-80"><a href="#HATAdjustmentRate-80"><span class="linenos"> 80</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-81"><a href="#HATAdjustmentRate-81"><span class="linenos"> 81</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-82"><a href="#HATAdjustmentRate-82"><span class="linenos"> 82</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATAdjustmentRate-83"><a href="#HATAdjustmentRate-83"><span class="linenos"> 83</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Plot adjustment rate after training batch.</span>
</span><span id="HATAdjustmentRate-84"><a href="#HATAdjustmentRate-84"><span class="linenos"> 84</span></a>
</span><span id="HATAdjustmentRate-85"><a href="#HATAdjustmentRate-85"><span class="linenos"> 85</span></a><span class="sd">        **Args:**</span>
</span><span id="HATAdjustmentRate-86"><a href="#HATAdjustmentRate-86"><span class="linenos"> 86</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the training step, which is the returns of the `training_step()` method in the `CLAlgorithm`.</span>
</span><span id="HATAdjustmentRate-87"><a href="#HATAdjustmentRate-87"><span class="linenos"> 87</span></a><span class="sd">        - **batch** (`Any`): the training data batch.</span>
</span><span id="HATAdjustmentRate-88"><a href="#HATAdjustmentRate-88"><span class="linenos"> 88</span></a><span class="sd">        - **batch_idx** (`int`): the index of the current batch. This is for the file name of mask figures.</span>
</span><span id="HATAdjustmentRate-89"><a href="#HATAdjustmentRate-89"><span class="linenos"> 89</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATAdjustmentRate-90"><a href="#HATAdjustmentRate-90"><span class="linenos"> 90</span></a>
</span><span id="HATAdjustmentRate-91"><a href="#HATAdjustmentRate-91"><span class="linenos"> 91</span></a>        <span class="c1"># get the adjustment rate</span>
</span><span id="HATAdjustmentRate-92"><a href="#HATAdjustmentRate-92"><span class="linenos"> 92</span></a>        <span class="n">adjustment_rate_weight</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;adjustment_rate_weight&quot;</span><span class="p">]</span>
</span><span id="HATAdjustmentRate-93"><a href="#HATAdjustmentRate-93"><span class="linenos"> 93</span></a>        <span class="n">adjustment_rate_bias</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;adjustment_rate_bias&quot;</span><span class="p">]</span>
</span><span id="HATAdjustmentRate-94"><a href="#HATAdjustmentRate-94"><span class="linenos"> 94</span></a>
</span><span id="HATAdjustmentRate-95"><a href="#HATAdjustmentRate-95"><span class="linenos"> 95</span></a>        <span class="c1"># plot the adjustment rate</span>
</span><span id="HATAdjustmentRate-96"><a href="#HATAdjustmentRate-96"><span class="linenos"> 96</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATAdjustmentRate-97"><a href="#HATAdjustmentRate-97"><span class="linenos"> 97</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="HATAdjustmentRate-98"><a href="#HATAdjustmentRate-98"><span class="linenos"> 98</span></a>                <span class="k">if</span> <span class="n">batch_idx</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_adjustment_rate_every_n_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="HATAdjustmentRate-99"><a href="#HATAdjustmentRate-99"><span class="linenos"> 99</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">plot_hat_adjustment_rate</span><span class="p">(</span>
</span><span id="HATAdjustmentRate-100"><a href="#HATAdjustmentRate-100"><span class="linenos">100</span></a>                        <span class="n">adjustment_rate</span><span class="o">=</span><span class="n">adjustment_rate_weight</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-101"><a href="#HATAdjustmentRate-101"><span class="linenos">101</span></a>                        <span class="n">weight_or_bias</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-102"><a href="#HATAdjustmentRate-102"><span class="linenos">102</span></a>                        <span class="n">step</span><span class="o">=</span><span class="n">batch_idx</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-103"><a href="#HATAdjustmentRate-103"><span class="linenos">103</span></a>                    <span class="p">)</span>
</span><span id="HATAdjustmentRate-104"><a href="#HATAdjustmentRate-104"><span class="linenos">104</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">plot_hat_adjustment_rate</span><span class="p">(</span>
</span><span id="HATAdjustmentRate-105"><a href="#HATAdjustmentRate-105"><span class="linenos">105</span></a>                        <span class="n">adjustment_rate</span><span class="o">=</span><span class="n">adjustment_rate_bias</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-106"><a href="#HATAdjustmentRate-106"><span class="linenos">106</span></a>                        <span class="n">weight_or_bias</span><span class="o">=</span><span class="s2">&quot;bias&quot;</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-107"><a href="#HATAdjustmentRate-107"><span class="linenos">107</span></a>                        <span class="n">step</span><span class="o">=</span><span class="n">batch_idx</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-108"><a href="#HATAdjustmentRate-108"><span class="linenos">108</span></a>                    <span class="p">)</span>
</span><span id="HATAdjustmentRate-109"><a href="#HATAdjustmentRate-109"><span class="linenos">109</span></a>
</span><span id="HATAdjustmentRate-110"><a href="#HATAdjustmentRate-110"><span class="linenos">110</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_hat_adjustment_rate</span><span class="p">(</span>
</span><span id="HATAdjustmentRate-111"><a href="#HATAdjustmentRate-111"><span class="linenos">111</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-112"><a href="#HATAdjustmentRate-112"><span class="linenos">112</span></a>        <span class="n">adjustment_rate</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="HATAdjustmentRate-113"><a href="#HATAdjustmentRate-113"><span class="linenos">113</span></a>        <span class="n">weight_or_bias</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-114"><a href="#HATAdjustmentRate-114"><span class="linenos">114</span></a>        <span class="n">step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-115"><a href="#HATAdjustmentRate-115"><span class="linenos">115</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATAdjustmentRate-116"><a href="#HATAdjustmentRate-116"><span class="linenos">116</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot adjustment rate in [HAT (Hard Attention to the Task)](http://proceedings.mlr.press/v80/serra18a)) algorithm. This includes the adjustment rate weight and adjustment rate bias (if applicable).</span>
</span><span id="HATAdjustmentRate-117"><a href="#HATAdjustmentRate-117"><span class="linenos">117</span></a>
</span><span id="HATAdjustmentRate-118"><a href="#HATAdjustmentRate-118"><span class="linenos">118</span></a><span class="sd">        **Args:**</span>
</span><span id="HATAdjustmentRate-119"><a href="#HATAdjustmentRate-119"><span class="linenos">119</span></a><span class="sd">        - **adjustment_rate** (`dict[str, Tensor]`): the adjustment rate. Key (`str`) is layer name, value (`Tensor`) is the adjustment rate tensor. If it&#39;s adjustment rate weight, it has size same as weights. If it&#39;s adjustment rate bias, it has size same as biases.</span>
</span><span id="HATAdjustmentRate-120"><a href="#HATAdjustmentRate-120"><span class="linenos">120</span></a><span class="sd">        - **weight_or_bias** (`str`): the type of adjustment rate. It can be either &#39;weight&#39; or &#39;bias&#39;. This is to form the plot name.</span>
</span><span id="HATAdjustmentRate-121"><a href="#HATAdjustmentRate-121"><span class="linenos">121</span></a><span class="sd">        - **step** (`int`): the training step (batch index) of the adjustment rate to be plotted. This is to form the plot name. Keep `None` for not showing the step in the plot name.</span>
</span><span id="HATAdjustmentRate-122"><a href="#HATAdjustmentRate-122"><span class="linenos">122</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATAdjustmentRate-123"><a href="#HATAdjustmentRate-123"><span class="linenos">123</span></a>
</span><span id="HATAdjustmentRate-124"><a href="#HATAdjustmentRate-124"><span class="linenos">124</span></a>        <span class="k">for</span> <span class="n">layer_name</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">adjustment_rate</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="HATAdjustmentRate-125"><a href="#HATAdjustmentRate-125"><span class="linenos">125</span></a>            <span class="n">layer_name</span> <span class="o">=</span> <span class="n">layer_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
</span><span id="HATAdjustmentRate-126"><a href="#HATAdjustmentRate-126"><span class="linenos">126</span></a>                <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span>
</span><span id="HATAdjustmentRate-127"><a href="#HATAdjustmentRate-127"><span class="linenos">127</span></a>            <span class="p">)</span>  <span class="c1"># the layer name contains &#39;/&#39;, which is not allowed in the file name. We replace it back with &#39;.&#39;.</span>
</span><span id="HATAdjustmentRate-128"><a href="#HATAdjustmentRate-128"><span class="linenos">128</span></a>
</span><span id="HATAdjustmentRate-129"><a href="#HATAdjustmentRate-129"><span class="linenos">129</span></a>            <span class="k">if</span> <span class="n">weight_or_bias</span> <span class="o">==</span> <span class="s2">&quot;bias&quot;</span><span class="p">:</span>
</span><span id="HATAdjustmentRate-130"><a href="#HATAdjustmentRate-130"><span class="linenos">130</span></a>                <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
</span><span id="HATAdjustmentRate-131"><a href="#HATAdjustmentRate-131"><span class="linenos">131</span></a>                    <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="HATAdjustmentRate-132"><a href="#HATAdjustmentRate-132"><span class="linenos">132</span></a>                <span class="p">)</span>  <span class="c1"># reshape the 1D mask to 2D so can be plotted by image show</span>
</span><span id="HATAdjustmentRate-133"><a href="#HATAdjustmentRate-133"><span class="linenos">133</span></a>
</span><span id="HATAdjustmentRate-134"><a href="#HATAdjustmentRate-134"><span class="linenos">134</span></a>            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span id="HATAdjustmentRate-135"><a href="#HATAdjustmentRate-135"><span class="linenos">135</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
</span><span id="HATAdjustmentRate-136"><a href="#HATAdjustmentRate-136"><span class="linenos">136</span></a>                <span class="n">a</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span>
</span><span id="HATAdjustmentRate-137"><a href="#HATAdjustmentRate-137"><span class="linenos">137</span></a>                <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-138"><a href="#HATAdjustmentRate-138"><span class="linenos">138</span></a>                <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Wistia&quot;</span><span class="p">,</span>
</span><span id="HATAdjustmentRate-139"><a href="#HATAdjustmentRate-139"><span class="linenos">139</span></a>                <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">),</span>
</span><span id="HATAdjustmentRate-140"><a href="#HATAdjustmentRate-140"><span class="linenos">140</span></a>            <span class="p">)</span>  <span class="c1"># can only convert to tensors in CPU to numpy arrays</span>
</span><span id="HATAdjustmentRate-141"><a href="#HATAdjustmentRate-141"><span class="linenos">141</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">()</span>  <span class="c1"># hide yticks</span>
</span><span id="HATAdjustmentRate-142"><a href="#HATAdjustmentRate-142"><span class="linenos">142</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</span><span id="HATAdjustmentRate-143"><a href="#HATAdjustmentRate-143"><span class="linenos">143</span></a>            <span class="k">if</span> <span class="n">step</span><span class="p">:</span>
</span><span id="HATAdjustmentRate-144"><a href="#HATAdjustmentRate-144"><span class="linenos">144</span></a>                <span class="n">plot_name</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="HATAdjustmentRate-145"><a href="#HATAdjustmentRate-145"><span class="linenos">145</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">weight_or_bias</span><span class="si">}</span><span class="s2">_task</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">_step</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">.png&quot;</span>
</span><span id="HATAdjustmentRate-146"><a href="#HATAdjustmentRate-146"><span class="linenos">146</span></a>                <span class="p">)</span>
</span><span id="HATAdjustmentRate-147"><a href="#HATAdjustmentRate-147"><span class="linenos">147</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="HATAdjustmentRate-148"><a href="#HATAdjustmentRate-148"><span class="linenos">148</span></a>                <span class="n">plot_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">weight_or_bias</span><span class="si">}</span><span class="s2">_task</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">.png&quot;</span>
</span><span id="HATAdjustmentRate-149"><a href="#HATAdjustmentRate-149"><span class="linenos">149</span></a>            <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">plot_name</span><span class="p">)</span>
</span><span id="HATAdjustmentRate-150"><a href="#HATAdjustmentRate-150"><span class="linenos">150</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="HATAdjustmentRate-151"><a href="#HATAdjustmentRate-151"><span class="linenos">151</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Provides all actions that are related to adjustment rate of <a href="http://proceedings.mlr.press/v80/serra18a">HAT (Hard Attention to the Task)</a> algorithm and its extensions, which include:</p>

<ul>
<li>Visualizing adjustment rate during training as figures.</li>
</ul>

<p>The callback is able to produce the following outputs:</p>

<ul>
<li>Figures of training adjustment rate.</li>
</ul>
</div>


                            <div id="HATAdjustmentRate.__init__" class="classattr">
                                        <input id="HATAdjustmentRate.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">HATAdjustmentRate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">plot_adjustment_rate_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="HATAdjustmentRate.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HATAdjustmentRate.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HATAdjustmentRate.__init__-36"><a href="#HATAdjustmentRate.__init__-36"><span class="linenos">36</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="HATAdjustmentRate.__init__-37"><a href="#HATAdjustmentRate.__init__-37"><span class="linenos">37</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.__init__-38"><a href="#HATAdjustmentRate.__init__-38"><span class="linenos">38</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.__init__-39"><a href="#HATAdjustmentRate.__init__-39"><span class="linenos">39</span></a>        <span class="n">plot_adjustment_rate_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.__init__-40"><a href="#HATAdjustmentRate.__init__-40"><span class="linenos">40</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATAdjustmentRate.__init__-41"><a href="#HATAdjustmentRate.__init__-41"><span class="linenos">41</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `HATAdjustmentRate`.</span>
</span><span id="HATAdjustmentRate.__init__-42"><a href="#HATAdjustmentRate.__init__-42"><span class="linenos">42</span></a>
</span><span id="HATAdjustmentRate.__init__-43"><a href="#HATAdjustmentRate.__init__-43"><span class="linenos">43</span></a><span class="sd">        **Args:**</span>
</span><span id="HATAdjustmentRate.__init__-44"><a href="#HATAdjustmentRate.__init__-44"><span class="linenos">44</span></a><span class="sd">        - **save_dir** (`str` | `None`): The directory to save the adjustment rate figures. Better inside the output folder.</span>
</span><span id="HATAdjustmentRate.__init__-45"><a href="#HATAdjustmentRate.__init__-45"><span class="linenos">45</span></a><span class="sd">        - **plot_adjustment_rate_every_n_steps** (`int` | `None`): the frequency of plotting adjustment rate figures in terms of number of batches during training.</span>
</span><span id="HATAdjustmentRate.__init__-46"><a href="#HATAdjustmentRate.__init__-46"><span class="linenos">46</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATAdjustmentRate.__init__-47"><a href="#HATAdjustmentRate.__init__-47"><span class="linenos">47</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="HATAdjustmentRate.__init__-48"><a href="#HATAdjustmentRate.__init__-48"><span class="linenos">48</span></a>
</span><span id="HATAdjustmentRate.__init__-49"><a href="#HATAdjustmentRate.__init__-49"><span class="linenos">49</span></a>        <span class="c1"># other settings</span>
</span><span id="HATAdjustmentRate.__init__-50"><a href="#HATAdjustmentRate.__init__-50"><span class="linenos">50</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot_adjustment_rate_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="HATAdjustmentRate.__init__-51"><a href="#HATAdjustmentRate.__init__-51"><span class="linenos">51</span></a>            <span class="n">plot_adjustment_rate_every_n_steps</span>
</span><span id="HATAdjustmentRate.__init__-52"><a href="#HATAdjustmentRate.__init__-52"><span class="linenos">52</span></a>        <span class="p">)</span>
</span><span id="HATAdjustmentRate.__init__-53"><a href="#HATAdjustmentRate.__init__-53"><span class="linenos">53</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the frequency of plotting adjustment rate in terms of number of batches.&quot;&quot;&quot;</span>
</span><span id="HATAdjustmentRate.__init__-54"><a href="#HATAdjustmentRate.__init__-54"><span class="linenos">54</span></a>
</span><span id="HATAdjustmentRate.__init__-55"><a href="#HATAdjustmentRate.__init__-55"><span class="linenos">55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="HATAdjustmentRate.__init__-56"><a href="#HATAdjustmentRate.__init__-56"><span class="linenos">56</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Task ID counter indicating which task is being processed. Self updated during the task loop. Starting from 1. &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the <code><a href="#HATAdjustmentRate">HATAdjustmentRate</a></code>.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>save_dir</strong> (<code>str</code> | <code>None</code>): The directory to save the adjustment rate figures. Better inside the output folder.</li>
<li><strong>plot_adjustment_rate_every_n_steps</strong> (<code>int</code> | <code>None</code>): the frequency of plotting adjustment rate figures in terms of number of batches during training.</li>
</ul>
</div>


                            </div>
                            <div id="HATAdjustmentRate.plot_adjustment_rate_every_n_steps" class="classattr">
                                <div class="attr variable">
            <span class="name">plot_adjustment_rate_every_n_steps</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#HATAdjustmentRate.plot_adjustment_rate_every_n_steps"></a>
    
            <div class="docstring"><p>Store the frequency of plotting adjustment rate in terms of number of batches.</p>
</div>


                            </div>
                            <div id="HATAdjustmentRate.task_id" class="classattr">
                                <div class="attr variable">
            <span class="name">task_id</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#HATAdjustmentRate.task_id"></a>
    
            <div class="docstring"><p>Task ID counter indicating which task is being processed. Self updated during the task loop. Starting from 1.</p>
</div>


                            </div>
                            <div id="HATAdjustmentRate.on_fit_start" class="classattr">
                                        <input id="HATAdjustmentRate.on_fit_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_fit_start</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="HATAdjustmentRate.on_fit_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HATAdjustmentRate.on_fit_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HATAdjustmentRate.on_fit_start-58"><a href="#HATAdjustmentRate.on_fit_start-58"><span class="linenos">58</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_fit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATAdjustmentRate.on_fit_start-59"><a href="#HATAdjustmentRate.on_fit_start-59"><span class="linenos">59</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the current task ID in the beginning of a task&#39;s fitting (training and validation). Sanity check the `pl_module` to be `HAT`.</span>
</span><span id="HATAdjustmentRate.on_fit_start-60"><a href="#HATAdjustmentRate.on_fit_start-60"><span class="linenos">60</span></a>
</span><span id="HATAdjustmentRate.on_fit_start-61"><a href="#HATAdjustmentRate.on_fit_start-61"><span class="linenos">61</span></a><span class="sd">        **Raises:**</span>
</span><span id="HATAdjustmentRate.on_fit_start-62"><a href="#HATAdjustmentRate.on_fit_start-62"><span class="linenos">62</span></a><span class="sd">        -**TypeError**: when the `pl_module` is not `HAT`.</span>
</span><span id="HATAdjustmentRate.on_fit_start-63"><a href="#HATAdjustmentRate.on_fit_start-63"><span class="linenos">63</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATAdjustmentRate.on_fit_start-64"><a href="#HATAdjustmentRate.on_fit_start-64"><span class="linenos">64</span></a>
</span><span id="HATAdjustmentRate.on_fit_start-65"><a href="#HATAdjustmentRate.on_fit_start-65"><span class="linenos">65</span></a>        <span class="c1"># get the current task_id from the `CLAlgorithm` object</span>
</span><span id="HATAdjustmentRate.on_fit_start-66"><a href="#HATAdjustmentRate.on_fit_start-66"><span class="linenos">66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">task_id</span>
</span><span id="HATAdjustmentRate.on_fit_start-67"><a href="#HATAdjustmentRate.on_fit_start-67"><span class="linenos">67</span></a>
</span><span id="HATAdjustmentRate.on_fit_start-68"><a href="#HATAdjustmentRate.on_fit_start-68"><span class="linenos">68</span></a>        <span class="c1"># sanity check</span>
</span><span id="HATAdjustmentRate.on_fit_start-69"><a href="#HATAdjustmentRate.on_fit_start-69"><span class="linenos">69</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pl_module</span><span class="p">,</span> <span class="n">HAT</span><span class="p">):</span>
</span><span id="HATAdjustmentRate.on_fit_start-70"><a href="#HATAdjustmentRate.on_fit_start-70"><span class="linenos">70</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="HATAdjustmentRate.on_fit_start-71"><a href="#HATAdjustmentRate.on_fit_start-71"><span class="linenos">71</span></a>                <span class="s2">&quot;The `CLAlgorithm` should be `HAT` to apply `HATAdjustmentRate`!&quot;</span>
</span><span id="HATAdjustmentRate.on_fit_start-72"><a href="#HATAdjustmentRate.on_fit_start-72"><span class="linenos">72</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get the current task ID in the beginning of a task's fitting (training and validation). Sanity check the <code>pl_module</code> to be <code>HAT</code>.</p>

<p><strong>Raises:</strong>
-<strong>TypeError</strong>: when the <code>pl_module</code> is not <code>HAT</code>.</p>
</div>


                            </div>
                            <div id="HATAdjustmentRate.on_train_batch_end" class="classattr">
                                        <input id="HATAdjustmentRate.on_train_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_train_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="HATAdjustmentRate.on_train_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HATAdjustmentRate.on_train_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HATAdjustmentRate.on_train_batch_end-74"><a href="#HATAdjustmentRate.on_train_batch_end-74"><span class="linenos"> 74</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-75"><a href="#HATAdjustmentRate.on_train_batch_end-75"><span class="linenos"> 75</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-76"><a href="#HATAdjustmentRate.on_train_batch_end-76"><span class="linenos"> 76</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-77"><a href="#HATAdjustmentRate.on_train_batch_end-77"><span class="linenos"> 77</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-78"><a href="#HATAdjustmentRate.on_train_batch_end-78"><span class="linenos"> 78</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-79"><a href="#HATAdjustmentRate.on_train_batch_end-79"><span class="linenos"> 79</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-80"><a href="#HATAdjustmentRate.on_train_batch_end-80"><span class="linenos"> 80</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-81"><a href="#HATAdjustmentRate.on_train_batch_end-81"><span class="linenos"> 81</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-82"><a href="#HATAdjustmentRate.on_train_batch_end-82"><span class="linenos"> 82</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-83"><a href="#HATAdjustmentRate.on_train_batch_end-83"><span class="linenos"> 83</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Plot adjustment rate after training batch.</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-84"><a href="#HATAdjustmentRate.on_train_batch_end-84"><span class="linenos"> 84</span></a>
</span><span id="HATAdjustmentRate.on_train_batch_end-85"><a href="#HATAdjustmentRate.on_train_batch_end-85"><span class="linenos"> 85</span></a><span class="sd">        **Args:**</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-86"><a href="#HATAdjustmentRate.on_train_batch_end-86"><span class="linenos"> 86</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the training step, which is the returns of the `training_step()` method in the `CLAlgorithm`.</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-87"><a href="#HATAdjustmentRate.on_train_batch_end-87"><span class="linenos"> 87</span></a><span class="sd">        - **batch** (`Any`): the training data batch.</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-88"><a href="#HATAdjustmentRate.on_train_batch_end-88"><span class="linenos"> 88</span></a><span class="sd">        - **batch_idx** (`int`): the index of the current batch. This is for the file name of mask figures.</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-89"><a href="#HATAdjustmentRate.on_train_batch_end-89"><span class="linenos"> 89</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-90"><a href="#HATAdjustmentRate.on_train_batch_end-90"><span class="linenos"> 90</span></a>
</span><span id="HATAdjustmentRate.on_train_batch_end-91"><a href="#HATAdjustmentRate.on_train_batch_end-91"><span class="linenos"> 91</span></a>        <span class="c1"># get the adjustment rate</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-92"><a href="#HATAdjustmentRate.on_train_batch_end-92"><span class="linenos"> 92</span></a>        <span class="n">adjustment_rate_weight</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;adjustment_rate_weight&quot;</span><span class="p">]</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-93"><a href="#HATAdjustmentRate.on_train_batch_end-93"><span class="linenos"> 93</span></a>        <span class="n">adjustment_rate_bias</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;adjustment_rate_bias&quot;</span><span class="p">]</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-94"><a href="#HATAdjustmentRate.on_train_batch_end-94"><span class="linenos"> 94</span></a>
</span><span id="HATAdjustmentRate.on_train_batch_end-95"><a href="#HATAdjustmentRate.on_train_batch_end-95"><span class="linenos"> 95</span></a>        <span class="c1"># plot the adjustment rate</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-96"><a href="#HATAdjustmentRate.on_train_batch_end-96"><span class="linenos"> 96</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-97"><a href="#HATAdjustmentRate.on_train_batch_end-97"><span class="linenos"> 97</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-98"><a href="#HATAdjustmentRate.on_train_batch_end-98"><span class="linenos"> 98</span></a>                <span class="k">if</span> <span class="n">batch_idx</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_adjustment_rate_every_n_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-99"><a href="#HATAdjustmentRate.on_train_batch_end-99"><span class="linenos"> 99</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">plot_hat_adjustment_rate</span><span class="p">(</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-100"><a href="#HATAdjustmentRate.on_train_batch_end-100"><span class="linenos">100</span></a>                        <span class="n">adjustment_rate</span><span class="o">=</span><span class="n">adjustment_rate_weight</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-101"><a href="#HATAdjustmentRate.on_train_batch_end-101"><span class="linenos">101</span></a>                        <span class="n">weight_or_bias</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-102"><a href="#HATAdjustmentRate.on_train_batch_end-102"><span class="linenos">102</span></a>                        <span class="n">step</span><span class="o">=</span><span class="n">batch_idx</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-103"><a href="#HATAdjustmentRate.on_train_batch_end-103"><span class="linenos">103</span></a>                    <span class="p">)</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-104"><a href="#HATAdjustmentRate.on_train_batch_end-104"><span class="linenos">104</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">plot_hat_adjustment_rate</span><span class="p">(</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-105"><a href="#HATAdjustmentRate.on_train_batch_end-105"><span class="linenos">105</span></a>                        <span class="n">adjustment_rate</span><span class="o">=</span><span class="n">adjustment_rate_bias</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-106"><a href="#HATAdjustmentRate.on_train_batch_end-106"><span class="linenos">106</span></a>                        <span class="n">weight_or_bias</span><span class="o">=</span><span class="s2">&quot;bias&quot;</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-107"><a href="#HATAdjustmentRate.on_train_batch_end-107"><span class="linenos">107</span></a>                        <span class="n">step</span><span class="o">=</span><span class="n">batch_idx</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.on_train_batch_end-108"><a href="#HATAdjustmentRate.on_train_batch_end-108"><span class="linenos">108</span></a>                    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plot adjustment rate after training batch.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the training step, which is the returns of the <code>training_step()</code> method in the <code>CLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the training data batch.</li>
<li><strong>batch_idx</strong> (<code>int</code>): the index of the current batch. This is for the file name of mask figures.</li>
</ul>
</div>


                            </div>
                            <div id="HATAdjustmentRate.plot_hat_adjustment_rate" class="classattr">
                                        <input id="HATAdjustmentRate.plot_hat_adjustment_rate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_hat_adjustment_rate</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">adjustment_rate</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">weight_or_bias</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="HATAdjustmentRate.plot_hat_adjustment_rate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HATAdjustmentRate.plot_hat_adjustment_rate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-110"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-110"><span class="linenos">110</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_hat_adjustment_rate</span><span class="p">(</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-111"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-111"><span class="linenos">111</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-112"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-112"><span class="linenos">112</span></a>        <span class="n">adjustment_rate</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-113"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-113"><span class="linenos">113</span></a>        <span class="n">weight_or_bias</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-114"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-114"><span class="linenos">114</span></a>        <span class="n">step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-115"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-115"><span class="linenos">115</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-116"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-116"><span class="linenos">116</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot adjustment rate in [HAT (Hard Attention to the Task)](http://proceedings.mlr.press/v80/serra18a)) algorithm. This includes the adjustment rate weight and adjustment rate bias (if applicable).</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-117"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-117"><span class="linenos">117</span></a>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-118"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-118"><span class="linenos">118</span></a><span class="sd">        **Args:**</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-119"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-119"><span class="linenos">119</span></a><span class="sd">        - **adjustment_rate** (`dict[str, Tensor]`): the adjustment rate. Key (`str`) is layer name, value (`Tensor`) is the adjustment rate tensor. If it&#39;s adjustment rate weight, it has size same as weights. If it&#39;s adjustment rate bias, it has size same as biases.</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-120"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-120"><span class="linenos">120</span></a><span class="sd">        - **weight_or_bias** (`str`): the type of adjustment rate. It can be either &#39;weight&#39; or &#39;bias&#39;. This is to form the plot name.</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-121"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-121"><span class="linenos">121</span></a><span class="sd">        - **step** (`int`): the training step (batch index) of the adjustment rate to be plotted. This is to form the plot name. Keep `None` for not showing the step in the plot name.</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-122"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-122"><span class="linenos">122</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-123"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-123"><span class="linenos">123</span></a>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-124"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-124"><span class="linenos">124</span></a>        <span class="k">for</span> <span class="n">layer_name</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">adjustment_rate</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-125"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-125"><span class="linenos">125</span></a>            <span class="n">layer_name</span> <span class="o">=</span> <span class="n">layer_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-126"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-126"><span class="linenos">126</span></a>                <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-127"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-127"><span class="linenos">127</span></a>            <span class="p">)</span>  <span class="c1"># the layer name contains &#39;/&#39;, which is not allowed in the file name. We replace it back with &#39;.&#39;.</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-128"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-128"><span class="linenos">128</span></a>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-129"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-129"><span class="linenos">129</span></a>            <span class="k">if</span> <span class="n">weight_or_bias</span> <span class="o">==</span> <span class="s2">&quot;bias&quot;</span><span class="p">:</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-130"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-130"><span class="linenos">130</span></a>                <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-131"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-131"><span class="linenos">131</span></a>                    <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-132"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-132"><span class="linenos">132</span></a>                <span class="p">)</span>  <span class="c1"># reshape the 1D mask to 2D so can be plotted by image show</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-133"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-133"><span class="linenos">133</span></a>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-134"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-134"><span class="linenos">134</span></a>            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-135"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-135"><span class="linenos">135</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-136"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-136"><span class="linenos">136</span></a>                <span class="n">a</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-137"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-137"><span class="linenos">137</span></a>                <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-138"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-138"><span class="linenos">138</span></a>                <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Wistia&quot;</span><span class="p">,</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-139"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-139"><span class="linenos">139</span></a>                <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">),</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-140"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-140"><span class="linenos">140</span></a>            <span class="p">)</span>  <span class="c1"># can only convert to tensors in CPU to numpy arrays</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-141"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-141"><span class="linenos">141</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">()</span>  <span class="c1"># hide yticks</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-142"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-142"><span class="linenos">142</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-143"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-143"><span class="linenos">143</span></a>            <span class="k">if</span> <span class="n">step</span><span class="p">:</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-144"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-144"><span class="linenos">144</span></a>                <span class="n">plot_name</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-145"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-145"><span class="linenos">145</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">weight_or_bias</span><span class="si">}</span><span class="s2">_task</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">_step</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">.png&quot;</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-146"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-146"><span class="linenos">146</span></a>                <span class="p">)</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-147"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-147"><span class="linenos">147</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-148"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-148"><span class="linenos">148</span></a>                <span class="n">plot_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">weight_or_bias</span><span class="si">}</span><span class="s2">_task</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">.png&quot;</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-149"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-149"><span class="linenos">149</span></a>            <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">plot_name</span><span class="p">)</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-150"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-150"><span class="linenos">150</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="HATAdjustmentRate.plot_hat_adjustment_rate-151"><a href="#HATAdjustmentRate.plot_hat_adjustment_rate-151"><span class="linenos">151</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plot adjustment rate in <a href="http://proceedings.mlr.press/v80/serra18a">HAT (Hard Attention to the Task)</a>) algorithm. This includes the adjustment rate weight and adjustment rate bias (if applicable).</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>adjustment_rate</strong> (<code>dict[str, Tensor]</code>): the adjustment rate. Key (<code>str</code>) is layer name, value (<code>Tensor</code>) is the adjustment rate tensor. If it's adjustment rate weight, it has size same as weights. If it's adjustment rate bias, it has size same as biases.</li>
<li><strong>weight_or_bias</strong> (<code>str</code>): the type of adjustment rate. It can be either 'weight' or 'bias'. This is to form the plot name.</li>
<li><strong>step</strong> (<code>int</code>): the training step (batch index) of the adjustment rate to be plotted. This is to form the plot name. Keep <code>None</code> for not showing the step in the plot name.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="HATNetworkCapacity">
                            <input id="HATNetworkCapacity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">HATNetworkCapacity</span><wbr>(<span class="base"><a href="#MetricCallback">clarena.metrics.MetricCallback</a></span>):

                <label class="view-source-button" for="HATNetworkCapacity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HATNetworkCapacity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HATNetworkCapacity-21"><a href="#HATNetworkCapacity-21"><span class="linenos">21</span></a><span class="k">class</span><span class="w"> </span><span class="nc">HATNetworkCapacity</span><span class="p">(</span><span class="n">MetricCallback</span><span class="p">):</span>
</span><span id="HATNetworkCapacity-22"><a href="#HATNetworkCapacity-22"><span class="linenos">22</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Provides all actions that are related to network capacity of [HAT (Hard Attention to the Task)](http://proceedings.mlr.press/v80/serra18a) algorithm and its extensions, which include:</span>
</span><span id="HATNetworkCapacity-23"><a href="#HATNetworkCapacity-23"><span class="linenos">23</span></a>
</span><span id="HATNetworkCapacity-24"><a href="#HATNetworkCapacity-24"><span class="linenos">24</span></a><span class="sd">    - Logging network capacity during training. See the &quot;Evaluation Metrics&quot; section in chapter 4.1 in [AdaHAT paper](https://link.springer.com/chapter/10.1007/978-3-031-70352-2_9) for more details about network capacity.</span>
</span><span id="HATNetworkCapacity-25"><a href="#HATNetworkCapacity-25"><span class="linenos">25</span></a>
</span><span id="HATNetworkCapacity-26"><a href="#HATNetworkCapacity-26"><span class="linenos">26</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="HATNetworkCapacity-27"><a href="#HATNetworkCapacity-27"><span class="linenos">27</span></a>
</span><span id="HATNetworkCapacity-28"><a href="#HATNetworkCapacity-28"><span class="linenos">28</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="HATNetworkCapacity-29"><a href="#HATNetworkCapacity-29"><span class="linenos">29</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="HATNetworkCapacity-30"><a href="#HATNetworkCapacity-30"><span class="linenos">30</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="HATNetworkCapacity-31"><a href="#HATNetworkCapacity-31"><span class="linenos">31</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATNetworkCapacity-32"><a href="#HATNetworkCapacity-32"><span class="linenos">32</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `HATNetworkCapacity`.</span>
</span><span id="HATNetworkCapacity-33"><a href="#HATNetworkCapacity-33"><span class="linenos">33</span></a>
</span><span id="HATNetworkCapacity-34"><a href="#HATNetworkCapacity-34"><span class="linenos">34</span></a><span class="sd">        **Args:**</span>
</span><span id="HATNetworkCapacity-35"><a href="#HATNetworkCapacity-35"><span class="linenos">35</span></a><span class="sd">        - **save_dir** (`str`): the directory to save the mask figures. Better inside the output folder.</span>
</span><span id="HATNetworkCapacity-36"><a href="#HATNetworkCapacity-36"><span class="linenos">36</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATNetworkCapacity-37"><a href="#HATNetworkCapacity-37"><span class="linenos">37</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="HATNetworkCapacity-38"><a href="#HATNetworkCapacity-38"><span class="linenos">38</span></a>
</span><span id="HATNetworkCapacity-39"><a href="#HATNetworkCapacity-39"><span class="linenos">39</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="HATNetworkCapacity-40"><a href="#HATNetworkCapacity-40"><span class="linenos">40</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Task ID counter indicating which task is being processed. Self updated during the task loop. Starting from 1. &quot;&quot;&quot;</span>
</span><span id="HATNetworkCapacity-41"><a href="#HATNetworkCapacity-41"><span class="linenos">41</span></a>
</span><span id="HATNetworkCapacity-42"><a href="#HATNetworkCapacity-42"><span class="linenos">42</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_fit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATNetworkCapacity-43"><a href="#HATNetworkCapacity-43"><span class="linenos">43</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the current task ID in the beginning of a task&#39;s fitting (training and validation). Sanity check the `pl_module` to be `HAT`.</span>
</span><span id="HATNetworkCapacity-44"><a href="#HATNetworkCapacity-44"><span class="linenos">44</span></a>
</span><span id="HATNetworkCapacity-45"><a href="#HATNetworkCapacity-45"><span class="linenos">45</span></a><span class="sd">        **Raises:**</span>
</span><span id="HATNetworkCapacity-46"><a href="#HATNetworkCapacity-46"><span class="linenos">46</span></a><span class="sd">        -**TypeError**: when the `pl_module` is not `HAT`.</span>
</span><span id="HATNetworkCapacity-47"><a href="#HATNetworkCapacity-47"><span class="linenos">47</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATNetworkCapacity-48"><a href="#HATNetworkCapacity-48"><span class="linenos">48</span></a>
</span><span id="HATNetworkCapacity-49"><a href="#HATNetworkCapacity-49"><span class="linenos">49</span></a>        <span class="c1"># get the current task_id from the `CLAlgorithm` object</span>
</span><span id="HATNetworkCapacity-50"><a href="#HATNetworkCapacity-50"><span class="linenos">50</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">task_id</span>
</span><span id="HATNetworkCapacity-51"><a href="#HATNetworkCapacity-51"><span class="linenos">51</span></a>
</span><span id="HATNetworkCapacity-52"><a href="#HATNetworkCapacity-52"><span class="linenos">52</span></a>        <span class="c1"># sanity check</span>
</span><span id="HATNetworkCapacity-53"><a href="#HATNetworkCapacity-53"><span class="linenos">53</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pl_module</span><span class="p">,</span> <span class="n">HAT</span><span class="p">):</span>
</span><span id="HATNetworkCapacity-54"><a href="#HATNetworkCapacity-54"><span class="linenos">54</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="HATNetworkCapacity-55"><a href="#HATNetworkCapacity-55"><span class="linenos">55</span></a>                <span class="s2">&quot;The `CLAlgorithm` should be `HAT` to apply `HATMetricCallback`!&quot;</span>
</span><span id="HATNetworkCapacity-56"><a href="#HATNetworkCapacity-56"><span class="linenos">56</span></a>            <span class="p">)</span>
</span><span id="HATNetworkCapacity-57"><a href="#HATNetworkCapacity-57"><span class="linenos">57</span></a>
</span><span id="HATNetworkCapacity-58"><a href="#HATNetworkCapacity-58"><span class="linenos">58</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="HATNetworkCapacity-59"><a href="#HATNetworkCapacity-59"><span class="linenos">59</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span>
</span><span id="HATNetworkCapacity-60"><a href="#HATNetworkCapacity-60"><span class="linenos">60</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="HATNetworkCapacity-61"><a href="#HATNetworkCapacity-61"><span class="linenos">61</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="HATNetworkCapacity-62"><a href="#HATNetworkCapacity-62"><span class="linenos">62</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="HATNetworkCapacity-63"><a href="#HATNetworkCapacity-63"><span class="linenos">63</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="HATNetworkCapacity-64"><a href="#HATNetworkCapacity-64"><span class="linenos">64</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="HATNetworkCapacity-65"><a href="#HATNetworkCapacity-65"><span class="linenos">65</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="HATNetworkCapacity-66"><a href="#HATNetworkCapacity-66"><span class="linenos">66</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATNetworkCapacity-67"><a href="#HATNetworkCapacity-67"><span class="linenos">67</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Plot training mask, adjustment rate and log network capacity after training batch.</span>
</span><span id="HATNetworkCapacity-68"><a href="#HATNetworkCapacity-68"><span class="linenos">68</span></a>
</span><span id="HATNetworkCapacity-69"><a href="#HATNetworkCapacity-69"><span class="linenos">69</span></a><span class="sd">        **Args:**</span>
</span><span id="HATNetworkCapacity-70"><a href="#HATNetworkCapacity-70"><span class="linenos">70</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the training step, which is the returns of the `training_step()` method in the `CLAlgorithm`.</span>
</span><span id="HATNetworkCapacity-71"><a href="#HATNetworkCapacity-71"><span class="linenos">71</span></a><span class="sd">        - **batch** (`Any`): the training data batch.</span>
</span><span id="HATNetworkCapacity-72"><a href="#HATNetworkCapacity-72"><span class="linenos">72</span></a><span class="sd">        - **batch_idx** (`int`): the index of the current batch. This is for the file name of mask figures.</span>
</span><span id="HATNetworkCapacity-73"><a href="#HATNetworkCapacity-73"><span class="linenos">73</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATNetworkCapacity-74"><a href="#HATNetworkCapacity-74"><span class="linenos">74</span></a>
</span><span id="HATNetworkCapacity-75"><a href="#HATNetworkCapacity-75"><span class="linenos">75</span></a>        <span class="c1"># get the current network capacity</span>
</span><span id="HATNetworkCapacity-76"><a href="#HATNetworkCapacity-76"><span class="linenos">76</span></a>        <span class="n">capacity</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;capacity&quot;</span><span class="p">]</span>
</span><span id="HATNetworkCapacity-77"><a href="#HATNetworkCapacity-77"><span class="linenos">77</span></a>
</span><span id="HATNetworkCapacity-78"><a href="#HATNetworkCapacity-78"><span class="linenos">78</span></a>        <span class="c1"># log the network capacity to Lightning loggers</span>
</span><span id="HATNetworkCapacity-79"><a href="#HATNetworkCapacity-79"><span class="linenos">79</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="HATNetworkCapacity-80"><a href="#HATNetworkCapacity-80"><span class="linenos">80</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/train/network_capacity&quot;</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span>
</span><span id="HATNetworkCapacity-81"><a href="#HATNetworkCapacity-81"><span class="linenos">81</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Provides all actions that are related to network capacity of <a href="http://proceedings.mlr.press/v80/serra18a">HAT (Hard Attention to the Task)</a> algorithm and its extensions, which include:</p>

<ul>
<li>Logging network capacity during training. See the "Evaluation Metrics" section in chapter 4.1 in <a href="https://link.springer.com/chapter/10.1007/978-3-031-70352-2_9">AdaHAT paper</a> for more details about network capacity.</li>
</ul>
</div>


                            <div id="HATNetworkCapacity.__init__" class="classattr">
                                        <input id="HATNetworkCapacity.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">HATNetworkCapacity</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span></span>)</span>

                <label class="view-source-button" for="HATNetworkCapacity.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HATNetworkCapacity.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HATNetworkCapacity.__init__-28"><a href="#HATNetworkCapacity.__init__-28"><span class="linenos">28</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="HATNetworkCapacity.__init__-29"><a href="#HATNetworkCapacity.__init__-29"><span class="linenos">29</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="HATNetworkCapacity.__init__-30"><a href="#HATNetworkCapacity.__init__-30"><span class="linenos">30</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="HATNetworkCapacity.__init__-31"><a href="#HATNetworkCapacity.__init__-31"><span class="linenos">31</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATNetworkCapacity.__init__-32"><a href="#HATNetworkCapacity.__init__-32"><span class="linenos">32</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `HATNetworkCapacity`.</span>
</span><span id="HATNetworkCapacity.__init__-33"><a href="#HATNetworkCapacity.__init__-33"><span class="linenos">33</span></a>
</span><span id="HATNetworkCapacity.__init__-34"><a href="#HATNetworkCapacity.__init__-34"><span class="linenos">34</span></a><span class="sd">        **Args:**</span>
</span><span id="HATNetworkCapacity.__init__-35"><a href="#HATNetworkCapacity.__init__-35"><span class="linenos">35</span></a><span class="sd">        - **save_dir** (`str`): the directory to save the mask figures. Better inside the output folder.</span>
</span><span id="HATNetworkCapacity.__init__-36"><a href="#HATNetworkCapacity.__init__-36"><span class="linenos">36</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATNetworkCapacity.__init__-37"><a href="#HATNetworkCapacity.__init__-37"><span class="linenos">37</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="HATNetworkCapacity.__init__-38"><a href="#HATNetworkCapacity.__init__-38"><span class="linenos">38</span></a>
</span><span id="HATNetworkCapacity.__init__-39"><a href="#HATNetworkCapacity.__init__-39"><span class="linenos">39</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="HATNetworkCapacity.__init__-40"><a href="#HATNetworkCapacity.__init__-40"><span class="linenos">40</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Task ID counter indicating which task is being processed. Self updated during the task loop. Starting from 1. &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the <code><a href="#HATNetworkCapacity">HATNetworkCapacity</a></code>.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>save_dir</strong> (<code>str</code>): the directory to save the mask figures. Better inside the output folder.</li>
</ul>
</div>


                            </div>
                            <div id="HATNetworkCapacity.task_id" class="classattr">
                                <div class="attr variable">
            <span class="name">task_id</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#HATNetworkCapacity.task_id"></a>
    
            <div class="docstring"><p>Task ID counter indicating which task is being processed. Self updated during the task loop. Starting from 1.</p>
</div>


                            </div>
                            <div id="HATNetworkCapacity.on_fit_start" class="classattr">
                                        <input id="HATNetworkCapacity.on_fit_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_fit_start</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="HATNetworkCapacity.on_fit_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HATNetworkCapacity.on_fit_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HATNetworkCapacity.on_fit_start-42"><a href="#HATNetworkCapacity.on_fit_start-42"><span class="linenos">42</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_fit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATNetworkCapacity.on_fit_start-43"><a href="#HATNetworkCapacity.on_fit_start-43"><span class="linenos">43</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the current task ID in the beginning of a task&#39;s fitting (training and validation). Sanity check the `pl_module` to be `HAT`.</span>
</span><span id="HATNetworkCapacity.on_fit_start-44"><a href="#HATNetworkCapacity.on_fit_start-44"><span class="linenos">44</span></a>
</span><span id="HATNetworkCapacity.on_fit_start-45"><a href="#HATNetworkCapacity.on_fit_start-45"><span class="linenos">45</span></a><span class="sd">        **Raises:**</span>
</span><span id="HATNetworkCapacity.on_fit_start-46"><a href="#HATNetworkCapacity.on_fit_start-46"><span class="linenos">46</span></a><span class="sd">        -**TypeError**: when the `pl_module` is not `HAT`.</span>
</span><span id="HATNetworkCapacity.on_fit_start-47"><a href="#HATNetworkCapacity.on_fit_start-47"><span class="linenos">47</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATNetworkCapacity.on_fit_start-48"><a href="#HATNetworkCapacity.on_fit_start-48"><span class="linenos">48</span></a>
</span><span id="HATNetworkCapacity.on_fit_start-49"><a href="#HATNetworkCapacity.on_fit_start-49"><span class="linenos">49</span></a>        <span class="c1"># get the current task_id from the `CLAlgorithm` object</span>
</span><span id="HATNetworkCapacity.on_fit_start-50"><a href="#HATNetworkCapacity.on_fit_start-50"><span class="linenos">50</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">task_id</span>
</span><span id="HATNetworkCapacity.on_fit_start-51"><a href="#HATNetworkCapacity.on_fit_start-51"><span class="linenos">51</span></a>
</span><span id="HATNetworkCapacity.on_fit_start-52"><a href="#HATNetworkCapacity.on_fit_start-52"><span class="linenos">52</span></a>        <span class="c1"># sanity check</span>
</span><span id="HATNetworkCapacity.on_fit_start-53"><a href="#HATNetworkCapacity.on_fit_start-53"><span class="linenos">53</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pl_module</span><span class="p">,</span> <span class="n">HAT</span><span class="p">):</span>
</span><span id="HATNetworkCapacity.on_fit_start-54"><a href="#HATNetworkCapacity.on_fit_start-54"><span class="linenos">54</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="HATNetworkCapacity.on_fit_start-55"><a href="#HATNetworkCapacity.on_fit_start-55"><span class="linenos">55</span></a>                <span class="s2">&quot;The `CLAlgorithm` should be `HAT` to apply `HATMetricCallback`!&quot;</span>
</span><span id="HATNetworkCapacity.on_fit_start-56"><a href="#HATNetworkCapacity.on_fit_start-56"><span class="linenos">56</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get the current task ID in the beginning of a task's fitting (training and validation). Sanity check the <code>pl_module</code> to be <code>HAT</code>.</p>

<p><strong>Raises:</strong>
-<strong>TypeError</strong>: when the <code>pl_module</code> is not <code>HAT</code>.</p>
</div>


                            </div>
                            <div id="HATNetworkCapacity.on_train_batch_end" class="classattr">
                                        <input id="HATNetworkCapacity.on_train_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_train_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="HATNetworkCapacity.on_train_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HATNetworkCapacity.on_train_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HATNetworkCapacity.on_train_batch_end-58"><a href="#HATNetworkCapacity.on_train_batch_end-58"><span class="linenos">58</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-59"><a href="#HATNetworkCapacity.on_train_batch_end-59"><span class="linenos">59</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-60"><a href="#HATNetworkCapacity.on_train_batch_end-60"><span class="linenos">60</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-61"><a href="#HATNetworkCapacity.on_train_batch_end-61"><span class="linenos">61</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-62"><a href="#HATNetworkCapacity.on_train_batch_end-62"><span class="linenos">62</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-63"><a href="#HATNetworkCapacity.on_train_batch_end-63"><span class="linenos">63</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-64"><a href="#HATNetworkCapacity.on_train_batch_end-64"><span class="linenos">64</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-65"><a href="#HATNetworkCapacity.on_train_batch_end-65"><span class="linenos">65</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-66"><a href="#HATNetworkCapacity.on_train_batch_end-66"><span class="linenos">66</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-67"><a href="#HATNetworkCapacity.on_train_batch_end-67"><span class="linenos">67</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Plot training mask, adjustment rate and log network capacity after training batch.</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-68"><a href="#HATNetworkCapacity.on_train_batch_end-68"><span class="linenos">68</span></a>
</span><span id="HATNetworkCapacity.on_train_batch_end-69"><a href="#HATNetworkCapacity.on_train_batch_end-69"><span class="linenos">69</span></a><span class="sd">        **Args:**</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-70"><a href="#HATNetworkCapacity.on_train_batch_end-70"><span class="linenos">70</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the training step, which is the returns of the `training_step()` method in the `CLAlgorithm`.</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-71"><a href="#HATNetworkCapacity.on_train_batch_end-71"><span class="linenos">71</span></a><span class="sd">        - **batch** (`Any`): the training data batch.</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-72"><a href="#HATNetworkCapacity.on_train_batch_end-72"><span class="linenos">72</span></a><span class="sd">        - **batch_idx** (`int`): the index of the current batch. This is for the file name of mask figures.</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-73"><a href="#HATNetworkCapacity.on_train_batch_end-73"><span class="linenos">73</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-74"><a href="#HATNetworkCapacity.on_train_batch_end-74"><span class="linenos">74</span></a>
</span><span id="HATNetworkCapacity.on_train_batch_end-75"><a href="#HATNetworkCapacity.on_train_batch_end-75"><span class="linenos">75</span></a>        <span class="c1"># get the current network capacity</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-76"><a href="#HATNetworkCapacity.on_train_batch_end-76"><span class="linenos">76</span></a>        <span class="n">capacity</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;capacity&quot;</span><span class="p">]</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-77"><a href="#HATNetworkCapacity.on_train_batch_end-77"><span class="linenos">77</span></a>
</span><span id="HATNetworkCapacity.on_train_batch_end-78"><a href="#HATNetworkCapacity.on_train_batch_end-78"><span class="linenos">78</span></a>        <span class="c1"># log the network capacity to Lightning loggers</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-79"><a href="#HATNetworkCapacity.on_train_batch_end-79"><span class="linenos">79</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-80"><a href="#HATNetworkCapacity.on_train_batch_end-80"><span class="linenos">80</span></a>            <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">/train/network_capacity&quot;</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span>
</span><span id="HATNetworkCapacity.on_train_batch_end-81"><a href="#HATNetworkCapacity.on_train_batch_end-81"><span class="linenos">81</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plot training mask, adjustment rate and log network capacity after training batch.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the training step, which is the returns of the <code>training_step()</code> method in the <code>CLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the training data batch.</li>
<li><strong>batch_idx</strong> (<code>int</code>): the index of the current batch. This is for the file name of mask figures.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="HATMasks">
                            <input id="HATMasks-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">HATMasks</span><wbr>(<span class="base"><a href="#MetricCallback">clarena.metrics.MetricCallback</a></span>):

                <label class="view-source-button" for="HATMasks-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HATMasks"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HATMasks-24"><a href="#HATMasks-24"><span class="linenos"> 24</span></a><span class="k">class</span><span class="w"> </span><span class="nc">HATMasks</span><span class="p">(</span><span class="n">MetricCallback</span><span class="p">):</span>
</span><span id="HATMasks-25"><a href="#HATMasks-25"><span class="linenos"> 25</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Provides all actions that are related to masks of [HAT (Hard Attention to the Task)](http://proceedings.mlr.press/v80/serra18a) algorithm and its extensions, which include:</span>
</span><span id="HATMasks-26"><a href="#HATMasks-26"><span class="linenos"> 26</span></a>
</span><span id="HATMasks-27"><a href="#HATMasks-27"><span class="linenos"> 27</span></a><span class="sd">    - Visualizing mask and cumulative mask figures during training and testing as figures.</span>
</span><span id="HATMasks-28"><a href="#HATMasks-28"><span class="linenos"> 28</span></a>
</span><span id="HATMasks-29"><a href="#HATMasks-29"><span class="linenos"> 29</span></a><span class="sd">    The callback is able to produce the following outputs:</span>
</span><span id="HATMasks-30"><a href="#HATMasks-30"><span class="linenos"> 30</span></a>
</span><span id="HATMasks-31"><a href="#HATMasks-31"><span class="linenos"> 31</span></a><span class="sd">    - Figures of both training and test, masks and cumulative masks.</span>
</span><span id="HATMasks-32"><a href="#HATMasks-32"><span class="linenos"> 32</span></a>
</span><span id="HATMasks-33"><a href="#HATMasks-33"><span class="linenos"> 33</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="HATMasks-34"><a href="#HATMasks-34"><span class="linenos"> 34</span></a>
</span><span id="HATMasks-35"><a href="#HATMasks-35"><span class="linenos"> 35</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="HATMasks-36"><a href="#HATMasks-36"><span class="linenos"> 36</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="HATMasks-37"><a href="#HATMasks-37"><span class="linenos"> 37</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="HATMasks-38"><a href="#HATMasks-38"><span class="linenos"> 38</span></a>        <span class="n">test_masks_dir_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HATMasks-39"><a href="#HATMasks-39"><span class="linenos"> 39</span></a>        <span class="n">test_cumulative_masks_dir_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HATMasks-40"><a href="#HATMasks-40"><span class="linenos"> 40</span></a>        <span class="n">training_masks_dir_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HATMasks-41"><a href="#HATMasks-41"><span class="linenos"> 41</span></a>        <span class="n">plot_training_mask_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HATMasks-42"><a href="#HATMasks-42"><span class="linenos"> 42</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATMasks-43"><a href="#HATMasks-43"><span class="linenos"> 43</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `HATMasks`.</span>
</span><span id="HATMasks-44"><a href="#HATMasks-44"><span class="linenos"> 44</span></a>
</span><span id="HATMasks-45"><a href="#HATMasks-45"><span class="linenos"> 45</span></a><span class="sd">        **Args:**</span>
</span><span id="HATMasks-46"><a href="#HATMasks-46"><span class="linenos"> 46</span></a><span class="sd">        - **save_dir** (`str`): the directory to save the mask figures. Better inside the output folder.</span>
</span><span id="HATMasks-47"><a href="#HATMasks-47"><span class="linenos"> 47</span></a><span class="sd">        - **test_masks_dir_name** (`str` | `None`): the relative path to `save_dir` to save the test mask figures. If `None`, no file will be saved.</span>
</span><span id="HATMasks-48"><a href="#HATMasks-48"><span class="linenos"> 48</span></a><span class="sd">        - **test_cumulative_masks_dir_name** (`str` | `None`): the directory to save the test cumulative mask figures. If `None`, no file will be saved.</span>
</span><span id="HATMasks-49"><a href="#HATMasks-49"><span class="linenos"> 49</span></a><span class="sd">        - **training_masks_dir_name** (`str` | `None`): the directory to save the training mask figures. If `None`, no file will be saved.</span>
</span><span id="HATMasks-50"><a href="#HATMasks-50"><span class="linenos"> 50</span></a><span class="sd">        - **plot_training_mask_every_n_steps** (`int` | `None`): the frequency of plotting training mask figures in terms of number of batches during training. Only applies when `training_masks_dir_name` is not `None`.</span>
</span><span id="HATMasks-51"><a href="#HATMasks-51"><span class="linenos"> 51</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATMasks-52"><a href="#HATMasks-52"><span class="linenos"> 52</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="HATMasks-53"><a href="#HATMasks-53"><span class="linenos"> 53</span></a>
</span><span id="HATMasks-54"><a href="#HATMasks-54"><span class="linenos"> 54</span></a>        <span class="c1"># paths</span>
</span><span id="HATMasks-55"><a href="#HATMasks-55"><span class="linenos"> 55</span></a>        <span class="k">if</span> <span class="n">test_masks_dir_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATMasks-56"><a href="#HATMasks-56"><span class="linenos"> 56</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_masks_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">test_masks_dir_name</span><span class="p">)</span>
</span><span id="HATMasks-57"><a href="#HATMasks-57"><span class="linenos"> 57</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the directory to save the test mask figures.&quot;&quot;&quot;</span>
</span><span id="HATMasks-58"><a href="#HATMasks-58"><span class="linenos"> 58</span></a>        <span class="k">if</span> <span class="n">test_cumulative_masks_dir_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATMasks-59"><a href="#HATMasks-59"><span class="linenos"> 59</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_cumulative_masks_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="HATMasks-60"><a href="#HATMasks-60"><span class="linenos"> 60</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">test_cumulative_masks_dir_name</span>
</span><span id="HATMasks-61"><a href="#HATMasks-61"><span class="linenos"> 61</span></a>            <span class="p">)</span>
</span><span id="HATMasks-62"><a href="#HATMasks-62"><span class="linenos"> 62</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the directory to save the test cumulative mask figures.&quot;&quot;&quot;</span>
</span><span id="HATMasks-63"><a href="#HATMasks-63"><span class="linenos"> 63</span></a>        <span class="k">if</span> <span class="n">training_masks_dir_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATMasks-64"><a href="#HATMasks-64"><span class="linenos"> 64</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">training_masks_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="HATMasks-65"><a href="#HATMasks-65"><span class="linenos"> 65</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">training_masks_dir_name</span>
</span><span id="HATMasks-66"><a href="#HATMasks-66"><span class="linenos"> 66</span></a>            <span class="p">)</span>
</span><span id="HATMasks-67"><a href="#HATMasks-67"><span class="linenos"> 67</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the directory to save the training mask figures.&quot;&quot;&quot;</span>
</span><span id="HATMasks-68"><a href="#HATMasks-68"><span class="linenos"> 68</span></a>
</span><span id="HATMasks-69"><a href="#HATMasks-69"><span class="linenos"> 69</span></a>        <span class="c1"># other settings</span>
</span><span id="HATMasks-70"><a href="#HATMasks-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot_training_mask_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">plot_training_mask_every_n_steps</span>
</span><span id="HATMasks-71"><a href="#HATMasks-71"><span class="linenos"> 71</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the frequency of plotting training masks in terms of number of batches.&quot;&quot;&quot;</span>
</span><span id="HATMasks-72"><a href="#HATMasks-72"><span class="linenos"> 72</span></a>
</span><span id="HATMasks-73"><a href="#HATMasks-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="HATMasks-74"><a href="#HATMasks-74"><span class="linenos"> 74</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Task ID counter indicating which task is being processed. Self updated during the task loop. Starting from 1. &quot;&quot;&quot;</span>
</span><span id="HATMasks-75"><a href="#HATMasks-75"><span class="linenos"> 75</span></a>
</span><span id="HATMasks-76"><a href="#HATMasks-76"><span class="linenos"> 76</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_fit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATMasks-77"><a href="#HATMasks-77"><span class="linenos"> 77</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the current task ID in the beginning of a task&#39;s fitting (training and validation). Sanity check the `pl_module` to be `HAT`.</span>
</span><span id="HATMasks-78"><a href="#HATMasks-78"><span class="linenos"> 78</span></a>
</span><span id="HATMasks-79"><a href="#HATMasks-79"><span class="linenos"> 79</span></a><span class="sd">        **Raises:**</span>
</span><span id="HATMasks-80"><a href="#HATMasks-80"><span class="linenos"> 80</span></a><span class="sd">        -**TypeError**: when the `pl_module` is not `HAT`.</span>
</span><span id="HATMasks-81"><a href="#HATMasks-81"><span class="linenos"> 81</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATMasks-82"><a href="#HATMasks-82"><span class="linenos"> 82</span></a>
</span><span id="HATMasks-83"><a href="#HATMasks-83"><span class="linenos"> 83</span></a>        <span class="c1"># get the current task_id from the `CLAlgorithm` object</span>
</span><span id="HATMasks-84"><a href="#HATMasks-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">task_id</span>
</span><span id="HATMasks-85"><a href="#HATMasks-85"><span class="linenos"> 85</span></a>
</span><span id="HATMasks-86"><a href="#HATMasks-86"><span class="linenos"> 86</span></a>        <span class="c1"># sanity check</span>
</span><span id="HATMasks-87"><a href="#HATMasks-87"><span class="linenos"> 87</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pl_module</span><span class="p">,</span> <span class="n">HAT</span><span class="p">):</span>
</span><span id="HATMasks-88"><a href="#HATMasks-88"><span class="linenos"> 88</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The `CLAlgorithm` should be `HAT` to apply `HATMasks`!&quot;</span><span class="p">)</span>
</span><span id="HATMasks-89"><a href="#HATMasks-89"><span class="linenos"> 89</span></a>
</span><span id="HATMasks-90"><a href="#HATMasks-90"><span class="linenos"> 90</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="HATMasks-91"><a href="#HATMasks-91"><span class="linenos"> 91</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span>
</span><span id="HATMasks-92"><a href="#HATMasks-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="HATMasks-93"><a href="#HATMasks-93"><span class="linenos"> 93</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="HATMasks-94"><a href="#HATMasks-94"><span class="linenos"> 94</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="HATMasks-95"><a href="#HATMasks-95"><span class="linenos"> 95</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="HATMasks-96"><a href="#HATMasks-96"><span class="linenos"> 96</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="HATMasks-97"><a href="#HATMasks-97"><span class="linenos"> 97</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="HATMasks-98"><a href="#HATMasks-98"><span class="linenos"> 98</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATMasks-99"><a href="#HATMasks-99"><span class="linenos"> 99</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Plot training mask after training batch.</span>
</span><span id="HATMasks-100"><a href="#HATMasks-100"><span class="linenos">100</span></a>
</span><span id="HATMasks-101"><a href="#HATMasks-101"><span class="linenos">101</span></a><span class="sd">        **Args:**</span>
</span><span id="HATMasks-102"><a href="#HATMasks-102"><span class="linenos">102</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the training step, which is the returns of the `training_step()` method in the `CLAlgorithm`.</span>
</span><span id="HATMasks-103"><a href="#HATMasks-103"><span class="linenos">103</span></a><span class="sd">        - **batch** (`Any`): the training data batch.</span>
</span><span id="HATMasks-104"><a href="#HATMasks-104"><span class="linenos">104</span></a><span class="sd">        - **batch_idx** (`int`): the index of the current batch. This is for the file name of mask figures.</span>
</span><span id="HATMasks-105"><a href="#HATMasks-105"><span class="linenos">105</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATMasks-106"><a href="#HATMasks-106"><span class="linenos">106</span></a>
</span><span id="HATMasks-107"><a href="#HATMasks-107"><span class="linenos">107</span></a>        <span class="c1"># get the mask over the model after training the batch</span>
</span><span id="HATMasks-108"><a href="#HATMasks-108"><span class="linenos">108</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span>
</span><span id="HATMasks-109"><a href="#HATMasks-109"><span class="linenos">109</span></a>
</span><span id="HATMasks-110"><a href="#HATMasks-110"><span class="linenos">110</span></a>        <span class="c1"># plot the mask</span>
</span><span id="HATMasks-111"><a href="#HATMasks-111"><span class="linenos">111</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_masks_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATMasks-112"><a href="#HATMasks-112"><span class="linenos">112</span></a>            <span class="k">if</span> <span class="n">batch_idx</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_training_mask_every_n_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="HATMasks-113"><a href="#HATMasks-113"><span class="linenos">113</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">plot_hat_mask</span><span class="p">(</span>
</span><span id="HATMasks-114"><a href="#HATMasks-114"><span class="linenos">114</span></a>                    <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="HATMasks-115"><a href="#HATMasks-115"><span class="linenos">115</span></a>                    <span class="n">plot_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_masks_dir</span><span class="p">,</span>
</span><span id="HATMasks-116"><a href="#HATMasks-116"><span class="linenos">116</span></a>                    <span class="n">task_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
</span><span id="HATMasks-117"><a href="#HATMasks-117"><span class="linenos">117</span></a>                    <span class="n">step</span><span class="o">=</span><span class="n">batch_idx</span><span class="p">,</span>
</span><span id="HATMasks-118"><a href="#HATMasks-118"><span class="linenos">118</span></a>                <span class="p">)</span>
</span><span id="HATMasks-119"><a href="#HATMasks-119"><span class="linenos">119</span></a>
</span><span id="HATMasks-120"><a href="#HATMasks-120"><span class="linenos">120</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="HATMasks-121"><a href="#HATMasks-121"><span class="linenos">121</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATMasks-122"><a href="#HATMasks-122"><span class="linenos">122</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Plot test mask and cumulative mask figures.&quot;&quot;&quot;</span>
</span><span id="HATMasks-123"><a href="#HATMasks-123"><span class="linenos">123</span></a>
</span><span id="HATMasks-124"><a href="#HATMasks-124"><span class="linenos">124</span></a>        <span class="c1"># test mask</span>
</span><span id="HATMasks-125"><a href="#HATMasks-125"><span class="linenos">125</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
</span><span id="HATMasks-126"><a href="#HATMasks-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot_hat_mask</span><span class="p">(</span>
</span><span id="HATMasks-127"><a href="#HATMasks-127"><span class="linenos">127</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">plot_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_masks_dir</span><span class="p">,</span> <span class="n">task_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span>
</span><span id="HATMasks-128"><a href="#HATMasks-128"><span class="linenos">128</span></a>        <span class="p">)</span>
</span><span id="HATMasks-129"><a href="#HATMasks-129"><span class="linenos">129</span></a>
</span><span id="HATMasks-130"><a href="#HATMasks-130"><span class="linenos">130</span></a>        <span class="c1"># cumulative mask</span>
</span><span id="HATMasks-131"><a href="#HATMasks-131"><span class="linenos">131</span></a>        <span class="n">cumulative_mask</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">cumulative_mask_for_previous_tasks</span>
</span><span id="HATMasks-132"><a href="#HATMasks-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot_hat_mask</span><span class="p">(</span>
</span><span id="HATMasks-133"><a href="#HATMasks-133"><span class="linenos">133</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">cumulative_mask</span><span class="p">,</span>
</span><span id="HATMasks-134"><a href="#HATMasks-134"><span class="linenos">134</span></a>            <span class="n">plot_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_cumulative_masks_dir</span><span class="p">,</span>
</span><span id="HATMasks-135"><a href="#HATMasks-135"><span class="linenos">135</span></a>            <span class="n">task_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
</span><span id="HATMasks-136"><a href="#HATMasks-136"><span class="linenos">136</span></a>        <span class="p">)</span>
</span><span id="HATMasks-137"><a href="#HATMasks-137"><span class="linenos">137</span></a>
</span><span id="HATMasks-138"><a href="#HATMasks-138"><span class="linenos">138</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_hat_mask</span><span class="p">(</span>
</span><span id="HATMasks-139"><a href="#HATMasks-139"><span class="linenos">139</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="HATMasks-140"><a href="#HATMasks-140"><span class="linenos">140</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="HATMasks-141"><a href="#HATMasks-141"><span class="linenos">141</span></a>        <span class="n">plot_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="HATMasks-142"><a href="#HATMasks-142"><span class="linenos">142</span></a>        <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="HATMasks-143"><a href="#HATMasks-143"><span class="linenos">143</span></a>        <span class="n">step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HATMasks-144"><a href="#HATMasks-144"><span class="linenos">144</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATMasks-145"><a href="#HATMasks-145"><span class="linenos">145</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot mask in [HAT (Hard Attention to the Task)](http://proceedings.mlr.press/v80/serra18a)) algorithm. This includes the mask and cumulative mask.</span>
</span><span id="HATMasks-146"><a href="#HATMasks-146"><span class="linenos">146</span></a>
</span><span id="HATMasks-147"><a href="#HATMasks-147"><span class="linenos">147</span></a><span class="sd">        **Args:**</span>
</span><span id="HATMasks-148"><a href="#HATMasks-148"><span class="linenos">148</span></a><span class="sd">        - **mask** (`dict[str, Tensor]`): the hard attention (whose values are 0 or 1) mask. Key (`str`) is layer name, value (`Tensor`) is the mask tensor. The mask tensor has size (number of units, ).</span>
</span><span id="HATMasks-149"><a href="#HATMasks-149"><span class="linenos">149</span></a><span class="sd">        - **plot_dir** (`str`): the directory to save plot. Better same as the output directory of the experiment.</span>
</span><span id="HATMasks-150"><a href="#HATMasks-150"><span class="linenos">150</span></a><span class="sd">        - **task_id** (`int`): the task ID of the mask to be plotted. This is to form the plot name.</span>
</span><span id="HATMasks-151"><a href="#HATMasks-151"><span class="linenos">151</span></a><span class="sd">        - **step** (`int`): the training step (batch index) of the mask to be plotted. Apply to the training mask only. This is to form the plot name. Keep `None` for not showing the step in the plot name.</span>
</span><span id="HATMasks-152"><a href="#HATMasks-152"><span class="linenos">152</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATMasks-153"><a href="#HATMasks-153"><span class="linenos">153</span></a>
</span><span id="HATMasks-154"><a href="#HATMasks-154"><span class="linenos">154</span></a>        <span class="k">for</span> <span class="n">layer_name</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mask</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="HATMasks-155"><a href="#HATMasks-155"><span class="linenos">155</span></a>            <span class="n">layer_name</span> <span class="o">=</span> <span class="n">layer_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
</span><span id="HATMasks-156"><a href="#HATMasks-156"><span class="linenos">156</span></a>                <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span>
</span><span id="HATMasks-157"><a href="#HATMasks-157"><span class="linenos">157</span></a>            <span class="p">)</span>  <span class="c1"># the layer name contains &#39;/&#39;, which is not allowed in the file name. We replace it back with &#39;.&#39;.</span>
</span><span id="HATMasks-158"><a href="#HATMasks-158"><span class="linenos">158</span></a>
</span><span id="HATMasks-159"><a href="#HATMasks-159"><span class="linenos">159</span></a>            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
</span><span id="HATMasks-160"><a href="#HATMasks-160"><span class="linenos">160</span></a>                <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="HATMasks-161"><a href="#HATMasks-161"><span class="linenos">161</span></a>            <span class="p">)</span>  <span class="c1"># reshape the 1D mask to 2D so can be plotted by image show</span>
</span><span id="HATMasks-162"><a href="#HATMasks-162"><span class="linenos">162</span></a>
</span><span id="HATMasks-163"><a href="#HATMasks-163"><span class="linenos">163</span></a>            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span id="HATMasks-164"><a href="#HATMasks-164"><span class="linenos">164</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
</span><span id="HATMasks-165"><a href="#HATMasks-165"><span class="linenos">165</span></a>                <span class="n">m</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span>
</span><span id="HATMasks-166"><a href="#HATMasks-166"><span class="linenos">166</span></a>            <span class="p">)</span>  <span class="c1"># can only convert to tensors in CPU to numpy arrays</span>
</span><span id="HATMasks-167"><a href="#HATMasks-167"><span class="linenos">167</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">()</span>  <span class="c1"># hide yticks</span>
</span><span id="HATMasks-168"><a href="#HATMasks-168"><span class="linenos">168</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</span><span id="HATMasks-169"><a href="#HATMasks-169"><span class="linenos">169</span></a>            <span class="k">if</span> <span class="n">step</span><span class="p">:</span>
</span><span id="HATMasks-170"><a href="#HATMasks-170"><span class="linenos">170</span></a>                <span class="n">plot_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">_task</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">_step</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">.png&quot;</span>
</span><span id="HATMasks-171"><a href="#HATMasks-171"><span class="linenos">171</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="HATMasks-172"><a href="#HATMasks-172"><span class="linenos">172</span></a>                <span class="n">plot_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">_task</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">.png&quot;</span>
</span><span id="HATMasks-173"><a href="#HATMasks-173"><span class="linenos">173</span></a>            <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plot_dir</span><span class="p">,</span> <span class="n">plot_name</span><span class="p">)</span>
</span><span id="HATMasks-174"><a href="#HATMasks-174"><span class="linenos">174</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="HATMasks-175"><a href="#HATMasks-175"><span class="linenos">175</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span><span id="HATMasks-176"><a href="#HATMasks-176"><span class="linenos">176</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span><span id="HATMasks-177"><a href="#HATMasks-177"><span class="linenos">177</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Provides all actions that are related to masks of <a href="http://proceedings.mlr.press/v80/serra18a">HAT (Hard Attention to the Task)</a> algorithm and its extensions, which include:</p>

<ul>
<li>Visualizing mask and cumulative mask figures during training and testing as figures.</li>
</ul>

<p>The callback is able to produce the following outputs:</p>

<ul>
<li>Figures of both training and test, masks and cumulative masks.</li>
</ul>
</div>


                            <div id="HATMasks.__init__" class="classattr">
                                        <input id="HATMasks.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">HATMasks</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">test_masks_dir_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">test_cumulative_masks_dir_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">training_masks_dir_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">plot_training_mask_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="HATMasks.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HATMasks.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HATMasks.__init__-35"><a href="#HATMasks.__init__-35"><span class="linenos">35</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="HATMasks.__init__-36"><a href="#HATMasks.__init__-36"><span class="linenos">36</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="HATMasks.__init__-37"><a href="#HATMasks.__init__-37"><span class="linenos">37</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="HATMasks.__init__-38"><a href="#HATMasks.__init__-38"><span class="linenos">38</span></a>        <span class="n">test_masks_dir_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HATMasks.__init__-39"><a href="#HATMasks.__init__-39"><span class="linenos">39</span></a>        <span class="n">test_cumulative_masks_dir_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HATMasks.__init__-40"><a href="#HATMasks.__init__-40"><span class="linenos">40</span></a>        <span class="n">training_masks_dir_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HATMasks.__init__-41"><a href="#HATMasks.__init__-41"><span class="linenos">41</span></a>        <span class="n">plot_training_mask_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HATMasks.__init__-42"><a href="#HATMasks.__init__-42"><span class="linenos">42</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATMasks.__init__-43"><a href="#HATMasks.__init__-43"><span class="linenos">43</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `HATMasks`.</span>
</span><span id="HATMasks.__init__-44"><a href="#HATMasks.__init__-44"><span class="linenos">44</span></a>
</span><span id="HATMasks.__init__-45"><a href="#HATMasks.__init__-45"><span class="linenos">45</span></a><span class="sd">        **Args:**</span>
</span><span id="HATMasks.__init__-46"><a href="#HATMasks.__init__-46"><span class="linenos">46</span></a><span class="sd">        - **save_dir** (`str`): the directory to save the mask figures. Better inside the output folder.</span>
</span><span id="HATMasks.__init__-47"><a href="#HATMasks.__init__-47"><span class="linenos">47</span></a><span class="sd">        - **test_masks_dir_name** (`str` | `None`): the relative path to `save_dir` to save the test mask figures. If `None`, no file will be saved.</span>
</span><span id="HATMasks.__init__-48"><a href="#HATMasks.__init__-48"><span class="linenos">48</span></a><span class="sd">        - **test_cumulative_masks_dir_name** (`str` | `None`): the directory to save the test cumulative mask figures. If `None`, no file will be saved.</span>
</span><span id="HATMasks.__init__-49"><a href="#HATMasks.__init__-49"><span class="linenos">49</span></a><span class="sd">        - **training_masks_dir_name** (`str` | `None`): the directory to save the training mask figures. If `None`, no file will be saved.</span>
</span><span id="HATMasks.__init__-50"><a href="#HATMasks.__init__-50"><span class="linenos">50</span></a><span class="sd">        - **plot_training_mask_every_n_steps** (`int` | `None`): the frequency of plotting training mask figures in terms of number of batches during training. Only applies when `training_masks_dir_name` is not `None`.</span>
</span><span id="HATMasks.__init__-51"><a href="#HATMasks.__init__-51"><span class="linenos">51</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATMasks.__init__-52"><a href="#HATMasks.__init__-52"><span class="linenos">52</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="HATMasks.__init__-53"><a href="#HATMasks.__init__-53"><span class="linenos">53</span></a>
</span><span id="HATMasks.__init__-54"><a href="#HATMasks.__init__-54"><span class="linenos">54</span></a>        <span class="c1"># paths</span>
</span><span id="HATMasks.__init__-55"><a href="#HATMasks.__init__-55"><span class="linenos">55</span></a>        <span class="k">if</span> <span class="n">test_masks_dir_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATMasks.__init__-56"><a href="#HATMasks.__init__-56"><span class="linenos">56</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_masks_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">test_masks_dir_name</span><span class="p">)</span>
</span><span id="HATMasks.__init__-57"><a href="#HATMasks.__init__-57"><span class="linenos">57</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the directory to save the test mask figures.&quot;&quot;&quot;</span>
</span><span id="HATMasks.__init__-58"><a href="#HATMasks.__init__-58"><span class="linenos">58</span></a>        <span class="k">if</span> <span class="n">test_cumulative_masks_dir_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATMasks.__init__-59"><a href="#HATMasks.__init__-59"><span class="linenos">59</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_cumulative_masks_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="HATMasks.__init__-60"><a href="#HATMasks.__init__-60"><span class="linenos">60</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">test_cumulative_masks_dir_name</span>
</span><span id="HATMasks.__init__-61"><a href="#HATMasks.__init__-61"><span class="linenos">61</span></a>            <span class="p">)</span>
</span><span id="HATMasks.__init__-62"><a href="#HATMasks.__init__-62"><span class="linenos">62</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the directory to save the test cumulative mask figures.&quot;&quot;&quot;</span>
</span><span id="HATMasks.__init__-63"><a href="#HATMasks.__init__-63"><span class="linenos">63</span></a>        <span class="k">if</span> <span class="n">training_masks_dir_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATMasks.__init__-64"><a href="#HATMasks.__init__-64"><span class="linenos">64</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">training_masks_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="HATMasks.__init__-65"><a href="#HATMasks.__init__-65"><span class="linenos">65</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">training_masks_dir_name</span>
</span><span id="HATMasks.__init__-66"><a href="#HATMasks.__init__-66"><span class="linenos">66</span></a>            <span class="p">)</span>
</span><span id="HATMasks.__init__-67"><a href="#HATMasks.__init__-67"><span class="linenos">67</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the directory to save the training mask figures.&quot;&quot;&quot;</span>
</span><span id="HATMasks.__init__-68"><a href="#HATMasks.__init__-68"><span class="linenos">68</span></a>
</span><span id="HATMasks.__init__-69"><a href="#HATMasks.__init__-69"><span class="linenos">69</span></a>        <span class="c1"># other settings</span>
</span><span id="HATMasks.__init__-70"><a href="#HATMasks.__init__-70"><span class="linenos">70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot_training_mask_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">plot_training_mask_every_n_steps</span>
</span><span id="HATMasks.__init__-71"><a href="#HATMasks.__init__-71"><span class="linenos">71</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the frequency of plotting training masks in terms of number of batches.&quot;&quot;&quot;</span>
</span><span id="HATMasks.__init__-72"><a href="#HATMasks.__init__-72"><span class="linenos">72</span></a>
</span><span id="HATMasks.__init__-73"><a href="#HATMasks.__init__-73"><span class="linenos">73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="HATMasks.__init__-74"><a href="#HATMasks.__init__-74"><span class="linenos">74</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Task ID counter indicating which task is being processed. Self updated during the task loop. Starting from 1. &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the <code><a href="#HATMasks">HATMasks</a></code>.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>save_dir</strong> (<code>str</code>): the directory to save the mask figures. Better inside the output folder.</li>
<li><strong>test_masks_dir_name</strong> (<code>str</code> | <code>None</code>): the relative path to <code><a href="#HATMasks.save_dir">save_dir</a></code> to save the test mask figures. If <code>None</code>, no file will be saved.</li>
<li><strong>test_cumulative_masks_dir_name</strong> (<code>str</code> | <code>None</code>): the directory to save the test cumulative mask figures. If <code>None</code>, no file will be saved.</li>
<li><strong>training_masks_dir_name</strong> (<code>str</code> | <code>None</code>): the directory to save the training mask figures. If <code>None</code>, no file will be saved.</li>
<li><strong>plot_training_mask_every_n_steps</strong> (<code>int</code> | <code>None</code>): the frequency of plotting training mask figures in terms of number of batches during training. Only applies when <code>training_masks_dir_name</code> is not <code>None</code>.</li>
</ul>
</div>


                            </div>
                            <div id="HATMasks.plot_training_mask_every_n_steps" class="classattr">
                                <div class="attr variable">
            <span class="name">plot_training_mask_every_n_steps</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#HATMasks.plot_training_mask_every_n_steps"></a>
    
            <div class="docstring"><p>Store the frequency of plotting training masks in terms of number of batches.</p>
</div>


                            </div>
                            <div id="HATMasks.task_id" class="classattr">
                                <div class="attr variable">
            <span class="name">task_id</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#HATMasks.task_id"></a>
    
            <div class="docstring"><p>Task ID counter indicating which task is being processed. Self updated during the task loop. Starting from 1.</p>
</div>


                            </div>
                            <div id="HATMasks.on_fit_start" class="classattr">
                                        <input id="HATMasks.on_fit_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_fit_start</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="HATMasks.on_fit_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HATMasks.on_fit_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HATMasks.on_fit_start-76"><a href="#HATMasks.on_fit_start-76"><span class="linenos">76</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_fit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATMasks.on_fit_start-77"><a href="#HATMasks.on_fit_start-77"><span class="linenos">77</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the current task ID in the beginning of a task&#39;s fitting (training and validation). Sanity check the `pl_module` to be `HAT`.</span>
</span><span id="HATMasks.on_fit_start-78"><a href="#HATMasks.on_fit_start-78"><span class="linenos">78</span></a>
</span><span id="HATMasks.on_fit_start-79"><a href="#HATMasks.on_fit_start-79"><span class="linenos">79</span></a><span class="sd">        **Raises:**</span>
</span><span id="HATMasks.on_fit_start-80"><a href="#HATMasks.on_fit_start-80"><span class="linenos">80</span></a><span class="sd">        -**TypeError**: when the `pl_module` is not `HAT`.</span>
</span><span id="HATMasks.on_fit_start-81"><a href="#HATMasks.on_fit_start-81"><span class="linenos">81</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATMasks.on_fit_start-82"><a href="#HATMasks.on_fit_start-82"><span class="linenos">82</span></a>
</span><span id="HATMasks.on_fit_start-83"><a href="#HATMasks.on_fit_start-83"><span class="linenos">83</span></a>        <span class="c1"># get the current task_id from the `CLAlgorithm` object</span>
</span><span id="HATMasks.on_fit_start-84"><a href="#HATMasks.on_fit_start-84"><span class="linenos">84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">task_id</span>
</span><span id="HATMasks.on_fit_start-85"><a href="#HATMasks.on_fit_start-85"><span class="linenos">85</span></a>
</span><span id="HATMasks.on_fit_start-86"><a href="#HATMasks.on_fit_start-86"><span class="linenos">86</span></a>        <span class="c1"># sanity check</span>
</span><span id="HATMasks.on_fit_start-87"><a href="#HATMasks.on_fit_start-87"><span class="linenos">87</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pl_module</span><span class="p">,</span> <span class="n">HAT</span><span class="p">):</span>
</span><span id="HATMasks.on_fit_start-88"><a href="#HATMasks.on_fit_start-88"><span class="linenos">88</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The `CLAlgorithm` should be `HAT` to apply `HATMasks`!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get the current task ID in the beginning of a task's fitting (training and validation). Sanity check the <code>pl_module</code> to be <code>HAT</code>.</p>

<p><strong>Raises:</strong>
-<strong>TypeError</strong>: when the <code>pl_module</code> is not <code>HAT</code>.</p>
</div>


                            </div>
                            <div id="HATMasks.on_train_batch_end" class="classattr">
                                        <input id="HATMasks.on_train_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_train_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="HATMasks.on_train_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HATMasks.on_train_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HATMasks.on_train_batch_end-90"><a href="#HATMasks.on_train_batch_end-90"><span class="linenos"> 90</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="HATMasks.on_train_batch_end-91"><a href="#HATMasks.on_train_batch_end-91"><span class="linenos"> 91</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span>
</span><span id="HATMasks.on_train_batch_end-92"><a href="#HATMasks.on_train_batch_end-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="HATMasks.on_train_batch_end-93"><a href="#HATMasks.on_train_batch_end-93"><span class="linenos"> 93</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="HATMasks.on_train_batch_end-94"><a href="#HATMasks.on_train_batch_end-94"><span class="linenos"> 94</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">,</span>
</span><span id="HATMasks.on_train_batch_end-95"><a href="#HATMasks.on_train_batch_end-95"><span class="linenos"> 95</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="HATMasks.on_train_batch_end-96"><a href="#HATMasks.on_train_batch_end-96"><span class="linenos"> 96</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="HATMasks.on_train_batch_end-97"><a href="#HATMasks.on_train_batch_end-97"><span class="linenos"> 97</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="HATMasks.on_train_batch_end-98"><a href="#HATMasks.on_train_batch_end-98"><span class="linenos"> 98</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATMasks.on_train_batch_end-99"><a href="#HATMasks.on_train_batch_end-99"><span class="linenos"> 99</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Plot training mask after training batch.</span>
</span><span id="HATMasks.on_train_batch_end-100"><a href="#HATMasks.on_train_batch_end-100"><span class="linenos">100</span></a>
</span><span id="HATMasks.on_train_batch_end-101"><a href="#HATMasks.on_train_batch_end-101"><span class="linenos">101</span></a><span class="sd">        **Args:**</span>
</span><span id="HATMasks.on_train_batch_end-102"><a href="#HATMasks.on_train_batch_end-102"><span class="linenos">102</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the training step, which is the returns of the `training_step()` method in the `CLAlgorithm`.</span>
</span><span id="HATMasks.on_train_batch_end-103"><a href="#HATMasks.on_train_batch_end-103"><span class="linenos">103</span></a><span class="sd">        - **batch** (`Any`): the training data batch.</span>
</span><span id="HATMasks.on_train_batch_end-104"><a href="#HATMasks.on_train_batch_end-104"><span class="linenos">104</span></a><span class="sd">        - **batch_idx** (`int`): the index of the current batch. This is for the file name of mask figures.</span>
</span><span id="HATMasks.on_train_batch_end-105"><a href="#HATMasks.on_train_batch_end-105"><span class="linenos">105</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATMasks.on_train_batch_end-106"><a href="#HATMasks.on_train_batch_end-106"><span class="linenos">106</span></a>
</span><span id="HATMasks.on_train_batch_end-107"><a href="#HATMasks.on_train_batch_end-107"><span class="linenos">107</span></a>        <span class="c1"># get the mask over the model after training the batch</span>
</span><span id="HATMasks.on_train_batch_end-108"><a href="#HATMasks.on_train_batch_end-108"><span class="linenos">108</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span>
</span><span id="HATMasks.on_train_batch_end-109"><a href="#HATMasks.on_train_batch_end-109"><span class="linenos">109</span></a>
</span><span id="HATMasks.on_train_batch_end-110"><a href="#HATMasks.on_train_batch_end-110"><span class="linenos">110</span></a>        <span class="c1"># plot the mask</span>
</span><span id="HATMasks.on_train_batch_end-111"><a href="#HATMasks.on_train_batch_end-111"><span class="linenos">111</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_masks_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATMasks.on_train_batch_end-112"><a href="#HATMasks.on_train_batch_end-112"><span class="linenos">112</span></a>            <span class="k">if</span> <span class="n">batch_idx</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_training_mask_every_n_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="HATMasks.on_train_batch_end-113"><a href="#HATMasks.on_train_batch_end-113"><span class="linenos">113</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">plot_hat_mask</span><span class="p">(</span>
</span><span id="HATMasks.on_train_batch_end-114"><a href="#HATMasks.on_train_batch_end-114"><span class="linenos">114</span></a>                    <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="HATMasks.on_train_batch_end-115"><a href="#HATMasks.on_train_batch_end-115"><span class="linenos">115</span></a>                    <span class="n">plot_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_masks_dir</span><span class="p">,</span>
</span><span id="HATMasks.on_train_batch_end-116"><a href="#HATMasks.on_train_batch_end-116"><span class="linenos">116</span></a>                    <span class="n">task_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
</span><span id="HATMasks.on_train_batch_end-117"><a href="#HATMasks.on_train_batch_end-117"><span class="linenos">117</span></a>                    <span class="n">step</span><span class="o">=</span><span class="n">batch_idx</span><span class="p">,</span>
</span><span id="HATMasks.on_train_batch_end-118"><a href="#HATMasks.on_train_batch_end-118"><span class="linenos">118</span></a>                <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plot training mask after training batch.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the training step, which is the returns of the <code>training_step()</code> method in the <code>CLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the training data batch.</li>
<li><strong>batch_idx</strong> (<code>int</code>): the index of the current batch. This is for the file name of mask figures.</li>
</ul>
</div>


                            </div>
                            <div id="HATMasks.on_test_start" class="classattr">
                                        <input id="HATMasks.on_test_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-rank_zero_only">@rank_zero_only</div>

        <span class="def">def</span>
        <span class="name">on_test_start</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="cl_algorithms.html#CLAlgorithm">clarena.cl_algorithms.CLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="HATMasks.on_test_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HATMasks.on_test_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HATMasks.on_test_start-120"><a href="#HATMasks.on_test_start-120"><span class="linenos">120</span></a>    <span class="nd">@rank_zero_only</span>
</span><span id="HATMasks.on_test_start-121"><a href="#HATMasks.on_test_start-121"><span class="linenos">121</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">CLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATMasks.on_test_start-122"><a href="#HATMasks.on_test_start-122"><span class="linenos">122</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Plot test mask and cumulative mask figures.&quot;&quot;&quot;</span>
</span><span id="HATMasks.on_test_start-123"><a href="#HATMasks.on_test_start-123"><span class="linenos">123</span></a>
</span><span id="HATMasks.on_test_start-124"><a href="#HATMasks.on_test_start-124"><span class="linenos">124</span></a>        <span class="c1"># test mask</span>
</span><span id="HATMasks.on_test_start-125"><a href="#HATMasks.on_test_start-125"><span class="linenos">125</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
</span><span id="HATMasks.on_test_start-126"><a href="#HATMasks.on_test_start-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot_hat_mask</span><span class="p">(</span>
</span><span id="HATMasks.on_test_start-127"><a href="#HATMasks.on_test_start-127"><span class="linenos">127</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">plot_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_masks_dir</span><span class="p">,</span> <span class="n">task_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span>
</span><span id="HATMasks.on_test_start-128"><a href="#HATMasks.on_test_start-128"><span class="linenos">128</span></a>        <span class="p">)</span>
</span><span id="HATMasks.on_test_start-129"><a href="#HATMasks.on_test_start-129"><span class="linenos">129</span></a>
</span><span id="HATMasks.on_test_start-130"><a href="#HATMasks.on_test_start-130"><span class="linenos">130</span></a>        <span class="c1"># cumulative mask</span>
</span><span id="HATMasks.on_test_start-131"><a href="#HATMasks.on_test_start-131"><span class="linenos">131</span></a>        <span class="n">cumulative_mask</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">cumulative_mask_for_previous_tasks</span>
</span><span id="HATMasks.on_test_start-132"><a href="#HATMasks.on_test_start-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot_hat_mask</span><span class="p">(</span>
</span><span id="HATMasks.on_test_start-133"><a href="#HATMasks.on_test_start-133"><span class="linenos">133</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">cumulative_mask</span><span class="p">,</span>
</span><span id="HATMasks.on_test_start-134"><a href="#HATMasks.on_test_start-134"><span class="linenos">134</span></a>            <span class="n">plot_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_cumulative_masks_dir</span><span class="p">,</span>
</span><span id="HATMasks.on_test_start-135"><a href="#HATMasks.on_test_start-135"><span class="linenos">135</span></a>            <span class="n">task_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
</span><span id="HATMasks.on_test_start-136"><a href="#HATMasks.on_test_start-136"><span class="linenos">136</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plot test mask and cumulative mask figures.</p>
</div>


                            </div>
                            <div id="HATMasks.plot_hat_mask" class="classattr">
                                        <input id="HATMasks.plot_hat_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_hat_mask</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">plot_dir</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="HATMasks.plot_hat_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HATMasks.plot_hat_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HATMasks.plot_hat_mask-138"><a href="#HATMasks.plot_hat_mask-138"><span class="linenos">138</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_hat_mask</span><span class="p">(</span>
</span><span id="HATMasks.plot_hat_mask-139"><a href="#HATMasks.plot_hat_mask-139"><span class="linenos">139</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="HATMasks.plot_hat_mask-140"><a href="#HATMasks.plot_hat_mask-140"><span class="linenos">140</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="HATMasks.plot_hat_mask-141"><a href="#HATMasks.plot_hat_mask-141"><span class="linenos">141</span></a>        <span class="n">plot_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="HATMasks.plot_hat_mask-142"><a href="#HATMasks.plot_hat_mask-142"><span class="linenos">142</span></a>        <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="HATMasks.plot_hat_mask-143"><a href="#HATMasks.plot_hat_mask-143"><span class="linenos">143</span></a>        <span class="n">step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="HATMasks.plot_hat_mask-144"><a href="#HATMasks.plot_hat_mask-144"><span class="linenos">144</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="HATMasks.plot_hat_mask-145"><a href="#HATMasks.plot_hat_mask-145"><span class="linenos">145</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot mask in [HAT (Hard Attention to the Task)](http://proceedings.mlr.press/v80/serra18a)) algorithm. This includes the mask and cumulative mask.</span>
</span><span id="HATMasks.plot_hat_mask-146"><a href="#HATMasks.plot_hat_mask-146"><span class="linenos">146</span></a>
</span><span id="HATMasks.plot_hat_mask-147"><a href="#HATMasks.plot_hat_mask-147"><span class="linenos">147</span></a><span class="sd">        **Args:**</span>
</span><span id="HATMasks.plot_hat_mask-148"><a href="#HATMasks.plot_hat_mask-148"><span class="linenos">148</span></a><span class="sd">        - **mask** (`dict[str, Tensor]`): the hard attention (whose values are 0 or 1) mask. Key (`str`) is layer name, value (`Tensor`) is the mask tensor. The mask tensor has size (number of units, ).</span>
</span><span id="HATMasks.plot_hat_mask-149"><a href="#HATMasks.plot_hat_mask-149"><span class="linenos">149</span></a><span class="sd">        - **plot_dir** (`str`): the directory to save plot. Better same as the output directory of the experiment.</span>
</span><span id="HATMasks.plot_hat_mask-150"><a href="#HATMasks.plot_hat_mask-150"><span class="linenos">150</span></a><span class="sd">        - **task_id** (`int`): the task ID of the mask to be plotted. This is to form the plot name.</span>
</span><span id="HATMasks.plot_hat_mask-151"><a href="#HATMasks.plot_hat_mask-151"><span class="linenos">151</span></a><span class="sd">        - **step** (`int`): the training step (batch index) of the mask to be plotted. Apply to the training mask only. This is to form the plot name. Keep `None` for not showing the step in the plot name.</span>
</span><span id="HATMasks.plot_hat_mask-152"><a href="#HATMasks.plot_hat_mask-152"><span class="linenos">152</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="HATMasks.plot_hat_mask-153"><a href="#HATMasks.plot_hat_mask-153"><span class="linenos">153</span></a>
</span><span id="HATMasks.plot_hat_mask-154"><a href="#HATMasks.plot_hat_mask-154"><span class="linenos">154</span></a>        <span class="k">for</span> <span class="n">layer_name</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mask</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="HATMasks.plot_hat_mask-155"><a href="#HATMasks.plot_hat_mask-155"><span class="linenos">155</span></a>            <span class="n">layer_name</span> <span class="o">=</span> <span class="n">layer_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
</span><span id="HATMasks.plot_hat_mask-156"><a href="#HATMasks.plot_hat_mask-156"><span class="linenos">156</span></a>                <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span>
</span><span id="HATMasks.plot_hat_mask-157"><a href="#HATMasks.plot_hat_mask-157"><span class="linenos">157</span></a>            <span class="p">)</span>  <span class="c1"># the layer name contains &#39;/&#39;, which is not allowed in the file name. We replace it back with &#39;.&#39;.</span>
</span><span id="HATMasks.plot_hat_mask-158"><a href="#HATMasks.plot_hat_mask-158"><span class="linenos">158</span></a>
</span><span id="HATMasks.plot_hat_mask-159"><a href="#HATMasks.plot_hat_mask-159"><span class="linenos">159</span></a>            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
</span><span id="HATMasks.plot_hat_mask-160"><a href="#HATMasks.plot_hat_mask-160"><span class="linenos">160</span></a>                <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="HATMasks.plot_hat_mask-161"><a href="#HATMasks.plot_hat_mask-161"><span class="linenos">161</span></a>            <span class="p">)</span>  <span class="c1"># reshape the 1D mask to 2D so can be plotted by image show</span>
</span><span id="HATMasks.plot_hat_mask-162"><a href="#HATMasks.plot_hat_mask-162"><span class="linenos">162</span></a>
</span><span id="HATMasks.plot_hat_mask-163"><a href="#HATMasks.plot_hat_mask-163"><span class="linenos">163</span></a>            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span id="HATMasks.plot_hat_mask-164"><a href="#HATMasks.plot_hat_mask-164"><span class="linenos">164</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
</span><span id="HATMasks.plot_hat_mask-165"><a href="#HATMasks.plot_hat_mask-165"><span class="linenos">165</span></a>                <span class="n">m</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span>
</span><span id="HATMasks.plot_hat_mask-166"><a href="#HATMasks.plot_hat_mask-166"><span class="linenos">166</span></a>            <span class="p">)</span>  <span class="c1"># can only convert to tensors in CPU to numpy arrays</span>
</span><span id="HATMasks.plot_hat_mask-167"><a href="#HATMasks.plot_hat_mask-167"><span class="linenos">167</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">()</span>  <span class="c1"># hide yticks</span>
</span><span id="HATMasks.plot_hat_mask-168"><a href="#HATMasks.plot_hat_mask-168"><span class="linenos">168</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</span><span id="HATMasks.plot_hat_mask-169"><a href="#HATMasks.plot_hat_mask-169"><span class="linenos">169</span></a>            <span class="k">if</span> <span class="n">step</span><span class="p">:</span>
</span><span id="HATMasks.plot_hat_mask-170"><a href="#HATMasks.plot_hat_mask-170"><span class="linenos">170</span></a>                <span class="n">plot_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">_task</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">_step</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">.png&quot;</span>
</span><span id="HATMasks.plot_hat_mask-171"><a href="#HATMasks.plot_hat_mask-171"><span class="linenos">171</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="HATMasks.plot_hat_mask-172"><a href="#HATMasks.plot_hat_mask-172"><span class="linenos">172</span></a>                <span class="n">plot_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">_task</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">.png&quot;</span>
</span><span id="HATMasks.plot_hat_mask-173"><a href="#HATMasks.plot_hat_mask-173"><span class="linenos">173</span></a>            <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plot_dir</span><span class="p">,</span> <span class="n">plot_name</span><span class="p">)</span>
</span><span id="HATMasks.plot_hat_mask-174"><a href="#HATMasks.plot_hat_mask-174"><span class="linenos">174</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="HATMasks.plot_hat_mask-175"><a href="#HATMasks.plot_hat_mask-175"><span class="linenos">175</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span><span id="HATMasks.plot_hat_mask-176"><a href="#HATMasks.plot_hat_mask-176"><span class="linenos">176</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span><span id="HATMasks.plot_hat_mask-177"><a href="#HATMasks.plot_hat_mask-177"><span class="linenos">177</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plot mask in <a href="http://proceedings.mlr.press/v80/serra18a">HAT (Hard Attention to the Task)</a>) algorithm. This includes the mask and cumulative mask.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>mask</strong> (<code>dict[str, Tensor]</code>): the hard attention (whose values are 0 or 1) mask. Key (<code>str</code>) is layer name, value (<code>Tensor</code>) is the mask tensor. The mask tensor has size (number of units, ).</li>
<li><strong>plot_dir</strong> (<code>str</code>): the directory to save plot. Better same as the output directory of the experiment.</li>
<li><strong>task_id</strong> (<code>int</code>): the task ID of the mask to be plotted. This is to form the plot name.</li>
<li><strong>step</strong> (<code>int</code>): the training step (batch index) of the mask to be plotted. Apply to the training mask only. This is to form the plot name. Keep <code>None</code> for not showing the step in the plot name.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="MTLAccuracy">
                            <input id="MTLAccuracy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MTLAccuracy</span><wbr>(<span class="base"><a href="#MetricCallback">clarena.metrics.MetricCallback</a></span>):

                <label class="view-source-button" for="MTLAccuracy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLAccuracy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLAccuracy-26"><a href="#MTLAccuracy-26"><span class="linenos"> 26</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MTLAccuracy</span><span class="p">(</span><span class="n">MetricCallback</span><span class="p">):</span>
</span><span id="MTLAccuracy-27"><a href="#MTLAccuracy-27"><span class="linenos"> 27</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Provides all actions that are related to MTL accuracy metrics, which include:</span>
</span><span id="MTLAccuracy-28"><a href="#MTLAccuracy-28"><span class="linenos"> 28</span></a>
</span><span id="MTLAccuracy-29"><a href="#MTLAccuracy-29"><span class="linenos"> 29</span></a><span class="sd">    - Defining, initializing and recording accuracy metric.</span>
</span><span id="MTLAccuracy-30"><a href="#MTLAccuracy-30"><span class="linenos"> 30</span></a><span class="sd">    - Logging training and validation accuracy metric to Lightning loggers in real time.</span>
</span><span id="MTLAccuracy-31"><a href="#MTLAccuracy-31"><span class="linenos"> 31</span></a><span class="sd">    - Saving test accuracy metric to files.</span>
</span><span id="MTLAccuracy-32"><a href="#MTLAccuracy-32"><span class="linenos"> 32</span></a><span class="sd">    - Visualizing test accuracy metric as plots.</span>
</span><span id="MTLAccuracy-33"><a href="#MTLAccuracy-33"><span class="linenos"> 33</span></a>
</span><span id="MTLAccuracy-34"><a href="#MTLAccuracy-34"><span class="linenos"> 34</span></a><span class="sd">    The callback is able to produce the following outputs:</span>
</span><span id="MTLAccuracy-35"><a href="#MTLAccuracy-35"><span class="linenos"> 35</span></a>
</span><span id="MTLAccuracy-36"><a href="#MTLAccuracy-36"><span class="linenos"> 36</span></a><span class="sd">    - CSV files for test accuracy of all tasks and average accuracy.</span>
</span><span id="MTLAccuracy-37"><a href="#MTLAccuracy-37"><span class="linenos"> 37</span></a><span class="sd">    - Bar charts for test accuracy of all tasks.</span>
</span><span id="MTLAccuracy-38"><a href="#MTLAccuracy-38"><span class="linenos"> 38</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="MTLAccuracy-39"><a href="#MTLAccuracy-39"><span class="linenos"> 39</span></a>
</span><span id="MTLAccuracy-40"><a href="#MTLAccuracy-40"><span class="linenos"> 40</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="MTLAccuracy-41"><a href="#MTLAccuracy-41"><span class="linenos"> 41</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLAccuracy-42"><a href="#MTLAccuracy-42"><span class="linenos"> 42</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MTLAccuracy-43"><a href="#MTLAccuracy-43"><span class="linenos"> 43</span></a>        <span class="n">test_acc_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;acc.csv&quot;</span><span class="p">,</span>
</span><span id="MTLAccuracy-44"><a href="#MTLAccuracy-44"><span class="linenos"> 44</span></a>        <span class="n">test_acc_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MTLAccuracy-45"><a href="#MTLAccuracy-45"><span class="linenos"> 45</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy-46"><a href="#MTLAccuracy-46"><span class="linenos"> 46</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `MTLAccuracy`.</span>
</span><span id="MTLAccuracy-47"><a href="#MTLAccuracy-47"><span class="linenos"> 47</span></a>
</span><span id="MTLAccuracy-48"><a href="#MTLAccuracy-48"><span class="linenos"> 48</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLAccuracy-49"><a href="#MTLAccuracy-49"><span class="linenos"> 49</span></a><span class="sd">        - **save_dir** (`str`): The directory where data and figures of metrics will be saved. Better inside the output folder.</span>
</span><span id="MTLAccuracy-50"><a href="#MTLAccuracy-50"><span class="linenos"> 50</span></a><span class="sd">        - **test_acc_csv_name** (`str`): file name to save test accuracy of all tasks and average accuracy as CSV file.</span>
</span><span id="MTLAccuracy-51"><a href="#MTLAccuracy-51"><span class="linenos"> 51</span></a><span class="sd">        - **test_acc_plot_name** (`str` | `None`): file name to save accuracy plot. If `None`, no file will be saved.</span>
</span><span id="MTLAccuracy-52"><a href="#MTLAccuracy-52"><span class="linenos"> 52</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLAccuracy-53"><a href="#MTLAccuracy-53"><span class="linenos"> 53</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="MTLAccuracy-54"><a href="#MTLAccuracy-54"><span class="linenos"> 54</span></a>
</span><span id="MTLAccuracy-55"><a href="#MTLAccuracy-55"><span class="linenos"> 55</span></a>        <span class="c1"># paths</span>
</span><span id="MTLAccuracy-56"><a href="#MTLAccuracy-56"><span class="linenos"> 56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_acc_csv_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">test_acc_csv_name</span><span class="p">)</span>
</span><span id="MTLAccuracy-57"><a href="#MTLAccuracy-57"><span class="linenos"> 57</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The path to save test accuracy of all tasks and average accuracy CSV file.&quot;&quot;&quot;</span>
</span><span id="MTLAccuracy-58"><a href="#MTLAccuracy-58"><span class="linenos"> 58</span></a>        <span class="k">if</span> <span class="n">test_acc_plot_name</span><span class="p">:</span>
</span><span id="MTLAccuracy-59"><a href="#MTLAccuracy-59"><span class="linenos"> 59</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_acc_plot_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">test_acc_plot_name</span><span class="p">)</span>
</span><span id="MTLAccuracy-60"><a href="#MTLAccuracy-60"><span class="linenos"> 60</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The path to save test accuracy plot.&quot;&quot;&quot;</span>
</span><span id="MTLAccuracy-61"><a href="#MTLAccuracy-61"><span class="linenos"> 61</span></a>
</span><span id="MTLAccuracy-62"><a href="#MTLAccuracy-62"><span class="linenos"> 62</span></a>        <span class="c1"># training accumulated metrics</span>
</span><span id="MTLAccuracy-63"><a href="#MTLAccuracy-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="MTLAccuracy-64"><a href="#MTLAccuracy-64"><span class="linenos"> 64</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Classification accuracy of training epoch. Accumulated and calculated from the training batches. &quot;&quot;&quot;</span>
</span><span id="MTLAccuracy-65"><a href="#MTLAccuracy-65"><span class="linenos"> 65</span></a>
</span><span id="MTLAccuracy-66"><a href="#MTLAccuracy-66"><span class="linenos"> 66</span></a>        <span class="c1"># validation accumulated metrics</span>
</span><span id="MTLAccuracy-67"><a href="#MTLAccuracy-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MTLAccuracy-68"><a href="#MTLAccuracy-68"><span class="linenos"> 68</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Validation classification accuracy of the model after training epoch. Accumulated and calculated from the validation batches. Keys are task IDs and values are the corresponding metrics.&quot;&quot;&quot;</span>
</span><span id="MTLAccuracy-69"><a href="#MTLAccuracy-69"><span class="linenos"> 69</span></a>
</span><span id="MTLAccuracy-70"><a href="#MTLAccuracy-70"><span class="linenos"> 70</span></a>        <span class="c1"># test accumulated metrics</span>
</span><span id="MTLAccuracy-71"><a href="#MTLAccuracy-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MTLAccuracy-72"><a href="#MTLAccuracy-72"><span class="linenos"> 72</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Test classification accuracy of all tasks. Accumulated and calculated from the test batches. Keys are task IDs and values are the corresponding metrics.&quot;&quot;&quot;</span>
</span><span id="MTLAccuracy-73"><a href="#MTLAccuracy-73"><span class="linenos"> 73</span></a>
</span><span id="MTLAccuracy-74"><a href="#MTLAccuracy-74"><span class="linenos"> 74</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_fit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy-75"><a href="#MTLAccuracy-75"><span class="linenos"> 75</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize training and validation metrics.&quot;&quot;&quot;</span>
</span><span id="MTLAccuracy-76"><a href="#MTLAccuracy-76"><span class="linenos"> 76</span></a>
</span><span id="MTLAccuracy-77"><a href="#MTLAccuracy-77"><span class="linenos"> 77</span></a>        <span class="c1"># initialize training metrics</span>
</span><span id="MTLAccuracy-78"><a href="#MTLAccuracy-78"><span class="linenos"> 78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span>
</span><span id="MTLAccuracy-79"><a href="#MTLAccuracy-79"><span class="linenos"> 79</span></a>
</span><span id="MTLAccuracy-80"><a href="#MTLAccuracy-80"><span class="linenos"> 80</span></a>        <span class="c1"># initialize validation metrics</span>
</span><span id="MTLAccuracy-81"><a href="#MTLAccuracy-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="MTLAccuracy-82"><a href="#MTLAccuracy-82"><span class="linenos"> 82</span></a>            <span class="n">task_id</span><span class="p">:</span> <span class="n">MeanMetricBatch</span><span class="p">()</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">trainer</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">train_tasks</span>
</span><span id="MTLAccuracy-83"><a href="#MTLAccuracy-83"><span class="linenos"> 83</span></a>        <span class="p">}</span>
</span><span id="MTLAccuracy-84"><a href="#MTLAccuracy-84"><span class="linenos"> 84</span></a>
</span><span id="MTLAccuracy-85"><a href="#MTLAccuracy-85"><span class="linenos"> 85</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span>
</span><span id="MTLAccuracy-86"><a href="#MTLAccuracy-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLAccuracy-87"><a href="#MTLAccuracy-87"><span class="linenos"> 87</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLAccuracy-88"><a href="#MTLAccuracy-88"><span class="linenos"> 88</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLAccuracy-89"><a href="#MTLAccuracy-89"><span class="linenos"> 89</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="MTLAccuracy-90"><a href="#MTLAccuracy-90"><span class="linenos"> 90</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="MTLAccuracy-91"><a href="#MTLAccuracy-91"><span class="linenos"> 91</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="MTLAccuracy-92"><a href="#MTLAccuracy-92"><span class="linenos"> 92</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy-93"><a href="#MTLAccuracy-93"><span class="linenos"> 93</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Record training metrics from training batch, log metrics of training batch and accumulated metrics of the epoch to Lightning loggers.</span>
</span><span id="MTLAccuracy-94"><a href="#MTLAccuracy-94"><span class="linenos"> 94</span></a>
</span><span id="MTLAccuracy-95"><a href="#MTLAccuracy-95"><span class="linenos"> 95</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLAccuracy-96"><a href="#MTLAccuracy-96"><span class="linenos"> 96</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the training step, the returns of the `training_step()` method in the `MTLAlgorithm`.</span>
</span><span id="MTLAccuracy-97"><a href="#MTLAccuracy-97"><span class="linenos"> 97</span></a><span class="sd">        - **batch** (`Any`): the training data batch.</span>
</span><span id="MTLAccuracy-98"><a href="#MTLAccuracy-98"><span class="linenos"> 98</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLAccuracy-99"><a href="#MTLAccuracy-99"><span class="linenos"> 99</span></a>        <span class="c1"># get the batch size</span>
</span><span id="MTLAccuracy-100"><a href="#MTLAccuracy-100"><span class="linenos">100</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="MTLAccuracy-101"><a href="#MTLAccuracy-101"><span class="linenos">101</span></a>
</span><span id="MTLAccuracy-102"><a href="#MTLAccuracy-102"><span class="linenos">102</span></a>        <span class="c1"># get training metrics values of current training batch from the outputs of the `training_step()`</span>
</span><span id="MTLAccuracy-103"><a href="#MTLAccuracy-103"><span class="linenos">103</span></a>        <span class="n">acc_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
</span><span id="MTLAccuracy-104"><a href="#MTLAccuracy-104"><span class="linenos">104</span></a>
</span><span id="MTLAccuracy-105"><a href="#MTLAccuracy-105"><span class="linenos">105</span></a>        <span class="c1"># update accumulated training metrics to calculate training metrics of the epoch</span>
</span><span id="MTLAccuracy-106"><a href="#MTLAccuracy-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="MTLAccuracy-107"><a href="#MTLAccuracy-107"><span class="linenos">107</span></a>
</span><span id="MTLAccuracy-108"><a href="#MTLAccuracy-108"><span class="linenos">108</span></a>        <span class="c1"># log training metrics of current training batch to Lightning loggers</span>
</span><span id="MTLAccuracy-109"><a href="#MTLAccuracy-109"><span class="linenos">109</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;train/acc_batch&quot;</span><span class="p">,</span> <span class="n">acc_batch</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="MTLAccuracy-110"><a href="#MTLAccuracy-110"><span class="linenos">110</span></a>
</span><span id="MTLAccuracy-111"><a href="#MTLAccuracy-111"><span class="linenos">111</span></a>        <span class="c1"># log accumulated training metrics till this training batch to Lightning loggers</span>
</span><span id="MTLAccuracy-112"><a href="#MTLAccuracy-112"><span class="linenos">112</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="MTLAccuracy-113"><a href="#MTLAccuracy-113"><span class="linenos">113</span></a>            <span class="s2">&quot;task/train/acc&quot;</span><span class="p">,</span>
</span><span id="MTLAccuracy-114"><a href="#MTLAccuracy-114"><span class="linenos">114</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="MTLAccuracy-115"><a href="#MTLAccuracy-115"><span class="linenos">115</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="MTLAccuracy-116"><a href="#MTLAccuracy-116"><span class="linenos">116</span></a>        <span class="p">)</span>
</span><span id="MTLAccuracy-117"><a href="#MTLAccuracy-117"><span class="linenos">117</span></a>
</span><span id="MTLAccuracy-118"><a href="#MTLAccuracy-118"><span class="linenos">118</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_epoch_end</span><span class="p">(</span>
</span><span id="MTLAccuracy-119"><a href="#MTLAccuracy-119"><span class="linenos">119</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLAccuracy-120"><a href="#MTLAccuracy-120"><span class="linenos">120</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLAccuracy-121"><a href="#MTLAccuracy-121"><span class="linenos">121</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLAccuracy-122"><a href="#MTLAccuracy-122"><span class="linenos">122</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy-123"><a href="#MTLAccuracy-123"><span class="linenos">123</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log metrics of training epoch to plot learning curves and reset the metrics accumulation at the end of training epoch.&quot;&quot;&quot;</span>
</span><span id="MTLAccuracy-124"><a href="#MTLAccuracy-124"><span class="linenos">124</span></a>
</span><span id="MTLAccuracy-125"><a href="#MTLAccuracy-125"><span class="linenos">125</span></a>
</span><span id="MTLAccuracy-126"><a href="#MTLAccuracy-126"><span class="linenos">126</span></a>        <span class="c1"># reset the metrics of training epoch as there are more epochs to go and not only one epoch like in the validation and test</span>
</span><span id="MTLAccuracy-127"><a href="#MTLAccuracy-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span><span id="MTLAccuracy-128"><a href="#MTLAccuracy-128"><span class="linenos">128</span></a>
</span><span id="MTLAccuracy-129"><a href="#MTLAccuracy-129"><span class="linenos">129</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_batch_end</span><span class="p">(</span>
</span><span id="MTLAccuracy-130"><a href="#MTLAccuracy-130"><span class="linenos">130</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLAccuracy-131"><a href="#MTLAccuracy-131"><span class="linenos">131</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLAccuracy-132"><a href="#MTLAccuracy-132"><span class="linenos">132</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLAccuracy-133"><a href="#MTLAccuracy-133"><span class="linenos">133</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="MTLAccuracy-134"><a href="#MTLAccuracy-134"><span class="linenos">134</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="MTLAccuracy-135"><a href="#MTLAccuracy-135"><span class="linenos">135</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="MTLAccuracy-136"><a href="#MTLAccuracy-136"><span class="linenos">136</span></a>        <span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="MTLAccuracy-137"><a href="#MTLAccuracy-137"><span class="linenos">137</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy-138"><a href="#MTLAccuracy-138"><span class="linenos">138</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from validation batch. We don&#39;t need to log and monitor the metrics of validation batches.</span>
</span><span id="MTLAccuracy-139"><a href="#MTLAccuracy-139"><span class="linenos">139</span></a>
</span><span id="MTLAccuracy-140"><a href="#MTLAccuracy-140"><span class="linenos">140</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLAccuracy-141"><a href="#MTLAccuracy-141"><span class="linenos">141</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the validation step, which is the returns of the `validation_step()` method in the `MTLAlgorithm`.</span>
</span><span id="MTLAccuracy-142"><a href="#MTLAccuracy-142"><span class="linenos">142</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="MTLAccuracy-143"><a href="#MTLAccuracy-143"><span class="linenos">143</span></a><span class="sd">        - **dataloader_idx** (`int`): the task ID of the validation dataloader. A default value of 0 is given otherwise the LightningModule will raise a `RuntimeError`.</span>
</span><span id="MTLAccuracy-144"><a href="#MTLAccuracy-144"><span class="linenos">144</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLAccuracy-145"><a href="#MTLAccuracy-145"><span class="linenos">145</span></a>
</span><span id="MTLAccuracy-146"><a href="#MTLAccuracy-146"><span class="linenos">146</span></a>        <span class="c1"># get the batch size</span>
</span><span id="MTLAccuracy-147"><a href="#MTLAccuracy-147"><span class="linenos">147</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="MTLAccuracy-148"><a href="#MTLAccuracy-148"><span class="linenos">148</span></a>
</span><span id="MTLAccuracy-149"><a href="#MTLAccuracy-149"><span class="linenos">149</span></a>        <span class="n">val_task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">get_val_task_id_from_dataloader_idx</span><span class="p">(</span><span class="n">dataloader_idx</span><span class="p">)</span>
</span><span id="MTLAccuracy-150"><a href="#MTLAccuracy-150"><span class="linenos">150</span></a>
</span><span id="MTLAccuracy-151"><a href="#MTLAccuracy-151"><span class="linenos">151</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="MTLAccuracy-152"><a href="#MTLAccuracy-152"><span class="linenos">152</span></a>        <span class="n">acc_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
</span><span id="MTLAccuracy-153"><a href="#MTLAccuracy-153"><span class="linenos">153</span></a>
</span><span id="MTLAccuracy-154"><a href="#MTLAccuracy-154"><span class="linenos">154</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the validation metrics</span>
</span><span id="MTLAccuracy-155"><a href="#MTLAccuracy-155"><span class="linenos">155</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span><span class="p">[</span><span class="n">val_task_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="MTLAccuracy-156"><a href="#MTLAccuracy-156"><span class="linenos">156</span></a>
</span><span id="MTLAccuracy-157"><a href="#MTLAccuracy-157"><span class="linenos">157</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_start</span><span class="p">(</span>
</span><span id="MTLAccuracy-158"><a href="#MTLAccuracy-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLAccuracy-159"><a href="#MTLAccuracy-159"><span class="linenos">159</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLAccuracy-160"><a href="#MTLAccuracy-160"><span class="linenos">160</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLAccuracy-161"><a href="#MTLAccuracy-161"><span class="linenos">161</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy-162"><a href="#MTLAccuracy-162"><span class="linenos">162</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the metrics for testing each seen task in the beginning of a task&#39;s testing.&quot;&quot;&quot;</span>
</span><span id="MTLAccuracy-163"><a href="#MTLAccuracy-163"><span class="linenos">163</span></a>
</span><span id="MTLAccuracy-164"><a href="#MTLAccuracy-164"><span class="linenos">164</span></a>        <span class="c1"># initialize test metrics for current and previous tasks</span>
</span><span id="MTLAccuracy-165"><a href="#MTLAccuracy-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="MTLAccuracy-166"><a href="#MTLAccuracy-166"><span class="linenos">166</span></a>            <span class="n">task_id</span><span class="p">:</span> <span class="n">MeanMetricBatch</span><span class="p">()</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">trainer</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">eval_tasks</span>
</span><span id="MTLAccuracy-167"><a href="#MTLAccuracy-167"><span class="linenos">167</span></a>        <span class="p">}</span>
</span><span id="MTLAccuracy-168"><a href="#MTLAccuracy-168"><span class="linenos">168</span></a>
</span><span id="MTLAccuracy-169"><a href="#MTLAccuracy-169"><span class="linenos">169</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_batch_end</span><span class="p">(</span>
</span><span id="MTLAccuracy-170"><a href="#MTLAccuracy-170"><span class="linenos">170</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLAccuracy-171"><a href="#MTLAccuracy-171"><span class="linenos">171</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLAccuracy-172"><a href="#MTLAccuracy-172"><span class="linenos">172</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLAccuracy-173"><a href="#MTLAccuracy-173"><span class="linenos">173</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="MTLAccuracy-174"><a href="#MTLAccuracy-174"><span class="linenos">174</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="MTLAccuracy-175"><a href="#MTLAccuracy-175"><span class="linenos">175</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="MTLAccuracy-176"><a href="#MTLAccuracy-176"><span class="linenos">176</span></a>        <span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="MTLAccuracy-177"><a href="#MTLAccuracy-177"><span class="linenos">177</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy-178"><a href="#MTLAccuracy-178"><span class="linenos">178</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from test batch. We don&#39;t need to log and monitor the metrics of test batches.</span>
</span><span id="MTLAccuracy-179"><a href="#MTLAccuracy-179"><span class="linenos">179</span></a>
</span><span id="MTLAccuracy-180"><a href="#MTLAccuracy-180"><span class="linenos">180</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLAccuracy-181"><a href="#MTLAccuracy-181"><span class="linenos">181</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the test step, which is the returns of the `test_step()` method in the `MTLAlgorithm`.</span>
</span><span id="MTLAccuracy-182"><a href="#MTLAccuracy-182"><span class="linenos">182</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="MTLAccuracy-183"><a href="#MTLAccuracy-183"><span class="linenos">183</span></a><span class="sd">        - **dataloader_idx** (`int`): the task ID of seen tasks to be tested. A default value of 0 is given otherwise the LightningModule will raise a `RuntimeError`.</span>
</span><span id="MTLAccuracy-184"><a href="#MTLAccuracy-184"><span class="linenos">184</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLAccuracy-185"><a href="#MTLAccuracy-185"><span class="linenos">185</span></a>
</span><span id="MTLAccuracy-186"><a href="#MTLAccuracy-186"><span class="linenos">186</span></a>        <span class="c1"># get the batch size</span>
</span><span id="MTLAccuracy-187"><a href="#MTLAccuracy-187"><span class="linenos">187</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="MTLAccuracy-188"><a href="#MTLAccuracy-188"><span class="linenos">188</span></a>
</span><span id="MTLAccuracy-189"><a href="#MTLAccuracy-189"><span class="linenos">189</span></a>        <span class="n">test_task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">get_test_task_id_from_dataloader_idx</span><span class="p">(</span><span class="n">dataloader_idx</span><span class="p">)</span>
</span><span id="MTLAccuracy-190"><a href="#MTLAccuracy-190"><span class="linenos">190</span></a>
</span><span id="MTLAccuracy-191"><a href="#MTLAccuracy-191"><span class="linenos">191</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="MTLAccuracy-192"><a href="#MTLAccuracy-192"><span class="linenos">192</span></a>        <span class="n">acc_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
</span><span id="MTLAccuracy-193"><a href="#MTLAccuracy-193"><span class="linenos">193</span></a>
</span><span id="MTLAccuracy-194"><a href="#MTLAccuracy-194"><span class="linenos">194</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the metrics of the epoch</span>
</span><span id="MTLAccuracy-195"><a href="#MTLAccuracy-195"><span class="linenos">195</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="p">[</span><span class="n">test_task_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="MTLAccuracy-196"><a href="#MTLAccuracy-196"><span class="linenos">196</span></a>
</span><span id="MTLAccuracy-197"><a href="#MTLAccuracy-197"><span class="linenos">197</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_epoch_end</span><span class="p">(</span>
</span><span id="MTLAccuracy-198"><a href="#MTLAccuracy-198"><span class="linenos">198</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLAccuracy-199"><a href="#MTLAccuracy-199"><span class="linenos">199</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLAccuracy-200"><a href="#MTLAccuracy-200"><span class="linenos">200</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLAccuracy-201"><a href="#MTLAccuracy-201"><span class="linenos">201</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy-202"><a href="#MTLAccuracy-202"><span class="linenos">202</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save and plot test metrics at the end of test.&quot;&quot;&quot;</span>
</span><span id="MTLAccuracy-203"><a href="#MTLAccuracy-203"><span class="linenos">203</span></a>
</span><span id="MTLAccuracy-204"><a href="#MTLAccuracy-204"><span class="linenos">204</span></a>        <span class="c1"># save (update) the test metrics to CSV files</span>
</span><span id="MTLAccuracy-205"><a href="#MTLAccuracy-205"><span class="linenos">205</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_test_acc_to_csv</span><span class="p">(</span>
</span><span id="MTLAccuracy-206"><a href="#MTLAccuracy-206"><span class="linenos">206</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_acc_csv_path</span><span class="p">,</span>
</span><span id="MTLAccuracy-207"><a href="#MTLAccuracy-207"><span class="linenos">207</span></a>        <span class="p">)</span>
</span><span id="MTLAccuracy-208"><a href="#MTLAccuracy-208"><span class="linenos">208</span></a>
</span><span id="MTLAccuracy-209"><a href="#MTLAccuracy-209"><span class="linenos">209</span></a>        <span class="c1"># plot the test metrics</span>
</span><span id="MTLAccuracy-210"><a href="#MTLAccuracy-210"><span class="linenos">210</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_acc_plot_path</span><span class="p">:</span>
</span><span id="MTLAccuracy-211"><a href="#MTLAccuracy-211"><span class="linenos">211</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plot_test_acc_from_csv</span><span class="p">(</span>
</span><span id="MTLAccuracy-212"><a href="#MTLAccuracy-212"><span class="linenos">212</span></a>                <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_acc_csv_path</span><span class="p">,</span>
</span><span id="MTLAccuracy-213"><a href="#MTLAccuracy-213"><span class="linenos">213</span></a>                <span class="n">plot_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_acc_plot_path</span><span class="p">,</span>
</span><span id="MTLAccuracy-214"><a href="#MTLAccuracy-214"><span class="linenos">214</span></a>            <span class="p">)</span>
</span><span id="MTLAccuracy-215"><a href="#MTLAccuracy-215"><span class="linenos">215</span></a>
</span><span id="MTLAccuracy-216"><a href="#MTLAccuracy-216"><span class="linenos">216</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_test_acc_to_csv</span><span class="p">(</span>
</span><span id="MTLAccuracy-217"><a href="#MTLAccuracy-217"><span class="linenos">217</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLAccuracy-218"><a href="#MTLAccuracy-218"><span class="linenos">218</span></a>        <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MTLAccuracy-219"><a href="#MTLAccuracy-219"><span class="linenos">219</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy-220"><a href="#MTLAccuracy-220"><span class="linenos">220</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save the test accuracy metrics of all tasks in multi-task learning to an CSV file.</span>
</span><span id="MTLAccuracy-221"><a href="#MTLAccuracy-221"><span class="linenos">221</span></a>
</span><span id="MTLAccuracy-222"><a href="#MTLAccuracy-222"><span class="linenos">222</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLAccuracy-223"><a href="#MTLAccuracy-223"><span class="linenos">223</span></a><span class="sd">        - **csv_path** (`str`): save the test metric to path. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/acc.csv&#39;.</span>
</span><span id="MTLAccuracy-224"><a href="#MTLAccuracy-224"><span class="linenos">224</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLAccuracy-225"><a href="#MTLAccuracy-225"><span class="linenos">225</span></a>        <span class="n">all_task_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="MTLAccuracy-226"><a href="#MTLAccuracy-226"><span class="linenos">226</span></a>        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;average_accuracy&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="MTLAccuracy-227"><a href="#MTLAccuracy-227"><span class="linenos">227</span></a>            <span class="sa">f</span><span class="s2">&quot;test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">all_task_ids</span>
</span><span id="MTLAccuracy-228"><a href="#MTLAccuracy-228"><span class="linenos">228</span></a>        <span class="p">]</span>
</span><span id="MTLAccuracy-229"><a href="#MTLAccuracy-229"><span class="linenos">229</span></a>        <span class="n">new_line</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MTLAccuracy-230"><a href="#MTLAccuracy-230"><span class="linenos">230</span></a>
</span><span id="MTLAccuracy-231"><a href="#MTLAccuracy-231"><span class="linenos">231</span></a>        <span class="c1"># construct the columns and calculate the average accuracy over tasks at the same time</span>
</span><span id="MTLAccuracy-232"><a href="#MTLAccuracy-232"><span class="linenos">232</span></a>        <span class="n">average_accuracy_over_tasks</span> <span class="o">=</span> <span class="n">MeanMetric</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
</span><span id="MTLAccuracy-233"><a href="#MTLAccuracy-233"><span class="linenos">233</span></a>            <span class="n">device</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">device</span>
</span><span id="MTLAccuracy-234"><a href="#MTLAccuracy-234"><span class="linenos">234</span></a>        <span class="p">)</span>
</span><span id="MTLAccuracy-235"><a href="#MTLAccuracy-235"><span class="linenos">235</span></a>        <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">all_task_ids</span><span class="p">:</span>
</span><span id="MTLAccuracy-236"><a href="#MTLAccuracy-236"><span class="linenos">236</span></a>            <span class="n">acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="MTLAccuracy-237"><a href="#MTLAccuracy-237"><span class="linenos">237</span></a>            <span class="n">new_line</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc</span>
</span><span id="MTLAccuracy-238"><a href="#MTLAccuracy-238"><span class="linenos">238</span></a>            <span class="n">average_accuracy_over_tasks</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
</span><span id="MTLAccuracy-239"><a href="#MTLAccuracy-239"><span class="linenos">239</span></a>        <span class="n">new_line</span><span class="p">[</span><span class="s2">&quot;average_accuracy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">average_accuracy_over_tasks</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="MTLAccuracy-240"><a href="#MTLAccuracy-240"><span class="linenos">240</span></a>
</span><span id="MTLAccuracy-241"><a href="#MTLAccuracy-241"><span class="linenos">241</span></a>        <span class="c1"># write</span>
</span><span id="MTLAccuracy-242"><a href="#MTLAccuracy-242"><span class="linenos">242</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="MTLAccuracy-243"><a href="#MTLAccuracy-243"><span class="linenos">243</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="MTLAccuracy-244"><a href="#MTLAccuracy-244"><span class="linenos">244</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="MTLAccuracy-245"><a href="#MTLAccuracy-245"><span class="linenos">245</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
</span><span id="MTLAccuracy-246"><a href="#MTLAccuracy-246"><span class="linenos">246</span></a>
</span><span id="MTLAccuracy-247"><a href="#MTLAccuracy-247"><span class="linenos">247</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_test_acc_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy-248"><a href="#MTLAccuracy-248"><span class="linenos">248</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the test accuracy bar chart of all tasks in multi-task learning from saved CSV file and save the plot to the designated directory.</span>
</span><span id="MTLAccuracy-249"><a href="#MTLAccuracy-249"><span class="linenos">249</span></a>
</span><span id="MTLAccuracy-250"><a href="#MTLAccuracy-250"><span class="linenos">250</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLAccuracy-251"><a href="#MTLAccuracy-251"><span class="linenos">251</span></a><span class="sd">        - **csv_path** (`str`): the path to the csv file where the `utils.save_test_acc_csv()` saved the test accuracy metric.</span>
</span><span id="MTLAccuracy-252"><a href="#MTLAccuracy-252"><span class="linenos">252</span></a><span class="sd">        - **plot_path** (`str`): the path to save plot. Better same as the output directory of the experiment. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/acc.png&#39;.</span>
</span><span id="MTLAccuracy-253"><a href="#MTLAccuracy-253"><span class="linenos">253</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLAccuracy-254"><a href="#MTLAccuracy-254"><span class="linenos">254</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="MTLAccuracy-255"><a href="#MTLAccuracy-255"><span class="linenos">255</span></a>
</span><span id="MTLAccuracy-256"><a href="#MTLAccuracy-256"><span class="linenos">256</span></a>        <span class="c1"># extract all accuracy columns including average</span>
</span><span id="MTLAccuracy-257"><a href="#MTLAccuracy-257"><span class="linenos">257</span></a>        <span class="n">all_columns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="MTLAccuracy-258"><a href="#MTLAccuracy-258"><span class="linenos">258</span></a>        <span class="n">task_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_columns</span><span class="p">)))</span>  <span class="c1"># assign index-based positions</span>
</span><span id="MTLAccuracy-259"><a href="#MTLAccuracy-259"><span class="linenos">259</span></a>        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="MTLAccuracy-260"><a href="#MTLAccuracy-260"><span class="linenos">260</span></a>            <span class="p">(</span>
</span><span id="MTLAccuracy-261"><a href="#MTLAccuracy-261"><span class="linenos">261</span></a>                <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;test_on_task_&quot;</span><span class="p">,</span> <span class="s2">&quot;Task &quot;</span><span class="p">)</span>
</span><span id="MTLAccuracy-262"><a href="#MTLAccuracy-262"><span class="linenos">262</span></a>                <span class="k">if</span> <span class="s2">&quot;test_on_task_&quot;</span> <span class="ow">in</span> <span class="n">col</span>
</span><span id="MTLAccuracy-263"><a href="#MTLAccuracy-263"><span class="linenos">263</span></a>                <span class="k">else</span> <span class="s2">&quot;Average&quot;</span>
</span><span id="MTLAccuracy-264"><a href="#MTLAccuracy-264"><span class="linenos">264</span></a>            <span class="p">)</span>
</span><span id="MTLAccuracy-265"><a href="#MTLAccuracy-265"><span class="linenos">265</span></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">all_columns</span>
</span><span id="MTLAccuracy-266"><a href="#MTLAccuracy-266"><span class="linenos">266</span></a>        <span class="p">]</span>
</span><span id="MTLAccuracy-267"><a href="#MTLAccuracy-267"><span class="linenos">267</span></a>        <span class="n">accuracies</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">all_columns</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="MTLAccuracy-268"><a href="#MTLAccuracy-268"><span class="linenos">268</span></a>
</span><span id="MTLAccuracy-269"><a href="#MTLAccuracy-269"><span class="linenos">269</span></a>        <span class="c1"># plot the accuracy bar chart over tasks</span>
</span><span id="MTLAccuracy-270"><a href="#MTLAccuracy-270"><span class="linenos">270</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
</span><span id="MTLAccuracy-271"><a href="#MTLAccuracy-271"><span class="linenos">271</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
</span><span id="MTLAccuracy-272"><a href="#MTLAccuracy-272"><span class="linenos">272</span></a>            <span class="n">task_ids</span><span class="p">,</span>
</span><span id="MTLAccuracy-273"><a href="#MTLAccuracy-273"><span class="linenos">273</span></a>            <span class="n">accuracies</span><span class="p">,</span>
</span><span id="MTLAccuracy-274"><a href="#MTLAccuracy-274"><span class="linenos">274</span></a>            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;skyblue&quot;</span><span class="p">,</span>
</span><span id="MTLAccuracy-275"><a href="#MTLAccuracy-275"><span class="linenos">275</span></a>            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="MTLAccuracy-276"><a href="#MTLAccuracy-276"><span class="linenos">276</span></a>        <span class="p">)</span>
</span><span id="MTLAccuracy-277"><a href="#MTLAccuracy-277"><span class="linenos">277</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Task&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="MTLAccuracy-278"><a href="#MTLAccuracy-278"><span class="linenos">278</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="MTLAccuracy-279"><a href="#MTLAccuracy-279"><span class="linenos">279</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="MTLAccuracy-280"><a href="#MTLAccuracy-280"><span class="linenos">280</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">task_ids</span><span class="p">)</span>
</span><span id="MTLAccuracy-281"><a href="#MTLAccuracy-281"><span class="linenos">281</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="MTLAccuracy-282"><a href="#MTLAccuracy-282"><span class="linenos">282</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="n">i</span> <span class="o">*</span> <span class="mf">0.05</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">)])</span>
</span><span id="MTLAccuracy-283"><a href="#MTLAccuracy-283"><span class="linenos">283</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="MTLAccuracy-284"><a href="#MTLAccuracy-284"><span class="linenos">284</span></a>            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mf">0.05</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">)]],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span>
</span><span id="MTLAccuracy-285"><a href="#MTLAccuracy-285"><span class="linenos">285</span></a>        <span class="p">)</span>
</span><span id="MTLAccuracy-286"><a href="#MTLAccuracy-286"><span class="linenos">286</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="MTLAccuracy-287"><a href="#MTLAccuracy-287"><span class="linenos">287</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="MTLAccuracy-288"><a href="#MTLAccuracy-288"><span class="linenos">288</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Provides all actions that are related to MTL accuracy metrics, which include:</p>

<ul>
<li>Defining, initializing and recording accuracy metric.</li>
<li>Logging training and validation accuracy metric to Lightning loggers in real time.</li>
<li>Saving test accuracy metric to files.</li>
<li>Visualizing test accuracy metric as plots.</li>
</ul>

<p>The callback is able to produce the following outputs:</p>

<ul>
<li>CSV files for test accuracy of all tasks and average accuracy.</li>
<li>Bar charts for test accuracy of all tasks.</li>
</ul>
</div>


                            <div id="MTLAccuracy.__init__" class="classattr">
                                        <input id="MTLAccuracy.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">MTLAccuracy</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">test_acc_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;acc.csv&#39;</span>,</span><span class="param">	<span class="n">test_acc_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="MTLAccuracy.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLAccuracy.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLAccuracy.__init__-40"><a href="#MTLAccuracy.__init__-40"><span class="linenos">40</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="MTLAccuracy.__init__-41"><a href="#MTLAccuracy.__init__-41"><span class="linenos">41</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLAccuracy.__init__-42"><a href="#MTLAccuracy.__init__-42"><span class="linenos">42</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MTLAccuracy.__init__-43"><a href="#MTLAccuracy.__init__-43"><span class="linenos">43</span></a>        <span class="n">test_acc_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;acc.csv&quot;</span><span class="p">,</span>
</span><span id="MTLAccuracy.__init__-44"><a href="#MTLAccuracy.__init__-44"><span class="linenos">44</span></a>        <span class="n">test_acc_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MTLAccuracy.__init__-45"><a href="#MTLAccuracy.__init__-45"><span class="linenos">45</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy.__init__-46"><a href="#MTLAccuracy.__init__-46"><span class="linenos">46</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `MTLAccuracy`.</span>
</span><span id="MTLAccuracy.__init__-47"><a href="#MTLAccuracy.__init__-47"><span class="linenos">47</span></a>
</span><span id="MTLAccuracy.__init__-48"><a href="#MTLAccuracy.__init__-48"><span class="linenos">48</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLAccuracy.__init__-49"><a href="#MTLAccuracy.__init__-49"><span class="linenos">49</span></a><span class="sd">        - **save_dir** (`str`): The directory where data and figures of metrics will be saved. Better inside the output folder.</span>
</span><span id="MTLAccuracy.__init__-50"><a href="#MTLAccuracy.__init__-50"><span class="linenos">50</span></a><span class="sd">        - **test_acc_csv_name** (`str`): file name to save test accuracy of all tasks and average accuracy as CSV file.</span>
</span><span id="MTLAccuracy.__init__-51"><a href="#MTLAccuracy.__init__-51"><span class="linenos">51</span></a><span class="sd">        - **test_acc_plot_name** (`str` | `None`): file name to save accuracy plot. If `None`, no file will be saved.</span>
</span><span id="MTLAccuracy.__init__-52"><a href="#MTLAccuracy.__init__-52"><span class="linenos">52</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLAccuracy.__init__-53"><a href="#MTLAccuracy.__init__-53"><span class="linenos">53</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="MTLAccuracy.__init__-54"><a href="#MTLAccuracy.__init__-54"><span class="linenos">54</span></a>
</span><span id="MTLAccuracy.__init__-55"><a href="#MTLAccuracy.__init__-55"><span class="linenos">55</span></a>        <span class="c1"># paths</span>
</span><span id="MTLAccuracy.__init__-56"><a href="#MTLAccuracy.__init__-56"><span class="linenos">56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_acc_csv_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">test_acc_csv_name</span><span class="p">)</span>
</span><span id="MTLAccuracy.__init__-57"><a href="#MTLAccuracy.__init__-57"><span class="linenos">57</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The path to save test accuracy of all tasks and average accuracy CSV file.&quot;&quot;&quot;</span>
</span><span id="MTLAccuracy.__init__-58"><a href="#MTLAccuracy.__init__-58"><span class="linenos">58</span></a>        <span class="k">if</span> <span class="n">test_acc_plot_name</span><span class="p">:</span>
</span><span id="MTLAccuracy.__init__-59"><a href="#MTLAccuracy.__init__-59"><span class="linenos">59</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_acc_plot_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">test_acc_plot_name</span><span class="p">)</span>
</span><span id="MTLAccuracy.__init__-60"><a href="#MTLAccuracy.__init__-60"><span class="linenos">60</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The path to save test accuracy plot.&quot;&quot;&quot;</span>
</span><span id="MTLAccuracy.__init__-61"><a href="#MTLAccuracy.__init__-61"><span class="linenos">61</span></a>
</span><span id="MTLAccuracy.__init__-62"><a href="#MTLAccuracy.__init__-62"><span class="linenos">62</span></a>        <span class="c1"># training accumulated metrics</span>
</span><span id="MTLAccuracy.__init__-63"><a href="#MTLAccuracy.__init__-63"><span class="linenos">63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="MTLAccuracy.__init__-64"><a href="#MTLAccuracy.__init__-64"><span class="linenos">64</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Classification accuracy of training epoch. Accumulated and calculated from the training batches. &quot;&quot;&quot;</span>
</span><span id="MTLAccuracy.__init__-65"><a href="#MTLAccuracy.__init__-65"><span class="linenos">65</span></a>
</span><span id="MTLAccuracy.__init__-66"><a href="#MTLAccuracy.__init__-66"><span class="linenos">66</span></a>        <span class="c1"># validation accumulated metrics</span>
</span><span id="MTLAccuracy.__init__-67"><a href="#MTLAccuracy.__init__-67"><span class="linenos">67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MTLAccuracy.__init__-68"><a href="#MTLAccuracy.__init__-68"><span class="linenos">68</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Validation classification accuracy of the model after training epoch. Accumulated and calculated from the validation batches. Keys are task IDs and values are the corresponding metrics.&quot;&quot;&quot;</span>
</span><span id="MTLAccuracy.__init__-69"><a href="#MTLAccuracy.__init__-69"><span class="linenos">69</span></a>
</span><span id="MTLAccuracy.__init__-70"><a href="#MTLAccuracy.__init__-70"><span class="linenos">70</span></a>        <span class="c1"># test accumulated metrics</span>
</span><span id="MTLAccuracy.__init__-71"><a href="#MTLAccuracy.__init__-71"><span class="linenos">71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MTLAccuracy.__init__-72"><a href="#MTLAccuracy.__init__-72"><span class="linenos">72</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Test classification accuracy of all tasks. Accumulated and calculated from the test batches. Keys are task IDs and values are the corresponding metrics.&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the <code><a href="#MTLAccuracy">MTLAccuracy</a></code>.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>save_dir</strong> (<code>str</code>): The directory where data and figures of metrics will be saved. Better inside the output folder.</li>
<li><strong>test_acc_csv_name</strong> (<code>str</code>): file name to save test accuracy of all tasks and average accuracy as CSV file.</li>
<li><strong>test_acc_plot_name</strong> (<code>str</code> | <code>None</code>): file name to save accuracy plot. If <code>None</code>, no file will be saved.</li>
</ul>
</div>


                            </div>
                            <div id="MTLAccuracy.test_acc_csv_path" class="classattr">
                                <div class="attr variable">
            <span class="name">test_acc_csv_path</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#MTLAccuracy.test_acc_csv_path"></a>
    
            <div class="docstring"><p>The path to save test accuracy of all tasks and average accuracy CSV file.</p>
</div>


                            </div>
                            <div id="MTLAccuracy.acc_training_epoch" class="classattr">
                                <div class="attr variable">
            <span class="name">acc_training_epoch</span><span class="annotation">: <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a></span>

        
    </div>
    <a class="headerlink" href="#MTLAccuracy.acc_training_epoch"></a>
    
            <div class="docstring"><p>Classification accuracy of training epoch. Accumulated and calculated from the training batches.</p>
</div>


                            </div>
                            <div id="MTLAccuracy.acc_val" class="classattr">
                                <div class="attr variable">
            <span class="name">acc_val</span><span class="annotation">: dict[int, <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a>]</span>

        
    </div>
    <a class="headerlink" href="#MTLAccuracy.acc_val"></a>
    
            <div class="docstring"><p>Validation classification accuracy of the model after training epoch. Accumulated and calculated from the validation batches. Keys are task IDs and values are the corresponding metrics.</p>
</div>


                            </div>
                            <div id="MTLAccuracy.acc_test" class="classattr">
                                <div class="attr variable">
            <span class="name">acc_test</span><span class="annotation">: dict[int, <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a>]</span>

        
    </div>
    <a class="headerlink" href="#MTLAccuracy.acc_test"></a>
    
            <div class="docstring"><p>Test classification accuracy of all tasks. Accumulated and calculated from the test batches. Keys are task IDs and values are the corresponding metrics.</p>
</div>


                            </div>
                            <div id="MTLAccuracy.on_fit_start" class="classattr">
                                        <input id="MTLAccuracy.on_fit_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_fit_start</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="mtl_algorithms/base.html#MTLAlgorithm">clarena.mtl_algorithms.base.MTLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLAccuracy.on_fit_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLAccuracy.on_fit_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLAccuracy.on_fit_start-74"><a href="#MTLAccuracy.on_fit_start-74"><span class="linenos">74</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_fit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy.on_fit_start-75"><a href="#MTLAccuracy.on_fit_start-75"><span class="linenos">75</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize training and validation metrics.&quot;&quot;&quot;</span>
</span><span id="MTLAccuracy.on_fit_start-76"><a href="#MTLAccuracy.on_fit_start-76"><span class="linenos">76</span></a>
</span><span id="MTLAccuracy.on_fit_start-77"><a href="#MTLAccuracy.on_fit_start-77"><span class="linenos">77</span></a>        <span class="c1"># initialize training metrics</span>
</span><span id="MTLAccuracy.on_fit_start-78"><a href="#MTLAccuracy.on_fit_start-78"><span class="linenos">78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span>
</span><span id="MTLAccuracy.on_fit_start-79"><a href="#MTLAccuracy.on_fit_start-79"><span class="linenos">79</span></a>
</span><span id="MTLAccuracy.on_fit_start-80"><a href="#MTLAccuracy.on_fit_start-80"><span class="linenos">80</span></a>        <span class="c1"># initialize validation metrics</span>
</span><span id="MTLAccuracy.on_fit_start-81"><a href="#MTLAccuracy.on_fit_start-81"><span class="linenos">81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="MTLAccuracy.on_fit_start-82"><a href="#MTLAccuracy.on_fit_start-82"><span class="linenos">82</span></a>            <span class="n">task_id</span><span class="p">:</span> <span class="n">MeanMetricBatch</span><span class="p">()</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">trainer</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">train_tasks</span>
</span><span id="MTLAccuracy.on_fit_start-83"><a href="#MTLAccuracy.on_fit_start-83"><span class="linenos">83</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Initialize training and validation metrics.</p>
</div>


                            </div>
                            <div id="MTLAccuracy.on_train_batch_end" class="classattr">
                                        <input id="MTLAccuracy.on_train_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_train_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="mtl_algorithms/base.html#MTLAlgorithm">clarena.mtl_algorithms.base.MTLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLAccuracy.on_train_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLAccuracy.on_train_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLAccuracy.on_train_batch_end-85"><a href="#MTLAccuracy.on_train_batch_end-85"><span class="linenos"> 85</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span>
</span><span id="MTLAccuracy.on_train_batch_end-86"><a href="#MTLAccuracy.on_train_batch_end-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_train_batch_end-87"><a href="#MTLAccuracy.on_train_batch_end-87"><span class="linenos"> 87</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_train_batch_end-88"><a href="#MTLAccuracy.on_train_batch_end-88"><span class="linenos"> 88</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_train_batch_end-89"><a href="#MTLAccuracy.on_train_batch_end-89"><span class="linenos"> 89</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="MTLAccuracy.on_train_batch_end-90"><a href="#MTLAccuracy.on_train_batch_end-90"><span class="linenos"> 90</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_train_batch_end-91"><a href="#MTLAccuracy.on_train_batch_end-91"><span class="linenos"> 91</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_train_batch_end-92"><a href="#MTLAccuracy.on_train_batch_end-92"><span class="linenos"> 92</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy.on_train_batch_end-93"><a href="#MTLAccuracy.on_train_batch_end-93"><span class="linenos"> 93</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Record training metrics from training batch, log metrics of training batch and accumulated metrics of the epoch to Lightning loggers.</span>
</span><span id="MTLAccuracy.on_train_batch_end-94"><a href="#MTLAccuracy.on_train_batch_end-94"><span class="linenos"> 94</span></a>
</span><span id="MTLAccuracy.on_train_batch_end-95"><a href="#MTLAccuracy.on_train_batch_end-95"><span class="linenos"> 95</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLAccuracy.on_train_batch_end-96"><a href="#MTLAccuracy.on_train_batch_end-96"><span class="linenos"> 96</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the training step, the returns of the `training_step()` method in the `MTLAlgorithm`.</span>
</span><span id="MTLAccuracy.on_train_batch_end-97"><a href="#MTLAccuracy.on_train_batch_end-97"><span class="linenos"> 97</span></a><span class="sd">        - **batch** (`Any`): the training data batch.</span>
</span><span id="MTLAccuracy.on_train_batch_end-98"><a href="#MTLAccuracy.on_train_batch_end-98"><span class="linenos"> 98</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLAccuracy.on_train_batch_end-99"><a href="#MTLAccuracy.on_train_batch_end-99"><span class="linenos"> 99</span></a>        <span class="c1"># get the batch size</span>
</span><span id="MTLAccuracy.on_train_batch_end-100"><a href="#MTLAccuracy.on_train_batch_end-100"><span class="linenos">100</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="MTLAccuracy.on_train_batch_end-101"><a href="#MTLAccuracy.on_train_batch_end-101"><span class="linenos">101</span></a>
</span><span id="MTLAccuracy.on_train_batch_end-102"><a href="#MTLAccuracy.on_train_batch_end-102"><span class="linenos">102</span></a>        <span class="c1"># get training metrics values of current training batch from the outputs of the `training_step()`</span>
</span><span id="MTLAccuracy.on_train_batch_end-103"><a href="#MTLAccuracy.on_train_batch_end-103"><span class="linenos">103</span></a>        <span class="n">acc_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
</span><span id="MTLAccuracy.on_train_batch_end-104"><a href="#MTLAccuracy.on_train_batch_end-104"><span class="linenos">104</span></a>
</span><span id="MTLAccuracy.on_train_batch_end-105"><a href="#MTLAccuracy.on_train_batch_end-105"><span class="linenos">105</span></a>        <span class="c1"># update accumulated training metrics to calculate training metrics of the epoch</span>
</span><span id="MTLAccuracy.on_train_batch_end-106"><a href="#MTLAccuracy.on_train_batch_end-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="MTLAccuracy.on_train_batch_end-107"><a href="#MTLAccuracy.on_train_batch_end-107"><span class="linenos">107</span></a>
</span><span id="MTLAccuracy.on_train_batch_end-108"><a href="#MTLAccuracy.on_train_batch_end-108"><span class="linenos">108</span></a>        <span class="c1"># log training metrics of current training batch to Lightning loggers</span>
</span><span id="MTLAccuracy.on_train_batch_end-109"><a href="#MTLAccuracy.on_train_batch_end-109"><span class="linenos">109</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;train/acc_batch&quot;</span><span class="p">,</span> <span class="n">acc_batch</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="MTLAccuracy.on_train_batch_end-110"><a href="#MTLAccuracy.on_train_batch_end-110"><span class="linenos">110</span></a>
</span><span id="MTLAccuracy.on_train_batch_end-111"><a href="#MTLAccuracy.on_train_batch_end-111"><span class="linenos">111</span></a>        <span class="c1"># log accumulated training metrics till this training batch to Lightning loggers</span>
</span><span id="MTLAccuracy.on_train_batch_end-112"><a href="#MTLAccuracy.on_train_batch_end-112"><span class="linenos">112</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="MTLAccuracy.on_train_batch_end-113"><a href="#MTLAccuracy.on_train_batch_end-113"><span class="linenos">113</span></a>            <span class="s2">&quot;task/train/acc&quot;</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_train_batch_end-114"><a href="#MTLAccuracy.on_train_batch_end-114"><span class="linenos">114</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="MTLAccuracy.on_train_batch_end-115"><a href="#MTLAccuracy.on_train_batch_end-115"><span class="linenos">115</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_train_batch_end-116"><a href="#MTLAccuracy.on_train_batch_end-116"><span class="linenos">116</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Record training metrics from training batch, log metrics of training batch and accumulated metrics of the epoch to Lightning loggers.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the training step, the returns of the <code>training_step()</code> method in the <code>MTLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the training data batch.</li>
</ul>
</div>


                            </div>
                            <div id="MTLAccuracy.on_train_epoch_end" class="classattr">
                                        <input id="MTLAccuracy.on_train_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_train_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="mtl_algorithms/base.html#MTLAlgorithm">clarena.mtl_algorithms.base.MTLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLAccuracy.on_train_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLAccuracy.on_train_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLAccuracy.on_train_epoch_end-118"><a href="#MTLAccuracy.on_train_epoch_end-118"><span class="linenos">118</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_epoch_end</span><span class="p">(</span>
</span><span id="MTLAccuracy.on_train_epoch_end-119"><a href="#MTLAccuracy.on_train_epoch_end-119"><span class="linenos">119</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_train_epoch_end-120"><a href="#MTLAccuracy.on_train_epoch_end-120"><span class="linenos">120</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_train_epoch_end-121"><a href="#MTLAccuracy.on_train_epoch_end-121"><span class="linenos">121</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_train_epoch_end-122"><a href="#MTLAccuracy.on_train_epoch_end-122"><span class="linenos">122</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy.on_train_epoch_end-123"><a href="#MTLAccuracy.on_train_epoch_end-123"><span class="linenos">123</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log metrics of training epoch to plot learning curves and reset the metrics accumulation at the end of training epoch.&quot;&quot;&quot;</span>
</span><span id="MTLAccuracy.on_train_epoch_end-124"><a href="#MTLAccuracy.on_train_epoch_end-124"><span class="linenos">124</span></a>
</span><span id="MTLAccuracy.on_train_epoch_end-125"><a href="#MTLAccuracy.on_train_epoch_end-125"><span class="linenos">125</span></a>
</span><span id="MTLAccuracy.on_train_epoch_end-126"><a href="#MTLAccuracy.on_train_epoch_end-126"><span class="linenos">126</span></a>        <span class="c1"># reset the metrics of training epoch as there are more epochs to go and not only one epoch like in the validation and test</span>
</span><span id="MTLAccuracy.on_train_epoch_end-127"><a href="#MTLAccuracy.on_train_epoch_end-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Log metrics of training epoch to plot learning curves and reset the metrics accumulation at the end of training epoch.</p>
</div>


                            </div>
                            <div id="MTLAccuracy.on_validation_batch_end" class="classattr">
                                        <input id="MTLAccuracy.on_validation_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_validation_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="mtl_algorithms/base.html#MTLAlgorithm">clarena.mtl_algorithms.base.MTLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLAccuracy.on_validation_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLAccuracy.on_validation_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLAccuracy.on_validation_batch_end-129"><a href="#MTLAccuracy.on_validation_batch_end-129"><span class="linenos">129</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_batch_end</span><span class="p">(</span>
</span><span id="MTLAccuracy.on_validation_batch_end-130"><a href="#MTLAccuracy.on_validation_batch_end-130"><span class="linenos">130</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_validation_batch_end-131"><a href="#MTLAccuracy.on_validation_batch_end-131"><span class="linenos">131</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_validation_batch_end-132"><a href="#MTLAccuracy.on_validation_batch_end-132"><span class="linenos">132</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_validation_batch_end-133"><a href="#MTLAccuracy.on_validation_batch_end-133"><span class="linenos">133</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="MTLAccuracy.on_validation_batch_end-134"><a href="#MTLAccuracy.on_validation_batch_end-134"><span class="linenos">134</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_validation_batch_end-135"><a href="#MTLAccuracy.on_validation_batch_end-135"><span class="linenos">135</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_validation_batch_end-136"><a href="#MTLAccuracy.on_validation_batch_end-136"><span class="linenos">136</span></a>        <span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_validation_batch_end-137"><a href="#MTLAccuracy.on_validation_batch_end-137"><span class="linenos">137</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy.on_validation_batch_end-138"><a href="#MTLAccuracy.on_validation_batch_end-138"><span class="linenos">138</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from validation batch. We don&#39;t need to log and monitor the metrics of validation batches.</span>
</span><span id="MTLAccuracy.on_validation_batch_end-139"><a href="#MTLAccuracy.on_validation_batch_end-139"><span class="linenos">139</span></a>
</span><span id="MTLAccuracy.on_validation_batch_end-140"><a href="#MTLAccuracy.on_validation_batch_end-140"><span class="linenos">140</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLAccuracy.on_validation_batch_end-141"><a href="#MTLAccuracy.on_validation_batch_end-141"><span class="linenos">141</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the validation step, which is the returns of the `validation_step()` method in the `MTLAlgorithm`.</span>
</span><span id="MTLAccuracy.on_validation_batch_end-142"><a href="#MTLAccuracy.on_validation_batch_end-142"><span class="linenos">142</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="MTLAccuracy.on_validation_batch_end-143"><a href="#MTLAccuracy.on_validation_batch_end-143"><span class="linenos">143</span></a><span class="sd">        - **dataloader_idx** (`int`): the task ID of the validation dataloader. A default value of 0 is given otherwise the LightningModule will raise a `RuntimeError`.</span>
</span><span id="MTLAccuracy.on_validation_batch_end-144"><a href="#MTLAccuracy.on_validation_batch_end-144"><span class="linenos">144</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLAccuracy.on_validation_batch_end-145"><a href="#MTLAccuracy.on_validation_batch_end-145"><span class="linenos">145</span></a>
</span><span id="MTLAccuracy.on_validation_batch_end-146"><a href="#MTLAccuracy.on_validation_batch_end-146"><span class="linenos">146</span></a>        <span class="c1"># get the batch size</span>
</span><span id="MTLAccuracy.on_validation_batch_end-147"><a href="#MTLAccuracy.on_validation_batch_end-147"><span class="linenos">147</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="MTLAccuracy.on_validation_batch_end-148"><a href="#MTLAccuracy.on_validation_batch_end-148"><span class="linenos">148</span></a>
</span><span id="MTLAccuracy.on_validation_batch_end-149"><a href="#MTLAccuracy.on_validation_batch_end-149"><span class="linenos">149</span></a>        <span class="n">val_task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">get_val_task_id_from_dataloader_idx</span><span class="p">(</span><span class="n">dataloader_idx</span><span class="p">)</span>
</span><span id="MTLAccuracy.on_validation_batch_end-150"><a href="#MTLAccuracy.on_validation_batch_end-150"><span class="linenos">150</span></a>
</span><span id="MTLAccuracy.on_validation_batch_end-151"><a href="#MTLAccuracy.on_validation_batch_end-151"><span class="linenos">151</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="MTLAccuracy.on_validation_batch_end-152"><a href="#MTLAccuracy.on_validation_batch_end-152"><span class="linenos">152</span></a>        <span class="n">acc_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
</span><span id="MTLAccuracy.on_validation_batch_end-153"><a href="#MTLAccuracy.on_validation_batch_end-153"><span class="linenos">153</span></a>
</span><span id="MTLAccuracy.on_validation_batch_end-154"><a href="#MTLAccuracy.on_validation_batch_end-154"><span class="linenos">154</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the validation metrics</span>
</span><span id="MTLAccuracy.on_validation_batch_end-155"><a href="#MTLAccuracy.on_validation_batch_end-155"><span class="linenos">155</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span><span class="p">[</span><span class="n">val_task_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Accumulating metrics from validation batch. We don't need to log and monitor the metrics of validation batches.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the validation step, which is the returns of the <code>validation_step()</code> method in the <code>MTLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the validation data batch.</li>
<li><strong>dataloader_idx</strong> (<code>int</code>): the task ID of the validation dataloader. A default value of 0 is given otherwise the LightningModule will raise a <code>RuntimeError</code>.</li>
</ul>
</div>


                            </div>
                            <div id="MTLAccuracy.on_test_start" class="classattr">
                                        <input id="MTLAccuracy.on_test_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_test_start</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="mtl_algorithms/base.html#MTLAlgorithm">clarena.mtl_algorithms.base.MTLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLAccuracy.on_test_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLAccuracy.on_test_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLAccuracy.on_test_start-157"><a href="#MTLAccuracy.on_test_start-157"><span class="linenos">157</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_start</span><span class="p">(</span>
</span><span id="MTLAccuracy.on_test_start-158"><a href="#MTLAccuracy.on_test_start-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_test_start-159"><a href="#MTLAccuracy.on_test_start-159"><span class="linenos">159</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_test_start-160"><a href="#MTLAccuracy.on_test_start-160"><span class="linenos">160</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_test_start-161"><a href="#MTLAccuracy.on_test_start-161"><span class="linenos">161</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy.on_test_start-162"><a href="#MTLAccuracy.on_test_start-162"><span class="linenos">162</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the metrics for testing each seen task in the beginning of a task&#39;s testing.&quot;&quot;&quot;</span>
</span><span id="MTLAccuracy.on_test_start-163"><a href="#MTLAccuracy.on_test_start-163"><span class="linenos">163</span></a>
</span><span id="MTLAccuracy.on_test_start-164"><a href="#MTLAccuracy.on_test_start-164"><span class="linenos">164</span></a>        <span class="c1"># initialize test metrics for current and previous tasks</span>
</span><span id="MTLAccuracy.on_test_start-165"><a href="#MTLAccuracy.on_test_start-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="MTLAccuracy.on_test_start-166"><a href="#MTLAccuracy.on_test_start-166"><span class="linenos">166</span></a>            <span class="n">task_id</span><span class="p">:</span> <span class="n">MeanMetricBatch</span><span class="p">()</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">trainer</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">eval_tasks</span>
</span><span id="MTLAccuracy.on_test_start-167"><a href="#MTLAccuracy.on_test_start-167"><span class="linenos">167</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the metrics for testing each seen task in the beginning of a task's testing.</p>
</div>


                            </div>
                            <div id="MTLAccuracy.on_test_batch_end" class="classattr">
                                        <input id="MTLAccuracy.on_test_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_test_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="mtl_algorithms/base.html#MTLAlgorithm">clarena.mtl_algorithms.base.MTLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLAccuracy.on_test_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLAccuracy.on_test_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLAccuracy.on_test_batch_end-169"><a href="#MTLAccuracy.on_test_batch_end-169"><span class="linenos">169</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_batch_end</span><span class="p">(</span>
</span><span id="MTLAccuracy.on_test_batch_end-170"><a href="#MTLAccuracy.on_test_batch_end-170"><span class="linenos">170</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_test_batch_end-171"><a href="#MTLAccuracy.on_test_batch_end-171"><span class="linenos">171</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_test_batch_end-172"><a href="#MTLAccuracy.on_test_batch_end-172"><span class="linenos">172</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_test_batch_end-173"><a href="#MTLAccuracy.on_test_batch_end-173"><span class="linenos">173</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="MTLAccuracy.on_test_batch_end-174"><a href="#MTLAccuracy.on_test_batch_end-174"><span class="linenos">174</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_test_batch_end-175"><a href="#MTLAccuracy.on_test_batch_end-175"><span class="linenos">175</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_test_batch_end-176"><a href="#MTLAccuracy.on_test_batch_end-176"><span class="linenos">176</span></a>        <span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_test_batch_end-177"><a href="#MTLAccuracy.on_test_batch_end-177"><span class="linenos">177</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy.on_test_batch_end-178"><a href="#MTLAccuracy.on_test_batch_end-178"><span class="linenos">178</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from test batch. We don&#39;t need to log and monitor the metrics of test batches.</span>
</span><span id="MTLAccuracy.on_test_batch_end-179"><a href="#MTLAccuracy.on_test_batch_end-179"><span class="linenos">179</span></a>
</span><span id="MTLAccuracy.on_test_batch_end-180"><a href="#MTLAccuracy.on_test_batch_end-180"><span class="linenos">180</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLAccuracy.on_test_batch_end-181"><a href="#MTLAccuracy.on_test_batch_end-181"><span class="linenos">181</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the test step, which is the returns of the `test_step()` method in the `MTLAlgorithm`.</span>
</span><span id="MTLAccuracy.on_test_batch_end-182"><a href="#MTLAccuracy.on_test_batch_end-182"><span class="linenos">182</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="MTLAccuracy.on_test_batch_end-183"><a href="#MTLAccuracy.on_test_batch_end-183"><span class="linenos">183</span></a><span class="sd">        - **dataloader_idx** (`int`): the task ID of seen tasks to be tested. A default value of 0 is given otherwise the LightningModule will raise a `RuntimeError`.</span>
</span><span id="MTLAccuracy.on_test_batch_end-184"><a href="#MTLAccuracy.on_test_batch_end-184"><span class="linenos">184</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLAccuracy.on_test_batch_end-185"><a href="#MTLAccuracy.on_test_batch_end-185"><span class="linenos">185</span></a>
</span><span id="MTLAccuracy.on_test_batch_end-186"><a href="#MTLAccuracy.on_test_batch_end-186"><span class="linenos">186</span></a>        <span class="c1"># get the batch size</span>
</span><span id="MTLAccuracy.on_test_batch_end-187"><a href="#MTLAccuracy.on_test_batch_end-187"><span class="linenos">187</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="MTLAccuracy.on_test_batch_end-188"><a href="#MTLAccuracy.on_test_batch_end-188"><span class="linenos">188</span></a>
</span><span id="MTLAccuracy.on_test_batch_end-189"><a href="#MTLAccuracy.on_test_batch_end-189"><span class="linenos">189</span></a>        <span class="n">test_task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">get_test_task_id_from_dataloader_idx</span><span class="p">(</span><span class="n">dataloader_idx</span><span class="p">)</span>
</span><span id="MTLAccuracy.on_test_batch_end-190"><a href="#MTLAccuracy.on_test_batch_end-190"><span class="linenos">190</span></a>
</span><span id="MTLAccuracy.on_test_batch_end-191"><a href="#MTLAccuracy.on_test_batch_end-191"><span class="linenos">191</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="MTLAccuracy.on_test_batch_end-192"><a href="#MTLAccuracy.on_test_batch_end-192"><span class="linenos">192</span></a>        <span class="n">acc_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
</span><span id="MTLAccuracy.on_test_batch_end-193"><a href="#MTLAccuracy.on_test_batch_end-193"><span class="linenos">193</span></a>
</span><span id="MTLAccuracy.on_test_batch_end-194"><a href="#MTLAccuracy.on_test_batch_end-194"><span class="linenos">194</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the metrics of the epoch</span>
</span><span id="MTLAccuracy.on_test_batch_end-195"><a href="#MTLAccuracy.on_test_batch_end-195"><span class="linenos">195</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="p">[</span><span class="n">test_task_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Accumulating metrics from test batch. We don't need to log and monitor the metrics of test batches.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the test step, which is the returns of the <code>test_step()</code> method in the <code>MTLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the validation data batch.</li>
<li><strong>dataloader_idx</strong> (<code>int</code>): the task ID of seen tasks to be tested. A default value of 0 is given otherwise the LightningModule will raise a <code>RuntimeError</code>.</li>
</ul>
</div>


                            </div>
                            <div id="MTLAccuracy.on_test_epoch_end" class="classattr">
                                        <input id="MTLAccuracy.on_test_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_test_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="mtl_algorithms/base.html#MTLAlgorithm">clarena.mtl_algorithms.base.MTLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLAccuracy.on_test_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLAccuracy.on_test_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLAccuracy.on_test_epoch_end-197"><a href="#MTLAccuracy.on_test_epoch_end-197"><span class="linenos">197</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_epoch_end</span><span class="p">(</span>
</span><span id="MTLAccuracy.on_test_epoch_end-198"><a href="#MTLAccuracy.on_test_epoch_end-198"><span class="linenos">198</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_test_epoch_end-199"><a href="#MTLAccuracy.on_test_epoch_end-199"><span class="linenos">199</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_test_epoch_end-200"><a href="#MTLAccuracy.on_test_epoch_end-200"><span class="linenos">200</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_test_epoch_end-201"><a href="#MTLAccuracy.on_test_epoch_end-201"><span class="linenos">201</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy.on_test_epoch_end-202"><a href="#MTLAccuracy.on_test_epoch_end-202"><span class="linenos">202</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save and plot test metrics at the end of test.&quot;&quot;&quot;</span>
</span><span id="MTLAccuracy.on_test_epoch_end-203"><a href="#MTLAccuracy.on_test_epoch_end-203"><span class="linenos">203</span></a>
</span><span id="MTLAccuracy.on_test_epoch_end-204"><a href="#MTLAccuracy.on_test_epoch_end-204"><span class="linenos">204</span></a>        <span class="c1"># save (update) the test metrics to CSV files</span>
</span><span id="MTLAccuracy.on_test_epoch_end-205"><a href="#MTLAccuracy.on_test_epoch_end-205"><span class="linenos">205</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_test_acc_to_csv</span><span class="p">(</span>
</span><span id="MTLAccuracy.on_test_epoch_end-206"><a href="#MTLAccuracy.on_test_epoch_end-206"><span class="linenos">206</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_acc_csv_path</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_test_epoch_end-207"><a href="#MTLAccuracy.on_test_epoch_end-207"><span class="linenos">207</span></a>        <span class="p">)</span>
</span><span id="MTLAccuracy.on_test_epoch_end-208"><a href="#MTLAccuracy.on_test_epoch_end-208"><span class="linenos">208</span></a>
</span><span id="MTLAccuracy.on_test_epoch_end-209"><a href="#MTLAccuracy.on_test_epoch_end-209"><span class="linenos">209</span></a>        <span class="c1"># plot the test metrics</span>
</span><span id="MTLAccuracy.on_test_epoch_end-210"><a href="#MTLAccuracy.on_test_epoch_end-210"><span class="linenos">210</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_acc_plot_path</span><span class="p">:</span>
</span><span id="MTLAccuracy.on_test_epoch_end-211"><a href="#MTLAccuracy.on_test_epoch_end-211"><span class="linenos">211</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plot_test_acc_from_csv</span><span class="p">(</span>
</span><span id="MTLAccuracy.on_test_epoch_end-212"><a href="#MTLAccuracy.on_test_epoch_end-212"><span class="linenos">212</span></a>                <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_acc_csv_path</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_test_epoch_end-213"><a href="#MTLAccuracy.on_test_epoch_end-213"><span class="linenos">213</span></a>                <span class="n">plot_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_acc_plot_path</span><span class="p">,</span>
</span><span id="MTLAccuracy.on_test_epoch_end-214"><a href="#MTLAccuracy.on_test_epoch_end-214"><span class="linenos">214</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save and plot test metrics at the end of test.</p>
</div>


                            </div>
                            <div id="MTLAccuracy.save_test_acc_to_csv" class="classattr">
                                        <input id="MTLAccuracy.save_test_acc_to_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_test_acc_to_csv</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLAccuracy.save_test_acc_to_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLAccuracy.save_test_acc_to_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLAccuracy.save_test_acc_to_csv-216"><a href="#MTLAccuracy.save_test_acc_to_csv-216"><span class="linenos">216</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_test_acc_to_csv</span><span class="p">(</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-217"><a href="#MTLAccuracy.save_test_acc_to_csv-217"><span class="linenos">217</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-218"><a href="#MTLAccuracy.save_test_acc_to_csv-218"><span class="linenos">218</span></a>        <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-219"><a href="#MTLAccuracy.save_test_acc_to_csv-219"><span class="linenos">219</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-220"><a href="#MTLAccuracy.save_test_acc_to_csv-220"><span class="linenos">220</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save the test accuracy metrics of all tasks in multi-task learning to an CSV file.</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-221"><a href="#MTLAccuracy.save_test_acc_to_csv-221"><span class="linenos">221</span></a>
</span><span id="MTLAccuracy.save_test_acc_to_csv-222"><a href="#MTLAccuracy.save_test_acc_to_csv-222"><span class="linenos">222</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-223"><a href="#MTLAccuracy.save_test_acc_to_csv-223"><span class="linenos">223</span></a><span class="sd">        - **csv_path** (`str`): save the test metric to path. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/acc.csv&#39;.</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-224"><a href="#MTLAccuracy.save_test_acc_to_csv-224"><span class="linenos">224</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-225"><a href="#MTLAccuracy.save_test_acc_to_csv-225"><span class="linenos">225</span></a>        <span class="n">all_task_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-226"><a href="#MTLAccuracy.save_test_acc_to_csv-226"><span class="linenos">226</span></a>        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;average_accuracy&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-227"><a href="#MTLAccuracy.save_test_acc_to_csv-227"><span class="linenos">227</span></a>            <span class="sa">f</span><span class="s2">&quot;test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">all_task_ids</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-228"><a href="#MTLAccuracy.save_test_acc_to_csv-228"><span class="linenos">228</span></a>        <span class="p">]</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-229"><a href="#MTLAccuracy.save_test_acc_to_csv-229"><span class="linenos">229</span></a>        <span class="n">new_line</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-230"><a href="#MTLAccuracy.save_test_acc_to_csv-230"><span class="linenos">230</span></a>
</span><span id="MTLAccuracy.save_test_acc_to_csv-231"><a href="#MTLAccuracy.save_test_acc_to_csv-231"><span class="linenos">231</span></a>        <span class="c1"># construct the columns and calculate the average accuracy over tasks at the same time</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-232"><a href="#MTLAccuracy.save_test_acc_to_csv-232"><span class="linenos">232</span></a>        <span class="n">average_accuracy_over_tasks</span> <span class="o">=</span> <span class="n">MeanMetric</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-233"><a href="#MTLAccuracy.save_test_acc_to_csv-233"><span class="linenos">233</span></a>            <span class="n">device</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">device</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-234"><a href="#MTLAccuracy.save_test_acc_to_csv-234"><span class="linenos">234</span></a>        <span class="p">)</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-235"><a href="#MTLAccuracy.save_test_acc_to_csv-235"><span class="linenos">235</span></a>        <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">all_task_ids</span><span class="p">:</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-236"><a href="#MTLAccuracy.save_test_acc_to_csv-236"><span class="linenos">236</span></a>            <span class="n">acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-237"><a href="#MTLAccuracy.save_test_acc_to_csv-237"><span class="linenos">237</span></a>            <span class="n">new_line</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-238"><a href="#MTLAccuracy.save_test_acc_to_csv-238"><span class="linenos">238</span></a>            <span class="n">average_accuracy_over_tasks</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-239"><a href="#MTLAccuracy.save_test_acc_to_csv-239"><span class="linenos">239</span></a>        <span class="n">new_line</span><span class="p">[</span><span class="s2">&quot;average_accuracy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">average_accuracy_over_tasks</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-240"><a href="#MTLAccuracy.save_test_acc_to_csv-240"><span class="linenos">240</span></a>
</span><span id="MTLAccuracy.save_test_acc_to_csv-241"><a href="#MTLAccuracy.save_test_acc_to_csv-241"><span class="linenos">241</span></a>        <span class="c1"># write</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-242"><a href="#MTLAccuracy.save_test_acc_to_csv-242"><span class="linenos">242</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-243"><a href="#MTLAccuracy.save_test_acc_to_csv-243"><span class="linenos">243</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-244"><a href="#MTLAccuracy.save_test_acc_to_csv-244"><span class="linenos">244</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="MTLAccuracy.save_test_acc_to_csv-245"><a href="#MTLAccuracy.save_test_acc_to_csv-245"><span class="linenos">245</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save the test accuracy metrics of all tasks in multi-task learning to an CSV file.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>csv_path</strong> (<code>str</code>): save the test metric to path. E.g. './outputs/expr_name/1970-01-01_00-00-00/results/acc.csv'.</li>
</ul>
</div>


                            </div>
                            <div id="MTLAccuracy.plot_test_acc_from_csv" class="classattr">
                                        <input id="MTLAccuracy.plot_test_acc_from_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_test_acc_from_csv</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLAccuracy.plot_test_acc_from_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLAccuracy.plot_test_acc_from_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLAccuracy.plot_test_acc_from_csv-247"><a href="#MTLAccuracy.plot_test_acc_from_csv-247"><span class="linenos">247</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_test_acc_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-248"><a href="#MTLAccuracy.plot_test_acc_from_csv-248"><span class="linenos">248</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the test accuracy bar chart of all tasks in multi-task learning from saved CSV file and save the plot to the designated directory.</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-249"><a href="#MTLAccuracy.plot_test_acc_from_csv-249"><span class="linenos">249</span></a>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-250"><a href="#MTLAccuracy.plot_test_acc_from_csv-250"><span class="linenos">250</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-251"><a href="#MTLAccuracy.plot_test_acc_from_csv-251"><span class="linenos">251</span></a><span class="sd">        - **csv_path** (`str`): the path to the csv file where the `utils.save_test_acc_csv()` saved the test accuracy metric.</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-252"><a href="#MTLAccuracy.plot_test_acc_from_csv-252"><span class="linenos">252</span></a><span class="sd">        - **plot_path** (`str`): the path to save plot. Better same as the output directory of the experiment. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/acc.png&#39;.</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-253"><a href="#MTLAccuracy.plot_test_acc_from_csv-253"><span class="linenos">253</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-254"><a href="#MTLAccuracy.plot_test_acc_from_csv-254"><span class="linenos">254</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-255"><a href="#MTLAccuracy.plot_test_acc_from_csv-255"><span class="linenos">255</span></a>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-256"><a href="#MTLAccuracy.plot_test_acc_from_csv-256"><span class="linenos">256</span></a>        <span class="c1"># extract all accuracy columns including average</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-257"><a href="#MTLAccuracy.plot_test_acc_from_csv-257"><span class="linenos">257</span></a>        <span class="n">all_columns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-258"><a href="#MTLAccuracy.plot_test_acc_from_csv-258"><span class="linenos">258</span></a>        <span class="n">task_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_columns</span><span class="p">)))</span>  <span class="c1"># assign index-based positions</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-259"><a href="#MTLAccuracy.plot_test_acc_from_csv-259"><span class="linenos">259</span></a>        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-260"><a href="#MTLAccuracy.plot_test_acc_from_csv-260"><span class="linenos">260</span></a>            <span class="p">(</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-261"><a href="#MTLAccuracy.plot_test_acc_from_csv-261"><span class="linenos">261</span></a>                <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;test_on_task_&quot;</span><span class="p">,</span> <span class="s2">&quot;Task &quot;</span><span class="p">)</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-262"><a href="#MTLAccuracy.plot_test_acc_from_csv-262"><span class="linenos">262</span></a>                <span class="k">if</span> <span class="s2">&quot;test_on_task_&quot;</span> <span class="ow">in</span> <span class="n">col</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-263"><a href="#MTLAccuracy.plot_test_acc_from_csv-263"><span class="linenos">263</span></a>                <span class="k">else</span> <span class="s2">&quot;Average&quot;</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-264"><a href="#MTLAccuracy.plot_test_acc_from_csv-264"><span class="linenos">264</span></a>            <span class="p">)</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-265"><a href="#MTLAccuracy.plot_test_acc_from_csv-265"><span class="linenos">265</span></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">all_columns</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-266"><a href="#MTLAccuracy.plot_test_acc_from_csv-266"><span class="linenos">266</span></a>        <span class="p">]</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-267"><a href="#MTLAccuracy.plot_test_acc_from_csv-267"><span class="linenos">267</span></a>        <span class="n">accuracies</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">all_columns</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-268"><a href="#MTLAccuracy.plot_test_acc_from_csv-268"><span class="linenos">268</span></a>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-269"><a href="#MTLAccuracy.plot_test_acc_from_csv-269"><span class="linenos">269</span></a>        <span class="c1"># plot the accuracy bar chart over tasks</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-270"><a href="#MTLAccuracy.plot_test_acc_from_csv-270"><span class="linenos">270</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-271"><a href="#MTLAccuracy.plot_test_acc_from_csv-271"><span class="linenos">271</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-272"><a href="#MTLAccuracy.plot_test_acc_from_csv-272"><span class="linenos">272</span></a>            <span class="n">task_ids</span><span class="p">,</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-273"><a href="#MTLAccuracy.plot_test_acc_from_csv-273"><span class="linenos">273</span></a>            <span class="n">accuracies</span><span class="p">,</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-274"><a href="#MTLAccuracy.plot_test_acc_from_csv-274"><span class="linenos">274</span></a>            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;skyblue&quot;</span><span class="p">,</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-275"><a href="#MTLAccuracy.plot_test_acc_from_csv-275"><span class="linenos">275</span></a>            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-276"><a href="#MTLAccuracy.plot_test_acc_from_csv-276"><span class="linenos">276</span></a>        <span class="p">)</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-277"><a href="#MTLAccuracy.plot_test_acc_from_csv-277"><span class="linenos">277</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Task&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-278"><a href="#MTLAccuracy.plot_test_acc_from_csv-278"><span class="linenos">278</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-279"><a href="#MTLAccuracy.plot_test_acc_from_csv-279"><span class="linenos">279</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-280"><a href="#MTLAccuracy.plot_test_acc_from_csv-280"><span class="linenos">280</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">task_ids</span><span class="p">)</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-281"><a href="#MTLAccuracy.plot_test_acc_from_csv-281"><span class="linenos">281</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-282"><a href="#MTLAccuracy.plot_test_acc_from_csv-282"><span class="linenos">282</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="n">i</span> <span class="o">*</span> <span class="mf">0.05</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">)])</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-283"><a href="#MTLAccuracy.plot_test_acc_from_csv-283"><span class="linenos">283</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-284"><a href="#MTLAccuracy.plot_test_acc_from_csv-284"><span class="linenos">284</span></a>            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mf">0.05</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">)]],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-285"><a href="#MTLAccuracy.plot_test_acc_from_csv-285"><span class="linenos">285</span></a>        <span class="p">)</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-286"><a href="#MTLAccuracy.plot_test_acc_from_csv-286"><span class="linenos">286</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-287"><a href="#MTLAccuracy.plot_test_acc_from_csv-287"><span class="linenos">287</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="MTLAccuracy.plot_test_acc_from_csv-288"><a href="#MTLAccuracy.plot_test_acc_from_csv-288"><span class="linenos">288</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plot the test accuracy bar chart of all tasks in multi-task learning from saved CSV file and save the plot to the designated directory.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>csv_path</strong> (<code>str</code>): the path to the csv file where the <code>utils.save_test_acc_csv()</code> saved the test accuracy metric.</li>
<li><strong>plot_path</strong> (<code>str</code>): the path to save plot. Better same as the output directory of the experiment. E.g. './outputs/expr_name/1970-01-01_00-00-00/acc.png'.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="MTLLoss">
                            <input id="MTLLoss-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MTLLoss</span><wbr>(<span class="base"><a href="#MetricCallback">clarena.metrics.MetricCallback</a></span>):

                <label class="view-source-button" for="MTLLoss-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLLoss"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLLoss-26"><a href="#MTLLoss-26"><span class="linenos"> 26</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MTLLoss</span><span class="p">(</span><span class="n">MetricCallback</span><span class="p">):</span>
</span><span id="MTLLoss-27"><a href="#MTLLoss-27"><span class="linenos"> 27</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Provides all actions that are related to MTL loss metrics, which include:</span>
</span><span id="MTLLoss-28"><a href="#MTLLoss-28"><span class="linenos"> 28</span></a>
</span><span id="MTLLoss-29"><a href="#MTLLoss-29"><span class="linenos"> 29</span></a><span class="sd">    - Defining, initializing and recording loss metrics.</span>
</span><span id="MTLLoss-30"><a href="#MTLLoss-30"><span class="linenos"> 30</span></a><span class="sd">    - Logging training and validation loss metrics to Lightning loggers in real time.</span>
</span><span id="MTLLoss-31"><a href="#MTLLoss-31"><span class="linenos"> 31</span></a><span class="sd">    - Saving test loss metrics to files.</span>
</span><span id="MTLLoss-32"><a href="#MTLLoss-32"><span class="linenos"> 32</span></a><span class="sd">    - Visualizing test loss metrics as plots.</span>
</span><span id="MTLLoss-33"><a href="#MTLLoss-33"><span class="linenos"> 33</span></a>
</span><span id="MTLLoss-34"><a href="#MTLLoss-34"><span class="linenos"> 34</span></a><span class="sd">    The callback is able to produce the following outputs:</span>
</span><span id="MTLLoss-35"><a href="#MTLLoss-35"><span class="linenos"> 35</span></a>
</span><span id="MTLLoss-36"><a href="#MTLLoss-36"><span class="linenos"> 36</span></a><span class="sd">    - CSV files for test classification loss of all tasks and average classification loss.</span>
</span><span id="MTLLoss-37"><a href="#MTLLoss-37"><span class="linenos"> 37</span></a><span class="sd">    - Bar charts for test classification loss of all tasks.</span>
</span><span id="MTLLoss-38"><a href="#MTLLoss-38"><span class="linenos"> 38</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="MTLLoss-39"><a href="#MTLLoss-39"><span class="linenos"> 39</span></a>
</span><span id="MTLLoss-40"><a href="#MTLLoss-40"><span class="linenos"> 40</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="MTLLoss-41"><a href="#MTLLoss-41"><span class="linenos"> 41</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLLoss-42"><a href="#MTLLoss-42"><span class="linenos"> 42</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MTLLoss-43"><a href="#MTLLoss-43"><span class="linenos"> 43</span></a>        <span class="n">test_loss_cls_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;loss_cls.csv&quot;</span><span class="p">,</span>
</span><span id="MTLLoss-44"><a href="#MTLLoss-44"><span class="linenos"> 44</span></a>        <span class="n">test_loss_cls_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MTLLoss-45"><a href="#MTLLoss-45"><span class="linenos"> 45</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss-46"><a href="#MTLLoss-46"><span class="linenos"> 46</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `MTLLoss`.</span>
</span><span id="MTLLoss-47"><a href="#MTLLoss-47"><span class="linenos"> 47</span></a>
</span><span id="MTLLoss-48"><a href="#MTLLoss-48"><span class="linenos"> 48</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLLoss-49"><a href="#MTLLoss-49"><span class="linenos"> 49</span></a><span class="sd">        - **save_dir** (`str`): The directory where data and figures of metrics will be saved. Better inside the output folder.</span>
</span><span id="MTLLoss-50"><a href="#MTLLoss-50"><span class="linenos"> 50</span></a><span class="sd">        - **test_loss_cls_csv_name**(`str`): file name to save classification loss of all tasks and average classification loss as CSV file.</span>
</span><span id="MTLLoss-51"><a href="#MTLLoss-51"><span class="linenos"> 51</span></a><span class="sd">        - **test_loss_cls_plot_name** (`str` | `None`): file name to save classification loss plot. If `None`, no file will be saved.</span>
</span><span id="MTLLoss-52"><a href="#MTLLoss-52"><span class="linenos"> 52</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLLoss-53"><a href="#MTLLoss-53"><span class="linenos"> 53</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="MTLLoss-54"><a href="#MTLLoss-54"><span class="linenos"> 54</span></a>
</span><span id="MTLLoss-55"><a href="#MTLLoss-55"><span class="linenos"> 55</span></a>        <span class="c1"># paths</span>
</span><span id="MTLLoss-56"><a href="#MTLLoss-56"><span class="linenos"> 56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_csv_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="MTLLoss-57"><a href="#MTLLoss-57"><span class="linenos"> 57</span></a>            <span class="n">save_dir</span><span class="p">,</span> <span class="n">test_loss_cls_csv_name</span>
</span><span id="MTLLoss-58"><a href="#MTLLoss-58"><span class="linenos"> 58</span></a>        <span class="p">)</span>
</span><span id="MTLLoss-59"><a href="#MTLLoss-59"><span class="linenos"> 59</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The path to save test classification loss of all tasks and average classification loss CSV file.&quot;&quot;&quot;</span>
</span><span id="MTLLoss-60"><a href="#MTLLoss-60"><span class="linenos"> 60</span></a>        <span class="k">if</span> <span class="n">test_loss_cls_plot_name</span><span class="p">:</span>
</span><span id="MTLLoss-61"><a href="#MTLLoss-61"><span class="linenos"> 61</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_plot_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="MTLLoss-62"><a href="#MTLLoss-62"><span class="linenos"> 62</span></a>                <span class="n">save_dir</span><span class="p">,</span> <span class="n">test_loss_cls_plot_name</span>
</span><span id="MTLLoss-63"><a href="#MTLLoss-63"><span class="linenos"> 63</span></a>            <span class="p">)</span>
</span><span id="MTLLoss-64"><a href="#MTLLoss-64"><span class="linenos"> 64</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The path to save test classification loss plot.&quot;&quot;&quot;</span>
</span><span id="MTLLoss-65"><a href="#MTLLoss-65"><span class="linenos"> 65</span></a>
</span><span id="MTLLoss-66"><a href="#MTLLoss-66"><span class="linenos"> 66</span></a>        <span class="c1"># training accumulated metrics</span>
</span><span id="MTLLoss-67"><a href="#MTLLoss-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="MTLLoss-68"><a href="#MTLLoss-68"><span class="linenos"> 68</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Classification loss of training epoch. Accumulated and calculated from the training batches. &quot;&quot;&quot;</span>
</span><span id="MTLLoss-69"><a href="#MTLLoss-69"><span class="linenos"> 69</span></a>
</span><span id="MTLLoss-70"><a href="#MTLLoss-70"><span class="linenos"> 70</span></a>        <span class="c1"># validation accumulated metrics</span>
</span><span id="MTLLoss-71"><a href="#MTLLoss-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MTLLoss-72"><a href="#MTLLoss-72"><span class="linenos"> 72</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Validation classification loss of the model after training epoch. Accumulated and calculated from the validation batches. Keys are task IDs and values are the corresponding metrics. &quot;&quot;&quot;</span>
</span><span id="MTLLoss-73"><a href="#MTLLoss-73"><span class="linenos"> 73</span></a>
</span><span id="MTLLoss-74"><a href="#MTLLoss-74"><span class="linenos"> 74</span></a>        <span class="c1"># test accumulated metrics</span>
</span><span id="MTLLoss-75"><a href="#MTLLoss-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MTLLoss-76"><a href="#MTLLoss-76"><span class="linenos"> 76</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Test classification loss of all tasks. Accumulated and calculated from the test batches. Keys are task IDs and values are the corresponding metrics. &quot;&quot;&quot;</span>
</span><span id="MTLLoss-77"><a href="#MTLLoss-77"><span class="linenos"> 77</span></a>
</span><span id="MTLLoss-78"><a href="#MTLLoss-78"><span class="linenos"> 78</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_fit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss-79"><a href="#MTLLoss-79"><span class="linenos"> 79</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize training and validation metrics.&quot;&quot;&quot;</span>
</span><span id="MTLLoss-80"><a href="#MTLLoss-80"><span class="linenos"> 80</span></a>
</span><span id="MTLLoss-81"><a href="#MTLLoss-81"><span class="linenos"> 81</span></a>        <span class="c1"># initialize training metrics</span>
</span><span id="MTLLoss-82"><a href="#MTLLoss-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span>
</span><span id="MTLLoss-83"><a href="#MTLLoss-83"><span class="linenos"> 83</span></a>
</span><span id="MTLLoss-84"><a href="#MTLLoss-84"><span class="linenos"> 84</span></a>        <span class="c1"># initialize validation metrics</span>
</span><span id="MTLLoss-85"><a href="#MTLLoss-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="MTLLoss-86"><a href="#MTLLoss-86"><span class="linenos"> 86</span></a>            <span class="n">task_id</span><span class="p">:</span> <span class="n">MeanMetricBatch</span><span class="p">()</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">trainer</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">train_tasks</span>
</span><span id="MTLLoss-87"><a href="#MTLLoss-87"><span class="linenos"> 87</span></a>        <span class="p">}</span>
</span><span id="MTLLoss-88"><a href="#MTLLoss-88"><span class="linenos"> 88</span></a>
</span><span id="MTLLoss-89"><a href="#MTLLoss-89"><span class="linenos"> 89</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span>
</span><span id="MTLLoss-90"><a href="#MTLLoss-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLLoss-91"><a href="#MTLLoss-91"><span class="linenos"> 91</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLLoss-92"><a href="#MTLLoss-92"><span class="linenos"> 92</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLLoss-93"><a href="#MTLLoss-93"><span class="linenos"> 93</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="MTLLoss-94"><a href="#MTLLoss-94"><span class="linenos"> 94</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="MTLLoss-95"><a href="#MTLLoss-95"><span class="linenos"> 95</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="MTLLoss-96"><a href="#MTLLoss-96"><span class="linenos"> 96</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss-97"><a href="#MTLLoss-97"><span class="linenos"> 97</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Record training metrics from training batch, log metrics of training batch and accumulated metrics of the epoch to Lightning loggers.</span>
</span><span id="MTLLoss-98"><a href="#MTLLoss-98"><span class="linenos"> 98</span></a>
</span><span id="MTLLoss-99"><a href="#MTLLoss-99"><span class="linenos"> 99</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLLoss-100"><a href="#MTLLoss-100"><span class="linenos">100</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the training step, the returns of the `training_step()` method in the `MTLAlgorithm`.</span>
</span><span id="MTLLoss-101"><a href="#MTLLoss-101"><span class="linenos">101</span></a><span class="sd">        - **batch** (`Any`): the training data batch.</span>
</span><span id="MTLLoss-102"><a href="#MTLLoss-102"><span class="linenos">102</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLLoss-103"><a href="#MTLLoss-103"><span class="linenos">103</span></a>        <span class="c1"># get the batch size</span>
</span><span id="MTLLoss-104"><a href="#MTLLoss-104"><span class="linenos">104</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="MTLLoss-105"><a href="#MTLLoss-105"><span class="linenos">105</span></a>
</span><span id="MTLLoss-106"><a href="#MTLLoss-106"><span class="linenos">106</span></a>        <span class="c1"># get training metrics values of current training batch from the outputs of the `training_step()`</span>
</span><span id="MTLLoss-107"><a href="#MTLLoss-107"><span class="linenos">107</span></a>        <span class="n">loss_cls_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="MTLLoss-108"><a href="#MTLLoss-108"><span class="linenos">108</span></a>
</span><span id="MTLLoss-109"><a href="#MTLLoss-109"><span class="linenos">109</span></a>        <span class="c1"># update accumulated training metrics to calculate training metrics of the epoch</span>
</span><span id="MTLLoss-110"><a href="#MTLLoss-110"><span class="linenos">110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="MTLLoss-111"><a href="#MTLLoss-111"><span class="linenos">111</span></a>
</span><span id="MTLLoss-112"><a href="#MTLLoss-112"><span class="linenos">112</span></a>        <span class="c1"># log training metrics of current training batch to Lightning loggers</span>
</span><span id="MTLLoss-113"><a href="#MTLLoss-113"><span class="linenos">113</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;train/loss_cls_batch&quot;</span><span class="p">,</span> <span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="MTLLoss-114"><a href="#MTLLoss-114"><span class="linenos">114</span></a>
</span><span id="MTLLoss-115"><a href="#MTLLoss-115"><span class="linenos">115</span></a>        <span class="c1"># log accumulated training metrics till this training batch to Lightning loggers</span>
</span><span id="MTLLoss-116"><a href="#MTLLoss-116"><span class="linenos">116</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="MTLLoss-117"><a href="#MTLLoss-117"><span class="linenos">117</span></a>            <span class="s2">&quot;task/train/loss_cls&quot;</span><span class="p">,</span>
</span><span id="MTLLoss-118"><a href="#MTLLoss-118"><span class="linenos">118</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="MTLLoss-119"><a href="#MTLLoss-119"><span class="linenos">119</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="MTLLoss-120"><a href="#MTLLoss-120"><span class="linenos">120</span></a>        <span class="p">)</span>
</span><span id="MTLLoss-121"><a href="#MTLLoss-121"><span class="linenos">121</span></a>
</span><span id="MTLLoss-122"><a href="#MTLLoss-122"><span class="linenos">122</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_epoch_end</span><span class="p">(</span>
</span><span id="MTLLoss-123"><a href="#MTLLoss-123"><span class="linenos">123</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLLoss-124"><a href="#MTLLoss-124"><span class="linenos">124</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLLoss-125"><a href="#MTLLoss-125"><span class="linenos">125</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLLoss-126"><a href="#MTLLoss-126"><span class="linenos">126</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss-127"><a href="#MTLLoss-127"><span class="linenos">127</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log metrics of training epoch to plot learning curves and reset the metrics accumulation at the end of training epoch.&quot;&quot;&quot;</span>
</span><span id="MTLLoss-128"><a href="#MTLLoss-128"><span class="linenos">128</span></a>
</span><span id="MTLLoss-129"><a href="#MTLLoss-129"><span class="linenos">129</span></a>        <span class="c1"># log the accumulated and computed metrics of the epoch to Lightning loggers, specially for plotting learning curves</span>
</span><span id="MTLLoss-130"><a href="#MTLLoss-130"><span class="linenos">130</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="MTLLoss-131"><a href="#MTLLoss-131"><span class="linenos">131</span></a>            <span class="s2">&quot;learning_curve/train/loss_cls&quot;</span><span class="p">,</span>
</span><span id="MTLLoss-132"><a href="#MTLLoss-132"><span class="linenos">132</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="MTLLoss-133"><a href="#MTLLoss-133"><span class="linenos">133</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="MTLLoss-134"><a href="#MTLLoss-134"><span class="linenos">134</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="MTLLoss-135"><a href="#MTLLoss-135"><span class="linenos">135</span></a>        <span class="p">)</span>
</span><span id="MTLLoss-136"><a href="#MTLLoss-136"><span class="linenos">136</span></a>
</span><span id="MTLLoss-137"><a href="#MTLLoss-137"><span class="linenos">137</span></a>        <span class="c1"># reset the metrics of training epoch as there are more epochs to go and not only one epoch like in the validation and test</span>
</span><span id="MTLLoss-138"><a href="#MTLLoss-138"><span class="linenos">138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span><span id="MTLLoss-139"><a href="#MTLLoss-139"><span class="linenos">139</span></a>
</span><span id="MTLLoss-140"><a href="#MTLLoss-140"><span class="linenos">140</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_batch_end</span><span class="p">(</span>
</span><span id="MTLLoss-141"><a href="#MTLLoss-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLLoss-142"><a href="#MTLLoss-142"><span class="linenos">142</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLLoss-143"><a href="#MTLLoss-143"><span class="linenos">143</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLLoss-144"><a href="#MTLLoss-144"><span class="linenos">144</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="MTLLoss-145"><a href="#MTLLoss-145"><span class="linenos">145</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="MTLLoss-146"><a href="#MTLLoss-146"><span class="linenos">146</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="MTLLoss-147"><a href="#MTLLoss-147"><span class="linenos">147</span></a>        <span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="MTLLoss-148"><a href="#MTLLoss-148"><span class="linenos">148</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss-149"><a href="#MTLLoss-149"><span class="linenos">149</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from validation batch. We don&#39;t need to log and monitor the metrics of validation batches.</span>
</span><span id="MTLLoss-150"><a href="#MTLLoss-150"><span class="linenos">150</span></a>
</span><span id="MTLLoss-151"><a href="#MTLLoss-151"><span class="linenos">151</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLLoss-152"><a href="#MTLLoss-152"><span class="linenos">152</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the validation step, which is the returns of the `validation_step()` method in the `MTLAlgorithm`.</span>
</span><span id="MTLLoss-153"><a href="#MTLLoss-153"><span class="linenos">153</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="MTLLoss-154"><a href="#MTLLoss-154"><span class="linenos">154</span></a><span class="sd">        - **dataloader_idx** (`int`): the task ID of the validation dataloader. A default value of 0 is given otherwise the LightningModule will raise a `RuntimeError`.</span>
</span><span id="MTLLoss-155"><a href="#MTLLoss-155"><span class="linenos">155</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLLoss-156"><a href="#MTLLoss-156"><span class="linenos">156</span></a>        <span class="c1"># get the batch size</span>
</span><span id="MTLLoss-157"><a href="#MTLLoss-157"><span class="linenos">157</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="MTLLoss-158"><a href="#MTLLoss-158"><span class="linenos">158</span></a>
</span><span id="MTLLoss-159"><a href="#MTLLoss-159"><span class="linenos">159</span></a>        <span class="c1"># map dataloader index to task id</span>
</span><span id="MTLLoss-160"><a href="#MTLLoss-160"><span class="linenos">160</span></a>        <span class="n">val_task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">get_val_task_id_from_dataloader_idx</span><span class="p">(</span><span class="n">dataloader_idx</span><span class="p">)</span>
</span><span id="MTLLoss-161"><a href="#MTLLoss-161"><span class="linenos">161</span></a>
</span><span id="MTLLoss-162"><a href="#MTLLoss-162"><span class="linenos">162</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="MTLLoss-163"><a href="#MTLLoss-163"><span class="linenos">163</span></a>        <span class="n">loss_cls_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="MTLLoss-164"><a href="#MTLLoss-164"><span class="linenos">164</span></a>
</span><span id="MTLLoss-165"><a href="#MTLLoss-165"><span class="linenos">165</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the validation metrics</span>
</span><span id="MTLLoss-166"><a href="#MTLLoss-166"><span class="linenos">166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="p">[</span><span class="n">val_task_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="MTLLoss-167"><a href="#MTLLoss-167"><span class="linenos">167</span></a>
</span><span id="MTLLoss-168"><a href="#MTLLoss-168"><span class="linenos">168</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_epoch_end</span><span class="p">(</span>
</span><span id="MTLLoss-169"><a href="#MTLLoss-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLLoss-170"><a href="#MTLLoss-170"><span class="linenos">170</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLLoss-171"><a href="#MTLLoss-171"><span class="linenos">171</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLLoss-172"><a href="#MTLLoss-172"><span class="linenos">172</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss-173"><a href="#MTLLoss-173"><span class="linenos">173</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log validation metrics to plot learning curves.&quot;&quot;&quot;</span>
</span><span id="MTLLoss-174"><a href="#MTLLoss-174"><span class="linenos">174</span></a>
</span><span id="MTLLoss-175"><a href="#MTLLoss-175"><span class="linenos">175</span></a>        <span class="c1"># compute average validation loss over tasks for logging learning curves</span>
</span><span id="MTLLoss-176"><a href="#MTLLoss-176"><span class="linenos">176</span></a>        <span class="n">average_val_loss</span> <span class="o">=</span> <span class="n">MeanMetric</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
</span><span id="MTLLoss-177"><a href="#MTLLoss-177"><span class="linenos">177</span></a>            <span class="n">device</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">device</span>
</span><span id="MTLLoss-178"><a href="#MTLLoss-178"><span class="linenos">178</span></a>        <span class="p">)</span>
</span><span id="MTLLoss-179"><a href="#MTLLoss-179"><span class="linenos">179</span></a>        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="MTLLoss-180"><a href="#MTLLoss-180"><span class="linenos">180</span></a>            <span class="n">average_val_loss</span><span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">compute</span><span class="p">())</span>
</span><span id="MTLLoss-181"><a href="#MTLLoss-181"><span class="linenos">181</span></a>
</span><span id="MTLLoss-182"><a href="#MTLLoss-182"><span class="linenos">182</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="MTLLoss-183"><a href="#MTLLoss-183"><span class="linenos">183</span></a>            <span class="s2">&quot;learning_curve/val/loss_cls&quot;</span><span class="p">,</span>
</span><span id="MTLLoss-184"><a href="#MTLLoss-184"><span class="linenos">184</span></a>            <span class="n">average_val_loss</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="MTLLoss-185"><a href="#MTLLoss-185"><span class="linenos">185</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="MTLLoss-186"><a href="#MTLLoss-186"><span class="linenos">186</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="MTLLoss-187"><a href="#MTLLoss-187"><span class="linenos">187</span></a>        <span class="p">)</span>
</span><span id="MTLLoss-188"><a href="#MTLLoss-188"><span class="linenos">188</span></a>
</span><span id="MTLLoss-189"><a href="#MTLLoss-189"><span class="linenos">189</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_start</span><span class="p">(</span>
</span><span id="MTLLoss-190"><a href="#MTLLoss-190"><span class="linenos">190</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLLoss-191"><a href="#MTLLoss-191"><span class="linenos">191</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLLoss-192"><a href="#MTLLoss-192"><span class="linenos">192</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLLoss-193"><a href="#MTLLoss-193"><span class="linenos">193</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss-194"><a href="#MTLLoss-194"><span class="linenos">194</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the metrics for testing each seen task in the beginning of a task&#39;s testing.&quot;&quot;&quot;</span>
</span><span id="MTLLoss-195"><a href="#MTLLoss-195"><span class="linenos">195</span></a>
</span><span id="MTLLoss-196"><a href="#MTLLoss-196"><span class="linenos">196</span></a>        <span class="c1"># initialize test metrics for current and previous tasks</span>
</span><span id="MTLLoss-197"><a href="#MTLLoss-197"><span class="linenos">197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="MTLLoss-198"><a href="#MTLLoss-198"><span class="linenos">198</span></a>            <span class="n">task_id</span><span class="p">:</span> <span class="n">MeanMetricBatch</span><span class="p">()</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">trainer</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">eval_tasks</span>
</span><span id="MTLLoss-199"><a href="#MTLLoss-199"><span class="linenos">199</span></a>        <span class="p">}</span>
</span><span id="MTLLoss-200"><a href="#MTLLoss-200"><span class="linenos">200</span></a>
</span><span id="MTLLoss-201"><a href="#MTLLoss-201"><span class="linenos">201</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_batch_end</span><span class="p">(</span>
</span><span id="MTLLoss-202"><a href="#MTLLoss-202"><span class="linenos">202</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLLoss-203"><a href="#MTLLoss-203"><span class="linenos">203</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLLoss-204"><a href="#MTLLoss-204"><span class="linenos">204</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLLoss-205"><a href="#MTLLoss-205"><span class="linenos">205</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="MTLLoss-206"><a href="#MTLLoss-206"><span class="linenos">206</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="MTLLoss-207"><a href="#MTLLoss-207"><span class="linenos">207</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="MTLLoss-208"><a href="#MTLLoss-208"><span class="linenos">208</span></a>        <span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="MTLLoss-209"><a href="#MTLLoss-209"><span class="linenos">209</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss-210"><a href="#MTLLoss-210"><span class="linenos">210</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from test batch. We don&#39;t need to log and monitor the metrics of test batches.</span>
</span><span id="MTLLoss-211"><a href="#MTLLoss-211"><span class="linenos">211</span></a>
</span><span id="MTLLoss-212"><a href="#MTLLoss-212"><span class="linenos">212</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLLoss-213"><a href="#MTLLoss-213"><span class="linenos">213</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the test step, which is the returns of the `test_step()` method in the `MTLAlgorithm`.</span>
</span><span id="MTLLoss-214"><a href="#MTLLoss-214"><span class="linenos">214</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="MTLLoss-215"><a href="#MTLLoss-215"><span class="linenos">215</span></a><span class="sd">        - **dataloader_idx** (`int`): the task ID of seen tasks to be tested. A default value of 0 is given otherwise the LightningModule will raise a `RuntimeError`.</span>
</span><span id="MTLLoss-216"><a href="#MTLLoss-216"><span class="linenos">216</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLLoss-217"><a href="#MTLLoss-217"><span class="linenos">217</span></a>
</span><span id="MTLLoss-218"><a href="#MTLLoss-218"><span class="linenos">218</span></a>        <span class="c1"># get the batch size</span>
</span><span id="MTLLoss-219"><a href="#MTLLoss-219"><span class="linenos">219</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="MTLLoss-220"><a href="#MTLLoss-220"><span class="linenos">220</span></a>
</span><span id="MTLLoss-221"><a href="#MTLLoss-221"><span class="linenos">221</span></a>        <span class="n">test_task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">get_test_task_id_from_dataloader_idx</span><span class="p">(</span><span class="n">dataloader_idx</span><span class="p">)</span>
</span><span id="MTLLoss-222"><a href="#MTLLoss-222"><span class="linenos">222</span></a>
</span><span id="MTLLoss-223"><a href="#MTLLoss-223"><span class="linenos">223</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="MTLLoss-224"><a href="#MTLLoss-224"><span class="linenos">224</span></a>        <span class="n">loss_cls_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="MTLLoss-225"><a href="#MTLLoss-225"><span class="linenos">225</span></a>
</span><span id="MTLLoss-226"><a href="#MTLLoss-226"><span class="linenos">226</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the metrics of the epoch</span>
</span><span id="MTLLoss-227"><a href="#MTLLoss-227"><span class="linenos">227</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="p">[</span><span class="n">test_task_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="MTLLoss-228"><a href="#MTLLoss-228"><span class="linenos">228</span></a>
</span><span id="MTLLoss-229"><a href="#MTLLoss-229"><span class="linenos">229</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_epoch_end</span><span class="p">(</span>
</span><span id="MTLLoss-230"><a href="#MTLLoss-230"><span class="linenos">230</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLLoss-231"><a href="#MTLLoss-231"><span class="linenos">231</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLLoss-232"><a href="#MTLLoss-232"><span class="linenos">232</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLLoss-233"><a href="#MTLLoss-233"><span class="linenos">233</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss-234"><a href="#MTLLoss-234"><span class="linenos">234</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save and plot test metrics at the end of test.&quot;&quot;&quot;</span>
</span><span id="MTLLoss-235"><a href="#MTLLoss-235"><span class="linenos">235</span></a>
</span><span id="MTLLoss-236"><a href="#MTLLoss-236"><span class="linenos">236</span></a>        <span class="c1"># save (update) the test metrics to CSV files</span>
</span><span id="MTLLoss-237"><a href="#MTLLoss-237"><span class="linenos">237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_test_loss_cls_to_csv</span><span class="p">(</span>
</span><span id="MTLLoss-238"><a href="#MTLLoss-238"><span class="linenos">238</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_csv_path</span><span class="p">,</span>
</span><span id="MTLLoss-239"><a href="#MTLLoss-239"><span class="linenos">239</span></a>        <span class="p">)</span>
</span><span id="MTLLoss-240"><a href="#MTLLoss-240"><span class="linenos">240</span></a>
</span><span id="MTLLoss-241"><a href="#MTLLoss-241"><span class="linenos">241</span></a>        <span class="c1"># plot the test metrics</span>
</span><span id="MTLLoss-242"><a href="#MTLLoss-242"><span class="linenos">242</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_plot_path</span><span class="p">:</span>
</span><span id="MTLLoss-243"><a href="#MTLLoss-243"><span class="linenos">243</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plot_test_loss_cls_from_csv</span><span class="p">(</span>
</span><span id="MTLLoss-244"><a href="#MTLLoss-244"><span class="linenos">244</span></a>                <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_csv_path</span><span class="p">,</span>
</span><span id="MTLLoss-245"><a href="#MTLLoss-245"><span class="linenos">245</span></a>                <span class="n">plot_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_plot_path</span><span class="p">,</span>
</span><span id="MTLLoss-246"><a href="#MTLLoss-246"><span class="linenos">246</span></a>            <span class="p">)</span>
</span><span id="MTLLoss-247"><a href="#MTLLoss-247"><span class="linenos">247</span></a>
</span><span id="MTLLoss-248"><a href="#MTLLoss-248"><span class="linenos">248</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_test_loss_cls_to_csv</span><span class="p">(</span>
</span><span id="MTLLoss-249"><a href="#MTLLoss-249"><span class="linenos">249</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLLoss-250"><a href="#MTLLoss-250"><span class="linenos">250</span></a>        <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MTLLoss-251"><a href="#MTLLoss-251"><span class="linenos">251</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss-252"><a href="#MTLLoss-252"><span class="linenos">252</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save the test classification loss metrics of all tasks in multi-task learning to an CSV file.</span>
</span><span id="MTLLoss-253"><a href="#MTLLoss-253"><span class="linenos">253</span></a>
</span><span id="MTLLoss-254"><a href="#MTLLoss-254"><span class="linenos">254</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLLoss-255"><a href="#MTLLoss-255"><span class="linenos">255</span></a><span class="sd">        - **csv_path** (`str`): save the test metric to path. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/loss_cls.csv&#39;.</span>
</span><span id="MTLLoss-256"><a href="#MTLLoss-256"><span class="linenos">256</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLLoss-257"><a href="#MTLLoss-257"><span class="linenos">257</span></a>        <span class="n">all_task_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="MTLLoss-258"><a href="#MTLLoss-258"><span class="linenos">258</span></a>        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;average_classification_loss&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="MTLLoss-259"><a href="#MTLLoss-259"><span class="linenos">259</span></a>            <span class="sa">f</span><span class="s2">&quot;test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">all_task_ids</span>
</span><span id="MTLLoss-260"><a href="#MTLLoss-260"><span class="linenos">260</span></a>        <span class="p">]</span>
</span><span id="MTLLoss-261"><a href="#MTLLoss-261"><span class="linenos">261</span></a>        <span class="n">new_line</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MTLLoss-262"><a href="#MTLLoss-262"><span class="linenos">262</span></a>
</span><span id="MTLLoss-263"><a href="#MTLLoss-263"><span class="linenos">263</span></a>        <span class="c1"># construct the columns and calculate the average loss over tasks at the same time</span>
</span><span id="MTLLoss-264"><a href="#MTLLoss-264"><span class="linenos">264</span></a>        <span class="n">average_loss_over_tasks</span> <span class="o">=</span> <span class="n">MeanMetric</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
</span><span id="MTLLoss-265"><a href="#MTLLoss-265"><span class="linenos">265</span></a>            <span class="n">device</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">device</span>
</span><span id="MTLLoss-266"><a href="#MTLLoss-266"><span class="linenos">266</span></a>        <span class="p">)</span>
</span><span id="MTLLoss-267"><a href="#MTLLoss-267"><span class="linenos">267</span></a>        <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">all_task_ids</span><span class="p">:</span>
</span><span id="MTLLoss-268"><a href="#MTLLoss-268"><span class="linenos">268</span></a>            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="MTLLoss-269"><a href="#MTLLoss-269"><span class="linenos">269</span></a>            <span class="n">new_line</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss</span>
</span><span id="MTLLoss-270"><a href="#MTLLoss-270"><span class="linenos">270</span></a>            <span class="n">average_loss_over_tasks</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
</span><span id="MTLLoss-271"><a href="#MTLLoss-271"><span class="linenos">271</span></a>        <span class="n">new_line</span><span class="p">[</span><span class="s2">&quot;average_classification_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MTLLoss-272"><a href="#MTLLoss-272"><span class="linenos">272</span></a>            <span class="n">average_loss_over_tasks</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="MTLLoss-273"><a href="#MTLLoss-273"><span class="linenos">273</span></a>        <span class="p">)</span>
</span><span id="MTLLoss-274"><a href="#MTLLoss-274"><span class="linenos">274</span></a>
</span><span id="MTLLoss-275"><a href="#MTLLoss-275"><span class="linenos">275</span></a>        <span class="c1"># write</span>
</span><span id="MTLLoss-276"><a href="#MTLLoss-276"><span class="linenos">276</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="MTLLoss-277"><a href="#MTLLoss-277"><span class="linenos">277</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="MTLLoss-278"><a href="#MTLLoss-278"><span class="linenos">278</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="MTLLoss-279"><a href="#MTLLoss-279"><span class="linenos">279</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
</span><span id="MTLLoss-280"><a href="#MTLLoss-280"><span class="linenos">280</span></a>
</span><span id="MTLLoss-281"><a href="#MTLLoss-281"><span class="linenos">281</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_test_loss_cls_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss-282"><a href="#MTLLoss-282"><span class="linenos">282</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the test classification loss bar chart of all tasks in multi-task learning from saved CSV file and save the plot to the designated directory.</span>
</span><span id="MTLLoss-283"><a href="#MTLLoss-283"><span class="linenos">283</span></a>
</span><span id="MTLLoss-284"><a href="#MTLLoss-284"><span class="linenos">284</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLLoss-285"><a href="#MTLLoss-285"><span class="linenos">285</span></a><span class="sd">        - **csv_path** (`str`): the path to the csv file where the `utils.save_test_acc_csv()` saved the test classification loss metric.</span>
</span><span id="MTLLoss-286"><a href="#MTLLoss-286"><span class="linenos">286</span></a><span class="sd">        - **plot_path** (`str`): the path to save plot. Better same as the output directory of the experiment. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/loss_cls.png&#39;.</span>
</span><span id="MTLLoss-287"><a href="#MTLLoss-287"><span class="linenos">287</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLLoss-288"><a href="#MTLLoss-288"><span class="linenos">288</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="MTLLoss-289"><a href="#MTLLoss-289"><span class="linenos">289</span></a>
</span><span id="MTLLoss-290"><a href="#MTLLoss-290"><span class="linenos">290</span></a>        <span class="c1"># extract all accuracy columns including average</span>
</span><span id="MTLLoss-291"><a href="#MTLLoss-291"><span class="linenos">291</span></a>        <span class="n">all_columns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="MTLLoss-292"><a href="#MTLLoss-292"><span class="linenos">292</span></a>        <span class="n">task_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_columns</span><span class="p">)))</span>  <span class="c1"># assign index-based positions</span>
</span><span id="MTLLoss-293"><a href="#MTLLoss-293"><span class="linenos">293</span></a>        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="MTLLoss-294"><a href="#MTLLoss-294"><span class="linenos">294</span></a>            <span class="p">(</span>
</span><span id="MTLLoss-295"><a href="#MTLLoss-295"><span class="linenos">295</span></a>                <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;test_on_task_&quot;</span><span class="p">,</span> <span class="s2">&quot;Task &quot;</span><span class="p">)</span>
</span><span id="MTLLoss-296"><a href="#MTLLoss-296"><span class="linenos">296</span></a>                <span class="k">if</span> <span class="s2">&quot;test_on_task_&quot;</span> <span class="ow">in</span> <span class="n">col</span>
</span><span id="MTLLoss-297"><a href="#MTLLoss-297"><span class="linenos">297</span></a>                <span class="k">else</span> <span class="s2">&quot;Average&quot;</span>
</span><span id="MTLLoss-298"><a href="#MTLLoss-298"><span class="linenos">298</span></a>            <span class="p">)</span>
</span><span id="MTLLoss-299"><a href="#MTLLoss-299"><span class="linenos">299</span></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">all_columns</span>
</span><span id="MTLLoss-300"><a href="#MTLLoss-300"><span class="linenos">300</span></a>        <span class="p">]</span>
</span><span id="MTLLoss-301"><a href="#MTLLoss-301"><span class="linenos">301</span></a>        <span class="n">loss_cls</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">all_columns</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="MTLLoss-302"><a href="#MTLLoss-302"><span class="linenos">302</span></a>
</span><span id="MTLLoss-303"><a href="#MTLLoss-303"><span class="linenos">303</span></a>        <span class="c1"># plot the classification loss bar chart over tasks</span>
</span><span id="MTLLoss-304"><a href="#MTLLoss-304"><span class="linenos">304</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
</span><span id="MTLLoss-305"><a href="#MTLLoss-305"><span class="linenos">305</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
</span><span id="MTLLoss-306"><a href="#MTLLoss-306"><span class="linenos">306</span></a>            <span class="n">task_ids</span><span class="p">,</span>
</span><span id="MTLLoss-307"><a href="#MTLLoss-307"><span class="linenos">307</span></a>            <span class="n">loss_cls</span><span class="p">,</span>
</span><span id="MTLLoss-308"><a href="#MTLLoss-308"><span class="linenos">308</span></a>            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;skyblue&quot;</span><span class="p">,</span>
</span><span id="MTLLoss-309"><a href="#MTLLoss-309"><span class="linenos">309</span></a>            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="MTLLoss-310"><a href="#MTLLoss-310"><span class="linenos">310</span></a>        <span class="p">)</span>
</span><span id="MTLLoss-311"><a href="#MTLLoss-311"><span class="linenos">311</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Task&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="MTLLoss-312"><a href="#MTLLoss-312"><span class="linenos">312</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Classification Loss&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="MTLLoss-313"><a href="#MTLLoss-313"><span class="linenos">313</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="MTLLoss-314"><a href="#MTLLoss-314"><span class="linenos">314</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">task_ids</span><span class="p">)</span>
</span><span id="MTLLoss-315"><a href="#MTLLoss-315"><span class="linenos">315</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="MTLLoss-316"><a href="#MTLLoss-316"><span class="linenos">316</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="n">i</span> <span class="o">*</span> <span class="mf">0.05</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">)])</span>
</span><span id="MTLLoss-317"><a href="#MTLLoss-317"><span class="linenos">317</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="MTLLoss-318"><a href="#MTLLoss-318"><span class="linenos">318</span></a>            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mf">0.05</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">)]],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span>
</span><span id="MTLLoss-319"><a href="#MTLLoss-319"><span class="linenos">319</span></a>        <span class="p">)</span>
</span><span id="MTLLoss-320"><a href="#MTLLoss-320"><span class="linenos">320</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="MTLLoss-321"><a href="#MTLLoss-321"><span class="linenos">321</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="MTLLoss-322"><a href="#MTLLoss-322"><span class="linenos">322</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Provides all actions that are related to MTL loss metrics, which include:</p>

<ul>
<li>Defining, initializing and recording loss metrics.</li>
<li>Logging training and validation loss metrics to Lightning loggers in real time.</li>
<li>Saving test loss metrics to files.</li>
<li>Visualizing test loss metrics as plots.</li>
</ul>

<p>The callback is able to produce the following outputs:</p>

<ul>
<li>CSV files for test classification loss of all tasks and average classification loss.</li>
<li>Bar charts for test classification loss of all tasks.</li>
</ul>
</div>


                            <div id="MTLLoss.__init__" class="classattr">
                                        <input id="MTLLoss.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">MTLLoss</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">test_loss_cls_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;loss_cls.csv&#39;</span>,</span><span class="param">	<span class="n">test_loss_cls_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="MTLLoss.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLLoss.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLLoss.__init__-40"><a href="#MTLLoss.__init__-40"><span class="linenos">40</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="MTLLoss.__init__-41"><a href="#MTLLoss.__init__-41"><span class="linenos">41</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLLoss.__init__-42"><a href="#MTLLoss.__init__-42"><span class="linenos">42</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MTLLoss.__init__-43"><a href="#MTLLoss.__init__-43"><span class="linenos">43</span></a>        <span class="n">test_loss_cls_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;loss_cls.csv&quot;</span><span class="p">,</span>
</span><span id="MTLLoss.__init__-44"><a href="#MTLLoss.__init__-44"><span class="linenos">44</span></a>        <span class="n">test_loss_cls_plot_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MTLLoss.__init__-45"><a href="#MTLLoss.__init__-45"><span class="linenos">45</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss.__init__-46"><a href="#MTLLoss.__init__-46"><span class="linenos">46</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `MTLLoss`.</span>
</span><span id="MTLLoss.__init__-47"><a href="#MTLLoss.__init__-47"><span class="linenos">47</span></a>
</span><span id="MTLLoss.__init__-48"><a href="#MTLLoss.__init__-48"><span class="linenos">48</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLLoss.__init__-49"><a href="#MTLLoss.__init__-49"><span class="linenos">49</span></a><span class="sd">        - **save_dir** (`str`): The directory where data and figures of metrics will be saved. Better inside the output folder.</span>
</span><span id="MTLLoss.__init__-50"><a href="#MTLLoss.__init__-50"><span class="linenos">50</span></a><span class="sd">        - **test_loss_cls_csv_name**(`str`): file name to save classification loss of all tasks and average classification loss as CSV file.</span>
</span><span id="MTLLoss.__init__-51"><a href="#MTLLoss.__init__-51"><span class="linenos">51</span></a><span class="sd">        - **test_loss_cls_plot_name** (`str` | `None`): file name to save classification loss plot. If `None`, no file will be saved.</span>
</span><span id="MTLLoss.__init__-52"><a href="#MTLLoss.__init__-52"><span class="linenos">52</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLLoss.__init__-53"><a href="#MTLLoss.__init__-53"><span class="linenos">53</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="MTLLoss.__init__-54"><a href="#MTLLoss.__init__-54"><span class="linenos">54</span></a>
</span><span id="MTLLoss.__init__-55"><a href="#MTLLoss.__init__-55"><span class="linenos">55</span></a>        <span class="c1"># paths</span>
</span><span id="MTLLoss.__init__-56"><a href="#MTLLoss.__init__-56"><span class="linenos">56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_csv_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="MTLLoss.__init__-57"><a href="#MTLLoss.__init__-57"><span class="linenos">57</span></a>            <span class="n">save_dir</span><span class="p">,</span> <span class="n">test_loss_cls_csv_name</span>
</span><span id="MTLLoss.__init__-58"><a href="#MTLLoss.__init__-58"><span class="linenos">58</span></a>        <span class="p">)</span>
</span><span id="MTLLoss.__init__-59"><a href="#MTLLoss.__init__-59"><span class="linenos">59</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The path to save test classification loss of all tasks and average classification loss CSV file.&quot;&quot;&quot;</span>
</span><span id="MTLLoss.__init__-60"><a href="#MTLLoss.__init__-60"><span class="linenos">60</span></a>        <span class="k">if</span> <span class="n">test_loss_cls_plot_name</span><span class="p">:</span>
</span><span id="MTLLoss.__init__-61"><a href="#MTLLoss.__init__-61"><span class="linenos">61</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_plot_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="MTLLoss.__init__-62"><a href="#MTLLoss.__init__-62"><span class="linenos">62</span></a>                <span class="n">save_dir</span><span class="p">,</span> <span class="n">test_loss_cls_plot_name</span>
</span><span id="MTLLoss.__init__-63"><a href="#MTLLoss.__init__-63"><span class="linenos">63</span></a>            <span class="p">)</span>
</span><span id="MTLLoss.__init__-64"><a href="#MTLLoss.__init__-64"><span class="linenos">64</span></a><span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The path to save test classification loss plot.&quot;&quot;&quot;</span>
</span><span id="MTLLoss.__init__-65"><a href="#MTLLoss.__init__-65"><span class="linenos">65</span></a>
</span><span id="MTLLoss.__init__-66"><a href="#MTLLoss.__init__-66"><span class="linenos">66</span></a>        <span class="c1"># training accumulated metrics</span>
</span><span id="MTLLoss.__init__-67"><a href="#MTLLoss.__init__-67"><span class="linenos">67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="MTLLoss.__init__-68"><a href="#MTLLoss.__init__-68"><span class="linenos">68</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Classification loss of training epoch. Accumulated and calculated from the training batches. &quot;&quot;&quot;</span>
</span><span id="MTLLoss.__init__-69"><a href="#MTLLoss.__init__-69"><span class="linenos">69</span></a>
</span><span id="MTLLoss.__init__-70"><a href="#MTLLoss.__init__-70"><span class="linenos">70</span></a>        <span class="c1"># validation accumulated metrics</span>
</span><span id="MTLLoss.__init__-71"><a href="#MTLLoss.__init__-71"><span class="linenos">71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MTLLoss.__init__-72"><a href="#MTLLoss.__init__-72"><span class="linenos">72</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Validation classification loss of the model after training epoch. Accumulated and calculated from the validation batches. Keys are task IDs and values are the corresponding metrics. &quot;&quot;&quot;</span>
</span><span id="MTLLoss.__init__-73"><a href="#MTLLoss.__init__-73"><span class="linenos">73</span></a>
</span><span id="MTLLoss.__init__-74"><a href="#MTLLoss.__init__-74"><span class="linenos">74</span></a>        <span class="c1"># test accumulated metrics</span>
</span><span id="MTLLoss.__init__-75"><a href="#MTLLoss.__init__-75"><span class="linenos">75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">MeanMetricBatch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MTLLoss.__init__-76"><a href="#MTLLoss.__init__-76"><span class="linenos">76</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Test classification loss of all tasks. Accumulated and calculated from the test batches. Keys are task IDs and values are the corresponding metrics. &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the <code><a href="#MTLLoss">MTLLoss</a></code>.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>save_dir</strong> (<code>str</code>): The directory where data and figures of metrics will be saved. Better inside the output folder.</li>
<li><strong>test_loss_cls_csv_name</strong>(<code>str</code>): file name to save classification loss of all tasks and average classification loss as CSV file.</li>
<li><strong>test_loss_cls_plot_name</strong> (<code>str</code> | <code>None</code>): file name to save classification loss plot. If <code>None</code>, no file will be saved.</li>
</ul>
</div>


                            </div>
                            <div id="MTLLoss.test_loss_cls_csv_path" class="classattr">
                                <div class="attr variable">
            <span class="name">test_loss_cls_csv_path</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#MTLLoss.test_loss_cls_csv_path"></a>
    
            <div class="docstring"><p>The path to save test classification loss of all tasks and average classification loss CSV file.</p>
</div>


                            </div>
                            <div id="MTLLoss.loss_cls_training_epoch" class="classattr">
                                <div class="attr variable">
            <span class="name">loss_cls_training_epoch</span><span class="annotation">: <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a></span>

        
    </div>
    <a class="headerlink" href="#MTLLoss.loss_cls_training_epoch"></a>
    
            <div class="docstring"><p>Classification loss of training epoch. Accumulated and calculated from the training batches.</p>
</div>


                            </div>
                            <div id="MTLLoss.loss_cls_val" class="classattr">
                                <div class="attr variable">
            <span class="name">loss_cls_val</span><span class="annotation">: dict[int, <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a>]</span>

        
    </div>
    <a class="headerlink" href="#MTLLoss.loss_cls_val"></a>
    
            <div class="docstring"><p>Validation classification loss of the model after training epoch. Accumulated and calculated from the validation batches. Keys are task IDs and values are the corresponding metrics.</p>
</div>


                            </div>
                            <div id="MTLLoss.loss_cls_test" class="classattr">
                                <div class="attr variable">
            <span class="name">loss_cls_test</span><span class="annotation">: dict[int, <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a>]</span>

        
    </div>
    <a class="headerlink" href="#MTLLoss.loss_cls_test"></a>
    
            <div class="docstring"><p>Test classification loss of all tasks. Accumulated and calculated from the test batches. Keys are task IDs and values are the corresponding metrics.</p>
</div>


                            </div>
                            <div id="MTLLoss.on_fit_start" class="classattr">
                                        <input id="MTLLoss.on_fit_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_fit_start</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="mtl_algorithms/base.html#MTLAlgorithm">clarena.mtl_algorithms.base.MTLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLLoss.on_fit_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLLoss.on_fit_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLLoss.on_fit_start-78"><a href="#MTLLoss.on_fit_start-78"><span class="linenos">78</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_fit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss.on_fit_start-79"><a href="#MTLLoss.on_fit_start-79"><span class="linenos">79</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize training and validation metrics.&quot;&quot;&quot;</span>
</span><span id="MTLLoss.on_fit_start-80"><a href="#MTLLoss.on_fit_start-80"><span class="linenos">80</span></a>
</span><span id="MTLLoss.on_fit_start-81"><a href="#MTLLoss.on_fit_start-81"><span class="linenos">81</span></a>        <span class="c1"># initialize training metrics</span>
</span><span id="MTLLoss.on_fit_start-82"><a href="#MTLLoss.on_fit_start-82"><span class="linenos">82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span>
</span><span id="MTLLoss.on_fit_start-83"><a href="#MTLLoss.on_fit_start-83"><span class="linenos">83</span></a>
</span><span id="MTLLoss.on_fit_start-84"><a href="#MTLLoss.on_fit_start-84"><span class="linenos">84</span></a>        <span class="c1"># initialize validation metrics</span>
</span><span id="MTLLoss.on_fit_start-85"><a href="#MTLLoss.on_fit_start-85"><span class="linenos">85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="MTLLoss.on_fit_start-86"><a href="#MTLLoss.on_fit_start-86"><span class="linenos">86</span></a>            <span class="n">task_id</span><span class="p">:</span> <span class="n">MeanMetricBatch</span><span class="p">()</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">trainer</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">train_tasks</span>
</span><span id="MTLLoss.on_fit_start-87"><a href="#MTLLoss.on_fit_start-87"><span class="linenos">87</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Initialize training and validation metrics.</p>
</div>


                            </div>
                            <div id="MTLLoss.on_train_batch_end" class="classattr">
                                        <input id="MTLLoss.on_train_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_train_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="mtl_algorithms/base.html#MTLAlgorithm">clarena.mtl_algorithms.base.MTLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLLoss.on_train_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLLoss.on_train_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLLoss.on_train_batch_end-89"><a href="#MTLLoss.on_train_batch_end-89"><span class="linenos"> 89</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span>
</span><span id="MTLLoss.on_train_batch_end-90"><a href="#MTLLoss.on_train_batch_end-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLLoss.on_train_batch_end-91"><a href="#MTLLoss.on_train_batch_end-91"><span class="linenos"> 91</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLLoss.on_train_batch_end-92"><a href="#MTLLoss.on_train_batch_end-92"><span class="linenos"> 92</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLLoss.on_train_batch_end-93"><a href="#MTLLoss.on_train_batch_end-93"><span class="linenos"> 93</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="MTLLoss.on_train_batch_end-94"><a href="#MTLLoss.on_train_batch_end-94"><span class="linenos"> 94</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="MTLLoss.on_train_batch_end-95"><a href="#MTLLoss.on_train_batch_end-95"><span class="linenos"> 95</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="MTLLoss.on_train_batch_end-96"><a href="#MTLLoss.on_train_batch_end-96"><span class="linenos"> 96</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss.on_train_batch_end-97"><a href="#MTLLoss.on_train_batch_end-97"><span class="linenos"> 97</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Record training metrics from training batch, log metrics of training batch and accumulated metrics of the epoch to Lightning loggers.</span>
</span><span id="MTLLoss.on_train_batch_end-98"><a href="#MTLLoss.on_train_batch_end-98"><span class="linenos"> 98</span></a>
</span><span id="MTLLoss.on_train_batch_end-99"><a href="#MTLLoss.on_train_batch_end-99"><span class="linenos"> 99</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLLoss.on_train_batch_end-100"><a href="#MTLLoss.on_train_batch_end-100"><span class="linenos">100</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the training step, the returns of the `training_step()` method in the `MTLAlgorithm`.</span>
</span><span id="MTLLoss.on_train_batch_end-101"><a href="#MTLLoss.on_train_batch_end-101"><span class="linenos">101</span></a><span class="sd">        - **batch** (`Any`): the training data batch.</span>
</span><span id="MTLLoss.on_train_batch_end-102"><a href="#MTLLoss.on_train_batch_end-102"><span class="linenos">102</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLLoss.on_train_batch_end-103"><a href="#MTLLoss.on_train_batch_end-103"><span class="linenos">103</span></a>        <span class="c1"># get the batch size</span>
</span><span id="MTLLoss.on_train_batch_end-104"><a href="#MTLLoss.on_train_batch_end-104"><span class="linenos">104</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="MTLLoss.on_train_batch_end-105"><a href="#MTLLoss.on_train_batch_end-105"><span class="linenos">105</span></a>
</span><span id="MTLLoss.on_train_batch_end-106"><a href="#MTLLoss.on_train_batch_end-106"><span class="linenos">106</span></a>        <span class="c1"># get training metrics values of current training batch from the outputs of the `training_step()`</span>
</span><span id="MTLLoss.on_train_batch_end-107"><a href="#MTLLoss.on_train_batch_end-107"><span class="linenos">107</span></a>        <span class="n">loss_cls_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="MTLLoss.on_train_batch_end-108"><a href="#MTLLoss.on_train_batch_end-108"><span class="linenos">108</span></a>
</span><span id="MTLLoss.on_train_batch_end-109"><a href="#MTLLoss.on_train_batch_end-109"><span class="linenos">109</span></a>        <span class="c1"># update accumulated training metrics to calculate training metrics of the epoch</span>
</span><span id="MTLLoss.on_train_batch_end-110"><a href="#MTLLoss.on_train_batch_end-110"><span class="linenos">110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="MTLLoss.on_train_batch_end-111"><a href="#MTLLoss.on_train_batch_end-111"><span class="linenos">111</span></a>
</span><span id="MTLLoss.on_train_batch_end-112"><a href="#MTLLoss.on_train_batch_end-112"><span class="linenos">112</span></a>        <span class="c1"># log training metrics of current training batch to Lightning loggers</span>
</span><span id="MTLLoss.on_train_batch_end-113"><a href="#MTLLoss.on_train_batch_end-113"><span class="linenos">113</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;train/loss_cls_batch&quot;</span><span class="p">,</span> <span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="MTLLoss.on_train_batch_end-114"><a href="#MTLLoss.on_train_batch_end-114"><span class="linenos">114</span></a>
</span><span id="MTLLoss.on_train_batch_end-115"><a href="#MTLLoss.on_train_batch_end-115"><span class="linenos">115</span></a>        <span class="c1"># log accumulated training metrics till this training batch to Lightning loggers</span>
</span><span id="MTLLoss.on_train_batch_end-116"><a href="#MTLLoss.on_train_batch_end-116"><span class="linenos">116</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="MTLLoss.on_train_batch_end-117"><a href="#MTLLoss.on_train_batch_end-117"><span class="linenos">117</span></a>            <span class="s2">&quot;task/train/loss_cls&quot;</span><span class="p">,</span>
</span><span id="MTLLoss.on_train_batch_end-118"><a href="#MTLLoss.on_train_batch_end-118"><span class="linenos">118</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="MTLLoss.on_train_batch_end-119"><a href="#MTLLoss.on_train_batch_end-119"><span class="linenos">119</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="MTLLoss.on_train_batch_end-120"><a href="#MTLLoss.on_train_batch_end-120"><span class="linenos">120</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Record training metrics from training batch, log metrics of training batch and accumulated metrics of the epoch to Lightning loggers.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the training step, the returns of the <code>training_step()</code> method in the <code>MTLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the training data batch.</li>
</ul>
</div>


                            </div>
                            <div id="MTLLoss.on_train_epoch_end" class="classattr">
                                        <input id="MTLLoss.on_train_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_train_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="mtl_algorithms/base.html#MTLAlgorithm">clarena.mtl_algorithms.base.MTLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLLoss.on_train_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLLoss.on_train_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLLoss.on_train_epoch_end-122"><a href="#MTLLoss.on_train_epoch_end-122"><span class="linenos">122</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_epoch_end</span><span class="p">(</span>
</span><span id="MTLLoss.on_train_epoch_end-123"><a href="#MTLLoss.on_train_epoch_end-123"><span class="linenos">123</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLLoss.on_train_epoch_end-124"><a href="#MTLLoss.on_train_epoch_end-124"><span class="linenos">124</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLLoss.on_train_epoch_end-125"><a href="#MTLLoss.on_train_epoch_end-125"><span class="linenos">125</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLLoss.on_train_epoch_end-126"><a href="#MTLLoss.on_train_epoch_end-126"><span class="linenos">126</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss.on_train_epoch_end-127"><a href="#MTLLoss.on_train_epoch_end-127"><span class="linenos">127</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log metrics of training epoch to plot learning curves and reset the metrics accumulation at the end of training epoch.&quot;&quot;&quot;</span>
</span><span id="MTLLoss.on_train_epoch_end-128"><a href="#MTLLoss.on_train_epoch_end-128"><span class="linenos">128</span></a>
</span><span id="MTLLoss.on_train_epoch_end-129"><a href="#MTLLoss.on_train_epoch_end-129"><span class="linenos">129</span></a>        <span class="c1"># log the accumulated and computed metrics of the epoch to Lightning loggers, specially for plotting learning curves</span>
</span><span id="MTLLoss.on_train_epoch_end-130"><a href="#MTLLoss.on_train_epoch_end-130"><span class="linenos">130</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="MTLLoss.on_train_epoch_end-131"><a href="#MTLLoss.on_train_epoch_end-131"><span class="linenos">131</span></a>            <span class="s2">&quot;learning_curve/train/loss_cls&quot;</span><span class="p">,</span>
</span><span id="MTLLoss.on_train_epoch_end-132"><a href="#MTLLoss.on_train_epoch_end-132"><span class="linenos">132</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="MTLLoss.on_train_epoch_end-133"><a href="#MTLLoss.on_train_epoch_end-133"><span class="linenos">133</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="MTLLoss.on_train_epoch_end-134"><a href="#MTLLoss.on_train_epoch_end-134"><span class="linenos">134</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="MTLLoss.on_train_epoch_end-135"><a href="#MTLLoss.on_train_epoch_end-135"><span class="linenos">135</span></a>        <span class="p">)</span>
</span><span id="MTLLoss.on_train_epoch_end-136"><a href="#MTLLoss.on_train_epoch_end-136"><span class="linenos">136</span></a>
</span><span id="MTLLoss.on_train_epoch_end-137"><a href="#MTLLoss.on_train_epoch_end-137"><span class="linenos">137</span></a>        <span class="c1"># reset the metrics of training epoch as there are more epochs to go and not only one epoch like in the validation and test</span>
</span><span id="MTLLoss.on_train_epoch_end-138"><a href="#MTLLoss.on_train_epoch_end-138"><span class="linenos">138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Log metrics of training epoch to plot learning curves and reset the metrics accumulation at the end of training epoch.</p>
</div>


                            </div>
                            <div id="MTLLoss.on_validation_batch_end" class="classattr">
                                        <input id="MTLLoss.on_validation_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_validation_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="mtl_algorithms/base.html#MTLAlgorithm">clarena.mtl_algorithms.base.MTLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLLoss.on_validation_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLLoss.on_validation_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLLoss.on_validation_batch_end-140"><a href="#MTLLoss.on_validation_batch_end-140"><span class="linenos">140</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_batch_end</span><span class="p">(</span>
</span><span id="MTLLoss.on_validation_batch_end-141"><a href="#MTLLoss.on_validation_batch_end-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLLoss.on_validation_batch_end-142"><a href="#MTLLoss.on_validation_batch_end-142"><span class="linenos">142</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLLoss.on_validation_batch_end-143"><a href="#MTLLoss.on_validation_batch_end-143"><span class="linenos">143</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLLoss.on_validation_batch_end-144"><a href="#MTLLoss.on_validation_batch_end-144"><span class="linenos">144</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="MTLLoss.on_validation_batch_end-145"><a href="#MTLLoss.on_validation_batch_end-145"><span class="linenos">145</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="MTLLoss.on_validation_batch_end-146"><a href="#MTLLoss.on_validation_batch_end-146"><span class="linenos">146</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="MTLLoss.on_validation_batch_end-147"><a href="#MTLLoss.on_validation_batch_end-147"><span class="linenos">147</span></a>        <span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="MTLLoss.on_validation_batch_end-148"><a href="#MTLLoss.on_validation_batch_end-148"><span class="linenos">148</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss.on_validation_batch_end-149"><a href="#MTLLoss.on_validation_batch_end-149"><span class="linenos">149</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from validation batch. We don&#39;t need to log and monitor the metrics of validation batches.</span>
</span><span id="MTLLoss.on_validation_batch_end-150"><a href="#MTLLoss.on_validation_batch_end-150"><span class="linenos">150</span></a>
</span><span id="MTLLoss.on_validation_batch_end-151"><a href="#MTLLoss.on_validation_batch_end-151"><span class="linenos">151</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLLoss.on_validation_batch_end-152"><a href="#MTLLoss.on_validation_batch_end-152"><span class="linenos">152</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the validation step, which is the returns of the `validation_step()` method in the `MTLAlgorithm`.</span>
</span><span id="MTLLoss.on_validation_batch_end-153"><a href="#MTLLoss.on_validation_batch_end-153"><span class="linenos">153</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="MTLLoss.on_validation_batch_end-154"><a href="#MTLLoss.on_validation_batch_end-154"><span class="linenos">154</span></a><span class="sd">        - **dataloader_idx** (`int`): the task ID of the validation dataloader. A default value of 0 is given otherwise the LightningModule will raise a `RuntimeError`.</span>
</span><span id="MTLLoss.on_validation_batch_end-155"><a href="#MTLLoss.on_validation_batch_end-155"><span class="linenos">155</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLLoss.on_validation_batch_end-156"><a href="#MTLLoss.on_validation_batch_end-156"><span class="linenos">156</span></a>        <span class="c1"># get the batch size</span>
</span><span id="MTLLoss.on_validation_batch_end-157"><a href="#MTLLoss.on_validation_batch_end-157"><span class="linenos">157</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="MTLLoss.on_validation_batch_end-158"><a href="#MTLLoss.on_validation_batch_end-158"><span class="linenos">158</span></a>
</span><span id="MTLLoss.on_validation_batch_end-159"><a href="#MTLLoss.on_validation_batch_end-159"><span class="linenos">159</span></a>        <span class="c1"># map dataloader index to task id</span>
</span><span id="MTLLoss.on_validation_batch_end-160"><a href="#MTLLoss.on_validation_batch_end-160"><span class="linenos">160</span></a>        <span class="n">val_task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">get_val_task_id_from_dataloader_idx</span><span class="p">(</span><span class="n">dataloader_idx</span><span class="p">)</span>
</span><span id="MTLLoss.on_validation_batch_end-161"><a href="#MTLLoss.on_validation_batch_end-161"><span class="linenos">161</span></a>
</span><span id="MTLLoss.on_validation_batch_end-162"><a href="#MTLLoss.on_validation_batch_end-162"><span class="linenos">162</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="MTLLoss.on_validation_batch_end-163"><a href="#MTLLoss.on_validation_batch_end-163"><span class="linenos">163</span></a>        <span class="n">loss_cls_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="MTLLoss.on_validation_batch_end-164"><a href="#MTLLoss.on_validation_batch_end-164"><span class="linenos">164</span></a>
</span><span id="MTLLoss.on_validation_batch_end-165"><a href="#MTLLoss.on_validation_batch_end-165"><span class="linenos">165</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the validation metrics</span>
</span><span id="MTLLoss.on_validation_batch_end-166"><a href="#MTLLoss.on_validation_batch_end-166"><span class="linenos">166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="p">[</span><span class="n">val_task_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Accumulating metrics from validation batch. We don't need to log and monitor the metrics of validation batches.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the validation step, which is the returns of the <code>validation_step()</code> method in the <code>MTLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the validation data batch.</li>
<li><strong>dataloader_idx</strong> (<code>int</code>): the task ID of the validation dataloader. A default value of 0 is given otherwise the LightningModule will raise a <code>RuntimeError</code>.</li>
</ul>
</div>


                            </div>
                            <div id="MTLLoss.on_validation_epoch_end" class="classattr">
                                        <input id="MTLLoss.on_validation_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_validation_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="mtl_algorithms/base.html#MTLAlgorithm">clarena.mtl_algorithms.base.MTLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLLoss.on_validation_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLLoss.on_validation_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLLoss.on_validation_epoch_end-168"><a href="#MTLLoss.on_validation_epoch_end-168"><span class="linenos">168</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_epoch_end</span><span class="p">(</span>
</span><span id="MTLLoss.on_validation_epoch_end-169"><a href="#MTLLoss.on_validation_epoch_end-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLLoss.on_validation_epoch_end-170"><a href="#MTLLoss.on_validation_epoch_end-170"><span class="linenos">170</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLLoss.on_validation_epoch_end-171"><a href="#MTLLoss.on_validation_epoch_end-171"><span class="linenos">171</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLLoss.on_validation_epoch_end-172"><a href="#MTLLoss.on_validation_epoch_end-172"><span class="linenos">172</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss.on_validation_epoch_end-173"><a href="#MTLLoss.on_validation_epoch_end-173"><span class="linenos">173</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log validation metrics to plot learning curves.&quot;&quot;&quot;</span>
</span><span id="MTLLoss.on_validation_epoch_end-174"><a href="#MTLLoss.on_validation_epoch_end-174"><span class="linenos">174</span></a>
</span><span id="MTLLoss.on_validation_epoch_end-175"><a href="#MTLLoss.on_validation_epoch_end-175"><span class="linenos">175</span></a>        <span class="c1"># compute average validation loss over tasks for logging learning curves</span>
</span><span id="MTLLoss.on_validation_epoch_end-176"><a href="#MTLLoss.on_validation_epoch_end-176"><span class="linenos">176</span></a>        <span class="n">average_val_loss</span> <span class="o">=</span> <span class="n">MeanMetric</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
</span><span id="MTLLoss.on_validation_epoch_end-177"><a href="#MTLLoss.on_validation_epoch_end-177"><span class="linenos">177</span></a>            <span class="n">device</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">device</span>
</span><span id="MTLLoss.on_validation_epoch_end-178"><a href="#MTLLoss.on_validation_epoch_end-178"><span class="linenos">178</span></a>        <span class="p">)</span>
</span><span id="MTLLoss.on_validation_epoch_end-179"><a href="#MTLLoss.on_validation_epoch_end-179"><span class="linenos">179</span></a>        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="MTLLoss.on_validation_epoch_end-180"><a href="#MTLLoss.on_validation_epoch_end-180"><span class="linenos">180</span></a>            <span class="n">average_val_loss</span><span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">compute</span><span class="p">())</span>
</span><span id="MTLLoss.on_validation_epoch_end-181"><a href="#MTLLoss.on_validation_epoch_end-181"><span class="linenos">181</span></a>
</span><span id="MTLLoss.on_validation_epoch_end-182"><a href="#MTLLoss.on_validation_epoch_end-182"><span class="linenos">182</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="MTLLoss.on_validation_epoch_end-183"><a href="#MTLLoss.on_validation_epoch_end-183"><span class="linenos">183</span></a>            <span class="s2">&quot;learning_curve/val/loss_cls&quot;</span><span class="p">,</span>
</span><span id="MTLLoss.on_validation_epoch_end-184"><a href="#MTLLoss.on_validation_epoch_end-184"><span class="linenos">184</span></a>            <span class="n">average_val_loss</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="MTLLoss.on_validation_epoch_end-185"><a href="#MTLLoss.on_validation_epoch_end-185"><span class="linenos">185</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="MTLLoss.on_validation_epoch_end-186"><a href="#MTLLoss.on_validation_epoch_end-186"><span class="linenos">186</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="MTLLoss.on_validation_epoch_end-187"><a href="#MTLLoss.on_validation_epoch_end-187"><span class="linenos">187</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Log validation metrics to plot learning curves.</p>
</div>


                            </div>
                            <div id="MTLLoss.on_test_start" class="classattr">
                                        <input id="MTLLoss.on_test_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_test_start</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="mtl_algorithms/base.html#MTLAlgorithm">clarena.mtl_algorithms.base.MTLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLLoss.on_test_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLLoss.on_test_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLLoss.on_test_start-189"><a href="#MTLLoss.on_test_start-189"><span class="linenos">189</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_start</span><span class="p">(</span>
</span><span id="MTLLoss.on_test_start-190"><a href="#MTLLoss.on_test_start-190"><span class="linenos">190</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLLoss.on_test_start-191"><a href="#MTLLoss.on_test_start-191"><span class="linenos">191</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLLoss.on_test_start-192"><a href="#MTLLoss.on_test_start-192"><span class="linenos">192</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLLoss.on_test_start-193"><a href="#MTLLoss.on_test_start-193"><span class="linenos">193</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss.on_test_start-194"><a href="#MTLLoss.on_test_start-194"><span class="linenos">194</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the metrics for testing each seen task in the beginning of a task&#39;s testing.&quot;&quot;&quot;</span>
</span><span id="MTLLoss.on_test_start-195"><a href="#MTLLoss.on_test_start-195"><span class="linenos">195</span></a>
</span><span id="MTLLoss.on_test_start-196"><a href="#MTLLoss.on_test_start-196"><span class="linenos">196</span></a>        <span class="c1"># initialize test metrics for current and previous tasks</span>
</span><span id="MTLLoss.on_test_start-197"><a href="#MTLLoss.on_test_start-197"><span class="linenos">197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="MTLLoss.on_test_start-198"><a href="#MTLLoss.on_test_start-198"><span class="linenos">198</span></a>            <span class="n">task_id</span><span class="p">:</span> <span class="n">MeanMetricBatch</span><span class="p">()</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">trainer</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">eval_tasks</span>
</span><span id="MTLLoss.on_test_start-199"><a href="#MTLLoss.on_test_start-199"><span class="linenos">199</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the metrics for testing each seen task in the beginning of a task's testing.</p>
</div>


                            </div>
                            <div id="MTLLoss.on_test_batch_end" class="classattr">
                                        <input id="MTLLoss.on_test_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_test_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="mtl_algorithms/base.html#MTLAlgorithm">clarena.mtl_algorithms.base.MTLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLLoss.on_test_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLLoss.on_test_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLLoss.on_test_batch_end-201"><a href="#MTLLoss.on_test_batch_end-201"><span class="linenos">201</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_batch_end</span><span class="p">(</span>
</span><span id="MTLLoss.on_test_batch_end-202"><a href="#MTLLoss.on_test_batch_end-202"><span class="linenos">202</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLLoss.on_test_batch_end-203"><a href="#MTLLoss.on_test_batch_end-203"><span class="linenos">203</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLLoss.on_test_batch_end-204"><a href="#MTLLoss.on_test_batch_end-204"><span class="linenos">204</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLLoss.on_test_batch_end-205"><a href="#MTLLoss.on_test_batch_end-205"><span class="linenos">205</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="MTLLoss.on_test_batch_end-206"><a href="#MTLLoss.on_test_batch_end-206"><span class="linenos">206</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="MTLLoss.on_test_batch_end-207"><a href="#MTLLoss.on_test_batch_end-207"><span class="linenos">207</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="MTLLoss.on_test_batch_end-208"><a href="#MTLLoss.on_test_batch_end-208"><span class="linenos">208</span></a>        <span class="n">dataloader_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="MTLLoss.on_test_batch_end-209"><a href="#MTLLoss.on_test_batch_end-209"><span class="linenos">209</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss.on_test_batch_end-210"><a href="#MTLLoss.on_test_batch_end-210"><span class="linenos">210</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from test batch. We don&#39;t need to log and monitor the metrics of test batches.</span>
</span><span id="MTLLoss.on_test_batch_end-211"><a href="#MTLLoss.on_test_batch_end-211"><span class="linenos">211</span></a>
</span><span id="MTLLoss.on_test_batch_end-212"><a href="#MTLLoss.on_test_batch_end-212"><span class="linenos">212</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLLoss.on_test_batch_end-213"><a href="#MTLLoss.on_test_batch_end-213"><span class="linenos">213</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the test step, which is the returns of the `test_step()` method in the `MTLAlgorithm`.</span>
</span><span id="MTLLoss.on_test_batch_end-214"><a href="#MTLLoss.on_test_batch_end-214"><span class="linenos">214</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="MTLLoss.on_test_batch_end-215"><a href="#MTLLoss.on_test_batch_end-215"><span class="linenos">215</span></a><span class="sd">        - **dataloader_idx** (`int`): the task ID of seen tasks to be tested. A default value of 0 is given otherwise the LightningModule will raise a `RuntimeError`.</span>
</span><span id="MTLLoss.on_test_batch_end-216"><a href="#MTLLoss.on_test_batch_end-216"><span class="linenos">216</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLLoss.on_test_batch_end-217"><a href="#MTLLoss.on_test_batch_end-217"><span class="linenos">217</span></a>
</span><span id="MTLLoss.on_test_batch_end-218"><a href="#MTLLoss.on_test_batch_end-218"><span class="linenos">218</span></a>        <span class="c1"># get the batch size</span>
</span><span id="MTLLoss.on_test_batch_end-219"><a href="#MTLLoss.on_test_batch_end-219"><span class="linenos">219</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="MTLLoss.on_test_batch_end-220"><a href="#MTLLoss.on_test_batch_end-220"><span class="linenos">220</span></a>
</span><span id="MTLLoss.on_test_batch_end-221"><a href="#MTLLoss.on_test_batch_end-221"><span class="linenos">221</span></a>        <span class="n">test_task_id</span> <span class="o">=</span> <span class="n">pl_module</span><span class="o">.</span><span class="n">get_test_task_id_from_dataloader_idx</span><span class="p">(</span><span class="n">dataloader_idx</span><span class="p">)</span>
</span><span id="MTLLoss.on_test_batch_end-222"><a href="#MTLLoss.on_test_batch_end-222"><span class="linenos">222</span></a>
</span><span id="MTLLoss.on_test_batch_end-223"><a href="#MTLLoss.on_test_batch_end-223"><span class="linenos">223</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="MTLLoss.on_test_batch_end-224"><a href="#MTLLoss.on_test_batch_end-224"><span class="linenos">224</span></a>        <span class="n">loss_cls_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="MTLLoss.on_test_batch_end-225"><a href="#MTLLoss.on_test_batch_end-225"><span class="linenos">225</span></a>
</span><span id="MTLLoss.on_test_batch_end-226"><a href="#MTLLoss.on_test_batch_end-226"><span class="linenos">226</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the metrics of the epoch</span>
</span><span id="MTLLoss.on_test_batch_end-227"><a href="#MTLLoss.on_test_batch_end-227"><span class="linenos">227</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="p">[</span><span class="n">test_task_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Accumulating metrics from test batch. We don't need to log and monitor the metrics of test batches.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the test step, which is the returns of the <code>test_step()</code> method in the <code>MTLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the validation data batch.</li>
<li><strong>dataloader_idx</strong> (<code>int</code>): the task ID of seen tasks to be tested. A default value of 0 is given otherwise the LightningModule will raise a <code>RuntimeError</code>.</li>
</ul>
</div>


                            </div>
                            <div id="MTLLoss.on_test_epoch_end" class="classattr">
                                        <input id="MTLLoss.on_test_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_test_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="mtl_algorithms/base.html#MTLAlgorithm">clarena.mtl_algorithms.base.MTLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLLoss.on_test_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLLoss.on_test_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLLoss.on_test_epoch_end-229"><a href="#MTLLoss.on_test_epoch_end-229"><span class="linenos">229</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_epoch_end</span><span class="p">(</span>
</span><span id="MTLLoss.on_test_epoch_end-230"><a href="#MTLLoss.on_test_epoch_end-230"><span class="linenos">230</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLLoss.on_test_epoch_end-231"><a href="#MTLLoss.on_test_epoch_end-231"><span class="linenos">231</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="MTLLoss.on_test_epoch_end-232"><a href="#MTLLoss.on_test_epoch_end-232"><span class="linenos">232</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">MTLAlgorithm</span><span class="p">,</span>
</span><span id="MTLLoss.on_test_epoch_end-233"><a href="#MTLLoss.on_test_epoch_end-233"><span class="linenos">233</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss.on_test_epoch_end-234"><a href="#MTLLoss.on_test_epoch_end-234"><span class="linenos">234</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save and plot test metrics at the end of test.&quot;&quot;&quot;</span>
</span><span id="MTLLoss.on_test_epoch_end-235"><a href="#MTLLoss.on_test_epoch_end-235"><span class="linenos">235</span></a>
</span><span id="MTLLoss.on_test_epoch_end-236"><a href="#MTLLoss.on_test_epoch_end-236"><span class="linenos">236</span></a>        <span class="c1"># save (update) the test metrics to CSV files</span>
</span><span id="MTLLoss.on_test_epoch_end-237"><a href="#MTLLoss.on_test_epoch_end-237"><span class="linenos">237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_test_loss_cls_to_csv</span><span class="p">(</span>
</span><span id="MTLLoss.on_test_epoch_end-238"><a href="#MTLLoss.on_test_epoch_end-238"><span class="linenos">238</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_csv_path</span><span class="p">,</span>
</span><span id="MTLLoss.on_test_epoch_end-239"><a href="#MTLLoss.on_test_epoch_end-239"><span class="linenos">239</span></a>        <span class="p">)</span>
</span><span id="MTLLoss.on_test_epoch_end-240"><a href="#MTLLoss.on_test_epoch_end-240"><span class="linenos">240</span></a>
</span><span id="MTLLoss.on_test_epoch_end-241"><a href="#MTLLoss.on_test_epoch_end-241"><span class="linenos">241</span></a>        <span class="c1"># plot the test metrics</span>
</span><span id="MTLLoss.on_test_epoch_end-242"><a href="#MTLLoss.on_test_epoch_end-242"><span class="linenos">242</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_plot_path</span><span class="p">:</span>
</span><span id="MTLLoss.on_test_epoch_end-243"><a href="#MTLLoss.on_test_epoch_end-243"><span class="linenos">243</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plot_test_loss_cls_from_csv</span><span class="p">(</span>
</span><span id="MTLLoss.on_test_epoch_end-244"><a href="#MTLLoss.on_test_epoch_end-244"><span class="linenos">244</span></a>                <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_csv_path</span><span class="p">,</span>
</span><span id="MTLLoss.on_test_epoch_end-245"><a href="#MTLLoss.on_test_epoch_end-245"><span class="linenos">245</span></a>                <span class="n">plot_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_plot_path</span><span class="p">,</span>
</span><span id="MTLLoss.on_test_epoch_end-246"><a href="#MTLLoss.on_test_epoch_end-246"><span class="linenos">246</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save and plot test metrics at the end of test.</p>
</div>


                            </div>
                            <div id="MTLLoss.save_test_loss_cls_to_csv" class="classattr">
                                        <input id="MTLLoss.save_test_loss_cls_to_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_test_loss_cls_to_csv</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLLoss.save_test_loss_cls_to_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLLoss.save_test_loss_cls_to_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLLoss.save_test_loss_cls_to_csv-248"><a href="#MTLLoss.save_test_loss_cls_to_csv-248"><span class="linenos">248</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_test_loss_cls_to_csv</span><span class="p">(</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-249"><a href="#MTLLoss.save_test_loss_cls_to_csv-249"><span class="linenos">249</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-250"><a href="#MTLLoss.save_test_loss_cls_to_csv-250"><span class="linenos">250</span></a>        <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-251"><a href="#MTLLoss.save_test_loss_cls_to_csv-251"><span class="linenos">251</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-252"><a href="#MTLLoss.save_test_loss_cls_to_csv-252"><span class="linenos">252</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save the test classification loss metrics of all tasks in multi-task learning to an CSV file.</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-253"><a href="#MTLLoss.save_test_loss_cls_to_csv-253"><span class="linenos">253</span></a>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-254"><a href="#MTLLoss.save_test_loss_cls_to_csv-254"><span class="linenos">254</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-255"><a href="#MTLLoss.save_test_loss_cls_to_csv-255"><span class="linenos">255</span></a><span class="sd">        - **csv_path** (`str`): save the test metric to path. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/loss_cls.csv&#39;.</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-256"><a href="#MTLLoss.save_test_loss_cls_to_csv-256"><span class="linenos">256</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-257"><a href="#MTLLoss.save_test_loss_cls_to_csv-257"><span class="linenos">257</span></a>        <span class="n">all_task_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-258"><a href="#MTLLoss.save_test_loss_cls_to_csv-258"><span class="linenos">258</span></a>        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;average_classification_loss&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-259"><a href="#MTLLoss.save_test_loss_cls_to_csv-259"><span class="linenos">259</span></a>            <span class="sa">f</span><span class="s2">&quot;test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">all_task_ids</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-260"><a href="#MTLLoss.save_test_loss_cls_to_csv-260"><span class="linenos">260</span></a>        <span class="p">]</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-261"><a href="#MTLLoss.save_test_loss_cls_to_csv-261"><span class="linenos">261</span></a>        <span class="n">new_line</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-262"><a href="#MTLLoss.save_test_loss_cls_to_csv-262"><span class="linenos">262</span></a>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-263"><a href="#MTLLoss.save_test_loss_cls_to_csv-263"><span class="linenos">263</span></a>        <span class="c1"># construct the columns and calculate the average loss over tasks at the same time</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-264"><a href="#MTLLoss.save_test_loss_cls_to_csv-264"><span class="linenos">264</span></a>        <span class="n">average_loss_over_tasks</span> <span class="o">=</span> <span class="n">MeanMetric</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-265"><a href="#MTLLoss.save_test_loss_cls_to_csv-265"><span class="linenos">265</span></a>            <span class="n">device</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">device</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-266"><a href="#MTLLoss.save_test_loss_cls_to_csv-266"><span class="linenos">266</span></a>        <span class="p">)</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-267"><a href="#MTLLoss.save_test_loss_cls_to_csv-267"><span class="linenos">267</span></a>        <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">all_task_ids</span><span class="p">:</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-268"><a href="#MTLLoss.save_test_loss_cls_to_csv-268"><span class="linenos">268</span></a>            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-269"><a href="#MTLLoss.save_test_loss_cls_to_csv-269"><span class="linenos">269</span></a>            <span class="n">new_line</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;test_on_task_</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-270"><a href="#MTLLoss.save_test_loss_cls_to_csv-270"><span class="linenos">270</span></a>            <span class="n">average_loss_over_tasks</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-271"><a href="#MTLLoss.save_test_loss_cls_to_csv-271"><span class="linenos">271</span></a>        <span class="n">new_line</span><span class="p">[</span><span class="s2">&quot;average_classification_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-272"><a href="#MTLLoss.save_test_loss_cls_to_csv-272"><span class="linenos">272</span></a>            <span class="n">average_loss_over_tasks</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-273"><a href="#MTLLoss.save_test_loss_cls_to_csv-273"><span class="linenos">273</span></a>        <span class="p">)</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-274"><a href="#MTLLoss.save_test_loss_cls_to_csv-274"><span class="linenos">274</span></a>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-275"><a href="#MTLLoss.save_test_loss_cls_to_csv-275"><span class="linenos">275</span></a>        <span class="c1"># write</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-276"><a href="#MTLLoss.save_test_loss_cls_to_csv-276"><span class="linenos">276</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-277"><a href="#MTLLoss.save_test_loss_cls_to_csv-277"><span class="linenos">277</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-278"><a href="#MTLLoss.save_test_loss_cls_to_csv-278"><span class="linenos">278</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="MTLLoss.save_test_loss_cls_to_csv-279"><a href="#MTLLoss.save_test_loss_cls_to_csv-279"><span class="linenos">279</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save the test classification loss metrics of all tasks in multi-task learning to an CSV file.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>csv_path</strong> (<code>str</code>): save the test metric to path. E.g. './outputs/expr_name/1970-01-01_00-00-00/results/loss_cls.csv'.</li>
</ul>
</div>


                            </div>
                            <div id="MTLLoss.plot_test_loss_cls_from_csv" class="classattr">
                                        <input id="MTLLoss.plot_test_loss_cls_from_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_test_loss_cls_from_csv</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MTLLoss.plot_test_loss_cls_from_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MTLLoss.plot_test_loss_cls_from_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MTLLoss.plot_test_loss_cls_from_csv-281"><a href="#MTLLoss.plot_test_loss_cls_from_csv-281"><span class="linenos">281</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_test_loss_cls_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-282"><a href="#MTLLoss.plot_test_loss_cls_from_csv-282"><span class="linenos">282</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the test classification loss bar chart of all tasks in multi-task learning from saved CSV file and save the plot to the designated directory.</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-283"><a href="#MTLLoss.plot_test_loss_cls_from_csv-283"><span class="linenos">283</span></a>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-284"><a href="#MTLLoss.plot_test_loss_cls_from_csv-284"><span class="linenos">284</span></a><span class="sd">        **Args:**</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-285"><a href="#MTLLoss.plot_test_loss_cls_from_csv-285"><span class="linenos">285</span></a><span class="sd">        - **csv_path** (`str`): the path to the csv file where the `utils.save_test_acc_csv()` saved the test classification loss metric.</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-286"><a href="#MTLLoss.plot_test_loss_cls_from_csv-286"><span class="linenos">286</span></a><span class="sd">        - **plot_path** (`str`): the path to save plot. Better same as the output directory of the experiment. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/loss_cls.png&#39;.</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-287"><a href="#MTLLoss.plot_test_loss_cls_from_csv-287"><span class="linenos">287</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-288"><a href="#MTLLoss.plot_test_loss_cls_from_csv-288"><span class="linenos">288</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-289"><a href="#MTLLoss.plot_test_loss_cls_from_csv-289"><span class="linenos">289</span></a>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-290"><a href="#MTLLoss.plot_test_loss_cls_from_csv-290"><span class="linenos">290</span></a>        <span class="c1"># extract all accuracy columns including average</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-291"><a href="#MTLLoss.plot_test_loss_cls_from_csv-291"><span class="linenos">291</span></a>        <span class="n">all_columns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-292"><a href="#MTLLoss.plot_test_loss_cls_from_csv-292"><span class="linenos">292</span></a>        <span class="n">task_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_columns</span><span class="p">)))</span>  <span class="c1"># assign index-based positions</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-293"><a href="#MTLLoss.plot_test_loss_cls_from_csv-293"><span class="linenos">293</span></a>        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-294"><a href="#MTLLoss.plot_test_loss_cls_from_csv-294"><span class="linenos">294</span></a>            <span class="p">(</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-295"><a href="#MTLLoss.plot_test_loss_cls_from_csv-295"><span class="linenos">295</span></a>                <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;test_on_task_&quot;</span><span class="p">,</span> <span class="s2">&quot;Task &quot;</span><span class="p">)</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-296"><a href="#MTLLoss.plot_test_loss_cls_from_csv-296"><span class="linenos">296</span></a>                <span class="k">if</span> <span class="s2">&quot;test_on_task_&quot;</span> <span class="ow">in</span> <span class="n">col</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-297"><a href="#MTLLoss.plot_test_loss_cls_from_csv-297"><span class="linenos">297</span></a>                <span class="k">else</span> <span class="s2">&quot;Average&quot;</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-298"><a href="#MTLLoss.plot_test_loss_cls_from_csv-298"><span class="linenos">298</span></a>            <span class="p">)</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-299"><a href="#MTLLoss.plot_test_loss_cls_from_csv-299"><span class="linenos">299</span></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">all_columns</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-300"><a href="#MTLLoss.plot_test_loss_cls_from_csv-300"><span class="linenos">300</span></a>        <span class="p">]</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-301"><a href="#MTLLoss.plot_test_loss_cls_from_csv-301"><span class="linenos">301</span></a>        <span class="n">loss_cls</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">all_columns</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-302"><a href="#MTLLoss.plot_test_loss_cls_from_csv-302"><span class="linenos">302</span></a>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-303"><a href="#MTLLoss.plot_test_loss_cls_from_csv-303"><span class="linenos">303</span></a>        <span class="c1"># plot the classification loss bar chart over tasks</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-304"><a href="#MTLLoss.plot_test_loss_cls_from_csv-304"><span class="linenos">304</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-305"><a href="#MTLLoss.plot_test_loss_cls_from_csv-305"><span class="linenos">305</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-306"><a href="#MTLLoss.plot_test_loss_cls_from_csv-306"><span class="linenos">306</span></a>            <span class="n">task_ids</span><span class="p">,</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-307"><a href="#MTLLoss.plot_test_loss_cls_from_csv-307"><span class="linenos">307</span></a>            <span class="n">loss_cls</span><span class="p">,</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-308"><a href="#MTLLoss.plot_test_loss_cls_from_csv-308"><span class="linenos">308</span></a>            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;skyblue&quot;</span><span class="p">,</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-309"><a href="#MTLLoss.plot_test_loss_cls_from_csv-309"><span class="linenos">309</span></a>            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-310"><a href="#MTLLoss.plot_test_loss_cls_from_csv-310"><span class="linenos">310</span></a>        <span class="p">)</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-311"><a href="#MTLLoss.plot_test_loss_cls_from_csv-311"><span class="linenos">311</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Task&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-312"><a href="#MTLLoss.plot_test_loss_cls_from_csv-312"><span class="linenos">312</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Classification Loss&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-313"><a href="#MTLLoss.plot_test_loss_cls_from_csv-313"><span class="linenos">313</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-314"><a href="#MTLLoss.plot_test_loss_cls_from_csv-314"><span class="linenos">314</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">task_ids</span><span class="p">)</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-315"><a href="#MTLLoss.plot_test_loss_cls_from_csv-315"><span class="linenos">315</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-316"><a href="#MTLLoss.plot_test_loss_cls_from_csv-316"><span class="linenos">316</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="n">i</span> <span class="o">*</span> <span class="mf">0.05</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">)])</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-317"><a href="#MTLLoss.plot_test_loss_cls_from_csv-317"><span class="linenos">317</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-318"><a href="#MTLLoss.plot_test_loss_cls_from_csv-318"><span class="linenos">318</span></a>            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mf">0.05</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">)]],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-319"><a href="#MTLLoss.plot_test_loss_cls_from_csv-319"><span class="linenos">319</span></a>        <span class="p">)</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-320"><a href="#MTLLoss.plot_test_loss_cls_from_csv-320"><span class="linenos">320</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-321"><a href="#MTLLoss.plot_test_loss_cls_from_csv-321"><span class="linenos">321</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
</span><span id="MTLLoss.plot_test_loss_cls_from_csv-322"><a href="#MTLLoss.plot_test_loss_cls_from_csv-322"><span class="linenos">322</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plot the test classification loss bar chart of all tasks in multi-task learning from saved CSV file and save the plot to the designated directory.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>csv_path</strong> (<code>str</code>): the path to the csv file where the <code>utils.save_test_acc_csv()</code> saved the test classification loss metric.</li>
<li><strong>plot_path</strong> (<code>str</code>): the path to save plot. Better same as the output directory of the experiment. E.g. './outputs/expr_name/1970-01-01_00-00-00/loss_cls.png'.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="STLAccuracy">
                            <input id="STLAccuracy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">STLAccuracy</span><wbr>(<span class="base"><a href="#MetricCallback">clarena.metrics.MetricCallback</a></span>):

                <label class="view-source-button" for="STLAccuracy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLAccuracy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLAccuracy-23"><a href="#STLAccuracy-23"><span class="linenos"> 23</span></a><span class="k">class</span><span class="w"> </span><span class="nc">STLAccuracy</span><span class="p">(</span><span class="n">MetricCallback</span><span class="p">):</span>
</span><span id="STLAccuracy-24"><a href="#STLAccuracy-24"><span class="linenos"> 24</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Provides all actions that are related to STL accuracy metric, which include:</span>
</span><span id="STLAccuracy-25"><a href="#STLAccuracy-25"><span class="linenos"> 25</span></a>
</span><span id="STLAccuracy-26"><a href="#STLAccuracy-26"><span class="linenos"> 26</span></a><span class="sd">    - Defining, initializing and recording accuracy metric.</span>
</span><span id="STLAccuracy-27"><a href="#STLAccuracy-27"><span class="linenos"> 27</span></a><span class="sd">    - Logging training and validation accuracy metric to Lightning loggers in real time.</span>
</span><span id="STLAccuracy-28"><a href="#STLAccuracy-28"><span class="linenos"> 28</span></a>
</span><span id="STLAccuracy-29"><a href="#STLAccuracy-29"><span class="linenos"> 29</span></a><span class="sd">    Saving test accuracy metric to files.</span>
</span><span id="STLAccuracy-30"><a href="#STLAccuracy-30"><span class="linenos"> 30</span></a>
</span><span id="STLAccuracy-31"><a href="#STLAccuracy-31"><span class="linenos"> 31</span></a><span class="sd">    - The callback is able to produce the following outputs:</span>
</span><span id="STLAccuracy-32"><a href="#STLAccuracy-32"><span class="linenos"> 32</span></a><span class="sd">    - CSV files for test accuracy.</span>
</span><span id="STLAccuracy-33"><a href="#STLAccuracy-33"><span class="linenos"> 33</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="STLAccuracy-34"><a href="#STLAccuracy-34"><span class="linenos"> 34</span></a>
</span><span id="STLAccuracy-35"><a href="#STLAccuracy-35"><span class="linenos"> 35</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="STLAccuracy-36"><a href="#STLAccuracy-36"><span class="linenos"> 36</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLAccuracy-37"><a href="#STLAccuracy-37"><span class="linenos"> 37</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="STLAccuracy-38"><a href="#STLAccuracy-38"><span class="linenos"> 38</span></a>        <span class="n">test_acc_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;acc.csv&quot;</span><span class="p">,</span>
</span><span id="STLAccuracy-39"><a href="#STLAccuracy-39"><span class="linenos"> 39</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy-40"><a href="#STLAccuracy-40"><span class="linenos"> 40</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `STLAccuracy`.</span>
</span><span id="STLAccuracy-41"><a href="#STLAccuracy-41"><span class="linenos"> 41</span></a>
</span><span id="STLAccuracy-42"><a href="#STLAccuracy-42"><span class="linenos"> 42</span></a><span class="sd">        **Args:**</span>
</span><span id="STLAccuracy-43"><a href="#STLAccuracy-43"><span class="linenos"> 43</span></a><span class="sd">        - **save_dir** (`str`): The directory where data and figures of metrics will be saved. Better inside the output folder.</span>
</span><span id="STLAccuracy-44"><a href="#STLAccuracy-44"><span class="linenos"> 44</span></a><span class="sd">        - **test_acc_csv_name** (`str`): file name to save test accuracy of all tasks and average accuracy as CSV file.</span>
</span><span id="STLAccuracy-45"><a href="#STLAccuracy-45"><span class="linenos"> 45</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLAccuracy-46"><a href="#STLAccuracy-46"><span class="linenos"> 46</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="STLAccuracy-47"><a href="#STLAccuracy-47"><span class="linenos"> 47</span></a>
</span><span id="STLAccuracy-48"><a href="#STLAccuracy-48"><span class="linenos"> 48</span></a>        <span class="c1"># paths</span>
</span><span id="STLAccuracy-49"><a href="#STLAccuracy-49"><span class="linenos"> 49</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_acc_csv_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">test_acc_csv_name</span><span class="p">)</span>
</span><span id="STLAccuracy-50"><a href="#STLAccuracy-50"><span class="linenos"> 50</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The path to save test accuracy of all tasks and average accuracy CSV file.&quot;&quot;&quot;</span>
</span><span id="STLAccuracy-51"><a href="#STLAccuracy-51"><span class="linenos"> 51</span></a>
</span><span id="STLAccuracy-52"><a href="#STLAccuracy-52"><span class="linenos"> 52</span></a>        <span class="c1"># training accumulated metrics</span>
</span><span id="STLAccuracy-53"><a href="#STLAccuracy-53"><span class="linenos"> 53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="STLAccuracy-54"><a href="#STLAccuracy-54"><span class="linenos"> 54</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Classification accuracy of training epoch. Accumulated and calculated from the training batches. &quot;&quot;&quot;</span>
</span><span id="STLAccuracy-55"><a href="#STLAccuracy-55"><span class="linenos"> 55</span></a>
</span><span id="STLAccuracy-56"><a href="#STLAccuracy-56"><span class="linenos"> 56</span></a>        <span class="c1"># validation accumulated metrics</span>
</span><span id="STLAccuracy-57"><a href="#STLAccuracy-57"><span class="linenos"> 57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="STLAccuracy-58"><a href="#STLAccuracy-58"><span class="linenos"> 58</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Validation classification accuracy of the model after training epoch. Accumulated and calculated from the validation batches. &quot;&quot;&quot;</span>
</span><span id="STLAccuracy-59"><a href="#STLAccuracy-59"><span class="linenos"> 59</span></a>
</span><span id="STLAccuracy-60"><a href="#STLAccuracy-60"><span class="linenos"> 60</span></a>        <span class="c1"># test accumulated metrics</span>
</span><span id="STLAccuracy-61"><a href="#STLAccuracy-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="STLAccuracy-62"><a href="#STLAccuracy-62"><span class="linenos"> 62</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Test classification accuracy. Accumulated and calculated from the test batches.&quot;&quot;&quot;</span>
</span><span id="STLAccuracy-63"><a href="#STLAccuracy-63"><span class="linenos"> 63</span></a>
</span><span id="STLAccuracy-64"><a href="#STLAccuracy-64"><span class="linenos"> 64</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_fit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy-65"><a href="#STLAccuracy-65"><span class="linenos"> 65</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize training and validation metrics.&quot;&quot;&quot;</span>
</span><span id="STLAccuracy-66"><a href="#STLAccuracy-66"><span class="linenos"> 66</span></a>
</span><span id="STLAccuracy-67"><a href="#STLAccuracy-67"><span class="linenos"> 67</span></a>        <span class="c1"># initialize training metrics</span>
</span><span id="STLAccuracy-68"><a href="#STLAccuracy-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span>
</span><span id="STLAccuracy-69"><a href="#STLAccuracy-69"><span class="linenos"> 69</span></a>
</span><span id="STLAccuracy-70"><a href="#STLAccuracy-70"><span class="linenos"> 70</span></a>        <span class="c1"># initialize validation metrics</span>
</span><span id="STLAccuracy-71"><a href="#STLAccuracy-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span>
</span><span id="STLAccuracy-72"><a href="#STLAccuracy-72"><span class="linenos"> 72</span></a>
</span><span id="STLAccuracy-73"><a href="#STLAccuracy-73"><span class="linenos"> 73</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span>
</span><span id="STLAccuracy-74"><a href="#STLAccuracy-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLAccuracy-75"><a href="#STLAccuracy-75"><span class="linenos"> 75</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLAccuracy-76"><a href="#STLAccuracy-76"><span class="linenos"> 76</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLAccuracy-77"><a href="#STLAccuracy-77"><span class="linenos"> 77</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="STLAccuracy-78"><a href="#STLAccuracy-78"><span class="linenos"> 78</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="STLAccuracy-79"><a href="#STLAccuracy-79"><span class="linenos"> 79</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="STLAccuracy-80"><a href="#STLAccuracy-80"><span class="linenos"> 80</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy-81"><a href="#STLAccuracy-81"><span class="linenos"> 81</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Record training metrics from training batch, log metrics of training batch and accumulated metrics of the epoch to Lightning loggers.</span>
</span><span id="STLAccuracy-82"><a href="#STLAccuracy-82"><span class="linenos"> 82</span></a>
</span><span id="STLAccuracy-83"><a href="#STLAccuracy-83"><span class="linenos"> 83</span></a><span class="sd">        **Args:**</span>
</span><span id="STLAccuracy-84"><a href="#STLAccuracy-84"><span class="linenos"> 84</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the training step, the returns of the `training_step()` method in the `STLAlgorithm`.</span>
</span><span id="STLAccuracy-85"><a href="#STLAccuracy-85"><span class="linenos"> 85</span></a><span class="sd">        - **batch** (`Any`): the training data batch.</span>
</span><span id="STLAccuracy-86"><a href="#STLAccuracy-86"><span class="linenos"> 86</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLAccuracy-87"><a href="#STLAccuracy-87"><span class="linenos"> 87</span></a>        <span class="c1"># get the batch size</span>
</span><span id="STLAccuracy-88"><a href="#STLAccuracy-88"><span class="linenos"> 88</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="STLAccuracy-89"><a href="#STLAccuracy-89"><span class="linenos"> 89</span></a>
</span><span id="STLAccuracy-90"><a href="#STLAccuracy-90"><span class="linenos"> 90</span></a>        <span class="c1"># get training metrics values of current training batch from the outputs of the `training_step()`</span>
</span><span id="STLAccuracy-91"><a href="#STLAccuracy-91"><span class="linenos"> 91</span></a>        <span class="n">acc_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
</span><span id="STLAccuracy-92"><a href="#STLAccuracy-92"><span class="linenos"> 92</span></a>
</span><span id="STLAccuracy-93"><a href="#STLAccuracy-93"><span class="linenos"> 93</span></a>        <span class="c1"># update accumulated training metrics to calculate training metrics of the epoch</span>
</span><span id="STLAccuracy-94"><a href="#STLAccuracy-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="STLAccuracy-95"><a href="#STLAccuracy-95"><span class="linenos"> 95</span></a>
</span><span id="STLAccuracy-96"><a href="#STLAccuracy-96"><span class="linenos"> 96</span></a>        <span class="c1"># log training metrics of current training batch to Lightning loggers</span>
</span><span id="STLAccuracy-97"><a href="#STLAccuracy-97"><span class="linenos"> 97</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;train/acc_batch&quot;</span><span class="p">,</span> <span class="n">acc_batch</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="STLAccuracy-98"><a href="#STLAccuracy-98"><span class="linenos"> 98</span></a>
</span><span id="STLAccuracy-99"><a href="#STLAccuracy-99"><span class="linenos"> 99</span></a>        <span class="c1"># log accumulated training metrics till this training batch to Lightning loggers</span>
</span><span id="STLAccuracy-100"><a href="#STLAccuracy-100"><span class="linenos">100</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="STLAccuracy-101"><a href="#STLAccuracy-101"><span class="linenos">101</span></a>            <span class="s2">&quot;task/train/acc&quot;</span><span class="p">,</span>
</span><span id="STLAccuracy-102"><a href="#STLAccuracy-102"><span class="linenos">102</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="STLAccuracy-103"><a href="#STLAccuracy-103"><span class="linenos">103</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLAccuracy-104"><a href="#STLAccuracy-104"><span class="linenos">104</span></a>        <span class="p">)</span>
</span><span id="STLAccuracy-105"><a href="#STLAccuracy-105"><span class="linenos">105</span></a>
</span><span id="STLAccuracy-106"><a href="#STLAccuracy-106"><span class="linenos">106</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_epoch_end</span><span class="p">(</span>
</span><span id="STLAccuracy-107"><a href="#STLAccuracy-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLAccuracy-108"><a href="#STLAccuracy-108"><span class="linenos">108</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLAccuracy-109"><a href="#STLAccuracy-109"><span class="linenos">109</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLAccuracy-110"><a href="#STLAccuracy-110"><span class="linenos">110</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy-111"><a href="#STLAccuracy-111"><span class="linenos">111</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log metrics of training epoch to plot learning curves and reset the metrics accumulation at the end of training epoch.&quot;&quot;&quot;</span>
</span><span id="STLAccuracy-112"><a href="#STLAccuracy-112"><span class="linenos">112</span></a>
</span><span id="STLAccuracy-113"><a href="#STLAccuracy-113"><span class="linenos">113</span></a>        <span class="c1"># log the accumulated and computed metrics of the epoch to Lightning loggers, specially for plotting learning curves</span>
</span><span id="STLAccuracy-114"><a href="#STLAccuracy-114"><span class="linenos">114</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="STLAccuracy-115"><a href="#STLAccuracy-115"><span class="linenos">115</span></a>            <span class="s2">&quot;learning_curve/train/acc&quot;</span><span class="p">,</span>
</span><span id="STLAccuracy-116"><a href="#STLAccuracy-116"><span class="linenos">116</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="STLAccuracy-117"><a href="#STLAccuracy-117"><span class="linenos">117</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLAccuracy-118"><a href="#STLAccuracy-118"><span class="linenos">118</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLAccuracy-119"><a href="#STLAccuracy-119"><span class="linenos">119</span></a>        <span class="p">)</span>
</span><span id="STLAccuracy-120"><a href="#STLAccuracy-120"><span class="linenos">120</span></a>
</span><span id="STLAccuracy-121"><a href="#STLAccuracy-121"><span class="linenos">121</span></a>        <span class="c1"># reset the metrics of training epoch as there are more epochs to go and not only one epoch like in the validation and test</span>
</span><span id="STLAccuracy-122"><a href="#STLAccuracy-122"><span class="linenos">122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span><span id="STLAccuracy-123"><a href="#STLAccuracy-123"><span class="linenos">123</span></a>
</span><span id="STLAccuracy-124"><a href="#STLAccuracy-124"><span class="linenos">124</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_batch_end</span><span class="p">(</span>
</span><span id="STLAccuracy-125"><a href="#STLAccuracy-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLAccuracy-126"><a href="#STLAccuracy-126"><span class="linenos">126</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLAccuracy-127"><a href="#STLAccuracy-127"><span class="linenos">127</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLAccuracy-128"><a href="#STLAccuracy-128"><span class="linenos">128</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="STLAccuracy-129"><a href="#STLAccuracy-129"><span class="linenos">129</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="STLAccuracy-130"><a href="#STLAccuracy-130"><span class="linenos">130</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="STLAccuracy-131"><a href="#STLAccuracy-131"><span class="linenos">131</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy-132"><a href="#STLAccuracy-132"><span class="linenos">132</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from validation batch. We don&#39;t need to log and monitor the metrics of validation batches.</span>
</span><span id="STLAccuracy-133"><a href="#STLAccuracy-133"><span class="linenos">133</span></a>
</span><span id="STLAccuracy-134"><a href="#STLAccuracy-134"><span class="linenos">134</span></a><span class="sd">        **Args:**</span>
</span><span id="STLAccuracy-135"><a href="#STLAccuracy-135"><span class="linenos">135</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the validation step, which is the returns of the `validation_step()` method in the `STLAlgorithm`.</span>
</span><span id="STLAccuracy-136"><a href="#STLAccuracy-136"><span class="linenos">136</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="STLAccuracy-137"><a href="#STLAccuracy-137"><span class="linenos">137</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLAccuracy-138"><a href="#STLAccuracy-138"><span class="linenos">138</span></a>
</span><span id="STLAccuracy-139"><a href="#STLAccuracy-139"><span class="linenos">139</span></a>        <span class="c1"># get the batch size</span>
</span><span id="STLAccuracy-140"><a href="#STLAccuracy-140"><span class="linenos">140</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="STLAccuracy-141"><a href="#STLAccuracy-141"><span class="linenos">141</span></a>
</span><span id="STLAccuracy-142"><a href="#STLAccuracy-142"><span class="linenos">142</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="STLAccuracy-143"><a href="#STLAccuracy-143"><span class="linenos">143</span></a>        <span class="n">acc_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
</span><span id="STLAccuracy-144"><a href="#STLAccuracy-144"><span class="linenos">144</span></a>
</span><span id="STLAccuracy-145"><a href="#STLAccuracy-145"><span class="linenos">145</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the validation metrics</span>
</span><span id="STLAccuracy-146"><a href="#STLAccuracy-146"><span class="linenos">146</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="STLAccuracy-147"><a href="#STLAccuracy-147"><span class="linenos">147</span></a>
</span><span id="STLAccuracy-148"><a href="#STLAccuracy-148"><span class="linenos">148</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_epoch_end</span><span class="p">(</span>
</span><span id="STLAccuracy-149"><a href="#STLAccuracy-149"><span class="linenos">149</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLAccuracy-150"><a href="#STLAccuracy-150"><span class="linenos">150</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLAccuracy-151"><a href="#STLAccuracy-151"><span class="linenos">151</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLAccuracy-152"><a href="#STLAccuracy-152"><span class="linenos">152</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy-153"><a href="#STLAccuracy-153"><span class="linenos">153</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log validation metrics to plot learning curves.&quot;&quot;&quot;</span>
</span><span id="STLAccuracy-154"><a href="#STLAccuracy-154"><span class="linenos">154</span></a>
</span><span id="STLAccuracy-155"><a href="#STLAccuracy-155"><span class="linenos">155</span></a>        <span class="c1"># log the accumulated and computed metrics of the epoch to Lightning loggers, specially for plotting learning curves</span>
</span><span id="STLAccuracy-156"><a href="#STLAccuracy-156"><span class="linenos">156</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="STLAccuracy-157"><a href="#STLAccuracy-157"><span class="linenos">157</span></a>            <span class="s2">&quot;learning_curve/val/acc&quot;</span><span class="p">,</span>
</span><span id="STLAccuracy-158"><a href="#STLAccuracy-158"><span class="linenos">158</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="STLAccuracy-159"><a href="#STLAccuracy-159"><span class="linenos">159</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLAccuracy-160"><a href="#STLAccuracy-160"><span class="linenos">160</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLAccuracy-161"><a href="#STLAccuracy-161"><span class="linenos">161</span></a>        <span class="p">)</span>
</span><span id="STLAccuracy-162"><a href="#STLAccuracy-162"><span class="linenos">162</span></a>
</span><span id="STLAccuracy-163"><a href="#STLAccuracy-163"><span class="linenos">163</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_start</span><span class="p">(</span>
</span><span id="STLAccuracy-164"><a href="#STLAccuracy-164"><span class="linenos">164</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLAccuracy-165"><a href="#STLAccuracy-165"><span class="linenos">165</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLAccuracy-166"><a href="#STLAccuracy-166"><span class="linenos">166</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLAccuracy-167"><a href="#STLAccuracy-167"><span class="linenos">167</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy-168"><a href="#STLAccuracy-168"><span class="linenos">168</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the testing metrics.&quot;&quot;&quot;</span>
</span><span id="STLAccuracy-169"><a href="#STLAccuracy-169"><span class="linenos">169</span></a>
</span><span id="STLAccuracy-170"><a href="#STLAccuracy-170"><span class="linenos">170</span></a>        <span class="c1"># initialize test metrics for current and previous tasks</span>
</span><span id="STLAccuracy-171"><a href="#STLAccuracy-171"><span class="linenos">171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span>
</span><span id="STLAccuracy-172"><a href="#STLAccuracy-172"><span class="linenos">172</span></a>
</span><span id="STLAccuracy-173"><a href="#STLAccuracy-173"><span class="linenos">173</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_batch_end</span><span class="p">(</span>
</span><span id="STLAccuracy-174"><a href="#STLAccuracy-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLAccuracy-175"><a href="#STLAccuracy-175"><span class="linenos">175</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLAccuracy-176"><a href="#STLAccuracy-176"><span class="linenos">176</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLAccuracy-177"><a href="#STLAccuracy-177"><span class="linenos">177</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="STLAccuracy-178"><a href="#STLAccuracy-178"><span class="linenos">178</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="STLAccuracy-179"><a href="#STLAccuracy-179"><span class="linenos">179</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="STLAccuracy-180"><a href="#STLAccuracy-180"><span class="linenos">180</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy-181"><a href="#STLAccuracy-181"><span class="linenos">181</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from test batch. We don&#39;t need to log and monitor the metrics of test batches.</span>
</span><span id="STLAccuracy-182"><a href="#STLAccuracy-182"><span class="linenos">182</span></a>
</span><span id="STLAccuracy-183"><a href="#STLAccuracy-183"><span class="linenos">183</span></a><span class="sd">        **Args:**</span>
</span><span id="STLAccuracy-184"><a href="#STLAccuracy-184"><span class="linenos">184</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the test step, which is the returns of the `test_step()` method in the `STLAlgorithm`.</span>
</span><span id="STLAccuracy-185"><a href="#STLAccuracy-185"><span class="linenos">185</span></a><span class="sd">        - **batch** (`Any`): the test data batch.</span>
</span><span id="STLAccuracy-186"><a href="#STLAccuracy-186"><span class="linenos">186</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLAccuracy-187"><a href="#STLAccuracy-187"><span class="linenos">187</span></a>
</span><span id="STLAccuracy-188"><a href="#STLAccuracy-188"><span class="linenos">188</span></a>        <span class="c1"># get the batch size</span>
</span><span id="STLAccuracy-189"><a href="#STLAccuracy-189"><span class="linenos">189</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="STLAccuracy-190"><a href="#STLAccuracy-190"><span class="linenos">190</span></a>
</span><span id="STLAccuracy-191"><a href="#STLAccuracy-191"><span class="linenos">191</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="STLAccuracy-192"><a href="#STLAccuracy-192"><span class="linenos">192</span></a>        <span class="n">acc_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
</span><span id="STLAccuracy-193"><a href="#STLAccuracy-193"><span class="linenos">193</span></a>
</span><span id="STLAccuracy-194"><a href="#STLAccuracy-194"><span class="linenos">194</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the metrics of the epoch</span>
</span><span id="STLAccuracy-195"><a href="#STLAccuracy-195"><span class="linenos">195</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="STLAccuracy-196"><a href="#STLAccuracy-196"><span class="linenos">196</span></a>
</span><span id="STLAccuracy-197"><a href="#STLAccuracy-197"><span class="linenos">197</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_epoch_end</span><span class="p">(</span>
</span><span id="STLAccuracy-198"><a href="#STLAccuracy-198"><span class="linenos">198</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLAccuracy-199"><a href="#STLAccuracy-199"><span class="linenos">199</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLAccuracy-200"><a href="#STLAccuracy-200"><span class="linenos">200</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLAccuracy-201"><a href="#STLAccuracy-201"><span class="linenos">201</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy-202"><a href="#STLAccuracy-202"><span class="linenos">202</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save and plot test metrics at the end of test.&quot;&quot;&quot;</span>
</span><span id="STLAccuracy-203"><a href="#STLAccuracy-203"><span class="linenos">203</span></a>
</span><span id="STLAccuracy-204"><a href="#STLAccuracy-204"><span class="linenos">204</span></a>        <span class="c1"># save (update) the test metrics to CSV files</span>
</span><span id="STLAccuracy-205"><a href="#STLAccuracy-205"><span class="linenos">205</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_test_acc_to_csv</span><span class="p">(</span>
</span><span id="STLAccuracy-206"><a href="#STLAccuracy-206"><span class="linenos">206</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_acc_csv_path</span><span class="p">,</span>
</span><span id="STLAccuracy-207"><a href="#STLAccuracy-207"><span class="linenos">207</span></a>        <span class="p">)</span>
</span><span id="STLAccuracy-208"><a href="#STLAccuracy-208"><span class="linenos">208</span></a>
</span><span id="STLAccuracy-209"><a href="#STLAccuracy-209"><span class="linenos">209</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_test_acc_to_csv</span><span class="p">(</span>
</span><span id="STLAccuracy-210"><a href="#STLAccuracy-210"><span class="linenos">210</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLAccuracy-211"><a href="#STLAccuracy-211"><span class="linenos">211</span></a>        <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="STLAccuracy-212"><a href="#STLAccuracy-212"><span class="linenos">212</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy-213"><a href="#STLAccuracy-213"><span class="linenos">213</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save the test accuracy metrics of all tasks in single-task learning to an CSV file.</span>
</span><span id="STLAccuracy-214"><a href="#STLAccuracy-214"><span class="linenos">214</span></a>
</span><span id="STLAccuracy-215"><a href="#STLAccuracy-215"><span class="linenos">215</span></a><span class="sd">        **Args:**</span>
</span><span id="STLAccuracy-216"><a href="#STLAccuracy-216"><span class="linenos">216</span></a><span class="sd">        - **csv_path** (`str`): save the test metric to path. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/acc.csv&#39;.</span>
</span><span id="STLAccuracy-217"><a href="#STLAccuracy-217"><span class="linenos">217</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLAccuracy-218"><a href="#STLAccuracy-218"><span class="linenos">218</span></a>        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]</span>
</span><span id="STLAccuracy-219"><a href="#STLAccuracy-219"><span class="linenos">219</span></a>        <span class="n">new_line</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="STLAccuracy-220"><a href="#STLAccuracy-220"><span class="linenos">220</span></a>        <span class="n">new_line</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="STLAccuracy-221"><a href="#STLAccuracy-221"><span class="linenos">221</span></a>
</span><span id="STLAccuracy-222"><a href="#STLAccuracy-222"><span class="linenos">222</span></a>        <span class="c1"># write</span>
</span><span id="STLAccuracy-223"><a href="#STLAccuracy-223"><span class="linenos">223</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="STLAccuracy-224"><a href="#STLAccuracy-224"><span class="linenos">224</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="STLAccuracy-225"><a href="#STLAccuracy-225"><span class="linenos">225</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="STLAccuracy-226"><a href="#STLAccuracy-226"><span class="linenos">226</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Provides all actions that are related to STL accuracy metric, which include:</p>

<ul>
<li>Defining, initializing and recording accuracy metric.</li>
<li>Logging training and validation accuracy metric to Lightning loggers in real time.</li>
</ul>

<p>Saving test accuracy metric to files.</p>

<ul>
<li>The callback is able to produce the following outputs:</li>
<li>CSV files for test accuracy.</li>
</ul>
</div>


                            <div id="STLAccuracy.__init__" class="classattr">
                                        <input id="STLAccuracy.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">STLAccuracy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">test_acc_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;acc.csv&#39;</span></span>)</span>

                <label class="view-source-button" for="STLAccuracy.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLAccuracy.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLAccuracy.__init__-35"><a href="#STLAccuracy.__init__-35"><span class="linenos">35</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="STLAccuracy.__init__-36"><a href="#STLAccuracy.__init__-36"><span class="linenos">36</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLAccuracy.__init__-37"><a href="#STLAccuracy.__init__-37"><span class="linenos">37</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="STLAccuracy.__init__-38"><a href="#STLAccuracy.__init__-38"><span class="linenos">38</span></a>        <span class="n">test_acc_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;acc.csv&quot;</span><span class="p">,</span>
</span><span id="STLAccuracy.__init__-39"><a href="#STLAccuracy.__init__-39"><span class="linenos">39</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy.__init__-40"><a href="#STLAccuracy.__init__-40"><span class="linenos">40</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `STLAccuracy`.</span>
</span><span id="STLAccuracy.__init__-41"><a href="#STLAccuracy.__init__-41"><span class="linenos">41</span></a>
</span><span id="STLAccuracy.__init__-42"><a href="#STLAccuracy.__init__-42"><span class="linenos">42</span></a><span class="sd">        **Args:**</span>
</span><span id="STLAccuracy.__init__-43"><a href="#STLAccuracy.__init__-43"><span class="linenos">43</span></a><span class="sd">        - **save_dir** (`str`): The directory where data and figures of metrics will be saved. Better inside the output folder.</span>
</span><span id="STLAccuracy.__init__-44"><a href="#STLAccuracy.__init__-44"><span class="linenos">44</span></a><span class="sd">        - **test_acc_csv_name** (`str`): file name to save test accuracy of all tasks and average accuracy as CSV file.</span>
</span><span id="STLAccuracy.__init__-45"><a href="#STLAccuracy.__init__-45"><span class="linenos">45</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLAccuracy.__init__-46"><a href="#STLAccuracy.__init__-46"><span class="linenos">46</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="STLAccuracy.__init__-47"><a href="#STLAccuracy.__init__-47"><span class="linenos">47</span></a>
</span><span id="STLAccuracy.__init__-48"><a href="#STLAccuracy.__init__-48"><span class="linenos">48</span></a>        <span class="c1"># paths</span>
</span><span id="STLAccuracy.__init__-49"><a href="#STLAccuracy.__init__-49"><span class="linenos">49</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_acc_csv_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">test_acc_csv_name</span><span class="p">)</span>
</span><span id="STLAccuracy.__init__-50"><a href="#STLAccuracy.__init__-50"><span class="linenos">50</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The path to save test accuracy of all tasks and average accuracy CSV file.&quot;&quot;&quot;</span>
</span><span id="STLAccuracy.__init__-51"><a href="#STLAccuracy.__init__-51"><span class="linenos">51</span></a>
</span><span id="STLAccuracy.__init__-52"><a href="#STLAccuracy.__init__-52"><span class="linenos">52</span></a>        <span class="c1"># training accumulated metrics</span>
</span><span id="STLAccuracy.__init__-53"><a href="#STLAccuracy.__init__-53"><span class="linenos">53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="STLAccuracy.__init__-54"><a href="#STLAccuracy.__init__-54"><span class="linenos">54</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Classification accuracy of training epoch. Accumulated and calculated from the training batches. &quot;&quot;&quot;</span>
</span><span id="STLAccuracy.__init__-55"><a href="#STLAccuracy.__init__-55"><span class="linenos">55</span></a>
</span><span id="STLAccuracy.__init__-56"><a href="#STLAccuracy.__init__-56"><span class="linenos">56</span></a>        <span class="c1"># validation accumulated metrics</span>
</span><span id="STLAccuracy.__init__-57"><a href="#STLAccuracy.__init__-57"><span class="linenos">57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="STLAccuracy.__init__-58"><a href="#STLAccuracy.__init__-58"><span class="linenos">58</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Validation classification accuracy of the model after training epoch. Accumulated and calculated from the validation batches. &quot;&quot;&quot;</span>
</span><span id="STLAccuracy.__init__-59"><a href="#STLAccuracy.__init__-59"><span class="linenos">59</span></a>
</span><span id="STLAccuracy.__init__-60"><a href="#STLAccuracy.__init__-60"><span class="linenos">60</span></a>        <span class="c1"># test accumulated metrics</span>
</span><span id="STLAccuracy.__init__-61"><a href="#STLAccuracy.__init__-61"><span class="linenos">61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="STLAccuracy.__init__-62"><a href="#STLAccuracy.__init__-62"><span class="linenos">62</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Test classification accuracy. Accumulated and calculated from the test batches.&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the <code><a href="#STLAccuracy">STLAccuracy</a></code>.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>save_dir</strong> (<code>str</code>): The directory where data and figures of metrics will be saved. Better inside the output folder.</li>
<li><strong>test_acc_csv_name</strong> (<code>str</code>): file name to save test accuracy of all tasks and average accuracy as CSV file.</li>
</ul>
</div>


                            </div>
                            <div id="STLAccuracy.test_acc_csv_path" class="classattr">
                                <div class="attr variable">
            <span class="name">test_acc_csv_path</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#STLAccuracy.test_acc_csv_path"></a>
    
            <div class="docstring"><p>The path to save test accuracy of all tasks and average accuracy CSV file.</p>
</div>


                            </div>
                            <div id="STLAccuracy.acc_training_epoch" class="classattr">
                                <div class="attr variable">
            <span class="name">acc_training_epoch</span><span class="annotation">: <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a></span>

        
    </div>
    <a class="headerlink" href="#STLAccuracy.acc_training_epoch"></a>
    
            <div class="docstring"><p>Classification accuracy of training epoch. Accumulated and calculated from the training batches.</p>
</div>


                            </div>
                            <div id="STLAccuracy.acc_val" class="classattr">
                                <div class="attr variable">
            <span class="name">acc_val</span><span class="annotation">: <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a></span>

        
    </div>
    <a class="headerlink" href="#STLAccuracy.acc_val"></a>
    
            <div class="docstring"><p>Validation classification accuracy of the model after training epoch. Accumulated and calculated from the validation batches.</p>
</div>


                            </div>
                            <div id="STLAccuracy.acc_test" class="classattr">
                                <div class="attr variable">
            <span class="name">acc_test</span><span class="annotation">: <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a></span>

        
    </div>
    <a class="headerlink" href="#STLAccuracy.acc_test"></a>
    
            <div class="docstring"><p>Test classification accuracy. Accumulated and calculated from the test batches.</p>
</div>


                            </div>
                            <div id="STLAccuracy.on_fit_start" class="classattr">
                                        <input id="STLAccuracy.on_fit_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_fit_start</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="stl_algorithms/base.html#STLAlgorithm">clarena.stl_algorithms.base.STLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="STLAccuracy.on_fit_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLAccuracy.on_fit_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLAccuracy.on_fit_start-64"><a href="#STLAccuracy.on_fit_start-64"><span class="linenos">64</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_fit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy.on_fit_start-65"><a href="#STLAccuracy.on_fit_start-65"><span class="linenos">65</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize training and validation metrics.&quot;&quot;&quot;</span>
</span><span id="STLAccuracy.on_fit_start-66"><a href="#STLAccuracy.on_fit_start-66"><span class="linenos">66</span></a>
</span><span id="STLAccuracy.on_fit_start-67"><a href="#STLAccuracy.on_fit_start-67"><span class="linenos">67</span></a>        <span class="c1"># initialize training metrics</span>
</span><span id="STLAccuracy.on_fit_start-68"><a href="#STLAccuracy.on_fit_start-68"><span class="linenos">68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span>
</span><span id="STLAccuracy.on_fit_start-69"><a href="#STLAccuracy.on_fit_start-69"><span class="linenos">69</span></a>
</span><span id="STLAccuracy.on_fit_start-70"><a href="#STLAccuracy.on_fit_start-70"><span class="linenos">70</span></a>        <span class="c1"># initialize validation metrics</span>
</span><span id="STLAccuracy.on_fit_start-71"><a href="#STLAccuracy.on_fit_start-71"><span class="linenos">71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Initialize training and validation metrics.</p>
</div>


                            </div>
                            <div id="STLAccuracy.on_train_batch_end" class="classattr">
                                        <input id="STLAccuracy.on_train_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_train_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="stl_algorithms/base.html#STLAlgorithm">clarena.stl_algorithms.base.STLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="STLAccuracy.on_train_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLAccuracy.on_train_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLAccuracy.on_train_batch_end-73"><a href="#STLAccuracy.on_train_batch_end-73"><span class="linenos"> 73</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span>
</span><span id="STLAccuracy.on_train_batch_end-74"><a href="#STLAccuracy.on_train_batch_end-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLAccuracy.on_train_batch_end-75"><a href="#STLAccuracy.on_train_batch_end-75"><span class="linenos"> 75</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLAccuracy.on_train_batch_end-76"><a href="#STLAccuracy.on_train_batch_end-76"><span class="linenos"> 76</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLAccuracy.on_train_batch_end-77"><a href="#STLAccuracy.on_train_batch_end-77"><span class="linenos"> 77</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="STLAccuracy.on_train_batch_end-78"><a href="#STLAccuracy.on_train_batch_end-78"><span class="linenos"> 78</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="STLAccuracy.on_train_batch_end-79"><a href="#STLAccuracy.on_train_batch_end-79"><span class="linenos"> 79</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="STLAccuracy.on_train_batch_end-80"><a href="#STLAccuracy.on_train_batch_end-80"><span class="linenos"> 80</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy.on_train_batch_end-81"><a href="#STLAccuracy.on_train_batch_end-81"><span class="linenos"> 81</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Record training metrics from training batch, log metrics of training batch and accumulated metrics of the epoch to Lightning loggers.</span>
</span><span id="STLAccuracy.on_train_batch_end-82"><a href="#STLAccuracy.on_train_batch_end-82"><span class="linenos"> 82</span></a>
</span><span id="STLAccuracy.on_train_batch_end-83"><a href="#STLAccuracy.on_train_batch_end-83"><span class="linenos"> 83</span></a><span class="sd">        **Args:**</span>
</span><span id="STLAccuracy.on_train_batch_end-84"><a href="#STLAccuracy.on_train_batch_end-84"><span class="linenos"> 84</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the training step, the returns of the `training_step()` method in the `STLAlgorithm`.</span>
</span><span id="STLAccuracy.on_train_batch_end-85"><a href="#STLAccuracy.on_train_batch_end-85"><span class="linenos"> 85</span></a><span class="sd">        - **batch** (`Any`): the training data batch.</span>
</span><span id="STLAccuracy.on_train_batch_end-86"><a href="#STLAccuracy.on_train_batch_end-86"><span class="linenos"> 86</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLAccuracy.on_train_batch_end-87"><a href="#STLAccuracy.on_train_batch_end-87"><span class="linenos"> 87</span></a>        <span class="c1"># get the batch size</span>
</span><span id="STLAccuracy.on_train_batch_end-88"><a href="#STLAccuracy.on_train_batch_end-88"><span class="linenos"> 88</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="STLAccuracy.on_train_batch_end-89"><a href="#STLAccuracy.on_train_batch_end-89"><span class="linenos"> 89</span></a>
</span><span id="STLAccuracy.on_train_batch_end-90"><a href="#STLAccuracy.on_train_batch_end-90"><span class="linenos"> 90</span></a>        <span class="c1"># get training metrics values of current training batch from the outputs of the `training_step()`</span>
</span><span id="STLAccuracy.on_train_batch_end-91"><a href="#STLAccuracy.on_train_batch_end-91"><span class="linenos"> 91</span></a>        <span class="n">acc_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
</span><span id="STLAccuracy.on_train_batch_end-92"><a href="#STLAccuracy.on_train_batch_end-92"><span class="linenos"> 92</span></a>
</span><span id="STLAccuracy.on_train_batch_end-93"><a href="#STLAccuracy.on_train_batch_end-93"><span class="linenos"> 93</span></a>        <span class="c1"># update accumulated training metrics to calculate training metrics of the epoch</span>
</span><span id="STLAccuracy.on_train_batch_end-94"><a href="#STLAccuracy.on_train_batch_end-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="STLAccuracy.on_train_batch_end-95"><a href="#STLAccuracy.on_train_batch_end-95"><span class="linenos"> 95</span></a>
</span><span id="STLAccuracy.on_train_batch_end-96"><a href="#STLAccuracy.on_train_batch_end-96"><span class="linenos"> 96</span></a>        <span class="c1"># log training metrics of current training batch to Lightning loggers</span>
</span><span id="STLAccuracy.on_train_batch_end-97"><a href="#STLAccuracy.on_train_batch_end-97"><span class="linenos"> 97</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;train/acc_batch&quot;</span><span class="p">,</span> <span class="n">acc_batch</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="STLAccuracy.on_train_batch_end-98"><a href="#STLAccuracy.on_train_batch_end-98"><span class="linenos"> 98</span></a>
</span><span id="STLAccuracy.on_train_batch_end-99"><a href="#STLAccuracy.on_train_batch_end-99"><span class="linenos"> 99</span></a>        <span class="c1"># log accumulated training metrics till this training batch to Lightning loggers</span>
</span><span id="STLAccuracy.on_train_batch_end-100"><a href="#STLAccuracy.on_train_batch_end-100"><span class="linenos">100</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="STLAccuracy.on_train_batch_end-101"><a href="#STLAccuracy.on_train_batch_end-101"><span class="linenos">101</span></a>            <span class="s2">&quot;task/train/acc&quot;</span><span class="p">,</span>
</span><span id="STLAccuracy.on_train_batch_end-102"><a href="#STLAccuracy.on_train_batch_end-102"><span class="linenos">102</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="STLAccuracy.on_train_batch_end-103"><a href="#STLAccuracy.on_train_batch_end-103"><span class="linenos">103</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLAccuracy.on_train_batch_end-104"><a href="#STLAccuracy.on_train_batch_end-104"><span class="linenos">104</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Record training metrics from training batch, log metrics of training batch and accumulated metrics of the epoch to Lightning loggers.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the training step, the returns of the <code>training_step()</code> method in the <code>STLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the training data batch.</li>
</ul>
</div>


                            </div>
                            <div id="STLAccuracy.on_train_epoch_end" class="classattr">
                                        <input id="STLAccuracy.on_train_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_train_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="stl_algorithms/base.html#STLAlgorithm">clarena.stl_algorithms.base.STLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="STLAccuracy.on_train_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLAccuracy.on_train_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLAccuracy.on_train_epoch_end-106"><a href="#STLAccuracy.on_train_epoch_end-106"><span class="linenos">106</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_epoch_end</span><span class="p">(</span>
</span><span id="STLAccuracy.on_train_epoch_end-107"><a href="#STLAccuracy.on_train_epoch_end-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLAccuracy.on_train_epoch_end-108"><a href="#STLAccuracy.on_train_epoch_end-108"><span class="linenos">108</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLAccuracy.on_train_epoch_end-109"><a href="#STLAccuracy.on_train_epoch_end-109"><span class="linenos">109</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLAccuracy.on_train_epoch_end-110"><a href="#STLAccuracy.on_train_epoch_end-110"><span class="linenos">110</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy.on_train_epoch_end-111"><a href="#STLAccuracy.on_train_epoch_end-111"><span class="linenos">111</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log metrics of training epoch to plot learning curves and reset the metrics accumulation at the end of training epoch.&quot;&quot;&quot;</span>
</span><span id="STLAccuracy.on_train_epoch_end-112"><a href="#STLAccuracy.on_train_epoch_end-112"><span class="linenos">112</span></a>
</span><span id="STLAccuracy.on_train_epoch_end-113"><a href="#STLAccuracy.on_train_epoch_end-113"><span class="linenos">113</span></a>        <span class="c1"># log the accumulated and computed metrics of the epoch to Lightning loggers, specially for plotting learning curves</span>
</span><span id="STLAccuracy.on_train_epoch_end-114"><a href="#STLAccuracy.on_train_epoch_end-114"><span class="linenos">114</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="STLAccuracy.on_train_epoch_end-115"><a href="#STLAccuracy.on_train_epoch_end-115"><span class="linenos">115</span></a>            <span class="s2">&quot;learning_curve/train/acc&quot;</span><span class="p">,</span>
</span><span id="STLAccuracy.on_train_epoch_end-116"><a href="#STLAccuracy.on_train_epoch_end-116"><span class="linenos">116</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="STLAccuracy.on_train_epoch_end-117"><a href="#STLAccuracy.on_train_epoch_end-117"><span class="linenos">117</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLAccuracy.on_train_epoch_end-118"><a href="#STLAccuracy.on_train_epoch_end-118"><span class="linenos">118</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLAccuracy.on_train_epoch_end-119"><a href="#STLAccuracy.on_train_epoch_end-119"><span class="linenos">119</span></a>        <span class="p">)</span>
</span><span id="STLAccuracy.on_train_epoch_end-120"><a href="#STLAccuracy.on_train_epoch_end-120"><span class="linenos">120</span></a>
</span><span id="STLAccuracy.on_train_epoch_end-121"><a href="#STLAccuracy.on_train_epoch_end-121"><span class="linenos">121</span></a>        <span class="c1"># reset the metrics of training epoch as there are more epochs to go and not only one epoch like in the validation and test</span>
</span><span id="STLAccuracy.on_train_epoch_end-122"><a href="#STLAccuracy.on_train_epoch_end-122"><span class="linenos">122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_training_epoch</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Log metrics of training epoch to plot learning curves and reset the metrics accumulation at the end of training epoch.</p>
</div>


                            </div>
                            <div id="STLAccuracy.on_validation_batch_end" class="classattr">
                                        <input id="STLAccuracy.on_validation_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_validation_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="stl_algorithms/base.html#STLAlgorithm">clarena.stl_algorithms.base.STLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="STLAccuracy.on_validation_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLAccuracy.on_validation_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLAccuracy.on_validation_batch_end-124"><a href="#STLAccuracy.on_validation_batch_end-124"><span class="linenos">124</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_batch_end</span><span class="p">(</span>
</span><span id="STLAccuracy.on_validation_batch_end-125"><a href="#STLAccuracy.on_validation_batch_end-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLAccuracy.on_validation_batch_end-126"><a href="#STLAccuracy.on_validation_batch_end-126"><span class="linenos">126</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLAccuracy.on_validation_batch_end-127"><a href="#STLAccuracy.on_validation_batch_end-127"><span class="linenos">127</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLAccuracy.on_validation_batch_end-128"><a href="#STLAccuracy.on_validation_batch_end-128"><span class="linenos">128</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="STLAccuracy.on_validation_batch_end-129"><a href="#STLAccuracy.on_validation_batch_end-129"><span class="linenos">129</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="STLAccuracy.on_validation_batch_end-130"><a href="#STLAccuracy.on_validation_batch_end-130"><span class="linenos">130</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="STLAccuracy.on_validation_batch_end-131"><a href="#STLAccuracy.on_validation_batch_end-131"><span class="linenos">131</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy.on_validation_batch_end-132"><a href="#STLAccuracy.on_validation_batch_end-132"><span class="linenos">132</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from validation batch. We don&#39;t need to log and monitor the metrics of validation batches.</span>
</span><span id="STLAccuracy.on_validation_batch_end-133"><a href="#STLAccuracy.on_validation_batch_end-133"><span class="linenos">133</span></a>
</span><span id="STLAccuracy.on_validation_batch_end-134"><a href="#STLAccuracy.on_validation_batch_end-134"><span class="linenos">134</span></a><span class="sd">        **Args:**</span>
</span><span id="STLAccuracy.on_validation_batch_end-135"><a href="#STLAccuracy.on_validation_batch_end-135"><span class="linenos">135</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the validation step, which is the returns of the `validation_step()` method in the `STLAlgorithm`.</span>
</span><span id="STLAccuracy.on_validation_batch_end-136"><a href="#STLAccuracy.on_validation_batch_end-136"><span class="linenos">136</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="STLAccuracy.on_validation_batch_end-137"><a href="#STLAccuracy.on_validation_batch_end-137"><span class="linenos">137</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLAccuracy.on_validation_batch_end-138"><a href="#STLAccuracy.on_validation_batch_end-138"><span class="linenos">138</span></a>
</span><span id="STLAccuracy.on_validation_batch_end-139"><a href="#STLAccuracy.on_validation_batch_end-139"><span class="linenos">139</span></a>        <span class="c1"># get the batch size</span>
</span><span id="STLAccuracy.on_validation_batch_end-140"><a href="#STLAccuracy.on_validation_batch_end-140"><span class="linenos">140</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="STLAccuracy.on_validation_batch_end-141"><a href="#STLAccuracy.on_validation_batch_end-141"><span class="linenos">141</span></a>
</span><span id="STLAccuracy.on_validation_batch_end-142"><a href="#STLAccuracy.on_validation_batch_end-142"><span class="linenos">142</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="STLAccuracy.on_validation_batch_end-143"><a href="#STLAccuracy.on_validation_batch_end-143"><span class="linenos">143</span></a>        <span class="n">acc_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
</span><span id="STLAccuracy.on_validation_batch_end-144"><a href="#STLAccuracy.on_validation_batch_end-144"><span class="linenos">144</span></a>
</span><span id="STLAccuracy.on_validation_batch_end-145"><a href="#STLAccuracy.on_validation_batch_end-145"><span class="linenos">145</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the validation metrics</span>
</span><span id="STLAccuracy.on_validation_batch_end-146"><a href="#STLAccuracy.on_validation_batch_end-146"><span class="linenos">146</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Accumulating metrics from validation batch. We don't need to log and monitor the metrics of validation batches.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the validation step, which is the returns of the <code>validation_step()</code> method in the <code>STLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the validation data batch.</li>
</ul>
</div>


                            </div>
                            <div id="STLAccuracy.on_validation_epoch_end" class="classattr">
                                        <input id="STLAccuracy.on_validation_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_validation_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="stl_algorithms/base.html#STLAlgorithm">clarena.stl_algorithms.base.STLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="STLAccuracy.on_validation_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLAccuracy.on_validation_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLAccuracy.on_validation_epoch_end-148"><a href="#STLAccuracy.on_validation_epoch_end-148"><span class="linenos">148</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_epoch_end</span><span class="p">(</span>
</span><span id="STLAccuracy.on_validation_epoch_end-149"><a href="#STLAccuracy.on_validation_epoch_end-149"><span class="linenos">149</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLAccuracy.on_validation_epoch_end-150"><a href="#STLAccuracy.on_validation_epoch_end-150"><span class="linenos">150</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLAccuracy.on_validation_epoch_end-151"><a href="#STLAccuracy.on_validation_epoch_end-151"><span class="linenos">151</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLAccuracy.on_validation_epoch_end-152"><a href="#STLAccuracy.on_validation_epoch_end-152"><span class="linenos">152</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy.on_validation_epoch_end-153"><a href="#STLAccuracy.on_validation_epoch_end-153"><span class="linenos">153</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log validation metrics to plot learning curves.&quot;&quot;&quot;</span>
</span><span id="STLAccuracy.on_validation_epoch_end-154"><a href="#STLAccuracy.on_validation_epoch_end-154"><span class="linenos">154</span></a>
</span><span id="STLAccuracy.on_validation_epoch_end-155"><a href="#STLAccuracy.on_validation_epoch_end-155"><span class="linenos">155</span></a>        <span class="c1"># log the accumulated and computed metrics of the epoch to Lightning loggers, specially for plotting learning curves</span>
</span><span id="STLAccuracy.on_validation_epoch_end-156"><a href="#STLAccuracy.on_validation_epoch_end-156"><span class="linenos">156</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="STLAccuracy.on_validation_epoch_end-157"><a href="#STLAccuracy.on_validation_epoch_end-157"><span class="linenos">157</span></a>            <span class="s2">&quot;learning_curve/val/acc&quot;</span><span class="p">,</span>
</span><span id="STLAccuracy.on_validation_epoch_end-158"><a href="#STLAccuracy.on_validation_epoch_end-158"><span class="linenos">158</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acc_val</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="STLAccuracy.on_validation_epoch_end-159"><a href="#STLAccuracy.on_validation_epoch_end-159"><span class="linenos">159</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLAccuracy.on_validation_epoch_end-160"><a href="#STLAccuracy.on_validation_epoch_end-160"><span class="linenos">160</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLAccuracy.on_validation_epoch_end-161"><a href="#STLAccuracy.on_validation_epoch_end-161"><span class="linenos">161</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Log validation metrics to plot learning curves.</p>
</div>


                            </div>
                            <div id="STLAccuracy.on_test_start" class="classattr">
                                        <input id="STLAccuracy.on_test_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_test_start</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="stl_algorithms/base.html#STLAlgorithm">clarena.stl_algorithms.base.STLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="STLAccuracy.on_test_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLAccuracy.on_test_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLAccuracy.on_test_start-163"><a href="#STLAccuracy.on_test_start-163"><span class="linenos">163</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_start</span><span class="p">(</span>
</span><span id="STLAccuracy.on_test_start-164"><a href="#STLAccuracy.on_test_start-164"><span class="linenos">164</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLAccuracy.on_test_start-165"><a href="#STLAccuracy.on_test_start-165"><span class="linenos">165</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLAccuracy.on_test_start-166"><a href="#STLAccuracy.on_test_start-166"><span class="linenos">166</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLAccuracy.on_test_start-167"><a href="#STLAccuracy.on_test_start-167"><span class="linenos">167</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy.on_test_start-168"><a href="#STLAccuracy.on_test_start-168"><span class="linenos">168</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the testing metrics.&quot;&quot;&quot;</span>
</span><span id="STLAccuracy.on_test_start-169"><a href="#STLAccuracy.on_test_start-169"><span class="linenos">169</span></a>
</span><span id="STLAccuracy.on_test_start-170"><a href="#STLAccuracy.on_test_start-170"><span class="linenos">170</span></a>        <span class="c1"># initialize test metrics for current and previous tasks</span>
</span><span id="STLAccuracy.on_test_start-171"><a href="#STLAccuracy.on_test_start-171"><span class="linenos">171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the testing metrics.</p>
</div>


                            </div>
                            <div id="STLAccuracy.on_test_batch_end" class="classattr">
                                        <input id="STLAccuracy.on_test_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_test_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="stl_algorithms/base.html#STLAlgorithm">clarena.stl_algorithms.base.STLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="STLAccuracy.on_test_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLAccuracy.on_test_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLAccuracy.on_test_batch_end-173"><a href="#STLAccuracy.on_test_batch_end-173"><span class="linenos">173</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_batch_end</span><span class="p">(</span>
</span><span id="STLAccuracy.on_test_batch_end-174"><a href="#STLAccuracy.on_test_batch_end-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLAccuracy.on_test_batch_end-175"><a href="#STLAccuracy.on_test_batch_end-175"><span class="linenos">175</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLAccuracy.on_test_batch_end-176"><a href="#STLAccuracy.on_test_batch_end-176"><span class="linenos">176</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLAccuracy.on_test_batch_end-177"><a href="#STLAccuracy.on_test_batch_end-177"><span class="linenos">177</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="STLAccuracy.on_test_batch_end-178"><a href="#STLAccuracy.on_test_batch_end-178"><span class="linenos">178</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="STLAccuracy.on_test_batch_end-179"><a href="#STLAccuracy.on_test_batch_end-179"><span class="linenos">179</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="STLAccuracy.on_test_batch_end-180"><a href="#STLAccuracy.on_test_batch_end-180"><span class="linenos">180</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy.on_test_batch_end-181"><a href="#STLAccuracy.on_test_batch_end-181"><span class="linenos">181</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from test batch. We don&#39;t need to log and monitor the metrics of test batches.</span>
</span><span id="STLAccuracy.on_test_batch_end-182"><a href="#STLAccuracy.on_test_batch_end-182"><span class="linenos">182</span></a>
</span><span id="STLAccuracy.on_test_batch_end-183"><a href="#STLAccuracy.on_test_batch_end-183"><span class="linenos">183</span></a><span class="sd">        **Args:**</span>
</span><span id="STLAccuracy.on_test_batch_end-184"><a href="#STLAccuracy.on_test_batch_end-184"><span class="linenos">184</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the test step, which is the returns of the `test_step()` method in the `STLAlgorithm`.</span>
</span><span id="STLAccuracy.on_test_batch_end-185"><a href="#STLAccuracy.on_test_batch_end-185"><span class="linenos">185</span></a><span class="sd">        - **batch** (`Any`): the test data batch.</span>
</span><span id="STLAccuracy.on_test_batch_end-186"><a href="#STLAccuracy.on_test_batch_end-186"><span class="linenos">186</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLAccuracy.on_test_batch_end-187"><a href="#STLAccuracy.on_test_batch_end-187"><span class="linenos">187</span></a>
</span><span id="STLAccuracy.on_test_batch_end-188"><a href="#STLAccuracy.on_test_batch_end-188"><span class="linenos">188</span></a>        <span class="c1"># get the batch size</span>
</span><span id="STLAccuracy.on_test_batch_end-189"><a href="#STLAccuracy.on_test_batch_end-189"><span class="linenos">189</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="STLAccuracy.on_test_batch_end-190"><a href="#STLAccuracy.on_test_batch_end-190"><span class="linenos">190</span></a>
</span><span id="STLAccuracy.on_test_batch_end-191"><a href="#STLAccuracy.on_test_batch_end-191"><span class="linenos">191</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="STLAccuracy.on_test_batch_end-192"><a href="#STLAccuracy.on_test_batch_end-192"><span class="linenos">192</span></a>        <span class="n">acc_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
</span><span id="STLAccuracy.on_test_batch_end-193"><a href="#STLAccuracy.on_test_batch_end-193"><span class="linenos">193</span></a>
</span><span id="STLAccuracy.on_test_batch_end-194"><a href="#STLAccuracy.on_test_batch_end-194"><span class="linenos">194</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the metrics of the epoch</span>
</span><span id="STLAccuracy.on_test_batch_end-195"><a href="#STLAccuracy.on_test_batch_end-195"><span class="linenos">195</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Accumulating metrics from test batch. We don't need to log and monitor the metrics of test batches.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the test step, which is the returns of the <code>test_step()</code> method in the <code>STLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the test data batch.</li>
</ul>
</div>


                            </div>
                            <div id="STLAccuracy.on_test_epoch_end" class="classattr">
                                        <input id="STLAccuracy.on_test_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_test_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="stl_algorithms/base.html#STLAlgorithm">clarena.stl_algorithms.base.STLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="STLAccuracy.on_test_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLAccuracy.on_test_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLAccuracy.on_test_epoch_end-197"><a href="#STLAccuracy.on_test_epoch_end-197"><span class="linenos">197</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_epoch_end</span><span class="p">(</span>
</span><span id="STLAccuracy.on_test_epoch_end-198"><a href="#STLAccuracy.on_test_epoch_end-198"><span class="linenos">198</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLAccuracy.on_test_epoch_end-199"><a href="#STLAccuracy.on_test_epoch_end-199"><span class="linenos">199</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLAccuracy.on_test_epoch_end-200"><a href="#STLAccuracy.on_test_epoch_end-200"><span class="linenos">200</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLAccuracy.on_test_epoch_end-201"><a href="#STLAccuracy.on_test_epoch_end-201"><span class="linenos">201</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy.on_test_epoch_end-202"><a href="#STLAccuracy.on_test_epoch_end-202"><span class="linenos">202</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save and plot test metrics at the end of test.&quot;&quot;&quot;</span>
</span><span id="STLAccuracy.on_test_epoch_end-203"><a href="#STLAccuracy.on_test_epoch_end-203"><span class="linenos">203</span></a>
</span><span id="STLAccuracy.on_test_epoch_end-204"><a href="#STLAccuracy.on_test_epoch_end-204"><span class="linenos">204</span></a>        <span class="c1"># save (update) the test metrics to CSV files</span>
</span><span id="STLAccuracy.on_test_epoch_end-205"><a href="#STLAccuracy.on_test_epoch_end-205"><span class="linenos">205</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_test_acc_to_csv</span><span class="p">(</span>
</span><span id="STLAccuracy.on_test_epoch_end-206"><a href="#STLAccuracy.on_test_epoch_end-206"><span class="linenos">206</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_acc_csv_path</span><span class="p">,</span>
</span><span id="STLAccuracy.on_test_epoch_end-207"><a href="#STLAccuracy.on_test_epoch_end-207"><span class="linenos">207</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save and plot test metrics at the end of test.</p>
</div>


                            </div>
                            <div id="STLAccuracy.save_test_acc_to_csv" class="classattr">
                                        <input id="STLAccuracy.save_test_acc_to_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_test_acc_to_csv</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="STLAccuracy.save_test_acc_to_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLAccuracy.save_test_acc_to_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLAccuracy.save_test_acc_to_csv-209"><a href="#STLAccuracy.save_test_acc_to_csv-209"><span class="linenos">209</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_test_acc_to_csv</span><span class="p">(</span>
</span><span id="STLAccuracy.save_test_acc_to_csv-210"><a href="#STLAccuracy.save_test_acc_to_csv-210"><span class="linenos">210</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLAccuracy.save_test_acc_to_csv-211"><a href="#STLAccuracy.save_test_acc_to_csv-211"><span class="linenos">211</span></a>        <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="STLAccuracy.save_test_acc_to_csv-212"><a href="#STLAccuracy.save_test_acc_to_csv-212"><span class="linenos">212</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLAccuracy.save_test_acc_to_csv-213"><a href="#STLAccuracy.save_test_acc_to_csv-213"><span class="linenos">213</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save the test accuracy metrics of all tasks in single-task learning to an CSV file.</span>
</span><span id="STLAccuracy.save_test_acc_to_csv-214"><a href="#STLAccuracy.save_test_acc_to_csv-214"><span class="linenos">214</span></a>
</span><span id="STLAccuracy.save_test_acc_to_csv-215"><a href="#STLAccuracy.save_test_acc_to_csv-215"><span class="linenos">215</span></a><span class="sd">        **Args:**</span>
</span><span id="STLAccuracy.save_test_acc_to_csv-216"><a href="#STLAccuracy.save_test_acc_to_csv-216"><span class="linenos">216</span></a><span class="sd">        - **csv_path** (`str`): save the test metric to path. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/acc.csv&#39;.</span>
</span><span id="STLAccuracy.save_test_acc_to_csv-217"><a href="#STLAccuracy.save_test_acc_to_csv-217"><span class="linenos">217</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLAccuracy.save_test_acc_to_csv-218"><a href="#STLAccuracy.save_test_acc_to_csv-218"><span class="linenos">218</span></a>        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]</span>
</span><span id="STLAccuracy.save_test_acc_to_csv-219"><a href="#STLAccuracy.save_test_acc_to_csv-219"><span class="linenos">219</span></a>        <span class="n">new_line</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="STLAccuracy.save_test_acc_to_csv-220"><a href="#STLAccuracy.save_test_acc_to_csv-220"><span class="linenos">220</span></a>        <span class="n">new_line</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acc_test</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="STLAccuracy.save_test_acc_to_csv-221"><a href="#STLAccuracy.save_test_acc_to_csv-221"><span class="linenos">221</span></a>
</span><span id="STLAccuracy.save_test_acc_to_csv-222"><a href="#STLAccuracy.save_test_acc_to_csv-222"><span class="linenos">222</span></a>        <span class="c1"># write</span>
</span><span id="STLAccuracy.save_test_acc_to_csv-223"><a href="#STLAccuracy.save_test_acc_to_csv-223"><span class="linenos">223</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="STLAccuracy.save_test_acc_to_csv-224"><a href="#STLAccuracy.save_test_acc_to_csv-224"><span class="linenos">224</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="STLAccuracy.save_test_acc_to_csv-225"><a href="#STLAccuracy.save_test_acc_to_csv-225"><span class="linenos">225</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="STLAccuracy.save_test_acc_to_csv-226"><a href="#STLAccuracy.save_test_acc_to_csv-226"><span class="linenos">226</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save the test accuracy metrics of all tasks in single-task learning to an CSV file.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>csv_path</strong> (<code>str</code>): save the test metric to path. E.g. './outputs/expr_name/1970-01-01_00-00-00/results/acc.csv'.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="STLLoss">
                            <input id="STLLoss-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">STLLoss</span><wbr>(<span class="base"><a href="#MetricCallback">clarena.metrics.MetricCallback</a></span>):

                <label class="view-source-button" for="STLLoss-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLLoss"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLLoss-23"><a href="#STLLoss-23"><span class="linenos"> 23</span></a><span class="k">class</span><span class="w"> </span><span class="nc">STLLoss</span><span class="p">(</span><span class="n">MetricCallback</span><span class="p">):</span>
</span><span id="STLLoss-24"><a href="#STLLoss-24"><span class="linenos"> 24</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Provides all actions that are related to STL loss metrics, which include:</span>
</span><span id="STLLoss-25"><a href="#STLLoss-25"><span class="linenos"> 25</span></a>
</span><span id="STLLoss-26"><a href="#STLLoss-26"><span class="linenos"> 26</span></a><span class="sd">    - Defining, initializing and recording loss metrics.</span>
</span><span id="STLLoss-27"><a href="#STLLoss-27"><span class="linenos"> 27</span></a><span class="sd">    - Logging training and validation loss metrics to Lightning loggers in real time.</span>
</span><span id="STLLoss-28"><a href="#STLLoss-28"><span class="linenos"> 28</span></a>
</span><span id="STLLoss-29"><a href="#STLLoss-29"><span class="linenos"> 29</span></a><span class="sd">    Saving test loss metrics to files.</span>
</span><span id="STLLoss-30"><a href="#STLLoss-30"><span class="linenos"> 30</span></a>
</span><span id="STLLoss-31"><a href="#STLLoss-31"><span class="linenos"> 31</span></a><span class="sd">    - The callback is able to produce the following outputs:</span>
</span><span id="STLLoss-32"><a href="#STLLoss-32"><span class="linenos"> 32</span></a><span class="sd">    - CSV files for test classification loss.</span>
</span><span id="STLLoss-33"><a href="#STLLoss-33"><span class="linenos"> 33</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="STLLoss-34"><a href="#STLLoss-34"><span class="linenos"> 34</span></a>
</span><span id="STLLoss-35"><a href="#STLLoss-35"><span class="linenos"> 35</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="STLLoss-36"><a href="#STLLoss-36"><span class="linenos"> 36</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLLoss-37"><a href="#STLLoss-37"><span class="linenos"> 37</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="STLLoss-38"><a href="#STLLoss-38"><span class="linenos"> 38</span></a>        <span class="n">test_loss_cls_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;loss_cls.csv&quot;</span><span class="p">,</span>
</span><span id="STLLoss-39"><a href="#STLLoss-39"><span class="linenos"> 39</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss-40"><a href="#STLLoss-40"><span class="linenos"> 40</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `STLLoss`.</span>
</span><span id="STLLoss-41"><a href="#STLLoss-41"><span class="linenos"> 41</span></a>
</span><span id="STLLoss-42"><a href="#STLLoss-42"><span class="linenos"> 42</span></a><span class="sd">        **Args:**</span>
</span><span id="STLLoss-43"><a href="#STLLoss-43"><span class="linenos"> 43</span></a><span class="sd">        - **save_dir** (`str`): The directory where data and figures of metrics will be saved. Better inside the output folder.</span>
</span><span id="STLLoss-44"><a href="#STLLoss-44"><span class="linenos"> 44</span></a><span class="sd">        - **test_loss_cls_csv_name**(`str`): file name to save classification loss of all tasks and average classification loss as CSV file.</span>
</span><span id="STLLoss-45"><a href="#STLLoss-45"><span class="linenos"> 45</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLLoss-46"><a href="#STLLoss-46"><span class="linenos"> 46</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="STLLoss-47"><a href="#STLLoss-47"><span class="linenos"> 47</span></a>
</span><span id="STLLoss-48"><a href="#STLLoss-48"><span class="linenos"> 48</span></a>        <span class="c1"># paths</span>
</span><span id="STLLoss-49"><a href="#STLLoss-49"><span class="linenos"> 49</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_csv_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="STLLoss-50"><a href="#STLLoss-50"><span class="linenos"> 50</span></a>            <span class="n">save_dir</span><span class="p">,</span> <span class="n">test_loss_cls_csv_name</span>
</span><span id="STLLoss-51"><a href="#STLLoss-51"><span class="linenos"> 51</span></a>        <span class="p">)</span>
</span><span id="STLLoss-52"><a href="#STLLoss-52"><span class="linenos"> 52</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the path to save test classification loss of all tasks and average classification loss CSV file.&quot;&quot;&quot;</span>
</span><span id="STLLoss-53"><a href="#STLLoss-53"><span class="linenos"> 53</span></a>
</span><span id="STLLoss-54"><a href="#STLLoss-54"><span class="linenos"> 54</span></a>        <span class="c1"># training accumulated metrics</span>
</span><span id="STLLoss-55"><a href="#STLLoss-55"><span class="linenos"> 55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="STLLoss-56"><a href="#STLLoss-56"><span class="linenos"> 56</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Classification loss of training epoch. Accumulated and calculated from the training batches. &quot;&quot;&quot;</span>
</span><span id="STLLoss-57"><a href="#STLLoss-57"><span class="linenos"> 57</span></a>
</span><span id="STLLoss-58"><a href="#STLLoss-58"><span class="linenos"> 58</span></a>        <span class="c1"># validation accumulated metrics</span>
</span><span id="STLLoss-59"><a href="#STLLoss-59"><span class="linenos"> 59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="STLLoss-60"><a href="#STLLoss-60"><span class="linenos"> 60</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Validation classification of the model loss after training epoch. Accumulated and calculated from the validation batches. &quot;&quot;&quot;</span>
</span><span id="STLLoss-61"><a href="#STLLoss-61"><span class="linenos"> 61</span></a>
</span><span id="STLLoss-62"><a href="#STLLoss-62"><span class="linenos"> 62</span></a>        <span class="c1"># test accumulated metrics</span>
</span><span id="STLLoss-63"><a href="#STLLoss-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="STLLoss-64"><a href="#STLLoss-64"><span class="linenos"> 64</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Test classification loss. Accumulated and calculated from the test batches.&quot;&quot;&quot;</span>
</span><span id="STLLoss-65"><a href="#STLLoss-65"><span class="linenos"> 65</span></a>
</span><span id="STLLoss-66"><a href="#STLLoss-66"><span class="linenos"> 66</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_fit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss-67"><a href="#STLLoss-67"><span class="linenos"> 67</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize training and validation metrics.&quot;&quot;&quot;</span>
</span><span id="STLLoss-68"><a href="#STLLoss-68"><span class="linenos"> 68</span></a>
</span><span id="STLLoss-69"><a href="#STLLoss-69"><span class="linenos"> 69</span></a>        <span class="c1"># initialize training metrics</span>
</span><span id="STLLoss-70"><a href="#STLLoss-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span>
</span><span id="STLLoss-71"><a href="#STLLoss-71"><span class="linenos"> 71</span></a>
</span><span id="STLLoss-72"><a href="#STLLoss-72"><span class="linenos"> 72</span></a>        <span class="c1"># initialize validation metrics</span>
</span><span id="STLLoss-73"><a href="#STLLoss-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span>
</span><span id="STLLoss-74"><a href="#STLLoss-74"><span class="linenos"> 74</span></a>
</span><span id="STLLoss-75"><a href="#STLLoss-75"><span class="linenos"> 75</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span>
</span><span id="STLLoss-76"><a href="#STLLoss-76"><span class="linenos"> 76</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLLoss-77"><a href="#STLLoss-77"><span class="linenos"> 77</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLLoss-78"><a href="#STLLoss-78"><span class="linenos"> 78</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLLoss-79"><a href="#STLLoss-79"><span class="linenos"> 79</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="STLLoss-80"><a href="#STLLoss-80"><span class="linenos"> 80</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="STLLoss-81"><a href="#STLLoss-81"><span class="linenos"> 81</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="STLLoss-82"><a href="#STLLoss-82"><span class="linenos"> 82</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss-83"><a href="#STLLoss-83"><span class="linenos"> 83</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Record training metrics from training batch, log metrics of training batch and accumulated metrics of the epoch to Lightning loggers.</span>
</span><span id="STLLoss-84"><a href="#STLLoss-84"><span class="linenos"> 84</span></a>
</span><span id="STLLoss-85"><a href="#STLLoss-85"><span class="linenos"> 85</span></a><span class="sd">        **Args:**</span>
</span><span id="STLLoss-86"><a href="#STLLoss-86"><span class="linenos"> 86</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the training step, the returns of the `training_step()` method in the `STLAlgorithm`.</span>
</span><span id="STLLoss-87"><a href="#STLLoss-87"><span class="linenos"> 87</span></a><span class="sd">        - **batch** (`Any`): the training data batch.</span>
</span><span id="STLLoss-88"><a href="#STLLoss-88"><span class="linenos"> 88</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLLoss-89"><a href="#STLLoss-89"><span class="linenos"> 89</span></a>        <span class="c1"># get the batch size</span>
</span><span id="STLLoss-90"><a href="#STLLoss-90"><span class="linenos"> 90</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="STLLoss-91"><a href="#STLLoss-91"><span class="linenos"> 91</span></a>
</span><span id="STLLoss-92"><a href="#STLLoss-92"><span class="linenos"> 92</span></a>        <span class="c1"># get training metrics values of current training batch from the outputs of the `training_step()`</span>
</span><span id="STLLoss-93"><a href="#STLLoss-93"><span class="linenos"> 93</span></a>        <span class="n">loss_cls_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="STLLoss-94"><a href="#STLLoss-94"><span class="linenos"> 94</span></a>
</span><span id="STLLoss-95"><a href="#STLLoss-95"><span class="linenos"> 95</span></a>        <span class="c1"># update accumulated training metrics to calculate training metrics of the epoch</span>
</span><span id="STLLoss-96"><a href="#STLLoss-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="STLLoss-97"><a href="#STLLoss-97"><span class="linenos"> 97</span></a>
</span><span id="STLLoss-98"><a href="#STLLoss-98"><span class="linenos"> 98</span></a>        <span class="c1"># log training metrics of current training batch to Lightning loggers</span>
</span><span id="STLLoss-99"><a href="#STLLoss-99"><span class="linenos"> 99</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;train/loss_cls_batch&quot;</span><span class="p">,</span> <span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="STLLoss-100"><a href="#STLLoss-100"><span class="linenos">100</span></a>
</span><span id="STLLoss-101"><a href="#STLLoss-101"><span class="linenos">101</span></a>        <span class="c1"># log accumulated training metrics till this training batch to Lightning loggers</span>
</span><span id="STLLoss-102"><a href="#STLLoss-102"><span class="linenos">102</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="STLLoss-103"><a href="#STLLoss-103"><span class="linenos">103</span></a>            <span class="s2">&quot;task/train/loss_cls&quot;</span><span class="p">,</span>
</span><span id="STLLoss-104"><a href="#STLLoss-104"><span class="linenos">104</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="STLLoss-105"><a href="#STLLoss-105"><span class="linenos">105</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLLoss-106"><a href="#STLLoss-106"><span class="linenos">106</span></a>        <span class="p">)</span>
</span><span id="STLLoss-107"><a href="#STLLoss-107"><span class="linenos">107</span></a>
</span><span id="STLLoss-108"><a href="#STLLoss-108"><span class="linenos">108</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_epoch_end</span><span class="p">(</span>
</span><span id="STLLoss-109"><a href="#STLLoss-109"><span class="linenos">109</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLLoss-110"><a href="#STLLoss-110"><span class="linenos">110</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLLoss-111"><a href="#STLLoss-111"><span class="linenos">111</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLLoss-112"><a href="#STLLoss-112"><span class="linenos">112</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss-113"><a href="#STLLoss-113"><span class="linenos">113</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log metrics of training epoch to plot learning curves and reset the metrics accumulation at the end of training epoch.&quot;&quot;&quot;</span>
</span><span id="STLLoss-114"><a href="#STLLoss-114"><span class="linenos">114</span></a>
</span><span id="STLLoss-115"><a href="#STLLoss-115"><span class="linenos">115</span></a>        <span class="c1"># log the accumulated and computed metrics of the epoch to Lightning loggers, specially for plotting learning curves</span>
</span><span id="STLLoss-116"><a href="#STLLoss-116"><span class="linenos">116</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="STLLoss-117"><a href="#STLLoss-117"><span class="linenos">117</span></a>            <span class="s2">&quot;learning_curve/train/loss_cls&quot;</span><span class="p">,</span>
</span><span id="STLLoss-118"><a href="#STLLoss-118"><span class="linenos">118</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="STLLoss-119"><a href="#STLLoss-119"><span class="linenos">119</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLLoss-120"><a href="#STLLoss-120"><span class="linenos">120</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLLoss-121"><a href="#STLLoss-121"><span class="linenos">121</span></a>        <span class="p">)</span>
</span><span id="STLLoss-122"><a href="#STLLoss-122"><span class="linenos">122</span></a>
</span><span id="STLLoss-123"><a href="#STLLoss-123"><span class="linenos">123</span></a>        <span class="c1"># reset the metrics of training epoch as there are more epochs to go and not only one epoch like in the validation and test</span>
</span><span id="STLLoss-124"><a href="#STLLoss-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span><span id="STLLoss-125"><a href="#STLLoss-125"><span class="linenos">125</span></a>
</span><span id="STLLoss-126"><a href="#STLLoss-126"><span class="linenos">126</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_batch_end</span><span class="p">(</span>
</span><span id="STLLoss-127"><a href="#STLLoss-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLLoss-128"><a href="#STLLoss-128"><span class="linenos">128</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLLoss-129"><a href="#STLLoss-129"><span class="linenos">129</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLLoss-130"><a href="#STLLoss-130"><span class="linenos">130</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="STLLoss-131"><a href="#STLLoss-131"><span class="linenos">131</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="STLLoss-132"><a href="#STLLoss-132"><span class="linenos">132</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="STLLoss-133"><a href="#STLLoss-133"><span class="linenos">133</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss-134"><a href="#STLLoss-134"><span class="linenos">134</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from validation batch. We don&#39;t need to log and monitor the metrics of validation batches.</span>
</span><span id="STLLoss-135"><a href="#STLLoss-135"><span class="linenos">135</span></a>
</span><span id="STLLoss-136"><a href="#STLLoss-136"><span class="linenos">136</span></a><span class="sd">        **Args:**</span>
</span><span id="STLLoss-137"><a href="#STLLoss-137"><span class="linenos">137</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the validation step, which is the returns of the `validation_step()` method in the `STLAlgorithm`.</span>
</span><span id="STLLoss-138"><a href="#STLLoss-138"><span class="linenos">138</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="STLLoss-139"><a href="#STLLoss-139"><span class="linenos">139</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLLoss-140"><a href="#STLLoss-140"><span class="linenos">140</span></a>
</span><span id="STLLoss-141"><a href="#STLLoss-141"><span class="linenos">141</span></a>        <span class="c1"># get the batch size</span>
</span><span id="STLLoss-142"><a href="#STLLoss-142"><span class="linenos">142</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="STLLoss-143"><a href="#STLLoss-143"><span class="linenos">143</span></a>
</span><span id="STLLoss-144"><a href="#STLLoss-144"><span class="linenos">144</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="STLLoss-145"><a href="#STLLoss-145"><span class="linenos">145</span></a>        <span class="n">loss_cls_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="STLLoss-146"><a href="#STLLoss-146"><span class="linenos">146</span></a>
</span><span id="STLLoss-147"><a href="#STLLoss-147"><span class="linenos">147</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the validation metrics</span>
</span><span id="STLLoss-148"><a href="#STLLoss-148"><span class="linenos">148</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="STLLoss-149"><a href="#STLLoss-149"><span class="linenos">149</span></a>
</span><span id="STLLoss-150"><a href="#STLLoss-150"><span class="linenos">150</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_epoch_end</span><span class="p">(</span>
</span><span id="STLLoss-151"><a href="#STLLoss-151"><span class="linenos">151</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLLoss-152"><a href="#STLLoss-152"><span class="linenos">152</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLLoss-153"><a href="#STLLoss-153"><span class="linenos">153</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLLoss-154"><a href="#STLLoss-154"><span class="linenos">154</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss-155"><a href="#STLLoss-155"><span class="linenos">155</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log validation metrics to plot learning curves.&quot;&quot;&quot;</span>
</span><span id="STLLoss-156"><a href="#STLLoss-156"><span class="linenos">156</span></a>
</span><span id="STLLoss-157"><a href="#STLLoss-157"><span class="linenos">157</span></a>        <span class="c1"># log the accumulated and computed metrics of the epoch to Lightning loggers, specially for plotting learning curves</span>
</span><span id="STLLoss-158"><a href="#STLLoss-158"><span class="linenos">158</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="STLLoss-159"><a href="#STLLoss-159"><span class="linenos">159</span></a>            <span class="s2">&quot;learning_curve/val/loss_cls&quot;</span><span class="p">,</span>
</span><span id="STLLoss-160"><a href="#STLLoss-160"><span class="linenos">160</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="STLLoss-161"><a href="#STLLoss-161"><span class="linenos">161</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLLoss-162"><a href="#STLLoss-162"><span class="linenos">162</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLLoss-163"><a href="#STLLoss-163"><span class="linenos">163</span></a>        <span class="p">)</span>
</span><span id="STLLoss-164"><a href="#STLLoss-164"><span class="linenos">164</span></a>
</span><span id="STLLoss-165"><a href="#STLLoss-165"><span class="linenos">165</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_start</span><span class="p">(</span>
</span><span id="STLLoss-166"><a href="#STLLoss-166"><span class="linenos">166</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLLoss-167"><a href="#STLLoss-167"><span class="linenos">167</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLLoss-168"><a href="#STLLoss-168"><span class="linenos">168</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLLoss-169"><a href="#STLLoss-169"><span class="linenos">169</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss-170"><a href="#STLLoss-170"><span class="linenos">170</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the metrics for testing each seen task in the beginning of a task&#39;s testing.&quot;&quot;&quot;</span>
</span><span id="STLLoss-171"><a href="#STLLoss-171"><span class="linenos">171</span></a>
</span><span id="STLLoss-172"><a href="#STLLoss-172"><span class="linenos">172</span></a>        <span class="c1"># initialize test metrics</span>
</span><span id="STLLoss-173"><a href="#STLLoss-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span>
</span><span id="STLLoss-174"><a href="#STLLoss-174"><span class="linenos">174</span></a>
</span><span id="STLLoss-175"><a href="#STLLoss-175"><span class="linenos">175</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_batch_end</span><span class="p">(</span>
</span><span id="STLLoss-176"><a href="#STLLoss-176"><span class="linenos">176</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLLoss-177"><a href="#STLLoss-177"><span class="linenos">177</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLLoss-178"><a href="#STLLoss-178"><span class="linenos">178</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLLoss-179"><a href="#STLLoss-179"><span class="linenos">179</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="STLLoss-180"><a href="#STLLoss-180"><span class="linenos">180</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="STLLoss-181"><a href="#STLLoss-181"><span class="linenos">181</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="STLLoss-182"><a href="#STLLoss-182"><span class="linenos">182</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss-183"><a href="#STLLoss-183"><span class="linenos">183</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from test batch. We don&#39;t need to log and monitor the metrics of test batches.</span>
</span><span id="STLLoss-184"><a href="#STLLoss-184"><span class="linenos">184</span></a>
</span><span id="STLLoss-185"><a href="#STLLoss-185"><span class="linenos">185</span></a><span class="sd">        **Args:**</span>
</span><span id="STLLoss-186"><a href="#STLLoss-186"><span class="linenos">186</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the test step, which is the returns of the `test_step()` method in the `STLAlgorithm`.</span>
</span><span id="STLLoss-187"><a href="#STLLoss-187"><span class="linenos">187</span></a><span class="sd">        - **batch** (`Any`): the test data batch.</span>
</span><span id="STLLoss-188"><a href="#STLLoss-188"><span class="linenos">188</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLLoss-189"><a href="#STLLoss-189"><span class="linenos">189</span></a>
</span><span id="STLLoss-190"><a href="#STLLoss-190"><span class="linenos">190</span></a>        <span class="c1"># get the batch size</span>
</span><span id="STLLoss-191"><a href="#STLLoss-191"><span class="linenos">191</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="STLLoss-192"><a href="#STLLoss-192"><span class="linenos">192</span></a>
</span><span id="STLLoss-193"><a href="#STLLoss-193"><span class="linenos">193</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="STLLoss-194"><a href="#STLLoss-194"><span class="linenos">194</span></a>        <span class="n">loss_cls_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="STLLoss-195"><a href="#STLLoss-195"><span class="linenos">195</span></a>
</span><span id="STLLoss-196"><a href="#STLLoss-196"><span class="linenos">196</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the metrics of the epoch</span>
</span><span id="STLLoss-197"><a href="#STLLoss-197"><span class="linenos">197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="STLLoss-198"><a href="#STLLoss-198"><span class="linenos">198</span></a>
</span><span id="STLLoss-199"><a href="#STLLoss-199"><span class="linenos">199</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_epoch_end</span><span class="p">(</span>
</span><span id="STLLoss-200"><a href="#STLLoss-200"><span class="linenos">200</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLLoss-201"><a href="#STLLoss-201"><span class="linenos">201</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLLoss-202"><a href="#STLLoss-202"><span class="linenos">202</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLLoss-203"><a href="#STLLoss-203"><span class="linenos">203</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss-204"><a href="#STLLoss-204"><span class="linenos">204</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save and plot test metrics at the end of test.&quot;&quot;&quot;</span>
</span><span id="STLLoss-205"><a href="#STLLoss-205"><span class="linenos">205</span></a>
</span><span id="STLLoss-206"><a href="#STLLoss-206"><span class="linenos">206</span></a>        <span class="c1"># save (update) the test metrics to CSV files</span>
</span><span id="STLLoss-207"><a href="#STLLoss-207"><span class="linenos">207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_test_loss_cls_to_csv</span><span class="p">(</span>
</span><span id="STLLoss-208"><a href="#STLLoss-208"><span class="linenos">208</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_csv_path</span><span class="p">,</span>
</span><span id="STLLoss-209"><a href="#STLLoss-209"><span class="linenos">209</span></a>        <span class="p">)</span>
</span><span id="STLLoss-210"><a href="#STLLoss-210"><span class="linenos">210</span></a>
</span><span id="STLLoss-211"><a href="#STLLoss-211"><span class="linenos">211</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_test_loss_cls_to_csv</span><span class="p">(</span>
</span><span id="STLLoss-212"><a href="#STLLoss-212"><span class="linenos">212</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLLoss-213"><a href="#STLLoss-213"><span class="linenos">213</span></a>        <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="STLLoss-214"><a href="#STLLoss-214"><span class="linenos">214</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss-215"><a href="#STLLoss-215"><span class="linenos">215</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save the test classification loss metrics in single-task learning to an CSV file.</span>
</span><span id="STLLoss-216"><a href="#STLLoss-216"><span class="linenos">216</span></a>
</span><span id="STLLoss-217"><a href="#STLLoss-217"><span class="linenos">217</span></a><span class="sd">        **Args:**</span>
</span><span id="STLLoss-218"><a href="#STLLoss-218"><span class="linenos">218</span></a><span class="sd">        - **csv_path** (`str`): save the test metric to path. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/loss_cls.csv&#39;.</span>
</span><span id="STLLoss-219"><a href="#STLLoss-219"><span class="linenos">219</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLLoss-220"><a href="#STLLoss-220"><span class="linenos">220</span></a>        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="STLLoss-221"><a href="#STLLoss-221"><span class="linenos">221</span></a>        <span class="n">new_line</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()}</span>
</span><span id="STLLoss-222"><a href="#STLLoss-222"><span class="linenos">222</span></a>
</span><span id="STLLoss-223"><a href="#STLLoss-223"><span class="linenos">223</span></a>        <span class="c1"># write</span>
</span><span id="STLLoss-224"><a href="#STLLoss-224"><span class="linenos">224</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="STLLoss-225"><a href="#STLLoss-225"><span class="linenos">225</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="STLLoss-226"><a href="#STLLoss-226"><span class="linenos">226</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="STLLoss-227"><a href="#STLLoss-227"><span class="linenos">227</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Provides all actions that are related to STL loss metrics, which include:</p>

<ul>
<li>Defining, initializing and recording loss metrics.</li>
<li>Logging training and validation loss metrics to Lightning loggers in real time.</li>
</ul>

<p>Saving test loss metrics to files.</p>

<ul>
<li>The callback is able to produce the following outputs:</li>
<li>CSV files for test classification loss.</li>
</ul>
</div>


                            <div id="STLLoss.__init__" class="classattr">
                                        <input id="STLLoss.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">STLLoss</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">test_loss_cls_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;loss_cls.csv&#39;</span></span>)</span>

                <label class="view-source-button" for="STLLoss.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLLoss.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLLoss.__init__-35"><a href="#STLLoss.__init__-35"><span class="linenos">35</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="STLLoss.__init__-36"><a href="#STLLoss.__init__-36"><span class="linenos">36</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLLoss.__init__-37"><a href="#STLLoss.__init__-37"><span class="linenos">37</span></a>        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="STLLoss.__init__-38"><a href="#STLLoss.__init__-38"><span class="linenos">38</span></a>        <span class="n">test_loss_cls_csv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;loss_cls.csv&quot;</span><span class="p">,</span>
</span><span id="STLLoss.__init__-39"><a href="#STLLoss.__init__-39"><span class="linenos">39</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss.__init__-40"><a href="#STLLoss.__init__-40"><span class="linenos">40</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the `STLLoss`.</span>
</span><span id="STLLoss.__init__-41"><a href="#STLLoss.__init__-41"><span class="linenos">41</span></a>
</span><span id="STLLoss.__init__-42"><a href="#STLLoss.__init__-42"><span class="linenos">42</span></a><span class="sd">        **Args:**</span>
</span><span id="STLLoss.__init__-43"><a href="#STLLoss.__init__-43"><span class="linenos">43</span></a><span class="sd">        - **save_dir** (`str`): The directory where data and figures of metrics will be saved. Better inside the output folder.</span>
</span><span id="STLLoss.__init__-44"><a href="#STLLoss.__init__-44"><span class="linenos">44</span></a><span class="sd">        - **test_loss_cls_csv_name**(`str`): file name to save classification loss of all tasks and average classification loss as CSV file.</span>
</span><span id="STLLoss.__init__-45"><a href="#STLLoss.__init__-45"><span class="linenos">45</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLLoss.__init__-46"><a href="#STLLoss.__init__-46"><span class="linenos">46</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="STLLoss.__init__-47"><a href="#STLLoss.__init__-47"><span class="linenos">47</span></a>
</span><span id="STLLoss.__init__-48"><a href="#STLLoss.__init__-48"><span class="linenos">48</span></a>        <span class="c1"># paths</span>
</span><span id="STLLoss.__init__-49"><a href="#STLLoss.__init__-49"><span class="linenos">49</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_csv_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="STLLoss.__init__-50"><a href="#STLLoss.__init__-50"><span class="linenos">50</span></a>            <span class="n">save_dir</span><span class="p">,</span> <span class="n">test_loss_cls_csv_name</span>
</span><span id="STLLoss.__init__-51"><a href="#STLLoss.__init__-51"><span class="linenos">51</span></a>        <span class="p">)</span>
</span><span id="STLLoss.__init__-52"><a href="#STLLoss.__init__-52"><span class="linenos">52</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Store the path to save test classification loss of all tasks and average classification loss CSV file.&quot;&quot;&quot;</span>
</span><span id="STLLoss.__init__-53"><a href="#STLLoss.__init__-53"><span class="linenos">53</span></a>
</span><span id="STLLoss.__init__-54"><a href="#STLLoss.__init__-54"><span class="linenos">54</span></a>        <span class="c1"># training accumulated metrics</span>
</span><span id="STLLoss.__init__-55"><a href="#STLLoss.__init__-55"><span class="linenos">55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="STLLoss.__init__-56"><a href="#STLLoss.__init__-56"><span class="linenos">56</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Classification loss of training epoch. Accumulated and calculated from the training batches. &quot;&quot;&quot;</span>
</span><span id="STLLoss.__init__-57"><a href="#STLLoss.__init__-57"><span class="linenos">57</span></a>
</span><span id="STLLoss.__init__-58"><a href="#STLLoss.__init__-58"><span class="linenos">58</span></a>        <span class="c1"># validation accumulated metrics</span>
</span><span id="STLLoss.__init__-59"><a href="#STLLoss.__init__-59"><span class="linenos">59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="STLLoss.__init__-60"><a href="#STLLoss.__init__-60"><span class="linenos">60</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Validation classification of the model loss after training epoch. Accumulated and calculated from the validation batches. &quot;&quot;&quot;</span>
</span><span id="STLLoss.__init__-61"><a href="#STLLoss.__init__-61"><span class="linenos">61</span></a>
</span><span id="STLLoss.__init__-62"><a href="#STLLoss.__init__-62"><span class="linenos">62</span></a>        <span class="c1"># test accumulated metrics</span>
</span><span id="STLLoss.__init__-63"><a href="#STLLoss.__init__-63"><span class="linenos">63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="p">:</span> <span class="n">MeanMetricBatch</span>
</span><span id="STLLoss.__init__-64"><a href="#STLLoss.__init__-64"><span class="linenos">64</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Test classification loss. Accumulated and calculated from the test batches.&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the <code><a href="#STLLoss">STLLoss</a></code>.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>save_dir</strong> (<code>str</code>): The directory where data and figures of metrics will be saved. Better inside the output folder.</li>
<li><strong>test_loss_cls_csv_name</strong>(<code>str</code>): file name to save classification loss of all tasks and average classification loss as CSV file.</li>
</ul>
</div>


                            </div>
                            <div id="STLLoss.test_loss_cls_csv_path" class="classattr">
                                <div class="attr variable">
            <span class="name">test_loss_cls_csv_path</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#STLLoss.test_loss_cls_csv_path"></a>
    
            <div class="docstring"><p>Store the path to save test classification loss of all tasks and average classification loss CSV file.</p>
</div>


                            </div>
                            <div id="STLLoss.loss_cls_training_epoch" class="classattr">
                                <div class="attr variable">
            <span class="name">loss_cls_training_epoch</span><span class="annotation">: <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a></span>

        
    </div>
    <a class="headerlink" href="#STLLoss.loss_cls_training_epoch"></a>
    
            <div class="docstring"><p>Classification loss of training epoch. Accumulated and calculated from the training batches.</p>
</div>


                            </div>
                            <div id="STLLoss.loss_cls_val" class="classattr">
                                <div class="attr variable">
            <span class="name">loss_cls_val</span><span class="annotation">: <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a></span>

        
    </div>
    <a class="headerlink" href="#STLLoss.loss_cls_val"></a>
    
            <div class="docstring"><p>Validation classification of the model loss after training epoch. Accumulated and calculated from the validation batches.</p>
</div>


                            </div>
                            <div id="STLLoss.loss_cls_test" class="classattr">
                                <div class="attr variable">
            <span class="name">loss_cls_test</span><span class="annotation">: <a href="utils/metrics.html#MeanMetricBatch">clarena.utils.metrics.MeanMetricBatch</a></span>

        
    </div>
    <a class="headerlink" href="#STLLoss.loss_cls_test"></a>
    
            <div class="docstring"><p>Test classification loss. Accumulated and calculated from the test batches.</p>
</div>


                            </div>
                            <div id="STLLoss.on_fit_start" class="classattr">
                                        <input id="STLLoss.on_fit_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_fit_start</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="stl_algorithms/base.html#STLAlgorithm">clarena.stl_algorithms.base.STLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="STLLoss.on_fit_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLLoss.on_fit_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLLoss.on_fit_start-66"><a href="#STLLoss.on_fit_start-66"><span class="linenos">66</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_fit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss.on_fit_start-67"><a href="#STLLoss.on_fit_start-67"><span class="linenos">67</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize training and validation metrics.&quot;&quot;&quot;</span>
</span><span id="STLLoss.on_fit_start-68"><a href="#STLLoss.on_fit_start-68"><span class="linenos">68</span></a>
</span><span id="STLLoss.on_fit_start-69"><a href="#STLLoss.on_fit_start-69"><span class="linenos">69</span></a>        <span class="c1"># initialize training metrics</span>
</span><span id="STLLoss.on_fit_start-70"><a href="#STLLoss.on_fit_start-70"><span class="linenos">70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span>
</span><span id="STLLoss.on_fit_start-71"><a href="#STLLoss.on_fit_start-71"><span class="linenos">71</span></a>
</span><span id="STLLoss.on_fit_start-72"><a href="#STLLoss.on_fit_start-72"><span class="linenos">72</span></a>        <span class="c1"># initialize validation metrics</span>
</span><span id="STLLoss.on_fit_start-73"><a href="#STLLoss.on_fit_start-73"><span class="linenos">73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Initialize training and validation metrics.</p>
</div>


                            </div>
                            <div id="STLLoss.on_train_batch_end" class="classattr">
                                        <input id="STLLoss.on_train_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_train_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="stl_algorithms/base.html#STLAlgorithm">clarena.stl_algorithms.base.STLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="STLLoss.on_train_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLLoss.on_train_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLLoss.on_train_batch_end-75"><a href="#STLLoss.on_train_batch_end-75"><span class="linenos"> 75</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span>
</span><span id="STLLoss.on_train_batch_end-76"><a href="#STLLoss.on_train_batch_end-76"><span class="linenos"> 76</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLLoss.on_train_batch_end-77"><a href="#STLLoss.on_train_batch_end-77"><span class="linenos"> 77</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLLoss.on_train_batch_end-78"><a href="#STLLoss.on_train_batch_end-78"><span class="linenos"> 78</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLLoss.on_train_batch_end-79"><a href="#STLLoss.on_train_batch_end-79"><span class="linenos"> 79</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="STLLoss.on_train_batch_end-80"><a href="#STLLoss.on_train_batch_end-80"><span class="linenos"> 80</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="STLLoss.on_train_batch_end-81"><a href="#STLLoss.on_train_batch_end-81"><span class="linenos"> 81</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="STLLoss.on_train_batch_end-82"><a href="#STLLoss.on_train_batch_end-82"><span class="linenos"> 82</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss.on_train_batch_end-83"><a href="#STLLoss.on_train_batch_end-83"><span class="linenos"> 83</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Record training metrics from training batch, log metrics of training batch and accumulated metrics of the epoch to Lightning loggers.</span>
</span><span id="STLLoss.on_train_batch_end-84"><a href="#STLLoss.on_train_batch_end-84"><span class="linenos"> 84</span></a>
</span><span id="STLLoss.on_train_batch_end-85"><a href="#STLLoss.on_train_batch_end-85"><span class="linenos"> 85</span></a><span class="sd">        **Args:**</span>
</span><span id="STLLoss.on_train_batch_end-86"><a href="#STLLoss.on_train_batch_end-86"><span class="linenos"> 86</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the training step, the returns of the `training_step()` method in the `STLAlgorithm`.</span>
</span><span id="STLLoss.on_train_batch_end-87"><a href="#STLLoss.on_train_batch_end-87"><span class="linenos"> 87</span></a><span class="sd">        - **batch** (`Any`): the training data batch.</span>
</span><span id="STLLoss.on_train_batch_end-88"><a href="#STLLoss.on_train_batch_end-88"><span class="linenos"> 88</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLLoss.on_train_batch_end-89"><a href="#STLLoss.on_train_batch_end-89"><span class="linenos"> 89</span></a>        <span class="c1"># get the batch size</span>
</span><span id="STLLoss.on_train_batch_end-90"><a href="#STLLoss.on_train_batch_end-90"><span class="linenos"> 90</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="STLLoss.on_train_batch_end-91"><a href="#STLLoss.on_train_batch_end-91"><span class="linenos"> 91</span></a>
</span><span id="STLLoss.on_train_batch_end-92"><a href="#STLLoss.on_train_batch_end-92"><span class="linenos"> 92</span></a>        <span class="c1"># get training metrics values of current training batch from the outputs of the `training_step()`</span>
</span><span id="STLLoss.on_train_batch_end-93"><a href="#STLLoss.on_train_batch_end-93"><span class="linenos"> 93</span></a>        <span class="n">loss_cls_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="STLLoss.on_train_batch_end-94"><a href="#STLLoss.on_train_batch_end-94"><span class="linenos"> 94</span></a>
</span><span id="STLLoss.on_train_batch_end-95"><a href="#STLLoss.on_train_batch_end-95"><span class="linenos"> 95</span></a>        <span class="c1"># update accumulated training metrics to calculate training metrics of the epoch</span>
</span><span id="STLLoss.on_train_batch_end-96"><a href="#STLLoss.on_train_batch_end-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="STLLoss.on_train_batch_end-97"><a href="#STLLoss.on_train_batch_end-97"><span class="linenos"> 97</span></a>
</span><span id="STLLoss.on_train_batch_end-98"><a href="#STLLoss.on_train_batch_end-98"><span class="linenos"> 98</span></a>        <span class="c1"># log training metrics of current training batch to Lightning loggers</span>
</span><span id="STLLoss.on_train_batch_end-99"><a href="#STLLoss.on_train_batch_end-99"><span class="linenos"> 99</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;train/loss_cls_batch&quot;</span><span class="p">,</span> <span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="STLLoss.on_train_batch_end-100"><a href="#STLLoss.on_train_batch_end-100"><span class="linenos">100</span></a>
</span><span id="STLLoss.on_train_batch_end-101"><a href="#STLLoss.on_train_batch_end-101"><span class="linenos">101</span></a>        <span class="c1"># log accumulated training metrics till this training batch to Lightning loggers</span>
</span><span id="STLLoss.on_train_batch_end-102"><a href="#STLLoss.on_train_batch_end-102"><span class="linenos">102</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="STLLoss.on_train_batch_end-103"><a href="#STLLoss.on_train_batch_end-103"><span class="linenos">103</span></a>            <span class="s2">&quot;task/train/loss_cls&quot;</span><span class="p">,</span>
</span><span id="STLLoss.on_train_batch_end-104"><a href="#STLLoss.on_train_batch_end-104"><span class="linenos">104</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="STLLoss.on_train_batch_end-105"><a href="#STLLoss.on_train_batch_end-105"><span class="linenos">105</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLLoss.on_train_batch_end-106"><a href="#STLLoss.on_train_batch_end-106"><span class="linenos">106</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Record training metrics from training batch, log metrics of training batch and accumulated metrics of the epoch to Lightning loggers.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the training step, the returns of the <code>training_step()</code> method in the <code>STLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the training data batch.</li>
</ul>
</div>


                            </div>
                            <div id="STLLoss.on_train_epoch_end" class="classattr">
                                        <input id="STLLoss.on_train_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_train_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="stl_algorithms/base.html#STLAlgorithm">clarena.stl_algorithms.base.STLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="STLLoss.on_train_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLLoss.on_train_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLLoss.on_train_epoch_end-108"><a href="#STLLoss.on_train_epoch_end-108"><span class="linenos">108</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_epoch_end</span><span class="p">(</span>
</span><span id="STLLoss.on_train_epoch_end-109"><a href="#STLLoss.on_train_epoch_end-109"><span class="linenos">109</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLLoss.on_train_epoch_end-110"><a href="#STLLoss.on_train_epoch_end-110"><span class="linenos">110</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLLoss.on_train_epoch_end-111"><a href="#STLLoss.on_train_epoch_end-111"><span class="linenos">111</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLLoss.on_train_epoch_end-112"><a href="#STLLoss.on_train_epoch_end-112"><span class="linenos">112</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss.on_train_epoch_end-113"><a href="#STLLoss.on_train_epoch_end-113"><span class="linenos">113</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log metrics of training epoch to plot learning curves and reset the metrics accumulation at the end of training epoch.&quot;&quot;&quot;</span>
</span><span id="STLLoss.on_train_epoch_end-114"><a href="#STLLoss.on_train_epoch_end-114"><span class="linenos">114</span></a>
</span><span id="STLLoss.on_train_epoch_end-115"><a href="#STLLoss.on_train_epoch_end-115"><span class="linenos">115</span></a>        <span class="c1"># log the accumulated and computed metrics of the epoch to Lightning loggers, specially for plotting learning curves</span>
</span><span id="STLLoss.on_train_epoch_end-116"><a href="#STLLoss.on_train_epoch_end-116"><span class="linenos">116</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="STLLoss.on_train_epoch_end-117"><a href="#STLLoss.on_train_epoch_end-117"><span class="linenos">117</span></a>            <span class="s2">&quot;learning_curve/train/loss_cls&quot;</span><span class="p">,</span>
</span><span id="STLLoss.on_train_epoch_end-118"><a href="#STLLoss.on_train_epoch_end-118"><span class="linenos">118</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="STLLoss.on_train_epoch_end-119"><a href="#STLLoss.on_train_epoch_end-119"><span class="linenos">119</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLLoss.on_train_epoch_end-120"><a href="#STLLoss.on_train_epoch_end-120"><span class="linenos">120</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLLoss.on_train_epoch_end-121"><a href="#STLLoss.on_train_epoch_end-121"><span class="linenos">121</span></a>        <span class="p">)</span>
</span><span id="STLLoss.on_train_epoch_end-122"><a href="#STLLoss.on_train_epoch_end-122"><span class="linenos">122</span></a>
</span><span id="STLLoss.on_train_epoch_end-123"><a href="#STLLoss.on_train_epoch_end-123"><span class="linenos">123</span></a>        <span class="c1"># reset the metrics of training epoch as there are more epochs to go and not only one epoch like in the validation and test</span>
</span><span id="STLLoss.on_train_epoch_end-124"><a href="#STLLoss.on_train_epoch_end-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_training_epoch</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Log metrics of training epoch to plot learning curves and reset the metrics accumulation at the end of training epoch.</p>
</div>


                            </div>
                            <div id="STLLoss.on_validation_batch_end" class="classattr">
                                        <input id="STLLoss.on_validation_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_validation_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="stl_algorithms/base.html#STLAlgorithm">clarena.stl_algorithms.base.STLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="STLLoss.on_validation_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLLoss.on_validation_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLLoss.on_validation_batch_end-126"><a href="#STLLoss.on_validation_batch_end-126"><span class="linenos">126</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_batch_end</span><span class="p">(</span>
</span><span id="STLLoss.on_validation_batch_end-127"><a href="#STLLoss.on_validation_batch_end-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLLoss.on_validation_batch_end-128"><a href="#STLLoss.on_validation_batch_end-128"><span class="linenos">128</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLLoss.on_validation_batch_end-129"><a href="#STLLoss.on_validation_batch_end-129"><span class="linenos">129</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLLoss.on_validation_batch_end-130"><a href="#STLLoss.on_validation_batch_end-130"><span class="linenos">130</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="STLLoss.on_validation_batch_end-131"><a href="#STLLoss.on_validation_batch_end-131"><span class="linenos">131</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="STLLoss.on_validation_batch_end-132"><a href="#STLLoss.on_validation_batch_end-132"><span class="linenos">132</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="STLLoss.on_validation_batch_end-133"><a href="#STLLoss.on_validation_batch_end-133"><span class="linenos">133</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss.on_validation_batch_end-134"><a href="#STLLoss.on_validation_batch_end-134"><span class="linenos">134</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from validation batch. We don&#39;t need to log and monitor the metrics of validation batches.</span>
</span><span id="STLLoss.on_validation_batch_end-135"><a href="#STLLoss.on_validation_batch_end-135"><span class="linenos">135</span></a>
</span><span id="STLLoss.on_validation_batch_end-136"><a href="#STLLoss.on_validation_batch_end-136"><span class="linenos">136</span></a><span class="sd">        **Args:**</span>
</span><span id="STLLoss.on_validation_batch_end-137"><a href="#STLLoss.on_validation_batch_end-137"><span class="linenos">137</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the validation step, which is the returns of the `validation_step()` method in the `STLAlgorithm`.</span>
</span><span id="STLLoss.on_validation_batch_end-138"><a href="#STLLoss.on_validation_batch_end-138"><span class="linenos">138</span></a><span class="sd">        - **batch** (`Any`): the validation data batch.</span>
</span><span id="STLLoss.on_validation_batch_end-139"><a href="#STLLoss.on_validation_batch_end-139"><span class="linenos">139</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLLoss.on_validation_batch_end-140"><a href="#STLLoss.on_validation_batch_end-140"><span class="linenos">140</span></a>
</span><span id="STLLoss.on_validation_batch_end-141"><a href="#STLLoss.on_validation_batch_end-141"><span class="linenos">141</span></a>        <span class="c1"># get the batch size</span>
</span><span id="STLLoss.on_validation_batch_end-142"><a href="#STLLoss.on_validation_batch_end-142"><span class="linenos">142</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="STLLoss.on_validation_batch_end-143"><a href="#STLLoss.on_validation_batch_end-143"><span class="linenos">143</span></a>
</span><span id="STLLoss.on_validation_batch_end-144"><a href="#STLLoss.on_validation_batch_end-144"><span class="linenos">144</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="STLLoss.on_validation_batch_end-145"><a href="#STLLoss.on_validation_batch_end-145"><span class="linenos">145</span></a>        <span class="n">loss_cls_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="STLLoss.on_validation_batch_end-146"><a href="#STLLoss.on_validation_batch_end-146"><span class="linenos">146</span></a>
</span><span id="STLLoss.on_validation_batch_end-147"><a href="#STLLoss.on_validation_batch_end-147"><span class="linenos">147</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the validation metrics</span>
</span><span id="STLLoss.on_validation_batch_end-148"><a href="#STLLoss.on_validation_batch_end-148"><span class="linenos">148</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Accumulating metrics from validation batch. We don't need to log and monitor the metrics of validation batches.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the validation step, which is the returns of the <code>validation_step()</code> method in the <code>STLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the validation data batch.</li>
</ul>
</div>


                            </div>
                            <div id="STLLoss.on_validation_epoch_end" class="classattr">
                                        <input id="STLLoss.on_validation_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_validation_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="stl_algorithms/base.html#STLAlgorithm">clarena.stl_algorithms.base.STLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="STLLoss.on_validation_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLLoss.on_validation_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLLoss.on_validation_epoch_end-150"><a href="#STLLoss.on_validation_epoch_end-150"><span class="linenos">150</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_epoch_end</span><span class="p">(</span>
</span><span id="STLLoss.on_validation_epoch_end-151"><a href="#STLLoss.on_validation_epoch_end-151"><span class="linenos">151</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLLoss.on_validation_epoch_end-152"><a href="#STLLoss.on_validation_epoch_end-152"><span class="linenos">152</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLLoss.on_validation_epoch_end-153"><a href="#STLLoss.on_validation_epoch_end-153"><span class="linenos">153</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLLoss.on_validation_epoch_end-154"><a href="#STLLoss.on_validation_epoch_end-154"><span class="linenos">154</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss.on_validation_epoch_end-155"><a href="#STLLoss.on_validation_epoch_end-155"><span class="linenos">155</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log validation metrics to plot learning curves.&quot;&quot;&quot;</span>
</span><span id="STLLoss.on_validation_epoch_end-156"><a href="#STLLoss.on_validation_epoch_end-156"><span class="linenos">156</span></a>
</span><span id="STLLoss.on_validation_epoch_end-157"><a href="#STLLoss.on_validation_epoch_end-157"><span class="linenos">157</span></a>        <span class="c1"># log the accumulated and computed metrics of the epoch to Lightning loggers, specially for plotting learning curves</span>
</span><span id="STLLoss.on_validation_epoch_end-158"><a href="#STLLoss.on_validation_epoch_end-158"><span class="linenos">158</span></a>        <span class="n">pl_module</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="STLLoss.on_validation_epoch_end-159"><a href="#STLLoss.on_validation_epoch_end-159"><span class="linenos">159</span></a>            <span class="s2">&quot;learning_curve/val/loss_cls&quot;</span><span class="p">,</span>
</span><span id="STLLoss.on_validation_epoch_end-160"><a href="#STLLoss.on_validation_epoch_end-160"><span class="linenos">160</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_val</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span>
</span><span id="STLLoss.on_validation_epoch_end-161"><a href="#STLLoss.on_validation_epoch_end-161"><span class="linenos">161</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLLoss.on_validation_epoch_end-162"><a href="#STLLoss.on_validation_epoch_end-162"><span class="linenos">162</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="STLLoss.on_validation_epoch_end-163"><a href="#STLLoss.on_validation_epoch_end-163"><span class="linenos">163</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Log validation metrics to plot learning curves.</p>
</div>


                            </div>
                            <div id="STLLoss.on_test_start" class="classattr">
                                        <input id="STLLoss.on_test_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_test_start</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="stl_algorithms/base.html#STLAlgorithm">clarena.stl_algorithms.base.STLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="STLLoss.on_test_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLLoss.on_test_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLLoss.on_test_start-165"><a href="#STLLoss.on_test_start-165"><span class="linenos">165</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_start</span><span class="p">(</span>
</span><span id="STLLoss.on_test_start-166"><a href="#STLLoss.on_test_start-166"><span class="linenos">166</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLLoss.on_test_start-167"><a href="#STLLoss.on_test_start-167"><span class="linenos">167</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLLoss.on_test_start-168"><a href="#STLLoss.on_test_start-168"><span class="linenos">168</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLLoss.on_test_start-169"><a href="#STLLoss.on_test_start-169"><span class="linenos">169</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss.on_test_start-170"><a href="#STLLoss.on_test_start-170"><span class="linenos">170</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the metrics for testing each seen task in the beginning of a task&#39;s testing.&quot;&quot;&quot;</span>
</span><span id="STLLoss.on_test_start-171"><a href="#STLLoss.on_test_start-171"><span class="linenos">171</span></a>
</span><span id="STLLoss.on_test_start-172"><a href="#STLLoss.on_test_start-172"><span class="linenos">172</span></a>        <span class="c1"># initialize test metrics</span>
</span><span id="STLLoss.on_test_start-173"><a href="#STLLoss.on_test_start-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span> <span class="o">=</span> <span class="n">MeanMetricBatch</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the metrics for testing each seen task in the beginning of a task's testing.</p>
</div>


                            </div>
                            <div id="STLLoss.on_test_batch_end" class="classattr">
                                        <input id="STLLoss.on_test_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_test_batch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="stl_algorithms/base.html#STLAlgorithm">clarena.stl_algorithms.base.STLAlgorithm</a></span>,</span><span class="param">	<span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="STLLoss.on_test_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLLoss.on_test_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLLoss.on_test_batch_end-175"><a href="#STLLoss.on_test_batch_end-175"><span class="linenos">175</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_batch_end</span><span class="p">(</span>
</span><span id="STLLoss.on_test_batch_end-176"><a href="#STLLoss.on_test_batch_end-176"><span class="linenos">176</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLLoss.on_test_batch_end-177"><a href="#STLLoss.on_test_batch_end-177"><span class="linenos">177</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLLoss.on_test_batch_end-178"><a href="#STLLoss.on_test_batch_end-178"><span class="linenos">178</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLLoss.on_test_batch_end-179"><a href="#STLLoss.on_test_batch_end-179"><span class="linenos">179</span></a>        <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="STLLoss.on_test_batch_end-180"><a href="#STLLoss.on_test_batch_end-180"><span class="linenos">180</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="STLLoss.on_test_batch_end-181"><a href="#STLLoss.on_test_batch_end-181"><span class="linenos">181</span></a>        <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="STLLoss.on_test_batch_end-182"><a href="#STLLoss.on_test_batch_end-182"><span class="linenos">182</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss.on_test_batch_end-183"><a href="#STLLoss.on_test_batch_end-183"><span class="linenos">183</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Accumulating metrics from test batch. We don&#39;t need to log and monitor the metrics of test batches.</span>
</span><span id="STLLoss.on_test_batch_end-184"><a href="#STLLoss.on_test_batch_end-184"><span class="linenos">184</span></a>
</span><span id="STLLoss.on_test_batch_end-185"><a href="#STLLoss.on_test_batch_end-185"><span class="linenos">185</span></a><span class="sd">        **Args:**</span>
</span><span id="STLLoss.on_test_batch_end-186"><a href="#STLLoss.on_test_batch_end-186"><span class="linenos">186</span></a><span class="sd">        - **outputs** (`dict[str, Any]`): the outputs of the test step, which is the returns of the `test_step()` method in the `STLAlgorithm`.</span>
</span><span id="STLLoss.on_test_batch_end-187"><a href="#STLLoss.on_test_batch_end-187"><span class="linenos">187</span></a><span class="sd">        - **batch** (`Any`): the test data batch.</span>
</span><span id="STLLoss.on_test_batch_end-188"><a href="#STLLoss.on_test_batch_end-188"><span class="linenos">188</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLLoss.on_test_batch_end-189"><a href="#STLLoss.on_test_batch_end-189"><span class="linenos">189</span></a>
</span><span id="STLLoss.on_test_batch_end-190"><a href="#STLLoss.on_test_batch_end-190"><span class="linenos">190</span></a>        <span class="c1"># get the batch size</span>
</span><span id="STLLoss.on_test_batch_end-191"><a href="#STLLoss.on_test_batch_end-191"><span class="linenos">191</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="STLLoss.on_test_batch_end-192"><a href="#STLLoss.on_test_batch_end-192"><span class="linenos">192</span></a>
</span><span id="STLLoss.on_test_batch_end-193"><a href="#STLLoss.on_test_batch_end-193"><span class="linenos">193</span></a>        <span class="c1"># get the metrics values of the batch from the outputs</span>
</span><span id="STLLoss.on_test_batch_end-194"><a href="#STLLoss.on_test_batch_end-194"><span class="linenos">194</span></a>        <span class="n">loss_cls_batch</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="STLLoss.on_test_batch_end-195"><a href="#STLLoss.on_test_batch_end-195"><span class="linenos">195</span></a>
</span><span id="STLLoss.on_test_batch_end-196"><a href="#STLLoss.on_test_batch_end-196"><span class="linenos">196</span></a>        <span class="c1"># update the accumulated metrics in order to calculate the metrics of the epoch</span>
</span><span id="STLLoss.on_test_batch_end-197"><a href="#STLLoss.on_test_batch_end-197"><span class="linenos">197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss_cls_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Accumulating metrics from test batch. We don't need to log and monitor the metrics of test batches.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>outputs</strong> (<code>dict[str, Any]</code>): the outputs of the test step, which is the returns of the <code>test_step()</code> method in the <code>STLAlgorithm</code>.</li>
<li><strong>batch</strong> (<code>Any</code>): the test data batch.</li>
</ul>
</div>


                            </div>
                            <div id="STLLoss.on_test_epoch_end" class="classattr">
                                        <input id="STLLoss.on_test_epoch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_test_epoch_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trainer</span><span class="p">:</span> <span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">Trainer</span>,</span><span class="param">	<span class="n">pl_module</span><span class="p">:</span> <span class="n"><a href="stl_algorithms/base.html#STLAlgorithm">clarena.stl_algorithms.base.STLAlgorithm</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="STLLoss.on_test_epoch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLLoss.on_test_epoch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLLoss.on_test_epoch_end-199"><a href="#STLLoss.on_test_epoch_end-199"><span class="linenos">199</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_test_epoch_end</span><span class="p">(</span>
</span><span id="STLLoss.on_test_epoch_end-200"><a href="#STLLoss.on_test_epoch_end-200"><span class="linenos">200</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLLoss.on_test_epoch_end-201"><a href="#STLLoss.on_test_epoch_end-201"><span class="linenos">201</span></a>        <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">,</span>
</span><span id="STLLoss.on_test_epoch_end-202"><a href="#STLLoss.on_test_epoch_end-202"><span class="linenos">202</span></a>        <span class="n">pl_module</span><span class="p">:</span> <span class="n">STLAlgorithm</span><span class="p">,</span>
</span><span id="STLLoss.on_test_epoch_end-203"><a href="#STLLoss.on_test_epoch_end-203"><span class="linenos">203</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss.on_test_epoch_end-204"><a href="#STLLoss.on_test_epoch_end-204"><span class="linenos">204</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save and plot test metrics at the end of test.&quot;&quot;&quot;</span>
</span><span id="STLLoss.on_test_epoch_end-205"><a href="#STLLoss.on_test_epoch_end-205"><span class="linenos">205</span></a>
</span><span id="STLLoss.on_test_epoch_end-206"><a href="#STLLoss.on_test_epoch_end-206"><span class="linenos">206</span></a>        <span class="c1"># save (update) the test metrics to CSV files</span>
</span><span id="STLLoss.on_test_epoch_end-207"><a href="#STLLoss.on_test_epoch_end-207"><span class="linenos">207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_test_loss_cls_to_csv</span><span class="p">(</span>
</span><span id="STLLoss.on_test_epoch_end-208"><a href="#STLLoss.on_test_epoch_end-208"><span class="linenos">208</span></a>            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loss_cls_csv_path</span><span class="p">,</span>
</span><span id="STLLoss.on_test_epoch_end-209"><a href="#STLLoss.on_test_epoch_end-209"><span class="linenos">209</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save and plot test metrics at the end of test.</p>
</div>


                            </div>
                            <div id="STLLoss.save_test_loss_cls_to_csv" class="classattr">
                                        <input id="STLLoss.save_test_loss_cls_to_csv-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_test_loss_cls_to_csv</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="STLLoss.save_test_loss_cls_to_csv-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#STLLoss.save_test_loss_cls_to_csv"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="STLLoss.save_test_loss_cls_to_csv-211"><a href="#STLLoss.save_test_loss_cls_to_csv-211"><span class="linenos">211</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_test_loss_cls_to_csv</span><span class="p">(</span>
</span><span id="STLLoss.save_test_loss_cls_to_csv-212"><a href="#STLLoss.save_test_loss_cls_to_csv-212"><span class="linenos">212</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="STLLoss.save_test_loss_cls_to_csv-213"><a href="#STLLoss.save_test_loss_cls_to_csv-213"><span class="linenos">213</span></a>        <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="STLLoss.save_test_loss_cls_to_csv-214"><a href="#STLLoss.save_test_loss_cls_to_csv-214"><span class="linenos">214</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="STLLoss.save_test_loss_cls_to_csv-215"><a href="#STLLoss.save_test_loss_cls_to_csv-215"><span class="linenos">215</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save the test classification loss metrics in single-task learning to an CSV file.</span>
</span><span id="STLLoss.save_test_loss_cls_to_csv-216"><a href="#STLLoss.save_test_loss_cls_to_csv-216"><span class="linenos">216</span></a>
</span><span id="STLLoss.save_test_loss_cls_to_csv-217"><a href="#STLLoss.save_test_loss_cls_to_csv-217"><span class="linenos">217</span></a><span class="sd">        **Args:**</span>
</span><span id="STLLoss.save_test_loss_cls_to_csv-218"><a href="#STLLoss.save_test_loss_cls_to_csv-218"><span class="linenos">218</span></a><span class="sd">        - **csv_path** (`str`): save the test metric to path. E.g. &#39;./outputs/expr_name/1970-01-01_00-00-00/results/loss_cls.csv&#39;.</span>
</span><span id="STLLoss.save_test_loss_cls_to_csv-219"><a href="#STLLoss.save_test_loss_cls_to_csv-219"><span class="linenos">219</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="STLLoss.save_test_loss_cls_to_csv-220"><a href="#STLLoss.save_test_loss_cls_to_csv-220"><span class="linenos">220</span></a>        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">]</span>
</span><span id="STLLoss.save_test_loss_cls_to_csv-221"><a href="#STLLoss.save_test_loss_cls_to_csv-221"><span class="linenos">221</span></a>        <span class="n">new_line</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;loss_cls&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_cls_test</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()}</span>
</span><span id="STLLoss.save_test_loss_cls_to_csv-222"><a href="#STLLoss.save_test_loss_cls_to_csv-222"><span class="linenos">222</span></a>
</span><span id="STLLoss.save_test_loss_cls_to_csv-223"><a href="#STLLoss.save_test_loss_cls_to_csv-223"><span class="linenos">223</span></a>        <span class="c1"># write</span>
</span><span id="STLLoss.save_test_loss_cls_to_csv-224"><a href="#STLLoss.save_test_loss_cls_to_csv-224"><span class="linenos">224</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="STLLoss.save_test_loss_cls_to_csv-225"><a href="#STLLoss.save_test_loss_cls_to_csv-225"><span class="linenos">225</span></a>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
</span><span id="STLLoss.save_test_loss_cls_to_csv-226"><a href="#STLLoss.save_test_loss_cls_to_csv-226"><span class="linenos">226</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="STLLoss.save_test_loss_cls_to_csv-227"><a href="#STLLoss.save_test_loss_cls_to_csv-227"><span class="linenos">227</span></a>            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save the test classification loss metrics in single-task learning to an CSV file.</p>

<p><strong>Args:</strong></p>

<ul>
<li><strong>csv_path</strong> (<code>str</code>): save the test metric to path. E.g. './outputs/expr_name/1970-01-01_00-00-00/results/loss_cls.csv'.</li>
</ul>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>